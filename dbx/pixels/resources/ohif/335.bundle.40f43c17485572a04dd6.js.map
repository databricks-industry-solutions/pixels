{"version":3,"file":"335.bundle.40f43c17485572a04dd6.js","mappings":"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","sources":["webpack:///../../../extensions/default/src/DicomWebDataSource/qido.js","webpack:///../../../extensions/default/src/DicomWebDataSource/utils/getImageId.js","webpack:///../../../extensions/default/src/DicomWebDataSource/utils/getWADORSImageId.js","webpack:///../../../extensions/default/src/DicomWebDataSource/wado/retrieveMetadataLoader.js","webpack:///../../../extensions/default/src/DicomWebDataSource/wado/retrieveMetadataLoaderSync.js","webpack:///../../../extensions/default/src/DicomWebDataSource/wado/retrieveMetadataLoaderAsync.js","webpack:///../../../extensions/default/src/DicomWebDataSource/wado/retrieveMetadata.js","webpack:///../../../extensions/default/src/DicomWebDataSource/utils/retrieveMetadataFiltered.js","webpack:///../../../extensions/default/src/DicomWebDataSource/retrieveStudyMetadata.js","webpack:///../../../extensions/default/src/DicomWebDataSource/utils/StaticWadoClient.ts","webpack:///../../../extensions/default/src/utils/getDirectURL.js","webpack:///../../../extensions/default/src/DicomWebDataSource/utils/fixBulkDataURI.ts","webpack:///../../../extensions/default/src/DicomWebDataSource/index.js","webpack:///../../../extensions/default/src/DicomWebDataSource/dcm4cheeReject.js","webpack:///../../../extensions/default/src/DicomJSONDataSource/index.js","webpack:///../../../extensions/default/src/DicomLocalDataSource/index.js","webpack:///../../../extensions/default/src/DatabricksPixelsDicom/utils.js","webpack:///../../../extensions/default/src/DatabricksPixelsDicom/index.js","webpack:///../../../extensions/default/src/DicomWebProxyDataSource/index.js","webpack:///../../../extensions/default/src/MergeDataSource/index.ts","webpack:///../../../extensions/default/src/getDataSourcesModule.js","webpack:///../../../extensions/default/src/Toolbar/Toolbar.tsx","webpack:///../../../extensions/default/src/ViewerLayout/ViewerHeader.tsx","webpack:///../../../extensions/default/src/Components/SidePanelWithServices.tsx","webpack:///../../../extensions/default/src/ViewerLayout/index.tsx","webpack:///../../../extensions/default/src/Panels/PanelStudyBrowser.tsx","webpack:///../../../extensions/default/src/Panels/getImageSrcFromImageId.js","webpack:///../../../extensions/default/src/Panels/getStudiesForPatientByMRN.js","webpack:///../../../extensions/default/src/Panels/requestDisplaySetCreationForStudy.js","webpack:///../../../extensions/default/src/Panels/WrappedPanelStudyBrowser.tsx","webpack:///../../../extensions/default/src/Panels/ActionButtons.tsx","webpack:///../../../extensions/default/src/Panels/createReportDialogPrompt.tsx","webpack:///../../../extensions/default/src/Actions/createReportAsync.tsx","webpack:///../../../extensions/default/src/utils/getNextSRSeriesNumber.js","webpack:///../../../extensions/default/src/utils/findSRWithSameSeriesDescription.ts","webpack:///../../../extensions/default/src/Panels/PanelMeasurementTable.tsx","webpack:///../../../extensions/default/src/getPanelModule.tsx","webpack:///../../../extensions/default/src/id.js","webpack:///../../../extensions/default/src/utils/validations/areAllImagePositionsEqual.ts","webpack:///../../../extensions/default/src/utils/calculateScanAxisNormal.ts","webpack:///../../../extensions/default/src/utils/validations/checkSingleFrames.ts","webpack:///../../../extensions/default/src/utils/validations/areAllImageDimensionsEqual.ts","webpack:///../../../extensions/default/src/utils/validations/areAllImageComponentsEqual.ts","webpack:///../../../extensions/default/src/utils/validations/areAllImageOrientationsEqual.ts","webpack:///../../../extensions/default/src/utils/validations/areAllImageSpacingEqual.ts","webpack:///../../../extensions/default/src/getDisplaySetMessages.ts","webpack:///../../../extensions/default/src/utils/validations/checkMultiframe.ts","webpack:///../../../extensions/default/src/getDisplaySetsFromUnsupportedSeries.js","webpack:///../../../extensions/default/src/getSopClassHandlerModule.js","webpack:///../../../extensions/default/src/Toolbar/ToolbarDivider.tsx","webpack:///../../../extensions/default/src/Toolbar/ToolbarLayoutSelector.tsx","webpack:///../../../extensions/default/src/Toolbar/ToolbarSplitButtonWithServices.tsx","webpack:///../../../extensions/default/src/Toolbar/ToolbarButtonWithServices.tsx","webpack:///../../../extensions/default/src/CustomizableContextMenu/ContextMenuItemsBuilder.ts","webpack:///../../../extensions/default/src/CustomizableContextMenu/ContextMenuController.tsx","webpack:///../../../extensions/default/src/CustomizableContextMenu/defaultContextMenu.ts","webpack:///../../../extensions/default/src/DicomTagBrowser/DicomTagTable.tsx","webpack:///../../../extensions/default/src/DicomTagBrowser/DicomTagBrowser.tsx","webpack:///../../../extensions/default/src/utils/reuseCachedLayouts.ts","webpack:///../../../extensions/default/src/findViewportsByPosition.ts","webpack:///../../../extensions/default/src/commandsModule.ts","webpack:///../../../extensions/default/src/hpMNGrid.ts","webpack:///../../../extensions/default/src/hpCompare.ts","webpack:///../../../extensions/default/src/getHangingProtocolModule.js","webpack:///../../../extensions/default/src/Panels/DataSourceSelector.tsx","webpack:///../../../extensions/default/src/Components/ItemListComponent.tsx","webpack:///../../../extensions/default/src/Components/DataSourceConfigurationModalComponent.tsx","webpack:///../../../extensions/default/src/Components/DataSourceConfigurationComponent.tsx","webpack:///../../../extensions/default/src/DataSourceConfigurationAPI/GoogleCloudDataSourceConfigurationAPI.ts","webpack:///../../../extensions/default/src/getPTImageIdInstanceMetadata.ts","webpack:///../../../extensions/default/src/init.ts","webpack:///../../../extensions/default/src/index.ts","webpack:///../../../extensions/default/src/getLayoutTemplateModule.js","webpack:///../../../extensions/default/src/getToolbarModule.tsx","webpack:///../../../extensions/default/src/getCustomizationModule.tsx"],"sourcesContent":["/**\n * QIDO - Query based on ID for DICOM Objects\n * search for studies, series and instances by patient ID, and receive their\n * unique identifiers for further usage.\n *\n * Quick: https://www.dicomstandard.org/dicomweb/query-qido-rs/\n * Standard: http://dicom.nema.org/medical/dicom/current/output/html/part18.html#sect_10.6\n *\n * Routes:\n * ==========\n * /studies?\n * /studies/{studyInstanceUid}/series?\n * /studies/{studyInstanceUid}/series/{seriesInstanceUid}/instances?\n *\n * Query Parameters:\n * ================\n * | KEY              | VALUE              |\n * |------------------|--------------------|\n * | {attributeId}    | {value}            |\n * | includeField     | {attribute} or all |\n * | fuzzymatching    | true OR false      |\n * | limit            | {number}           |\n * | offset           | {number}           |\n */\nimport { DICOMWeb, utils } from '@ohif/core';\nimport { sortStudySeries } from '@ohif/core/src/utils/sortStudy';\n\nconst { getString, getName, getModalities } = DICOMWeb;\n\n/**\n * Parses resulting data from a QIDO call into a set of Study MetaData\n *\n * @param {Array} qidoStudies - An array of study objects. Each object contains a keys for DICOM tags.\n * @param {object} qidoStudies[0].qidoStudy - An object where each key is the DICOM Tag group+element\n * @param {object} qidoStudies[0].qidoStudy[dicomTag] - Optional object that represents DICOM Tag\n * @param {string} qidoStudies[0].qidoStudy[dicomTag].vr - Value Representation\n * @param {string[]} qidoStudies[0].qidoStudy[dicomTag].Value - Optional string array representation of the DICOM Tag's value\n * @returns {Array} An array of Study MetaData objects\n */\nfunction processResults(qidoStudies) {\n  if (!qidoStudies || !qidoStudies.length) {\n    return [];\n  }\n\n  const studies = [];\n\n  qidoStudies.forEach(qidoStudy =>\n    studies.push({\n      studyInstanceUid: getString(qidoStudy['0020000D']),\n      date: getString(qidoStudy['00080020']), // YYYYMMDD\n      time: getString(qidoStudy['00080030']), // HHmmss.SSS (24-hour, minutes, seconds, fractional seconds)\n      accession: getString(qidoStudy['00080050']) || '', // short string, probably a number?\n      mrn: getString(qidoStudy['00100020']) || '', // medicalRecordNumber\n      patientName: utils.formatPN(getName(qidoStudy['00100010'])) || '',\n      instances: Number(getString(qidoStudy['00201208'])) || 0, // number\n      description: getString(qidoStudy['00081030']) || '',\n      modalities: getString(getModalities(qidoStudy['00080060'], qidoStudy['00080061'])) || '',\n    })\n  );\n\n  return studies;\n}\n\n/**\n * Parses resulting data from a QIDO call into a set of Study MetaData\n *\n * @param {Array} qidoSeries - An array of study objects. Each object contains a keys for DICOM tags.\n * @param {object} qidoSeries[0].qidoSeries - An object where each key is the DICOM Tag group+element\n * @param {object} qidoSeries[0].qidoSeries[dicomTag] - Optional object that represents DICOM Tag\n * @param {string} qidoSeries[0].qidoSeries[dicomTag].vr - Value Representation\n * @param {string[]} qidoSeries[0].qidoSeries[dicomTag].Value - Optional string array representation of the DICOM Tag's value\n * @returns {Array} An array of Study MetaData objects\n */\nexport function processSeriesResults(qidoSeries) {\n  const series = [];\n\n  if (qidoSeries && qidoSeries.length) {\n    qidoSeries.forEach(qidoSeries =>\n      series.push({\n        studyInstanceUid: getString(qidoSeries['0020000D']),\n        seriesInstanceUid: getString(qidoSeries['0020000E']),\n        modality: getString(qidoSeries['00080060']),\n        seriesNumber: getString(qidoSeries['00200011']),\n        seriesDate: utils.formatDate(getString(qidoSeries['00080021'])),\n        numSeriesInstances: Number(getString(qidoSeries['00201209'])),\n        description: getString(qidoSeries['0008103E']),\n      })\n    );\n  }\n\n  sortStudySeries(series);\n\n  return series;\n}\n\n/**\n *\n * @param {object} dicomWebClient - Client similar to what's provided by `dicomweb-client` library\n * @param {function} dicomWebClient.searchForStudies -\n * @param {string} [studyInstanceUid]\n * @param {string} [seriesInstanceUid]\n * @param {string} [queryParamaters]\n * @returns {Promise<results>} - Promise that resolves results\n */\nasync function search(dicomWebClient, studyInstanceUid, seriesInstanceUid, queryParameters) {\n  let searchResult = await dicomWebClient.searchForStudies({\n    studyInstanceUid: undefined,\n    queryParams: queryParameters,\n  });\n\n  return searchResult;\n}\n\n/**\n *\n * @param {string} studyInstanceUID - ID of study to return a list of series for\n * @returns {Promise} - Resolves SeriesMetadata[] in study\n */\nexport function seriesInStudy(dicomWebClient, studyInstanceUID) {\n  // Series Description\n  // Already included?\n  const commaSeparatedFields = ['0008103E', '00080021'].join(',');\n  const queryParams = {\n    includefield: commaSeparatedFields,\n  };\n\n  return dicomWebClient.searchForSeries({ studyInstanceUID, queryParams });\n}\n\nexport default function searchStudies(server, filter) {\n  const queryParams = getQIDOQueryParams(filter, server.qidoSupportsIncludeField);\n  const options = {\n    queryParams,\n  };\n\n  return dicomWeb.searchForStudies(options).then(resultDataToStudies);\n}\n\n/**\n * Produces a QIDO URL given server details and a set of specified search filter\n * items\n *\n * @param filter\n * @param serverSupportsQIDOIncludeField\n * @returns {string} The URL with encoded filter query data\n */\nfunction mapParams(params, options = {}) {\n  if (!params) {\n    return;\n  }\n  const commaSeparatedFields = [\n    '00081030', // Study Description\n    '00080060', // Modality\n    // Add more fields here if you want them in the result\n  ].join(',');\n\n  const { supportsWildcard } = options;\n  const withWildcard = value => {\n    return supportsWildcard && value ? `*${value}*` : value;\n  };\n\n  const parameters = {\n    // Named\n    PatientName: withWildcard(params.patientName),\n    //PatientID: withWildcard(params.patientId),\n    '00100020': withWildcard(params.patientId), // Temporarily to make the tests pass with dicomweb-server.. Apparently it's broken?\n    AccessionNumber: withWildcard(params.accessionNumber),\n    StudyDescription: withWildcard(params.studyDescription),\n    ModalitiesInStudy: params.modalitiesInStudy,\n    // Other\n    limit: params.limit || 101,\n    offset: params.offset || 0,\n    fuzzymatching: options.supportsFuzzyMatching === true,\n    includefield: commaSeparatedFields, // serverSupportsQIDOIncludeField ? commaSeparatedFields : 'all',\n  };\n\n  // build the StudyDate range parameter\n  if (params.startDate && params.endDate) {\n    parameters.StudyDate = `${params.startDate}-${params.endDate}`;\n  } else if (params.startDate) {\n    const today = new Date();\n    const DD = String(today.getDate()).padStart(2, '0');\n    const MM = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!\n    const YYYY = today.getFullYear();\n    const todayStr = `${YYYY}${MM}${DD}`;\n\n    parameters.StudyDate = `${params.startDate}-${todayStr}`;\n  } else if (params.endDate) {\n    const oldDateStr = `19700102`;\n\n    parameters.StudyDate = `${oldDateStr}-${params.endDate}`;\n  }\n\n  // Build the StudyInstanceUID parameter\n  if (params.studyInstanceUid) {\n    let studyUids = params.studyInstanceUid;\n    studyUids = Array.isArray(studyUids) ? studyUids.join() : studyUids;\n    studyUids = studyUids.replace(/[^0-9.]+/g, '\\\\');\n    parameters.StudyInstanceUID = studyUids;\n  }\n\n  // Clean query params of undefined values.\n  const final = {};\n  Object.keys(parameters).forEach(key => {\n    if (parameters[key] !== undefined && parameters[key] !== '') {\n      final[key] = parameters[key];\n    }\n  });\n\n  return final;\n}\n\nexport { mapParams, search, processResults };\n","import getWADORSImageId from './getWADORSImageId';\n\nfunction buildInstanceWadoUrl(config, instance) {\n  const { StudyInstanceUID, SeriesInstanceUID, SOPInstanceUID } = instance;\n  const params = [];\n\n  params.push('requestType=WADO');\n  params.push(`studyUID=${StudyInstanceUID}`);\n  params.push(`seriesUID=${SeriesInstanceUID}`);\n  params.push(`objectUID=${SOPInstanceUID}`);\n  params.push('contentType=application/dicom');\n  params.push('transferSyntax=*');\n\n  const paramString = params.join('&');\n\n  return `${config.wadoUriRoot}?${paramString}`;\n}\n\n/**\n * Obtain an imageId for Cornerstone from an image instance\n *\n * @param instance\n * @param frame\n * @param thumbnail\n * @returns {string} The imageId to be used by Cornerstone\n */\nexport default function getImageId({ instance, frame, config, thumbnail = false }) {\n  if (!instance) {\n    return;\n  }\n\n  if (instance.url) {\n    return instance.url;\n  }\n\n  const renderingAttr = thumbnail ? 'thumbnailRendering' : 'imageRendering';\n\n  if (!config[renderingAttr] || config[renderingAttr] === 'wadouri') {\n    const wadouri = buildInstanceWadoUrl(config, instance);\n\n    let imageId = 'dicomweb:' + wadouri;\n    if (frame !== undefined) {\n      imageId += '&frame=' + frame;\n    }\n\n    return imageId;\n  } else {\n    return getWADORSImageId(instance, config, frame); // WADO-RS Retrieve Frame\n  }\n}\n","function buildInstanceWadoRsUri(instance, config) {\n  const { StudyInstanceUID, SeriesInstanceUID, SOPInstanceUID } = instance;\n  return `${config.wadoRoot}/studies/${StudyInstanceUID}/series/${SeriesInstanceUID}/instances/${SOPInstanceUID}`;\n}\n\nfunction buildInstanceFrameWadoRsUri(instance, config, frame) {\n  const baseWadoRsUri = buildInstanceWadoRsUri(instance, config);\n\n  frame = frame || 1;\n\n  return `${baseWadoRsUri}/frames/${frame}`;\n}\n\n// function getWADORSImageUrl(instance, frame) {\n//   const wadorsuri = buildInstanceFrameWadoRsUri(instance, config, frame);\n\n//   if (!wadorsuri) {\n//     return;\n//   }\n\n//   // Use null to obtain an imageId which represents the instance\n//   if (frame === null) {\n//     wadorsuri = wadorsuri.replace(/frames\\/(\\d+)/, '');\n//   } else {\n//     // We need to sum 1 because WADO-RS frame number is 1-based\n//     frame = frame ? parseInt(frame) + 1 : 1;\n\n//     // Replaces /frame/1 by /frame/{frame}\n//     wadorsuri = wadorsuri.replace(/frames\\/(\\d+)/, `frames/${frame}`);\n//   }\n\n//   return wadorsuri;\n// }\n\n/**\n * Obtain an imageId for Cornerstone based on the WADO-RS scheme\n *\n * @param {object} instanceMetada metadata object (InstanceMetadata)\n * @param {(string\\|number)} [frame] the frame number\n * @returns {string} The imageId to be used by Cornerstone\n */\nexport default function getWADORSImageId(instance, config, frame) {\n  //const uri = getWADORSImageUrl(instance, frame);\n  const uri = buildInstanceFrameWadoRsUri(instance, config, frame);\n\n  if (!uri) {\n    return;\n  }\n\n  return `wadors:${uri}`;\n}\n","/**\n * Class to define inheritance of load retrieve strategy.\n * The process can be async load (lazy) or sync load\n *\n * There are methods that must be implemented at consumer level\n * To retrieve study call execLoad\n */\nexport default class RetrieveMetadataLoader {\n  /**\n   * @constructor\n   * @param {Object} client The dicomweb-client.\n   * @param {Array} studyInstanceUID Study instance ui to be retrieved\n   * @param {Object} [filters] - Object containing filters to be applied on retrieve metadata process\n   * @param {string} [filters.seriesInstanceUID] - series instance uid to filter results against\n   * @param {Object} [sortCriteria] - Custom sort criteria used for series\n   * @param {Function} [sortFunction] - Custom sort function for series\n   */\n  constructor(\n    client,\n    studyInstanceUID,\n    filters = {},\n    sortCriteria = undefined,\n    sortFunction = undefined\n  ) {\n    this.client = client;\n    this.studyInstanceUID = studyInstanceUID;\n    this.filters = filters;\n    this.sortCriteria = sortCriteria;\n    this.sortFunction = sortFunction;\n  }\n\n  async execLoad() {\n    const preLoadData = await this.preLoad();\n    const loadData = await this.load(preLoadData);\n    const postLoadData = await this.posLoad(loadData);\n    return postLoadData;\n  }\n\n  /**\n   * It iterates over given loaders running each one. Loaders parameters must be bind when getting it.\n   * @param {Array} loaders - array of loader to retrieve data.\n   */\n  async runLoaders(loaders) {\n    let result;\n    for (const loader of loaders) {\n      result = await loader();\n      if (result && result.length) {\n        break; // closes iterator in case data is retrieved successfully\n      }\n    }\n\n    if (loaders.next().done && !result) {\n      throw new Error('RetrieveMetadataLoader failed');\n    }\n\n    return result;\n  }\n\n  // Methods to be overwrite\n  async configLoad() {}\n  async preLoad() {}\n  async load(preLoadData) {}\n  async posLoad(loadData) {}\n}\n","// import { api } from 'dicomweb-client';\n// import DICOMWeb from '../../../DICOMWeb/';\nimport { createStudyFromSOPInstanceList } from './studyInstanceHelpers';\nimport RetrieveMetadataLoader from './retrieveMetadataLoader';\n\n/**\n * Class for sync load of study metadata.\n * It inherits from RetrieveMetadataLoader\n *\n * A list of loaders (getLoaders) can be created so, it will be applied a fallback load strategy.\n * I.e Retrieve metadata using all loaders possibilities.\n */\nexport default class RetrieveMetadataLoaderSync extends RetrieveMetadataLoader {\n  getOptions() {\n    const { studyInstanceUID, filters } = this;\n\n    const options = {\n      studyInstanceUID,\n    };\n\n    const { seriesInstanceUID } = filters;\n    if (seriesInstanceUID) {\n      options['seriesInstanceUID'] = seriesInstanceUID;\n    }\n\n    return options;\n  }\n\n  /**\n   * @returns {Array} Array of loaders. To be consumed as queue\n   */\n  *getLoaders() {\n    const loaders = [];\n    const { studyInstanceUID, filters: { seriesInstanceUID } = {}, client } = this;\n\n    if (seriesInstanceUID) {\n      loaders.push(\n        client.retrieveSeriesMetadata.bind(client, {\n          studyInstanceUID,\n          seriesInstanceUID,\n        })\n      );\n    }\n\n    loaders.push(client.retrieveStudyMetadata.bind(client, { studyInstanceUID }));\n\n    yield* loaders;\n  }\n\n  async load(preLoadData) {\n    const loaders = this.getLoaders();\n    const result = this.runLoaders(loaders);\n    return result;\n  }\n\n  async posLoad(loadData) {\n    return loadData;\n  }\n}\n","import dcmjs from 'dcmjs';\nimport { sortStudySeries } from '@ohif/core/src/utils/sortStudy';\nimport RetrieveMetadataLoader from './retrieveMetadataLoader';\n\n// Series Date, Series Time, Series Description and Series Number to be included\n// in the series metadata query result\nconst includeField = ['00080021', '00080031', '0008103E', '00200011'].join(',');\n\nexport class DeferredPromise {\n  metadata = undefined;\n  processFunction = undefined;\n  internalPromise = undefined;\n  thenFunction = undefined;\n  rejectFunction = undefined;\n\n  setMetadata(metadata) {\n    this.metadata = metadata;\n  }\n  setProcessFunction(func) {\n    this.processFunction = func;\n  }\n  getPromise() {\n    return this.start();\n  }\n  start() {\n    if (this.internalPromise) {\n      return this.internalPromise;\n    }\n    this.internalPromise = this.processFunction();\n    // in case then and reject functions called before start\n    if (this.thenFunction) {\n      this.then(this.thenFunction);\n      this.thenFunction = undefined;\n    }\n    if (this.rejectFunction) {\n      this.reject(this.rejectFunction);\n      this.rejectFunction = undefined;\n    }\n    return this.internalPromise;\n  }\n  then(func) {\n    if (this.internalPromise) {\n      return this.internalPromise.then(func);\n    } else {\n      this.thenFunction = func;\n    }\n  }\n  reject(func) {\n    if (this.internalPromise) {\n      return this.internalPromise.reject(func);\n    } else {\n      this.rejectFunction = func;\n    }\n  }\n}\n/**\n * Creates an immutable series loader object which loads each series sequentially using the iterator interface.\n *\n * @param {DICOMWebClient} dicomWebClient The DICOMWebClient instance to be used for series load\n * @param {string} studyInstanceUID The Study Instance UID from which series will be loaded\n * @param {Array} seriesInstanceUIDList A list of Series Instance UIDs\n *\n * @returns {Object} Returns an object which supports loading of instances from each of given Series Instance UID\n */\nfunction makeSeriesAsyncLoader(client, studyInstanceUID, seriesInstanceUIDList) {\n  return Object.freeze({\n    hasNext() {\n      return seriesInstanceUIDList.length > 0;\n    },\n    next() {\n      const { seriesInstanceUID, metadata } = seriesInstanceUIDList.shift();\n      const promise = new DeferredPromise();\n      promise.setMetadata(metadata);\n      promise.setProcessFunction(() => {\n        return client.retrieveSeriesMetadata({\n          studyInstanceUID,\n          seriesInstanceUID,\n        });\n      });\n      return promise;\n    },\n  });\n}\n\n/**\n * Class for async load of study metadata.\n * It inherits from RetrieveMetadataLoader\n *\n * It loads the one series and then append to seriesLoader the others to be consumed/loaded\n */\nexport default class RetrieveMetadataLoaderAsync extends RetrieveMetadataLoader {\n  /**\n   * @returns {Array} Array of preLoaders. To be consumed as queue\n   */\n  *getPreLoaders() {\n    const preLoaders = [];\n    const { studyInstanceUID, filters: { seriesInstanceUID } = {}, client } = this;\n\n    // asking to include Series Date, Series Time, Series Description\n    // and Series Number in the series metadata returned to better sort series\n    // in preLoad function\n    let options = {\n      studyInstanceUID,\n      queryParams: {\n        includefield: includeField,\n      },\n    };\n\n    if (seriesInstanceUID) {\n      options.queryParams.SeriesInstanceUID = seriesInstanceUID;\n      preLoaders.push(client.searchForSeries.bind(client, options));\n    }\n    // Fallback preloader\n    preLoaders.push(client.searchForSeries.bind(client, options));\n\n    yield* preLoaders;\n  }\n\n  async preLoad() {\n    const preLoaders = this.getPreLoaders();\n    const result = await this.runLoaders(preLoaders);\n    const sortCriteria = this.sortCriteria;\n    const sortFunction = this.sortFunction;\n\n    const { naturalizeDataset } = dcmjs.data.DicomMetaDictionary;\n    const naturalized = result.map(naturalizeDataset);\n\n    return sortStudySeries(naturalized, sortCriteria, sortFunction);\n  }\n\n  async load(preLoadData) {\n    const { client, studyInstanceUID } = this;\n\n    const seriesInstanceUIDs = preLoadData.map(seriesMetadata => {\n      return { seriesInstanceUID: seriesMetadata.SeriesInstanceUID, metadata: seriesMetadata };\n    });\n\n    const seriesAsyncLoader = makeSeriesAsyncLoader(client, studyInstanceUID, seriesInstanceUIDs);\n\n    const promises = [];\n\n    while (seriesAsyncLoader.hasNext()) {\n      const promise = seriesAsyncLoader.next();\n      promises.push(promise);\n    }\n\n    return {\n      preLoadData,\n      promises,\n    };\n  }\n\n  async posLoad({ preLoadData, promises }) {\n    return {\n      preLoadData,\n      promises,\n    };\n  }\n}\n","import RetrieveMetadataLoaderSync from './retrieveMetadataLoaderSync';\nimport RetrieveMetadataLoaderAsync from './retrieveMetadataLoaderAsync';\n\n/**\n * Retrieve Study metadata from a DICOM server. If the server is configured to use lazy load, only the first series\n * will be loaded and the property \"studyLoader\" will be set to let consumer load remaining series as needed.\n *\n * @param {*} dicomWebClient The DICOMWebClient instance to be used for series load\n * @param {*} StudyInstanceUID The UID of the Study to be retrieved\n * @param {*} enableStudyLazyLoad Whether the study metadata should be loaded asynchronously\n * @param {object} filters Object containing filters to be applied on retrieve metadata process\n * @param {string} [filters.seriesInstanceUID] Series instance uid to filter results against\n * @param {array} [filters.SeriesInstanceUIDs] Series instance uids to filter results against\n * @param {function} [sortCriteria] Sort criteria function\n * @param {function} [sortFunction] Sort function\n *\n * @returns {Promise} A promises that resolves the study descriptor object\n */\nasync function RetrieveMetadata(\n  dicomWebClient,\n  StudyInstanceUID,\n  enableStudyLazyLoad,\n  filters = {},\n  sortCriteria,\n  sortFunction\n) {\n  const RetrieveMetadataLoader =\n    enableStudyLazyLoad !== false ? RetrieveMetadataLoaderAsync : RetrieveMetadataLoaderSync;\n\n  const retrieveMetadataLoader = new RetrieveMetadataLoader(\n    dicomWebClient,\n    StudyInstanceUID,\n    filters,\n    sortCriteria,\n    sortFunction\n  );\n  const data = await retrieveMetadataLoader.execLoad();\n\n  return data;\n}\n\nexport default RetrieveMetadata;\n","import RetrieveMetadata from '../wado/retrieveMetadata';\n\n/**\n * Retrieve metadata filtered.\n *\n * @param {*} dicomWebClient The DICOMWebClient instance to be used for series load\n * @param {*} StudyInstanceUID The UID of the Study to be retrieved\n * @param {*} enableStudyLazyLoad Whether the study metadata should be loaded asynchronously\n * @param {object} filters Object containing filters to be applied on retrieve metadata process\n * @param {string} [filters.seriesInstanceUID] Series instance uid to filter results against\n * @param {array} [filters.SeriesInstanceUIDs] Series instance uids to filter results against\n * @param {function} [sortCriteria] Sort criteria function\n * @param {function} [sortFunction] Sort function\n *\n * @returns\n */\nfunction retrieveMetadataFiltered(\n  dicomWebClient,\n  StudyInstanceUID,\n  enableStudyLazyLoad,\n  filters,\n  sortCriteria,\n  sortFunction\n) {\n  const { SeriesInstanceUIDs } = filters;\n\n  return new Promise((resolve, reject) => {\n    const promises = SeriesInstanceUIDs.map(uid => {\n      const seriesSpecificFilters = Object.assign({}, filters, {\n        seriesInstanceUID: uid,\n      });\n\n      return RetrieveMetadata(\n        dicomWebClient,\n        StudyInstanceUID,\n        enableStudyLazyLoad,\n        seriesSpecificFilters,\n        sortCriteria,\n        sortFunction\n      );\n    });\n\n    Promise.all(promises).then(results => {\n      const aggregatedResult = { preLoadData: [], promises: [] };\n\n      results.forEach(({ preLoadData, promises }) => {\n        aggregatedResult.preLoadData = aggregatedResult.preLoadData.concat(preLoadData);\n        aggregatedResult.promises = aggregatedResult.promises.concat(promises);\n      });\n\n      resolve(aggregatedResult);\n    }, reject);\n  });\n}\n\nexport default retrieveMetadataFiltered;\n","import retrieveMetadataFiltered from './utils/retrieveMetadataFiltered.js';\nimport RetrieveMetadata from './wado/retrieveMetadata.js';\n\nconst moduleName = 'RetrieveStudyMetadata';\n// Cache for promises. Prevents unnecessary subsequent calls to the server\nconst StudyMetaDataPromises = new Map();\n\n/**\n * Retrieves study metadata.\n *\n * @param {Object} dicomWebClient The DICOMWebClient instance to be used for series load\n * @param {string} StudyInstanceUID The UID of the Study to be retrieved\n * @param {boolean} enableStudyLazyLoad Whether the study metadata should be loaded asynchronously.\n * @param {Object} [filters] Object containing filters to be applied on retrieve metadata process\n * @param {string} [filters.seriesInstanceUID] Series instance uid to filter results against\n * @param {array} [filters.SeriesInstanceUIDs] Series instance uids to filter results against\n * @param {function} [sortCriteria] Sort criteria function\n * @param {function} [sortFunction] Sort function\n *\n * @returns {Promise} that will be resolved with the metadata or rejected with the error\n */\nexport function retrieveStudyMetadata(\n  dicomWebClient,\n  StudyInstanceUID,\n  enableStudyLazyLoad,\n  filters,\n  sortCriteria,\n  sortFunction,\n  dicomWebConfig = {}\n) {\n  // @TODO: Whenever a study metadata request has failed, its related promise will be rejected once and for all\n  // and further requests for that metadata will always fail. On failure, we probably need to remove the\n  // corresponding promise from the \"StudyMetaDataPromises\" map...\n\n  if (!dicomWebClient) {\n    throw new Error(`${moduleName}: Required 'dicomWebClient' parameter not provided.`);\n  }\n  if (!StudyInstanceUID) {\n    throw new Error(`${moduleName}: Required 'StudyInstanceUID' parameter not provided.`);\n  }\n\n  const promiseId = `${dicomWebConfig.name}:${StudyInstanceUID}`;\n\n  // Already waiting on result? Return cached promise\n  if (StudyMetaDataPromises.has(promiseId)) {\n    return StudyMetaDataPromises.get(promiseId);\n  }\n\n  let promise;\n\n  if (filters && filters.SeriesInstanceUIDs) {\n    promise = retrieveMetadataFiltered(\n      dicomWebClient,\n      StudyInstanceUID,\n      enableStudyLazyLoad,\n      filters,\n      sortCriteria,\n      sortFunction\n    );\n  } else {\n    // Create a promise to handle the data retrieval\n    promise = new Promise((resolve, reject) => {\n      RetrieveMetadata(\n        dicomWebClient,\n        StudyInstanceUID,\n        enableStudyLazyLoad,\n        filters,\n        sortCriteria,\n        sortFunction\n      ).then(function (data) {\n        resolve(data);\n      }, reject);\n    });\n  }\n\n  // Store the promise in cache\n  StudyMetaDataPromises.set(promiseId, promise);\n\n  return promise;\n}\n\n/**\n * Delete the cached study metadata retrieval promise to ensure that the browser will\n * re-retrieve the study metadata when it is next requested.\n *\n * @param {String} StudyInstanceUID The UID of the Study to be removed from cache\n */\nexport function deleteStudyMetadataPromise(StudyInstanceUID) {\n  if (StudyMetaDataPromises.has(StudyInstanceUID)) {\n    StudyMetaDataPromises.delete(StudyInstanceUID);\n  }\n}\n","import { api } from 'dicomweb-client';\n\n/**\n * An implementation of the static wado client, that fetches data from\n * a static response rather than actually doing real queries.  This allows\n * fast encoding of test data, but because it is static, anything actually\n * performing searches doesn't work.  This version fixes the query issue\n * by manually implementing a query option.\n */\n\nexport default class StaticWadoClient extends api.DICOMwebClient {\n  static studyFilterKeys = {\n    studyinstanceuid: '0020000D',\n    patientname: '00100010',\n    '00100020': 'mrn',\n    studydescription: '00081030',\n    studydate: '00080020',\n    modalitiesinstudy: '00080061',\n    accessionnumber: '00080050',\n  };\n\n  static seriesFilterKeys = {\n    seriesinstanceuid: '0020000E',\n    seriesnumber: '00200011',\n    modality: '00080060',\n  };\n\n  constructor(qidoConfig) {\n    super(qidoConfig);\n    this.staticWado = qidoConfig.staticWado;\n  }\n\n  /**\n   * Replace the search for studies remote query with a local version which\n   * retrieves a complete query list and then sub-selects from it locally.\n   * @param {*} options\n   * @returns\n   */\n  async searchForStudies(options) {\n    if (!this.staticWado) {\n      return super.searchForStudies(options);\n    }\n\n    const searchResult = await super.searchForStudies(options);\n    const { queryParams } = options;\n\n    if (!queryParams) {\n      return searchResult;\n    }\n\n    const lowerParams = this.toLowerParams(queryParams);\n    const filtered = searchResult.filter(study => {\n      for (const key of Object.keys(StaticWadoClient.studyFilterKeys)) {\n        if (!this.filterItem(key, lowerParams, study, StaticWadoClient.studyFilterKeys)) {\n          return false;\n        }\n      }\n      return true;\n    });\n    return filtered;\n  }\n\n  async searchForSeries(options) {\n    if (!this.staticWado) {\n      return super.searchForSeries(options);\n    }\n\n    const searchResult = await super.searchForSeries(options);\n    const { queryParams } = options;\n    if (!queryParams) {\n      return searchResult;\n    }\n    const lowerParams = this.toLowerParams(queryParams);\n\n    const filtered = searchResult.filter(series => {\n      for (const key of Object.keys(StaticWadoClient.seriesFilterKeys)) {\n        if (!this.filterItem(key, lowerParams, series, StaticWadoClient.seriesFilterKeys)) {\n          return false;\n        }\n      }\n      return true;\n    });\n\n    return filtered;\n  }\n\n  /**\n   * Compares values, matching any instance of desired to any instance of\n   * actual by recursively go through the paired set of values.  That is,\n   * this is O(m*n) where m is how many items in desired and n is the length of actual\n   * Then, at the individual item node, compares the Alphabetic name if present,\n   * and does a sub-string matching on string values, and otherwise does an\n   * exact match comparison.\n   *\n   * @param {*} desired\n   * @param {*} actual\n   * @returns true if the values match\n   */\n  compareValues(desired, actual) {\n    if (Array.isArray(desired)) {\n      return desired.find(item => this.compareValues(item, actual));\n    }\n    if (Array.isArray(actual)) {\n      return actual.find(actualItem => this.compareValues(desired, actualItem));\n    }\n    if (actual?.Alphabetic) {\n      actual = actual.Alphabetic;\n    }\n    if (typeof actual == 'string') {\n      if (actual.length === 0) {\n        return true;\n      }\n      if (desired.length === 0 || desired === '*') {\n        return true;\n      }\n      if (desired[0] === '*' && desired[desired.length - 1] === '*') {\n        // console.log(`Comparing ${actual} to ${desired.substring(1, desired.length - 1)}`)\n        return actual.indexOf(desired.substring(1, desired.length - 1)) != -1;\n      } else if (desired[desired.length - 1] === '*') {\n        return actual.indexOf(desired.substring(0, desired.length - 1)) != -1;\n      } else if (desired[0] === '*') {\n        return actual.indexOf(desired.substring(1)) === actual.length - desired.length + 1;\n      }\n    }\n    return desired === actual;\n  }\n\n  /** Compares a pair of dates to see if the value is within the range */\n  compareDateRange(range, value) {\n    if (!value) {\n      return true;\n    }\n    const dash = range.indexOf('-');\n    if (dash === -1) {\n      return this.compareValues(range, value);\n    }\n    const start = range.substring(0, dash);\n    const end = range.substring(dash + 1);\n    return (!start || value >= start) && (!end || value <= end);\n  }\n\n  /**\n   * Filters the return list by the query parameters.\n   *\n   * @param anyCaseKey - a possible search key\n   * @param queryParams -\n   * @param {*} study\n   * @param {*} sourceFilterMap\n   * @returns\n   */\n  filterItem(key: string, queryParams, study, sourceFilterMap) {\n    const altKey = sourceFilterMap[key] || key;\n    if (!queryParams) {\n      return true;\n    }\n    const testValue = queryParams[key] || queryParams[altKey];\n    if (!testValue) {\n      return true;\n    }\n    const valueElem = study[key] || study[altKey];\n    if (!valueElem) {\n      return false;\n    }\n    if (valueElem.vr === 'DA' && valueElem.Value?.[0]) {\n      return this.compareDateRange(testValue, valueElem.Value[0]);\n    }\n    const value = valueElem.Value;\n    return this.compareValues(testValue, value);\n  }\n\n  /** Converts the query parameters to lower case query parameters */\n  toLowerParams(queryParams: Record<string, unknown>): Record<string, unknown> {\n    const lowerParams = {};\n    Object.entries(queryParams).forEach(([key, value]) => {\n      lowerParams[key.toLowerCase()] = value;\n    });\n    return lowerParams;\n  }\n}\n","import { utils } from '@ohif/core';\n\n/**\n * Generates a URL that can be used for direct retrieve of the bulkdata\n *\n * @param {object} params\n * @param {string} params.tag is the tag name of the URL to retrieve\n * @param {string} params.defaultPath path for the pixel data url\n * @param {object} params.instance is the instance object that the tag is in\n * @param {string} params.defaultType is the mime type of the response\n * @param {string} params.singlepart is the type of the part to retrieve\n * @param {string} params.fetchPart unknown?\n * @returns an absolute URL to the resource, if the absolute URL can be retrieved as singlepart,\n *    or is already retrieved, or a promise to a URL for such use if a BulkDataURI\n */\nconst getDirectURL = (config, params) => {\n  const { wadoRoot, singlepart } = config;\n  const {\n    instance,\n    tag = 'PixelData',\n    defaultPath = '/pixeldata',\n    defaultType = 'video/mp4',\n    singlepart: fetchPart = 'video',\n  } = params;\n  const value = instance[tag];\n  if (!value) {\n    return undefined;\n  }\n\n  if (value.DirectRetrieveURL) {\n    return value.DirectRetrieveURL;\n  }\n  if (value.InlineBinary) {\n    const blob = utils.b64toBlob(value.InlineBinary, defaultType);\n    value.DirectRetrieveURL = URL.createObjectURL(blob);\n    return value.DirectRetrieveURL;\n  }\n  if (!singlepart || (singlepart !== true && singlepart.indexOf(fetchPart) === -1)) {\n    if (value.retrieveBulkData) {\n      // Try the specified retrieve type.\n      const options = {\n        mediaType: defaultType,\n      };\n      return value.retrieveBulkData(options).then(arr => {\n        value.DirectRetrieveURL = URL.createObjectURL(new Blob([arr], { type: defaultType }));\n        return value.DirectRetrieveURL;\n      });\n    }\n    console.warn('Unable to retrieve', tag, 'from', instance);\n    return undefined;\n  }\n\n  const { StudyInstanceUID, SeriesInstanceUID, SOPInstanceUID } = instance;\n  const BulkDataURI =\n    (value && value.BulkDataURI) ||\n    `series/${SeriesInstanceUID}/instances/${SOPInstanceUID}${defaultPath}`;\n  const hasQuery = BulkDataURI.indexOf('?') !== -1;\n  const hasAccept = BulkDataURI.indexOf('accept=') !== -1;\n  const acceptUri =\n    BulkDataURI + (hasAccept ? '' : (hasQuery ? '&' : '?') + `accept=${defaultType}`);\n\n  if (tag === 'PixelData' || tag === 'EncapsulatedDocument') {\n    return `${wadoRoot}/studies/${StudyInstanceUID}/series/${SeriesInstanceUID}/instances/${SOPInstanceUID}/rendered`;\n  }\n\n  // The DICOMweb standard states that the default is multipart related, and then\n  // separately states that the accept parameter is the URL parameter equivalent of the accept header.\n  return acceptUri;\n};\n\nexport default getDirectURL;\n","/**\n * Modifies a bulkDataURI to ensure it is absolute based on the DICOMWeb configuration and\n * instance data. The modification is in-place.\n *\n * If the bulkDataURI is relative to the series or study (according to the DICOM standard),\n * it is made absolute by prepending the relevant paths.\n *\n * In scenarios where the bulkDataURI is a server-relative path (starting with '/'), the function\n * handles two cases:\n *\n * 1. If the wado root is absolute (starts with 'http'), it prepends the wado root to the bulkDataURI.\n * 2. If the wado root is relative, no changes are needed as the bulkDataURI is already correctly relative to the server root.\n *\n * @param value - The object containing BulkDataURI to be fixed.\n * @param instance - The object (DICOM instance data) containing StudyInstanceUID and SeriesInstanceUID.\n * @param dicomWebConfig - The DICOMWeb configuration object, containing wadoRoot and potentially bulkDataURI.relativeResolution.\n * @returns The function modifies `value` in-place, it does not return a value.\n */\nfunction fixBulkDataURI(value, instance, dicomWebConfig) {\n  // in case of the relative path, make it absolute. The current DICOM standard says\n  // the bulkdataURI is relative to the series. However, there are situations where\n  // it can be relative to the study too\n  if (!value.BulkDataURI.startsWith('http') && !value.BulkDataURI.startsWith('/')) {\n    if (dicomWebConfig.bulkDataURI?.relativeResolution === 'studies') {\n      value.BulkDataURI = `${dicomWebConfig.wadoRoot}/studies/${instance.StudyInstanceUID}/${value.BulkDataURI}`;\n    } else if (\n      dicomWebConfig.bulkDataURI?.relativeResolution === 'series' ||\n      !dicomWebConfig.bulkDataURI?.relativeResolution\n    ) {\n      value.BulkDataURI = `${dicomWebConfig.wadoRoot}/studies/${instance.StudyInstanceUID}/series/${instance.SeriesInstanceUID}/${value.BulkDataURI}`;\n    }\n\n    return;\n  }\n\n  // in case it is relative path but starts at the server (e.g., /bulk/1e, note the missing http\n  // in the beginning and the first character is /) There are two scenarios, whether the wado root\n  // is absolute or relative. In case of absolute, we need to prepend the wado root to the bulkdata\n  // uri (e.g., bulkData: /bulk/1e, wado root: http://myserver.com/dicomweb, output: http://myserver.com/bulk/1e)\n  // and in case of relative wado root, we need to prepend the bulkdata uri to the wado root (e.g,. bulkData: /bulk/1e\n  // wado root: /dicomweb, output: /bulk/1e)\n  if (value.BulkDataURI[0] === '/') {\n    if (dicomWebConfig.wadoRoot.startsWith('http')) {\n      // Absolute wado root\n      const url = new URL(dicomWebConfig.wadoRoot);\n      value.BulkDataURI = `${url.origin}${value.BulkDataURI}`;\n    } else {\n      // Relative wado root, we don't need to do anything, bulkdata uri is already correct\n    }\n  }\n}\n\nexport { fixBulkDataURI };\n","import { api } from 'dicomweb-client';\nimport { DicomMetadataStore, IWebApiDataSource, utils, errorHandler, classes } from '@ohif/core';\n\nimport {\n  mapParams,\n  search as qidoSearch,\n  seriesInStudy,\n  processResults,\n  processSeriesResults,\n} from './qido.js';\nimport dcm4cheeReject from './dcm4cheeReject';\n\nimport getImageId from './utils/getImageId';\nimport dcmjs from 'dcmjs';\nimport { retrieveStudyMetadata, deleteStudyMetadataPromise } from './retrieveStudyMetadata.js';\nimport StaticWadoClient from './utils/StaticWadoClient';\nimport getDirectURL from '../utils/getDirectURL';\nimport { fixBulkDataURI } from './utils/fixBulkDataURI';\n\nconst { DicomMetaDictionary, DicomDict } = dcmjs.data;\n\nconst { naturalizeDataset, denaturalizeDataset } = DicomMetaDictionary;\n\nconst ImplementationClassUID = '2.25.270695996825855179949881587723571202391.2.0.0';\nconst ImplementationVersionName = 'OHIF-VIEWER-2.0.0';\nconst EXPLICIT_VR_LITTLE_ENDIAN = '1.2.840.10008.1.2.1';\n\nconst metadataProvider = classes.MetadataProvider;\n\n/**\n * Creates a DICOM Web API based on the provided configuration.\n *\n * @param {object} dicomWebConfig - Configuration for the DICOM Web API\n * @param {string} dicomWebConfig.name - Data source name\n * @param {string} dicomWebConfig.wadoUriRoot - Legacy? (potentially unused/replaced)\n * @param {string} dicomWebConfig.qidoRoot - Base URL to use for QIDO requests\n * @param {string} dicomWebConfig.wadoRoot - Base URL to use for WADO requests\n * @param {string} dicomWebConfig.wadoUri - Base URL to use for WADO URI requests\n * @param {boolean} dicomWebConfig.qidoSupportsIncludeField - Whether QIDO supports the \"Include\" option to request additional fields in response\n * @param {string} dicomWebConfig.imageRendering - wadors | ? (unsure of where/how this is used)\n * @param {string} dicomWebConfig.thumbnailRendering - wadors | ? (unsure of where/how this is used)\n * @param {boolean} dicomWebConfig.supportsReject - Whether the server supports reject calls (i.e. DCM4CHEE)\n * @param {boolean} dicomWebConfig.lazyLoadStudy - \"enableStudyLazyLoad\"; Request series meta async instead of blocking\n * @param {string|boolean} dicomWebConfig.singlepart - indicates if the retrieves can fetch singlepart. Options are bulkdata, video, image, or boolean true\n * @param {string} dicomWebConfig.requestTransferSyntaxUID - Transfer syntax to request from the server\n * @param {object} dicomWebConfig.acceptHeader - Accept header to use for requests\n * @param {boolean} dicomWebConfig.omitQuotationForMultipartRequest - Whether to omit quotation marks for multipart requests\n * @param {boolean} dicomWebConfig.supportsFuzzyMatching - Whether the server supports fuzzy matching\n * @param {boolean} dicomWebConfig.supportsWildcard - Whether the server supports wildcard matching\n * @param {boolean} dicomWebConfig.supportsNativeDICOMModel - Whether the server supports the native DICOM model\n * @param {boolean} dicomWebConfig.enableStudyLazyLoad - Whether to enable study lazy loading\n * @param {boolean} dicomWebConfig.enableRequestTag - Whether to enable request tag\n * @param {boolean} dicomWebConfig.enableStudyLazyLoad - Whether to enable study lazy loading\n * @param {boolean} dicomWebConfig.bulkDataURI - Whether to enable bulkDataURI\n * @param {function} dicomWebConfig.onConfiguration - Function that is called after the configuration is initialized\n * @param {boolean} dicomWebConfig.staticWado - Whether to use the static WADO client\n * @param {object} userAuthenticationService - User authentication service\n * @param {object} userAuthenticationService.getAuthorizationHeader - Function that returns the authorization header\n * @returns {object} - DICOM Web API object\n */\nfunction createDicomWebApi(dicomWebConfig, servicesManager) {\n  const { userAuthenticationService, customizationService } = servicesManager.services;\n  let dicomWebConfigCopy,\n    qidoConfig,\n    wadoConfig,\n    qidoDicomWebClient,\n    wadoDicomWebClient,\n    getAuthrorizationHeader,\n    generateWadoHeader;\n\n  const implementation = {\n    initialize: ({ params, query }) => {\n      if (dicomWebConfig.onConfiguration && typeof dicomWebConfig.onConfiguration === 'function') {\n        dicomWebConfig = dicomWebConfig.onConfiguration(dicomWebConfig, {\n          params,\n          query,\n        });\n      }\n\n      dicomWebConfigCopy = JSON.parse(JSON.stringify(dicomWebConfig));\n\n      getAuthrorizationHeader = () => {\n        const xhrRequestHeaders = {};\n        const authHeaders = userAuthenticationService.getAuthorizationHeader();\n        if (authHeaders && authHeaders.Authorization) {\n          xhrRequestHeaders.Authorization = authHeaders.Authorization;\n        }\n        return xhrRequestHeaders;\n      };\n\n      generateWadoHeader = () => {\n        let authorizationHeader = getAuthrorizationHeader();\n        //Generate accept header depending on config params\n        let formattedAcceptHeader = utils.generateAcceptHeader(\n          dicomWebConfig.acceptHeader,\n          dicomWebConfig.requestTransferSyntaxUID,\n          dicomWebConfig.omitQuotationForMultipartRequest\n        );\n\n        return {\n          ...authorizationHeader,\n          Accept: formattedAcceptHeader,\n        };\n      };\n\n      qidoConfig = {\n        url: dicomWebConfig.qidoRoot,\n        staticWado: dicomWebConfig.staticWado,\n        singlepart: dicomWebConfig.singlepart,\n        headers: userAuthenticationService.getAuthorizationHeader(),\n        errorInterceptor: errorHandler.getHTTPErrorHandler(),\n      };\n\n      wadoConfig = {\n        url: dicomWebConfig.wadoRoot,\n        staticWado: dicomWebConfig.staticWado,\n        singlepart: dicomWebConfig.singlepart,\n        headers: userAuthenticationService.getAuthorizationHeader(),\n        errorInterceptor: errorHandler.getHTTPErrorHandler(),\n      };\n\n      // TODO -> Two clients sucks, but its better than 1000.\n      // TODO -> We'll need to merge auth later.\n      qidoDicomWebClient = dicomWebConfig.staticWado\n        ? new StaticWadoClient(qidoConfig)\n        : new api.DICOMwebClient(qidoConfig);\n\n      wadoDicomWebClient = dicomWebConfig.staticWado\n        ? new StaticWadoClient(wadoConfig)\n        : new api.DICOMwebClient(wadoConfig);\n    },\n    query: {\n      studies: {\n        mapParams: mapParams.bind(),\n        search: async function (origParams) {\n          qidoDicomWebClient.headers = getAuthrorizationHeader();\n          const { studyInstanceUid, seriesInstanceUid, ...mappedParams } =\n            mapParams(origParams, {\n              supportsFuzzyMatching: dicomWebConfig.supportsFuzzyMatching,\n              supportsWildcard: dicomWebConfig.supportsWildcard,\n            }) || {};\n\n          const results = await qidoSearch(qidoDicomWebClient, undefined, undefined, mappedParams);\n\n          return processResults(results);\n        },\n        processResults: processResults.bind(),\n      },\n      series: {\n        // mapParams: mapParams.bind(),\n        search: async function (studyInstanceUid) {\n          qidoDicomWebClient.headers = getAuthrorizationHeader();\n          const results = await seriesInStudy(qidoDicomWebClient, studyInstanceUid);\n\n          return processSeriesResults(results);\n        },\n        // processResults: processResults.bind(),\n      },\n      instances: {\n        search: (studyInstanceUid, queryParameters) => {\n          qidoDicomWebClient.headers = getAuthrorizationHeader();\n          return qidoSearch.call(\n            undefined,\n            qidoDicomWebClient,\n            studyInstanceUid,\n            null,\n            queryParameters\n          );\n        },\n      },\n    },\n    retrieve: {\n      /**\n       * Generates a URL that can be used for direct retrieve of the bulkdata\n       *\n       * @param {object} params\n       * @param {string} params.tag is the tag name of the URL to retrieve\n       * @param {object} params.instance is the instance object that the tag is in\n       * @param {string} params.defaultType is the mime type of the response\n       * @param {string} params.singlepart is the type of the part to retrieve\n       * @returns an absolute URL to the resource, if the absolute URL can be retrieved as singlepart,\n       *    or is already retrieved, or a promise to a URL for such use if a BulkDataURI\n       */\n      directURL: params => {\n        return getDirectURL(\n          {\n            wadoRoot: dicomWebConfig.wadoRoot,\n            singlepart: dicomWebConfig.singlepart,\n          },\n          params\n        );\n      },\n      bulkDataURI: async ({ StudyInstanceUID, BulkDataURI }) => {\n        qidoDicomWebClient.headers = getAuthrorizationHeader();\n        const options = {\n          multipart: false,\n          BulkDataURI,\n          StudyInstanceUID,\n        };\n        return qidoDicomWebClient.retrieveBulkData(options).then(val => {\n          const ret = (val && val[0]) || undefined;\n          return ret;\n        });\n      },\n      series: {\n        metadata: async ({\n          StudyInstanceUID,\n          filters,\n          sortCriteria,\n          sortFunction,\n          madeInClient = false,\n          returnPromises = false,\n        } = {}) => {\n          if (!StudyInstanceUID) {\n            throw new Error('Unable to query for SeriesMetadata without StudyInstanceUID');\n          }\n\n          if (dicomWebConfig.enableStudyLazyLoad) {\n            return implementation._retrieveSeriesMetadataAsync(\n              StudyInstanceUID,\n              filters,\n              sortCriteria,\n              sortFunction,\n              madeInClient,\n              returnPromises\n            );\n          }\n\n          return implementation._retrieveSeriesMetadataSync(\n            StudyInstanceUID,\n            filters,\n            sortCriteria,\n            sortFunction,\n            madeInClient\n          );\n        },\n      },\n    },\n\n    store: {\n      dicom: async (dataset, request, dicomDict) => {\n        wadoDicomWebClient.headers = getAuthrorizationHeader();\n        if (dataset instanceof ArrayBuffer) {\n          const options = {\n            datasets: [dataset],\n            request,\n          };\n          await wadoDicomWebClient.storeInstances(options);\n        } else {\n          let effectiveDicomDict = dicomDict;\n\n          if (!dicomDict) {\n            const meta = {\n              FileMetaInformationVersion: dataset._meta?.FileMetaInformationVersion?.Value,\n              MediaStorageSOPClassUID: dataset.SOPClassUID,\n              MediaStorageSOPInstanceUID: dataset.SOPInstanceUID,\n              TransferSyntaxUID: EXPLICIT_VR_LITTLE_ENDIAN,\n              ImplementationClassUID,\n              ImplementationVersionName,\n            };\n\n            const denaturalized = denaturalizeDataset(meta);\n            const defaultDicomDict = new DicomDict(denaturalized);\n            defaultDicomDict.dict = denaturalizeDataset(dataset);\n\n            effectiveDicomDict = defaultDicomDict;\n          }\n\n          const part10Buffer = effectiveDicomDict.write();\n\n          const options = {\n            datasets: [part10Buffer],\n            request,\n          };\n\n          await wadoDicomWebClient.storeInstances(options);\n        }\n      },\n    },\n\n    _retrieveSeriesMetadataSync: async (\n      StudyInstanceUID,\n      filters,\n      sortCriteria,\n      sortFunction,\n      madeInClient\n    ) => {\n      const enableStudyLazyLoad = false;\n      wadoDicomWebClient.headers = generateWadoHeader();\n      // data is all SOPInstanceUIDs\n      const data = await retrieveStudyMetadata(\n        wadoDicomWebClient,\n        StudyInstanceUID,\n        enableStudyLazyLoad,\n        filters,\n        sortCriteria,\n        sortFunction,\n        dicomWebConfig\n      );\n\n      // first naturalize the data\n      const naturalizedInstancesMetadata = data.map(naturalizeDataset);\n\n      const seriesSummaryMetadata = {};\n      const instancesPerSeries = {};\n\n      naturalizedInstancesMetadata.forEach(instance => {\n        if (!seriesSummaryMetadata[instance.SeriesInstanceUID]) {\n          seriesSummaryMetadata[instance.SeriesInstanceUID] = {\n            StudyInstanceUID: instance.StudyInstanceUID,\n            StudyDescription: instance.StudyDescription,\n            SeriesInstanceUID: instance.SeriesInstanceUID,\n            SeriesDescription: instance.SeriesDescription,\n            SeriesNumber: instance.SeriesNumber,\n            SeriesTime: instance.SeriesTime,\n            SOPClassUID: instance.SOPClassUID,\n            ProtocolName: instance.ProtocolName,\n            Modality: instance.Modality,\n          };\n        }\n\n        if (!instancesPerSeries[instance.SeriesInstanceUID]) {\n          instancesPerSeries[instance.SeriesInstanceUID] = [];\n        }\n\n        const imageId = implementation.getImageIdsForInstance({\n          instance,\n        });\n\n        instance.imageId = imageId;\n        instance.wadoRoot = dicomWebConfig.wadoRoot;\n        instance.wadoUri = dicomWebConfig.wadoUri;\n\n        metadataProvider.addImageIdToUIDs(imageId, {\n          StudyInstanceUID,\n          SeriesInstanceUID: instance.SeriesInstanceUID,\n          SOPInstanceUID: instance.SOPInstanceUID,\n        });\n\n        instancesPerSeries[instance.SeriesInstanceUID].push(instance);\n      });\n\n      // grab all the series metadata\n      const seriesMetadata = Object.values(seriesSummaryMetadata);\n      DicomMetadataStore.addSeriesMetadata(seriesMetadata, madeInClient);\n\n      Object.keys(instancesPerSeries).forEach(seriesInstanceUID =>\n        DicomMetadataStore.addInstances(instancesPerSeries[seriesInstanceUID], madeInClient)\n      );\n\n      return seriesSummaryMetadata;\n    },\n\n    _retrieveSeriesMetadataAsync: async (\n      StudyInstanceUID,\n      filters,\n      sortCriteria,\n      sortFunction,\n      madeInClient = false,\n      returnPromises = false\n    ) => {\n      const enableStudyLazyLoad = true;\n      wadoDicomWebClient.headers = generateWadoHeader();\n      // Get Series\n      const { preLoadData: seriesSummaryMetadata, promises: seriesPromises } =\n        await retrieveStudyMetadata(\n          wadoDicomWebClient,\n          StudyInstanceUID,\n          enableStudyLazyLoad,\n          filters,\n          sortCriteria,\n          sortFunction,\n          dicomWebConfig\n        );\n\n      /**\n       * naturalizes the dataset, and adds a retrieve bulkdata method\n       * to any values containing BulkDataURI.\n       * @param {*} instance\n       * @returns naturalized dataset, with retrieveBulkData methods\n       */\n      const addRetrieveBulkData = instance => {\n        const naturalized = naturalizeDataset(instance);\n\n        // if we know the server doesn't use bulkDataURI, then don't\n        if (!dicomWebConfig.bulkDataURI?.enabled) {\n          return naturalized;\n        }\n\n        Object.keys(naturalized).forEach(key => {\n          const value = naturalized[key];\n\n          // The value.Value will be set with the bulkdata read value\n          // in which case it isn't necessary to re-read this.\n          if (value && value.BulkDataURI && !value.Value) {\n            // Provide a method to fetch bulkdata\n            value.retrieveBulkData = (options = {}) => {\n              // handle the scenarios where bulkDataURI is relative path\n              fixBulkDataURI(value, naturalized, dicomWebConfig);\n\n              const { mediaType } = options;\n              const useOptions = {\n                // The bulkdata fetches work with either multipart or\n                // singlepart, so set multipart to false to let the server\n                // decide which type to respond with.\n                multipart: false,\n                BulkDataURI: value.BulkDataURI,\n                // The study instance UID is required if the bulkdata uri\n                // is relative - that isn't disallowed by DICOMweb, but\n                // isn't well specified in the standard, but is needed in\n                // any implementation that stores static copies of the metadata\n                StudyInstanceUID: naturalized.StudyInstanceUID,\n                mediaTypes: mediaType\n                  ? [{ mediaType }, { mediaType: 'application/octet-stream' }]\n                  : undefined,\n                ...options,\n              };\n              // Todo: this needs to be from wado dicom web client\n              return qidoDicomWebClient.retrieveBulkData(useOptions).then(val => {\n                // There are DICOM PDF cases where the first ArrayBuffer in the array is\n                // the bulk data and DICOM video cases where the second ArrayBuffer is\n                // the bulk data. Here we play it safe and do a find.\n                const ret =\n                  (val instanceof Array && val.find(arrayBuffer => arrayBuffer?.byteLength)) ||\n                  undefined;\n                value.Value = ret;\n                return ret;\n              });\n            };\n          }\n        });\n        return naturalized;\n      };\n\n      // Async load series, store as retrieved\n      function storeInstances(instances) {\n        const naturalizedInstances = instances.map(addRetrieveBulkData);\n\n        // Adding instanceMetadata to OHIF MetadataProvider\n        naturalizedInstances.forEach(instance => {\n          instance.wadoRoot = dicomWebConfig.wadoRoot;\n          instance.wadoUri = dicomWebConfig.wadoUri;\n\n          const imageId = implementation.getImageIdsForInstance({\n            instance,\n          });\n\n          // Adding imageId to each instance\n          // Todo: This is not the best way I can think of to let external\n          // metadata handlers know about the imageId that is stored in the store\n          instance.imageId = imageId;\n\n          // Adding UIDs to metadataProvider\n          // Note: storing imageURI in metadataProvider since stack viewports\n          // will use the same imageURI\n          metadataProvider.addImageIdToUIDs(imageId, {\n            StudyInstanceUID,\n            SeriesInstanceUID: instance.SeriesInstanceUID,\n            SOPInstanceUID: instance.SOPInstanceUID,\n          });\n        });\n\n        DicomMetadataStore.addInstances(naturalizedInstances, madeInClient);\n      }\n\n      function setSuccessFlag() {\n        const study = DicomMetadataStore.getStudy(StudyInstanceUID);\n        if (!study) {\n          return;\n        }\n        study.isLoaded = true;\n      }\n\n      // Google Cloud Healthcare doesn't return StudyInstanceUID, so we need to add\n      // it manually here\n      seriesSummaryMetadata.forEach(aSeries => {\n        aSeries.StudyInstanceUID = StudyInstanceUID;\n      });\n\n      DicomMetadataStore.addSeriesMetadata(seriesSummaryMetadata, madeInClient);\n\n      const seriesDeliveredPromises = seriesPromises.map(promise => {\n        if (!returnPromises) {\n          promise?.start();\n        }\n        return promise.then(instances => {\n          storeInstances(instances);\n        });\n      });\n\n      if (returnPromises) {\n        Promise.all(seriesDeliveredPromises).then(() => setSuccessFlag());\n        return seriesPromises;\n      } else {\n        await Promise.all(seriesDeliveredPromises);\n        setSuccessFlag();\n      }\n\n      return seriesSummaryMetadata;\n    },\n    deleteStudyMetadataPromise,\n    getImageIdsForDisplaySet(displaySet) {\n      const images = displaySet.images;\n      const imageIds = [];\n\n      if (!images) {\n        return imageIds;\n      }\n\n      displaySet.images.forEach(instance => {\n        const NumberOfFrames = instance.NumberOfFrames;\n\n        if (NumberOfFrames > 1) {\n          for (let frame = 1; frame <= NumberOfFrames; frame++) {\n            const imageId = this.getImageIdsForInstance({\n              instance,\n              frame,\n            });\n            imageIds.push(imageId);\n          }\n        } else {\n          const imageId = this.getImageIdsForInstance({ instance });\n          imageIds.push(imageId);\n        }\n      });\n\n      return imageIds;\n    },\n    getImageIdsForInstance({ instance, frame = undefined }) {\n      const imageIds = getImageId({\n        instance,\n        frame,\n        config: dicomWebConfig,\n      });\n      return imageIds;\n    },\n    getConfig() {\n      return dicomWebConfigCopy;\n    },\n    getStudyInstanceUIDs({ params, query }) {\n      const { StudyInstanceUIDs: paramsStudyInstanceUIDs } = params;\n      const queryStudyInstanceUIDs = utils.splitComma(query.getAll('StudyInstanceUIDs'));\n\n      const StudyInstanceUIDs =\n        (queryStudyInstanceUIDs.length && queryStudyInstanceUIDs) || paramsStudyInstanceUIDs;\n      const StudyInstanceUIDsAsArray =\n        StudyInstanceUIDs && Array.isArray(StudyInstanceUIDs)\n          ? StudyInstanceUIDs\n          : [StudyInstanceUIDs];\n\n      return StudyInstanceUIDsAsArray;\n    },\n  };\n\n  if (dicomWebConfig.supportsReject) {\n    implementation.reject = dcm4cheeReject(dicomWebConfig.wadoRoot);\n  }\n\n  return IWebApiDataSource.create(implementation);\n}\n\nexport { createDicomWebApi };\n","export default function (wadoRoot) {\n  return {\n    series: (StudyInstanceUID, SeriesInstanceUID) => {\n      return new Promise((resolve, reject) => {\n        // Reject because of Quality. (Seems the most sensible out of the options)\n        const CodeValueAndCodeSchemeDesignator = `113001%5EDCM`;\n\n        const url = `${wadoRoot}/studies/${StudyInstanceUID}/series/${SeriesInstanceUID}/reject/${CodeValueAndCodeSchemeDesignator}`;\n\n        const xhr = new XMLHttpRequest();\n        xhr.open('POST', url, true);\n\n        //Send the proper header information along with the request\n        // TODO -> Auth when we re-add authorization.\n\n        console.log(xhr);\n\n        xhr.onreadystatechange = function () {\n          //Call a function when the state changes.\n          if (xhr.readyState == 4) {\n            switch (xhr.status) {\n              case 204:\n                resolve(xhr.responseText);\n\n                break;\n              case 404:\n                reject('Your dataSource does not support reject functionality');\n            }\n          }\n        };\n        xhr.send();\n      });\n    },\n  };\n}\n","import { DicomMetadataStore, IWebApiDataSource } from '@ohif/core';\nimport OHIF from '@ohif/core';\n\nimport getImageId from '../DicomWebDataSource/utils/getImageId';\nimport getDirectURL from '../utils/getDirectURL';\n\nconst metadataProvider = OHIF.classes.MetadataProvider;\n\nconst mappings = {\n  studyInstanceUid: 'StudyInstanceUID',\n  patientId: 'PatientID',\n};\n\nlet _store = {\n  urls: [],\n  studyInstanceUIDMap: new Map(), // map of urls to array of study instance UIDs\n  // {\n  //   url: url1\n  //   studies: [Study1, Study2], // if multiple studies\n  // }\n  // {\n  //   url: url2\n  //   studies: [Study1],\n  // }\n  // }\n};\n\nfunction wrapSequences(obj) {\n  return Object.keys(obj).reduce(\n    (acc, key) => {\n      if (typeof obj[key] === 'object' && obj[key] !== null) {\n        // Recursively wrap sequences for nested objects\n        acc[key] = wrapSequences(obj[key]);\n      } else {\n        acc[key] = obj[key];\n      }\n      if (key.endsWith('Sequence')) {\n        acc[key] = OHIF.utils.addAccessors(acc[key]);\n      }\n      return acc;\n    },\n    Array.isArray(obj) ? [] : {}\n  );\n}\nconst getMetaDataByURL = url => {\n  return _store.urls.find(metaData => metaData.url === url);\n};\n\nconst findStudies = (key, value) => {\n  let studies = [];\n  _store.urls.map(metaData => {\n    metaData.studies.map(aStudy => {\n      if (aStudy[key] === value) {\n        studies.push(aStudy);\n      }\n    });\n  });\n  return studies;\n};\n\nfunction createDicomJSONApi(dicomJsonConfig) {\n  const { wadoRoot } = dicomJsonConfig;\n\n  const implementation = {\n    initialize: async ({ query, url }) => {\n      if (!url) {\n        url = query.get('url');\n      }\n      let metaData = getMetaDataByURL(url);\n\n      // if we have already cached the data from this specific url\n      // We are only handling one StudyInstanceUID to run; however,\n      // all studies for patientID will be put in the correct tab\n      if (metaData) {\n        return metaData.studies.map(aStudy => {\n          return aStudy.StudyInstanceUID;\n        });\n      }\n\n      const response = await fetch(url);\n      const data = await response.json();\n\n      let StudyInstanceUID;\n      let SeriesInstanceUID;\n      data.studies.forEach(study => {\n        StudyInstanceUID = study.StudyInstanceUID;\n\n        study.series.forEach(series => {\n          SeriesInstanceUID = series.SeriesInstanceUID;\n\n          series.instances.forEach(instance => {\n            const { url: imageId, metadata: naturalizedDicom } = instance;\n\n            // Add imageId specific mapping to this data as the URL isn't necessarliy WADO-URI.\n            metadataProvider.addImageIdToUIDs(imageId, {\n              StudyInstanceUID,\n              SeriesInstanceUID,\n              SOPInstanceUID: naturalizedDicom.SOPInstanceUID,\n            });\n          });\n        });\n      });\n\n      _store.urls.push({\n        url,\n        studies: [...data.studies],\n      });\n      _store.studyInstanceUIDMap.set(\n        url,\n        data.studies.map(study => study.StudyInstanceUID)\n      );\n    },\n    query: {\n      studies: {\n        mapParams: () => {},\n        search: async param => {\n          const [key, value] = Object.entries(param)[0];\n          const mappedParam = mappings[key];\n\n          // todo: should fetch from dicomMetadataStore\n          const studies = findStudies(mappedParam, value);\n\n          return studies.map(aStudy => {\n            return {\n              accession: aStudy.AccessionNumber,\n              date: aStudy.StudyDate,\n              description: aStudy.StudyDescription,\n              instances: aStudy.NumInstances,\n              modalities: aStudy.Modalities,\n              mrn: aStudy.PatientID,\n              patientName: aStudy.PatientName,\n              studyInstanceUid: aStudy.StudyInstanceUID,\n              NumInstances: aStudy.NumInstances,\n              time: aStudy.StudyTime,\n            };\n          });\n        },\n        processResults: () => {\n          console.warn(' DICOMJson QUERY processResults not implemented');\n        },\n      },\n      series: {\n        // mapParams: mapParams.bind(),\n        search: () => {\n          console.warn(' DICOMJson QUERY SERIES SEARCH not implemented');\n        },\n      },\n      instances: {\n        search: () => {\n          console.warn(' DICOMJson QUERY instances SEARCH not implemented');\n        },\n      },\n    },\n    retrieve: {\n      /**\n       * Generates a URL that can be used for direct retrieve of the bulkdata\n       *\n       * @param {object} params\n       * @param {string} params.tag is the tag name of the URL to retrieve\n       * @param {string} params.defaultPath path for the pixel data url\n       * @param {object} params.instance is the instance object that the tag is in\n       * @param {string} params.defaultType is the mime type of the response\n       * @param {string} params.singlepart is the type of the part to retrieve\n       * @param {string} params.fetchPart unknown?\n       * @returns an absolute URL to the resource, if the absolute URL can be retrieved as singlepart,\n       *    or is already retrieved, or a promise to a URL for such use if a BulkDataURI\n       */\n      directURL: params => {\n        return getDirectURL(wadoRoot, params);\n      },\n      series: {\n        metadata: async ({ StudyInstanceUID, madeInClient = false, customSort } = {}) => {\n          if (!StudyInstanceUID) {\n            throw new Error('Unable to query for SeriesMetadata without StudyInstanceUID');\n          }\n\n          const study = findStudies('StudyInstanceUID', StudyInstanceUID)[0];\n          let series;\n\n          if (customSort) {\n            series = customSort(study.series);\n          } else {\n            series = study.series;\n          }\n\n          const seriesSummaryMetadata = series.map(series => {\n            const seriesSummary = {\n              StudyInstanceUID: study.StudyInstanceUID,\n              ...series,\n            };\n            delete seriesSummary.instances;\n            return seriesSummary;\n          });\n\n          // Async load series, store as retrieved\n          function storeInstances(naturalizedInstances) {\n            DicomMetadataStore.addInstances(naturalizedInstances, madeInClient);\n          }\n\n          DicomMetadataStore.addSeriesMetadata(seriesSummaryMetadata, madeInClient);\n\n          function setSuccessFlag() {\n            const study = DicomMetadataStore.getStudy(StudyInstanceUID, madeInClient);\n            study.isLoaded = true;\n          }\n\n          const numberOfSeries = series.length;\n          series.forEach((series, index) => {\n            const instances = series.instances.map(instance => {\n              // for instance.metadata if the key ends with sequence then\n              // we need to add a proxy to the first item in the sequence\n              // so that we can access the value of the sequence\n              // by using sequenceName.value\n              const modifiedMetadata = wrapSequences(instance.metadata);\n\n              const obj = {\n                ...modifiedMetadata,\n                url: instance.url,\n                imageId: instance.url,\n                ...series,\n                ...study,\n              };\n              delete obj.instances;\n              delete obj.series;\n              return obj;\n            });\n            storeInstances(instances);\n            if (index === numberOfSeries - 1) {\n              setSuccessFlag();\n            }\n          });\n        },\n      },\n    },\n    store: {\n      dicom: () => {\n        console.warn(' DICOMJson store dicom not implemented');\n      },\n    },\n    getImageIdsForDisplaySet(displaySet) {\n      const images = displaySet.images;\n      const imageIds = [];\n\n      if (!images) {\n        return imageIds;\n      }\n\n      displaySet.images.forEach(instance => {\n        const NumberOfFrames = instance.NumberOfFrames;\n\n        if (NumberOfFrames > 1) {\n          for (let i = 0; i < NumberOfFrames; i++) {\n            const imageId = getImageId({\n              instance,\n              frame: i,\n              config: dicomJsonConfig,\n            });\n            imageIds.push(imageId);\n          }\n        } else {\n          const imageId = getImageId({ instance, config: dicomJsonConfig });\n          imageIds.push(imageId);\n        }\n      });\n\n      return imageIds;\n    },\n    getImageIdsForInstance({ instance, frame }) {\n      const imageIds = getImageId({ instance, frame });\n      return imageIds;\n    },\n    getStudyInstanceUIDs: ({ params, query }) => {\n      const url = query.get('url');\n      return _store.studyInstanceUIDMap.get(url);\n    },\n  };\n  return IWebApiDataSource.create(implementation);\n}\n\nexport { createDicomJSONApi };\n","import { DicomMetadataStore, IWebApiDataSource, utils } from '@ohif/core';\nimport OHIF from '@ohif/core';\nimport dcmjs from 'dcmjs';\n\nconst metadataProvider = OHIF.classes.MetadataProvider;\nconst { EVENTS } = DicomMetadataStore;\n\nconst END_MODALITIES = {\n  SR: true,\n  SEG: true,\n  DOC: true,\n};\n\nconst compareValue = (v1, v2, def = 0) => {\n  if (v1 === v2) {\n    return def;\n  }\n  if (v1 < v2) {\n    return -1;\n  }\n  return 1;\n};\n\n// Sorting SR modalities to be at the end of series list\nconst customSort = (seriesA, seriesB) => {\n  const instanceA = seriesA.instances[0];\n  const instanceB = seriesB.instances[0];\n  const modalityA = instanceA.Modality;\n  const modalityB = instanceB.Modality;\n\n  const isEndA = END_MODALITIES[modalityA];\n  const isEndB = END_MODALITIES[modalityB];\n\n  if (isEndA && isEndB) {\n    // Compare by series date\n    return compareValue(instanceA.SeriesNumber, instanceB.SeriesNumber);\n  }\n  if (!isEndA && !isEndB) {\n    return compareValue(instanceB.SeriesNumber, instanceA.SeriesNumber);\n  }\n  return isEndA ? -1 : 1;\n};\n\nfunction createDicomLocalApi(dicomLocalConfig) {\n  const { name } = dicomLocalConfig;\n\n  const implementation = {\n    initialize: ({ params, query }) => {},\n    query: {\n      studies: {\n        mapParams: () => {},\n        search: params => {\n          const studyUIDs = DicomMetadataStore.getStudyInstanceUIDs();\n\n          return studyUIDs.map(StudyInstanceUID => {\n            let numInstances = 0;\n            const modalities = new Set();\n\n            // Calculating the number of instances in the study and modalities\n            // present in the study\n            const study = DicomMetadataStore.getStudy(StudyInstanceUID);\n            study.series.forEach(aSeries => {\n              numInstances += aSeries.instances.length;\n              modalities.add(aSeries.instances[0].Modality);\n            });\n\n            // first instance in the first series\n            const firstInstance = study?.series[0]?.instances[0];\n\n            if (firstInstance) {\n              return {\n                accession: firstInstance.AccessionNumber,\n                date: firstInstance.StudyDate,\n                description: firstInstance.StudyDescription,\n                mrn: firstInstance.PatientID,\n                patientName: utils.formatPN(firstInstance.PatientName),\n                studyInstanceUid: firstInstance.StudyInstanceUID,\n                time: firstInstance.StudyTime,\n                //\n                instances: numInstances,\n                modalities: Array.from(modalities).join('/'),\n                NumInstances: numInstances,\n              };\n            }\n          });\n        },\n        processResults: () => {\n          console.warn(' DICOMLocal QUERY processResults not implemented');\n        },\n      },\n      series: {\n        search: studyInstanceUID => {\n          const study = DicomMetadataStore.getStudy(studyInstanceUID);\n          return study.series.map(aSeries => {\n            const firstInstance = aSeries?.instances[0];\n            return {\n              studyInstanceUid: studyInstanceUID,\n              seriesInstanceUid: firstInstance.SeriesInstanceUID,\n              modality: firstInstance.Modality,\n              seriesNumber: firstInstance.SeriesNumber,\n              seriesDate: firstInstance.SeriesDate,\n              numSeriesInstances: aSeries.instances.length,\n              description: firstInstance.SeriesDescription,\n            };\n          });\n        },\n      },\n      instances: {\n        search: () => {\n          console.warn(' DICOMLocal QUERY instances SEARCH not implemented');\n        },\n      },\n    },\n    retrieve: {\n      directURL: params => {\n        const { instance, tag, defaultType } = params;\n\n        const value = instance[tag];\n        if (value instanceof Array && value[0] instanceof ArrayBuffer) {\n          return URL.createObjectURL(\n            new Blob([value[0]], {\n              type: defaultType,\n            })\n          );\n        }\n      },\n      series: {\n        metadata: async ({ StudyInstanceUID, madeInClient = false } = {}) => {\n          if (!StudyInstanceUID) {\n            throw new Error('Unable to query for SeriesMetadata without StudyInstanceUID');\n          }\n\n          // Instances metadata already added via local upload\n          const study = DicomMetadataStore.getStudy(StudyInstanceUID, madeInClient);\n\n          // Series metadata already added via local upload\n          DicomMetadataStore._broadcastEvent(EVENTS.SERIES_ADDED, {\n            StudyInstanceUID,\n            madeInClient,\n          });\n\n          study.series.forEach(aSeries => {\n            const { SeriesInstanceUID } = aSeries;\n\n            const isMultiframe = aSeries.instances[0].NumberOfFrames > 1;\n\n            aSeries.instances.forEach((instance, index) => {\n              const {\n                url: imageId,\n                StudyInstanceUID,\n                SeriesInstanceUID,\n                SOPInstanceUID,\n              } = instance;\n\n              instance.imageId = imageId;\n\n              // Add imageId specific mapping to this data as the URL isn't necessarily WADO-URI.\n              metadataProvider.addImageIdToUIDs(imageId, {\n                StudyInstanceUID,\n                SeriesInstanceUID,\n                SOPInstanceUID,\n                frameIndex: isMultiframe ? index : 1,\n              });\n            });\n\n            DicomMetadataStore._broadcastEvent(EVENTS.INSTANCES_ADDED, {\n              StudyInstanceUID,\n              SeriesInstanceUID,\n              madeInClient,\n            });\n          });\n        },\n      },\n    },\n    store: {\n      dicom: naturalizedReport => {\n        const reportBlob = dcmjs.data.datasetToBlob(naturalizedReport);\n\n        //Create a URL for the binary.\n        var objectUrl = URL.createObjectURL(reportBlob);\n        window.location.assign(objectUrl);\n      },\n    },\n    getImageIdsForDisplaySet(displaySet) {\n      const images = displaySet.images;\n      const imageIds = [];\n\n      if (!images) {\n        return imageIds;\n      }\n\n      displaySet.images.forEach(instance => {\n        const NumberOfFrames = instance.NumberOfFrames;\n        if (NumberOfFrames > 1) {\n          // in multiframe we start at frame 1\n          for (let i = 1; i <= NumberOfFrames; i++) {\n            const imageId = this.getImageIdsForInstance({\n              instance,\n              frame: i,\n            });\n            imageIds.push(imageId);\n          }\n        } else {\n          const imageId = this.getImageIdsForInstance({ instance });\n          imageIds.push(imageId);\n        }\n      });\n\n      return imageIds;\n    },\n    getImageIdsForInstance({ instance, frame }) {\n      const { StudyInstanceUID, SeriesInstanceUID, SOPInstanceUID } = instance;\n      const storedInstance = DicomMetadataStore.getInstance(\n        StudyInstanceUID,\n        SeriesInstanceUID,\n        SOPInstanceUID\n      );\n\n      let imageId = storedInstance.url;\n\n      if (frame !== undefined) {\n        imageId += `&frame=${frame}`;\n      }\n\n      return imageId;\n    },\n    deleteStudyMetadataPromise() {\n      console.log('deleteStudyMetadataPromise not implemented');\n    },\n    getStudyInstanceUIDs: ({ params, query }) => {\n      const { StudyInstanceUIDs: paramsStudyInstanceUIDs } = params;\n      const queryStudyInstanceUIDs = query.getAll('StudyInstanceUIDs');\n\n      const StudyInstanceUIDs = queryStudyInstanceUIDs || paramsStudyInstanceUIDs;\n      const StudyInstanceUIDsAsArray =\n        StudyInstanceUIDs && Array.isArray(StudyInstanceUIDs)\n          ? StudyInstanceUIDs\n          : [StudyInstanceUIDs];\n\n      // Put SRs at the end of series list to make sure images are loaded first\n      let isStudyInCache = false;\n      StudyInstanceUIDsAsArray.forEach(StudyInstanceUID => {\n        const study = DicomMetadataStore.getStudy(StudyInstanceUID);\n        if (study) {\n          study.series = study.series.sort(customSort);\n          isStudyInCache = true;\n        }\n      });\n\n      return isStudyInCache ? StudyInstanceUIDsAsArray : [];\n    },\n  };\n  return IWebApiDataSource.create(implementation);\n}\n\nexport { createDicomLocalApi };\n","import { DICOMWeb, utils } from '@ohif/core';\nimport { sortStudySeries } from '@ohif/core/src/utils/sortStudy';\n\nconst { getString, getName, getModalities } = DICOMWeb;\n\nconst SQL_STATEMENT_API = \"sql/statements/\"\n\nfunction processResults(qidoStudies) {\n  if (!qidoStudies || !qidoStudies.length) {\n    return [];\n  }\n\n  const studies = [];\n\n  qidoStudies.forEach(qidoStudy =>\n    studies.push({\n      studyInstanceUid: getString(JSON.parse(qidoStudy[0])),\n      date: getString(JSON.parse(qidoStudy[1])), // YYYYMMDD\n      time: getString(JSON.parse(qidoStudy[2])), // HHmmss.SSS (24-hour, minutes, seconds, fractional seconds)\n      accession: getString(JSON.parse(qidoStudy[3])) || '', // short string, probably a number?\n      mrn: getString(JSON.parse(qidoStudy[4])) || '', // medicalRecordNumber\n      patientName: utils.formatPN(getName(JSON.parse(qidoStudy[5]))) || '',\n      description: getString(JSON.parse(qidoStudy[6])) || '',\n      modalities: getString(getModalities(JSON.parse(qidoStudy[7]), JSON.parse(qidoStudy[8]))) || '',\n      instances: Number(JSON.parse(qidoStudy[9])) || 1, // number\n    })\n  );\n\n  return studies;\n}\n\nfunction processSeriesMetadataResults(qidoSeriesMetadata) {\n  if (!qidoSeriesMetadata || !qidoSeriesMetadata.length) {\n    return [];\n  }\n\n  const series = [];\n\n  qidoSeriesMetadata.forEach(currentSerie => {\n    var serie = {\n      StudyInstanceUid: currentSerie[0],\n      SeriesInstanceUid: currentSerie[1],\n      instances: JSON.parse(currentSerie[2])\n    }\n\n    serie.instances.forEach((instance, index) => {\n      instance.StudyInstanceUID = serie.StudyInstanceUid\n      instance.SeriesInstanceUID = serie.SeriesInstanceUid\n      instance.InstanceNumber = index\n      instance.numImageFrames = serie.instances.length\n      instance.meta = JSON.parse(instance.meta.replaceAll(\"'\", '\"'))\n    });\n\n    series.push(serie)\n  })\n\n  return series;\n}\n\nexport function processSeriesResults(qidoSeries) {\n  const series = [];\n\n  if (qidoSeries && qidoSeries.length) {\n    qidoSeries.forEach(qidoSeries =>\n      series.push({\n        studyInstanceUid: getString(JSON.parse(qidoSeries[0])),\n        seriesInstanceUid: getString(JSON.parse(qidoSeries[1])),\n        sopInstanceUID: getString(JSON.parse(qidoSeries[2])),\n        modality: getString(JSON.parse(qidoSeries[3])),\n        seriesNumber: getString(JSON.parse(qidoSeries[4])),\n        seriesDate: utils.formatDate(getString(JSON.parse(qidoSeries[5]))),\n        numSeriesInstances: Number(getString(JSON.parse(qidoSeries[6]))),\n        description: getString(JSON.parse(qidoSeries[7])),\n        path: qidoSeries[8],\n      })\n    );\n  }\n\n  sortStudySeries(series);\n\n  return series;\n}\n\nasync function qidoStudiesSearch(databricksClient, warehouseId, pixelsTable) {\n\n  let body = {\n    \"warehouse_id\": warehouseId,\n    \"statement\": `select *, count(*) as instances from (SELECT\n          meta:['0020000D'] as studyInstanceUid,\n          meta:['00080020'] as date,\n          meta:['00080030'] as time,\n          meta:['00080050'] as accession,\n          meta:['00100020'] as mrn,\n          meta:['00100010'] as patientName,\n          meta:['00081030'] as description,\n          meta:['00080060'] as modalities1,\n          meta:['00080061'] as modalities2\n       FROM ${pixelsTable})\n       group by all`,\n    \"wait_timeout\": \"30s\",\n    \"on_wait_timeout\": \"CANCEL\"\n  }\n\n  const result = await databricksClient.post(SQL_STATEMENT_API, body)\n\n  return result.data.result.data_array;\n}\n\nasync function qidoSeriesSearch(databricksClient, warehouseId, studyInstanceUid, pixelsTable) {\n\n  let body = {\n    \"warehouse_id\": warehouseId,\n    \"statement\": `SELECT \\\n            meta:['0020000D'] as studyInstanceUid,\n            meta:['0020000E'] as seriesInstanceUid,\n            meta:['00080018'] as SOPInstanceUID,\n            meta:['00080060'] as modality,\n            meta:['00200011'] as seriesNumber,\n            meta:['00080021'] as seriesDate,\n            meta:['00201209'] as numSeriesInstances,\n            meta:['0008103E'] as description,\n            path\n       FROM ${pixelsTable}\n       WHERE meta:['0020000D'].Value[0] = '${studyInstanceUid}'`,\n    \"wait_timeout\": \"30s\",\n    \"on_wait_timeout\": \"CANCEL\"\n  }\n\n  const result = await databricksClient.post(SQL_STATEMENT_API, body)\n\n  return result.data.result.data_array;\n}\n\nasync function qidoSeriesMetadataSearch(databricksClient, warehouseId, studyInstanceUid, pixelsTable) {\n\n  let body = {\n    \"warehouse_id\": warehouseId,\n    \"statement\": `\n    with qico(\n      SELECT\n            meta:['0020000D'].Value[0] as StudyInstanceUID,\n            meta:['0020000E'].Value[0] as SeriesInstanceUID,\n            meta:['00080018'].Value[0] as SOPInstanceUID,\n            meta:['00080016'].Value[0] as SOPClassUID,\n            meta,\n            relative_path\n       FROM ${pixelsTable}\n    )\n\n    select StudyInstanceUID, SeriesInstanceUID, collect_list(\n      struct(SOPInstanceUID,\n            SOPClassUID,\n            meta,\n            relative_path)\n    ) from qico\n       WHERE studyInstanceUid = '${studyInstanceUid}'\n       group by studyInstanceUid, seriesInstanceUid`,\n    \"wait_timeout\": \"30s\",\n    \"on_wait_timeout\": \"CANCEL\"\n  }\n\n  const result = await databricksClient.post(SQL_STATEMENT_API, body)\n\n  return result.data.result.data_array;\n}\n\n/**\n *\n * @param {string} studyInstanceUID - ID of study to return a list of series for\n * @returns {Promise} - Resolves SeriesMetadata[] in study\n */\nexport function seriesInStudy(dicomWebClient, studyInstanceUID) {\n  // Series Description\n  // Already included?\n  const commaSeparatedFields = ['0008103E', '00080021'].join(',');\n  const queryParams = {\n    includefield: commaSeparatedFields,\n  };\n\n  return dicomWebClient.searchForSeries({ studyInstanceUID, queryParams });\n}\n\n/**\n * Produces a QIDO URL given server details and a set of specified search filter\n * items\n *\n * @param filter\n * @param serverSupportsQIDOIncludeField\n * @returns {string} The URL with encoded filter query data\n */\nfunction mapParams(params, options = {}) {\n  if (!params) {\n    return;\n  }\n  const commaSeparatedFields = [\n    '00081030', // Study Description\n    '00080060', // Modality\n    // Add more fields here if you want them in the result\n  ].join(',');\n\n  const { supportsWildcard } = options;\n  const withWildcard = value => {\n    return supportsWildcard && value ? `*${value}*` : value;\n  };\n\n  const parameters = {\n    // Named\n    PatientName: withWildcard(params.patientName),\n    //PatientID: withWildcard(params.patientId),\n    '00100020': withWildcard(params.patientId), // Temporarily to make the tests pass with dicomweb-server.. Apparently it's broken?\n    AccessionNumber: withWildcard(params.accessionNumber),\n    StudyDescription: withWildcard(params.studyDescription),\n    ModalitiesInStudy: params.modalitiesInStudy,\n    // Other\n    limit: params.limit || 101,\n    offset: params.offset || 0,\n    fuzzymatching: options.supportsFuzzyMatching === true,\n    includefield: commaSeparatedFields, // serverSupportsQIDOIncludeField ? commaSeparatedFields : 'all',\n  };\n\n  // build the StudyDate range parameter\n  if (params.startDate && params.endDate) {\n    parameters.StudyDate = `${params.startDate}-${params.endDate}`;\n  } else if (params.startDate) {\n    const today = new Date();\n    const DD = String(today.getDate()).padStart(2, '0');\n    const MM = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!\n    const YYYY = today.getFullYear();\n    const todayStr = `${YYYY}${MM}${DD}`;\n\n    parameters.StudyDate = `${params.startDate}-${todayStr}`;\n  } else if (params.endDate) {\n    const oldDateStr = `19700102`;\n\n    parameters.StudyDate = `${oldDateStr}-${params.endDate}`;\n  }\n\n  // Build the StudyInstanceUID parameter\n  if (params.studyInstanceUid) {\n    let studyUids = params.studyInstanceUid;\n    studyUids = Array.isArray(studyUids) ? studyUids.join() : studyUids;\n    studyUids = studyUids.replace(/[^0-9.]+/g, '\\\\');\n    parameters.StudyInstanceUID = studyUids;\n  }\n\n  // Clean query params of undefined values.\n  const final = {};\n  Object.keys(parameters).forEach(key => {\n    if (parameters[key] !== undefined && parameters[key] !== '') {\n      final[key] = parameters[key];\n    }\n  });\n\n  return final;\n}\n\nexport { mapParams, qidoStudiesSearch, qidoSeriesSearch, qidoSeriesMetadataSearch, processResults, processSeriesMetadataResults };\n","import { DicomMetadataStore, IWebApiDataSource, utils } from '@ohif/core';\nimport OHIF from '@ohif/core';\nimport dcmjs from 'dcmjs';\n\nimport axios from \"axios\";\n\nimport {\n  mapParams,\n  qidoSeriesSearch,\n  qidoSeriesMetadataSearch,\n  qidoStudiesSearch,\n  processResults,\n  processSeriesResults,\n  processSeriesMetadataResults\n} from './utils.js';\n\nconst metadataProvider = OHIF.classes.MetadataProvider;\n\nconst { DicomMetaDictionary, DicomDict } = dcmjs.data;\nconst { naturalizeDataset, denaturalizeDataset } = DicomMetaDictionary;\n\nfunction createDatabricksPixelsDicom(dcmConfig, servicesManager) {\n\n  let dicomConfig,\n    databricksClient,\n    warehouseId;\n\n  console.info(\"createDatabricksPixelsDicom\")\n\n  const implementation = {\n    initialize: async ({ params, query }) => {\n\n      console.info(\"createDatabricksPixelsDicom - Initialize\")\n\n      dicomConfig = JSON.parse(JSON.stringify(dcmConfig));\n\n      if (!dicomConfig.token || !dicomConfig.serverHostname || !dicomConfig.httpPath || !dicomConfig.pixelsTable) {\n        throw new Error(\"Cannot find Server Hostname, HTTP Path, or \" +\n          \"personal access token. \" +\n          \"Check the environment variables DATABRICKS_SERVER_HOSTNAME, \" +\n          \"DATABRICKS_HTTP_PATH, DATABRICKS_TOKEN and pixelsTable.\");\n      }\n\n      const connectOptions = {\n        token: dicomConfig.token,\n        host: dicomConfig.serverHostname,\n        path: dicomConfig.httpPath\n      };\n\n      databricksClient = axios.create({\n        baseURL: connectOptions.host + \"/api/2.0/\",\n      });\n\n      databricksClient.defaults.headers.common['Authorization'] = `Bearer ${connectOptions.token}`\n      const userAuthenticationService = servicesManager.services.userAuthenticationService;\n      userAuthenticationService.getAuthorizationHeader = () => {\n        return { 'Authorization': `Bearer ${connectOptions.token}` }\n      }\n\n      warehouseId = dicomConfig.httpPath.split(\"/\")[4]\n\n    },\n    query: {\n      studies: {\n        mapParams: mapParams.bind(),\n        search: async function (origParams) {\n\n          console.info(\"createDatabricksPixelsDicom - query studies\")\n\n          const results = await qidoStudiesSearch(databricksClient, warehouseId, dicomConfig.pixelsTable);\n\n          return processResults(results);\n        },\n        processResults: processResults.bind(),\n      },\n      series: {\n        search: async studyInstanceUID => {\n          console.info(\"createDatabricksPixelsDicom - query series\", studyInstanceUID)\n\n          const series = await qidoSeriesSearch(databricksClient, warehouseId, studyInstanceUID, dicomConfig.pixelsTable);\n          const result = processSeriesResults(series);\n\n          return result\n        },\n      },\n      instances: {\n        search: () => {\n          console.warn(' QUERY instances SEARCH not implemented');\n        },\n      },\n    },\n    retrieve: {\n      directURL: params => {\n        const { instance, tag, defaultType } = params;\n\n        console.log(\"retrieve direct url\")\n        const value = instance[tag];\n        if (value instanceof Array && value[0] instanceof ArrayBuffer) {\n          return URL.createObjectURL(\n            new Blob([value[0]], {\n              type: defaultType,\n            })\n          );\n        }\n      },\n      bulkDataURI: async ({ StudyInstanceUID, BulkDataURI }) => {\n        console.warn(' Retrieve bulkDataURI not implemented');\n      },\n      series: {\n        metadata: async ({\n          StudyInstanceUID,\n          madeInClient = false\n        } = {}) => {\n          if (!StudyInstanceUID) {\n            throw new Error('Unable to query for SeriesMetadata without StudyInstanceUID');\n          }\n\n          const study = await qidoSeriesMetadataSearch(databricksClient, warehouseId, StudyInstanceUID, dicomConfig.pixelsTable);\n          const result = processSeriesMetadataResults(study);\n\n          const seriesSummaryMetadata = {};\n          const instancesPerSeries = {};\n\n\n          result.forEach(aSeries => {\n\n            aSeries.instances.forEach((instance, index) => {\n\n              const naturalizedInstancesMetadata = naturalizeDataset(instance.meta);\n\n              naturalizedInstancesMetadata.url = \"dicomweb:\" + databricksClient.defaults.baseURL + \"fs/files/\" + instance.relative_path\n\n              const {\n                url: imageId,\n                StudyInstanceUID,\n                SeriesInstanceUID,\n                SOPInstanceUID,\n              } = naturalizedInstancesMetadata;\n\n              naturalizedInstancesMetadata.imageId = imageId;\n\n              if (!seriesSummaryMetadata[naturalizedInstancesMetadata.SeriesInstanceUID]) {\n                seriesSummaryMetadata[naturalizedInstancesMetadata.SeriesInstanceUID] = {\n                  StudyInstanceUID: naturalizedInstancesMetadata.StudyInstanceUID,\n                  StudyDescription: naturalizedInstancesMetadata.studyDescription,\n                  SeriesInstanceUID: naturalizedInstancesMetadata.SeriesInstanceUID,\n                  SeriesDescription: naturalizedInstancesMetadata.seriesDescription,\n                  SOPInstanceUID: naturalizedInstancesMetadata.SOPInstanceUID,\n                  SeriesNumber: naturalizedInstancesMetadata.seriesNumber,\n                  SeriesTime: naturalizedInstancesMetadata.seriesTime,\n                  SOPClassUID: naturalizedInstancesMetadata.sopClassUID,\n                  ProtocolName: naturalizedInstancesMetadata.protocolName,\n                  Modality: naturalizedInstancesMetadata.modality,\n                };\n              }\n\n              if (!instancesPerSeries[naturalizedInstancesMetadata.SeriesInstanceUID]) {\n                instancesPerSeries[naturalizedInstancesMetadata.SeriesInstanceUID] = [];\n              }\n\n              // Add imageId specific mapping to this data as the URL isn't necessarily WADO-URI.\n              metadataProvider.addImageIdToUIDs(imageId, {\n                StudyInstanceUID,\n                SeriesInstanceUID,\n                SOPInstanceUID,\n                frameIndex: 1,\n              });\n\n              instancesPerSeries[naturalizedInstancesMetadata.SeriesInstanceUID].push(naturalizedInstancesMetadata);\n\n            });\n\n            // grab all the series metadata\n            const seriesMetadata = Object.values(seriesSummaryMetadata);\n            DicomMetadataStore.addSeriesMetadata(seriesMetadata, madeInClient);\n\n            Object.keys(instancesPerSeries).forEach(SeriesInstanceUID =>\n              DicomMetadataStore.addInstances(instancesPerSeries[SeriesInstanceUID], madeInClient)\n            );\n\n          });\n        }\n      },\n    },\n    store: {\n      dicom: async (dataset, request, dicomDict) => {\n        console.warn(' store dicom not implemented');\n      }\n    },\n    getImageIdsForDisplaySet(displaySet) {\n      const images = displaySet.images;\n      const imageIds = [];\n\n      if (!images) {\n        return imageIds;\n      }\n\n      displaySet.images.forEach(instance => {\n        const NumberOfFrames = instance.NumberOfFrames;\n        if (NumberOfFrames > 1) {\n          // in multiframe we start at frame 1\n          for (let i = 1; i <= NumberOfFrames; i++) {\n            const imageId = this.getImageIdsForInstance({\n              instance,\n              frame: i,\n            });\n            imageIds.push(imageId);\n          }\n        } else {\n          const imageId = this.getImageIdsForInstance({ instance });\n          imageIds.push(imageId);\n        }\n      });\n\n      return imageIds;\n    },\n    getImageIdsForInstance({ instance, frame }) {\n      const { StudyInstanceUID, SeriesInstanceUID, SOPInstanceUID } = instance;\n      const storedInstance = DicomMetadataStore.getInstance(\n        StudyInstanceUID,\n        SeriesInstanceUID,\n        SOPInstanceUID\n      );\n\n      let imageId = storedInstance.url;\n\n      if (frame !== undefined) {\n        imageId += `&frame=${frame}`;\n      }\n\n      return imageId;\n    },\n    deleteStudyMetadataPromise() {\n      console.log('deleteStudyMetadataPromise not implemented');\n    },\n    getStudyInstanceUIDs: ({ params, query }) => {\n      console.log(\"getStudyInstanceUIDs\")\n      const { StudyInstanceUIDs: paramsStudyInstanceUIDs } = params;\n      const queryStudyInstanceUIDs = utils.splitComma(query.getAll('StudyInstanceUIDs'));\n\n      const StudyInstanceUIDs =\n        (queryStudyInstanceUIDs.length && queryStudyInstanceUIDs) || paramsStudyInstanceUIDs;\n      const StudyInstanceUIDsAsArray =\n        StudyInstanceUIDs && Array.isArray(StudyInstanceUIDs)\n          ? StudyInstanceUIDs\n          : [StudyInstanceUIDs];\n\n      return StudyInstanceUIDsAsArray;\n    },\n  };\n  return IWebApiDataSource.create(implementation);\n}\n\nexport { createDatabricksPixelsDicom };\n","import { IWebApiDataSource } from '@ohif/core';\nimport { createDicomWebApi } from '../DicomWebDataSource/index';\n\n/**\n * This datasource is initialized with a url that returns a JSON object with a\n * dicomWeb datasource configuration array present in a \"servers\" object.\n *\n * Only the first array item is parsed, if there are multiple items in the\n * dicomWeb configuration array\n *\n */\nfunction createDicomWebProxyApi(dicomWebProxyConfig, servicesManager) {\n  const { name } = dicomWebProxyConfig;\n  let dicomWebDelegate = undefined;\n\n  const implementation = {\n    initialize: async ({ params, query }) => {\n      const url = query.get('url');\n\n      if (!url) {\n        throw new Error(`No url for '${name}'`);\n      } else {\n        const response = await fetch(url);\n        let data = await response.json();\n        if (!data.servers?.dicomWeb?.[0]) {\n          throw new Error('Invalid configuration returned by url');\n        }\n\n        dicomWebDelegate = createDicomWebApi(\n          data.servers.dicomWeb[0].configuration,\n          servicesManager\n        );\n        dicomWebDelegate.initialize({ params, query });\n      }\n    },\n    query: {\n      studies: {\n        search: params => dicomWebDelegate.query.studies.search(params),\n      },\n      series: {\n        search: (...args) => dicomWebDelegate.query.series.search(...args),\n      },\n      instances: {\n        search: (studyInstanceUid, queryParameters) =>\n          dicomWebDelegate.query.instances.search(studyInstanceUid, queryParameters),\n      },\n    },\n    retrieve: {\n      directURL: (...args) => dicomWebDelegate.retrieve.directURL(...args),\n      series: {\n        metadata: async (...args) => dicomWebDelegate.retrieve.series.metadata(...args),\n      },\n    },\n    store: {\n      dicom: (...args) => dicomWebDelegate.store(...args),\n    },\n    deleteStudyMetadataPromise: (...args) => dicomWebDelegate.deleteStudyMetadataPromise(...args),\n    getImageIdsForDisplaySet: (...args) => dicomWebDelegate.getImageIdsForDisplaySet(...args),\n    getImageIdsForInstance: (...args) => dicomWebDelegate.getImageIdsForInstance(...args),\n    getStudyInstanceUIDs({ params, query }) {\n      let studyInstanceUIDs = [];\n\n      // there seem to be a couple of variations of the case for this parameter\n      const queryStudyInstanceUIDs =\n        query.get('studyInstanceUIDs') || query.get('studyInstanceUids');\n      if (!queryStudyInstanceUIDs) {\n        throw new Error(`No studyInstanceUids in request for '${name}'`);\n      }\n      studyInstanceUIDs = queryStudyInstanceUIDs.split(';');\n      return studyInstanceUIDs;\n    },\n  };\n  return IWebApiDataSource.create(implementation);\n}\n\nexport { createDicomWebProxyApi };\n","import { DicomMetadataStore, IWebApiDataSource } from '@ohif/core';\nimport { get, uniqBy } from 'lodash';\nimport {\n  MergeConfig,\n  CallForAllDataSourcesAsyncOptions,\n  CallForAllDataSourcesOptions,\n  CallForDefaultDataSourceOptions,\n  CallByRetrieveAETitleOptions,\n  MergeMap,\n} from './types';\n\nexport const mergeMap: MergeMap = {\n  'query.studies.search': {\n    mergeKey: 'studyInstanceUid',\n    tagFunc: x => x,\n  },\n  'query.series.search': {\n    mergeKey: 'seriesInstanceUid',\n    tagFunc: (series, sourceName) => {\n      series.forEach(series => {\n        series.RetrieveAETitle = sourceName;\n        DicomMetadataStore.updateSeriesMetadata(series);\n      });\n      return series;\n    },\n  },\n};\n\n/**\n * Calls all data sources asynchronously and merges the results.\n * @param {CallForAllDataSourcesAsyncOptions} options - The options for calling all data sources.\n * @param {string} options.path - The path to the function to be called on each data source.\n * @param {unknown[]} options.args - The arguments to be passed to the function.\n * @param {ExtensionManager} options.extensionManager - The extension manager.\n * @param {string[]} options.dataSourceNames - The names of the data sources to be called.\n * @param {string} options.defaultDataSourceName - The name of the default data source.\n * @returns {Promise<unknown[]>} - A promise that resolves to the merged data from all data sources.\n */\nexport const callForAllDataSourcesAsync = async ({\n  mergeMap,\n  path,\n  args,\n  extensionManager,\n  dataSourceNames,\n  defaultDataSourceName,\n}: CallForAllDataSourcesAsyncOptions) => {\n  const { mergeKey, tagFunc } = mergeMap[path] || { tagFunc: x => x };\n\n  /** Sort by default data source */\n  const defs = Object.values(extensionManager.dataSourceDefs);\n  const defaultDataSourceDef = defs.find(def => def.sourceName === defaultDataSourceName);\n  const dataSourceDefs = defs.filter(def => def.sourceName !== defaultDataSourceName);\n  if (defaultDataSourceDef) {\n    dataSourceDefs.unshift(defaultDataSourceDef);\n  }\n\n  const promises = [];\n  const sourceNames = [];\n\n  for (const dataSourceDef of dataSourceDefs) {\n    const { configuration, sourceName } = dataSourceDef;\n    if (!!configuration && dataSourceNames.includes(sourceName)) {\n      const [dataSource] = extensionManager.getDataSources(sourceName);\n      const func = get(dataSource, path);\n      const promise = func.apply(dataSource, args);\n      promises.push(promise);\n      sourceNames.push(sourceName);\n    }\n  }\n\n  const data = await Promise.allSettled(promises);\n  const mergedData = data.map((data, i) => tagFunc(data.value, sourceNames[i]));\n\n  let results = [];\n  if (mergeKey) {\n    results = uniqBy(mergedData.flat(), obj => get(obj, mergeKey));\n  } else {\n    results = mergedData.flat();\n  }\n\n  return results;\n};\n\n/**\n * Calls all data sources that match the provided names and merges their data.\n * @param options - The options for calling all data sources.\n * @param options.path - The path to the function to be called on each data source.\n * @param options.args - The arguments to be passed to the function.\n * @param options.extensionManager - The extension manager instance.\n * @param options.dataSourceNames - The names of the data sources to be called.\n * @param options.defaultDataSourceName - The name of the default data source.\n * @returns The merged data from all the matching data sources.\n */\nexport const callForAllDataSources = ({\n  path,\n  args,\n  extensionManager,\n  dataSourceNames,\n  defaultDataSourceName,\n}: CallForAllDataSourcesOptions) => {\n  /** Sort by default data source */\n  const defs = Object.values(extensionManager.dataSourceDefs);\n  const defaultDataSourceDef = defs.find(def => def.sourceName === defaultDataSourceName);\n  const dataSourceDefs = defs.filter(def => def.sourceName !== defaultDataSourceName);\n  if (defaultDataSourceDef) {\n    dataSourceDefs.unshift(defaultDataSourceDef);\n  }\n\n  const mergedData = [];\n  for (const dataSourceDef of dataSourceDefs) {\n    const { configuration, sourceName } = dataSourceDef;\n    if (!!configuration && dataSourceNames.includes(sourceName)) {\n      const [dataSource] = extensionManager.getDataSources(sourceName);\n      const func = get(dataSource, path);\n      const data = func.apply(dataSource, args);\n      mergedData.push(data);\n    }\n  }\n\n  return mergedData.flat();\n};\n\n/**\n * Calls the default data source function specified by the given path with the provided arguments.\n * @param {CallForDefaultDataSourceOptions} options - The options for calling the default data source.\n * @param {string} options.path - The path to the function within the default data source.\n * @param {unknown[]} options.args - The arguments to pass to the function.\n * @param {string} options.defaultDataSourceName - The name of the default data source.\n * @param {ExtensionManager} options.extensionManager - The extension manager instance.\n * @returns {unknown} - The result of calling the default data source function.\n */\nexport const callForDefaultDataSource = ({\n  path,\n  args,\n  defaultDataSourceName,\n  extensionManager,\n}: CallForDefaultDataSourceOptions) => {\n  const [dataSource] = extensionManager.getDataSources(defaultDataSourceName);\n  const func = get(dataSource, path);\n  return func.apply(dataSource, args);\n};\n\n/**\n * Calls the data source specified by the RetrieveAETitle of the given display set.\n * @typedef {Object} CallByRetrieveAETitleOptions\n * @property {string} path - The path of the method to call on the data source.\n * @property {any[]} args - The arguments to pass to the method.\n * @property {string} defaultDataSourceName - The name of the default data source.\n * @property {ExtensionManager} extensionManager - The extension manager.\n */\nexport const callByRetrieveAETitle = ({\n  path,\n  args,\n  defaultDataSourceName,\n  extensionManager,\n}: CallByRetrieveAETitleOptions) => {\n  const [displaySet] = args;\n  const seriesMetadata = DicomMetadataStore.getSeries(\n    displaySet.StudyInstanceUID,\n    displaySet.SeriesInstanceUID\n  );\n  const [dataSource] = extensionManager.getDataSources(\n    seriesMetadata.RetrieveAETitle || defaultDataSourceName\n  );\n  return dataSource[path](...args);\n};\n\nfunction createMergeDataSourceApi(\n  mergeConfig: MergeConfig,\n  servicesManager: unknown,\n  extensionManager\n) {\n  const { seriesMerge } = mergeConfig;\n  const { dataSourceNames, defaultDataSourceName } = seriesMerge;\n\n  const implementation = {\n    initialize: (...args: unknown[]) =>\n      callForAllDataSources({\n        path: 'initialize',\n        args,\n        extensionManager,\n        dataSourceNames,\n        defaultDataSourceName,\n      }),\n    query: {\n      studies: {\n        search: (...args: unknown[]) =>\n          callForAllDataSourcesAsync({\n            mergeMap,\n            path: 'query.studies.search',\n            args,\n            extensionManager,\n            dataSourceNames,\n            defaultDataSourceName,\n          }),\n      },\n      series: {\n        search: (...args: unknown[]) =>\n          callForAllDataSourcesAsync({\n            mergeMap,\n            path: 'query.series.search',\n            args,\n            extensionManager,\n            dataSourceNames,\n            defaultDataSourceName,\n          }),\n      },\n      instances: {\n        search: (...args: unknown[]) =>\n          callForAllDataSourcesAsync({\n            mergeMap,\n            path: 'query.instances.search',\n            args,\n            extensionManager,\n            dataSourceNames,\n            defaultDataSourceName,\n          }),\n      },\n    },\n    retrieve: {\n      bulkDataURI: (...args: unknown[]) =>\n        callForAllDataSourcesAsync({\n          mergeMap,\n          path: 'retrieve.bulkDataURI',\n          args,\n          extensionManager,\n          dataSourceNames,\n          defaultDataSourceName,\n        }),\n      directURL: (...args: unknown[]) =>\n        callForDefaultDataSource({\n          path: 'retrieve.directURL',\n          args,\n          defaultDataSourceName,\n          extensionManager,\n        }),\n      series: {\n        metadata: (...args: unknown[]) =>\n          callForAllDataSourcesAsync({\n            mergeMap,\n            path: 'retrieve.series.metadata',\n            args,\n            extensionManager,\n            dataSourceNames,\n            defaultDataSourceName,\n          }),\n      },\n    },\n    store: {\n      dicom: (...args: unknown[]) =>\n        callForDefaultDataSource({\n          path: 'store.dicom',\n          args,\n          defaultDataSourceName,\n          extensionManager,\n        }),\n    },\n    deleteStudyMetadataPromise: (...args: unknown[]) =>\n      callForAllDataSources({\n        path: 'deleteStudyMetadataPromise',\n        args,\n        extensionManager,\n        dataSourceNames,\n        defaultDataSourceName,\n      }),\n    getImageIdsForDisplaySet: (...args: unknown[]) =>\n      callByRetrieveAETitle({\n        path: 'getImageIdsForDisplaySet',\n        args,\n        defaultDataSourceName,\n        extensionManager,\n      }),\n    getImageIdsForInstance: (...args: unknown[]) =>\n      callByRetrieveAETitle({\n        path: 'getImageIdsForDisplaySet',\n        args,\n        defaultDataSourceName,\n        extensionManager,\n      }),\n    getStudyInstanceUIDs: (...args: unknown[]) =>\n      callForAllDataSources({\n        path: 'getStudyInstanceUIDs',\n        args,\n        extensionManager,\n        dataSourceNames,\n        defaultDataSourceName,\n      }),\n  };\n\n  return IWebApiDataSource.create(implementation);\n}\n\nexport { createMergeDataSourceApi };\n","// TODO: Pull in IWebClientApi from @ohif/core\n// TODO: Use constructor to create an instance of IWebClientApi\n// TODO: Use existing DICOMWeb configuration (previously, appConfig, to configure instance)\n\nimport { createDicomWebApi } from './DicomWebDataSource/index.js';\nimport { createDicomJSONApi } from './DicomJSONDataSource/index.js';\nimport { createDicomLocalApi } from './DicomLocalDataSource/index.js';\nimport { createDatabricksPixelsDicom } from './DatabricksPixelsDicom/index.js';\nimport { createDicomWebProxyApi } from './DicomWebProxyDataSource/index.js';\nimport { createMergeDataSourceApi } from './MergeDataSource/index';\n\n/**\n *\n */\nfunction getDataSourcesModule() {\n  return [\n    {\n      name: 'dicomweb',\n      type: 'webApi',\n      createDataSource: createDicomWebApi,\n    },\n    {\n      name: 'dicomwebproxy',\n      type: 'webApi',\n      createDataSource: createDicomWebProxyApi,\n    },\n    {\n      name: 'dicomjson',\n      type: 'jsonApi',\n      createDataSource: createDicomJSONApi,\n    },\n    {\n      name: 'dicomlocal',\n      type: 'localApi',\n      createDataSource: createDicomLocalApi,\n    },\n    {\n      name: 'databricksPixelsDicom',\n      type: 'webApi',\n      createDataSource: createDatabricksPixelsDicom,\n    },\n    {\n      name: 'merge',\n      type: 'mergeApi',\n      createDataSource: createMergeDataSourceApi,\n    },\n  ];\n}\n\nexport default getDataSourcesModule;\n","import React, { useCallback, useEffect, useState } from 'react';\nimport classnames from 'classnames';\nimport { useViewportGrid } from '@ohif/ui';\n\nexport default function Toolbar({\n  servicesManager,\n}: Types.Extensions.ExtensionParams): React.ReactElement {\n  const { toolbarService } = servicesManager.services;\n\n  const [viewportGrid, viewportGridService] = useViewportGrid();\n\n  const [toolbarButtons, setToolbarButtons] = useState([]);\n\n  useEffect(() => {\n    const updateToolbar = () => {\n      const toolGroupId =\n        viewportGridService.getActiveViewportOptionByKey('toolGroupId') ?? 'default';\n      setToolbarButtons(toolbarService.getButtonSection(toolGroupId));\n    };\n\n    const { unsubscribe } = toolbarService.subscribe(\n      toolbarService.EVENTS.TOOL_BAR_MODIFIED,\n      updateToolbar\n    );\n\n    updateToolbar();\n\n    return () => {\n      unsubscribe();\n    };\n  }, [toolbarService, viewportGrid]);\n\n  const onInteraction = useCallback(\n    args => toolbarService.recordInteraction(args),\n    [toolbarService]\n  );\n\n  return (\n    <>\n      {toolbarButtons.map(toolDef => {\n        const { id, Component, componentProps } = toolDef;\n        return (\n          // The margin for separating the tools on the toolbar should go here and NOT in each individual component (button) item.\n          // This allows for the individual items to be included in other UI components where perhaps alternative margins are desired.\n          <div\n            key={id}\n            className={classnames('mr-1')}\n          >\n            <Component\n              id={id}\n              {...componentProps}\n              onInteraction={onInteraction}\n              servicesManager={servicesManager}\n            />\n          </div>\n        );\n      })}\n    </>\n  );\n}\n","import React from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { useTranslation } from 'react-i18next';\nimport { useLocation } from 'react-router';\n\nimport { ErrorBoundary, UserPreferences, AboutModal, Header, useModal } from '@ohif/ui';\nimport i18n from '@ohif/i18n';\nimport { hotkeys } from '@ohif/core';\nimport { useAppConfig } from '@state';\nimport Toolbar from '../Toolbar/Toolbar';\n\nconst { availableLanguages, defaultLanguage, currentLanguage } = i18n;\n\nfunction ViewerHeader({ hotkeysManager, extensionManager, servicesManager }) {\n  const [appConfig] = useAppConfig();\n  const navigate = useNavigate();\n  const location = useLocation();\n\n  const onClickReturnButton = () => {\n    const { pathname } = location;\n    const dataSourceIdx = pathname.indexOf('/', 1);\n    const query = new URLSearchParams(window.location.search);\n    const configUrl = query.get('configUrl');\n\n    const dataSourceName = pathname.substring(dataSourceIdx + 1);\n    const existingDataSource = extensionManager.getDataSources(dataSourceName);\n\n    const searchQuery = new URLSearchParams();\n    if (dataSourceIdx !== -1 && existingDataSource) {\n      searchQuery.append('datasources', pathname.substring(dataSourceIdx + 1));\n    }\n\n    if (configUrl) {\n      searchQuery.append('configUrl', configUrl);\n    }\n\n    navigate({\n      pathname: '/',\n      search: decodeURIComponent(searchQuery.toString()),\n    });\n  };\n\n  const { t } = useTranslation();\n  const { show, hide } = useModal();\n  const { hotkeyDefinitions, hotkeyDefaults } = hotkeysManager;\n  const versionNumber = process.env.VERSION_NUMBER;\n  const commitHash = process.env.COMMIT_HASH;\n\n  const menuOptions = [\n    {\n      title: t('Header:About'),\n      icon: 'info',\n      onClick: () =>\n        show({\n          content: AboutModal,\n          title: t('AboutModal:About OHIF Viewer'),\n          contentProps: { versionNumber, commitHash },\n        }),\n    },\n    {\n      title: t('Header:Preferences'),\n      icon: 'settings',\n      onClick: () =>\n        show({\n          title: t('UserPreferencesModal:User preferences'),\n          content: UserPreferences,\n          contentProps: {\n            hotkeyDefaults: hotkeysManager.getValidHotkeyDefinitions(hotkeyDefaults),\n            hotkeyDefinitions,\n            currentLanguage: currentLanguage(),\n            availableLanguages,\n            defaultLanguage,\n            onCancel: () => {\n              hotkeys.stopRecord();\n              hotkeys.unpause();\n              hide();\n            },\n            onSubmit: ({ hotkeyDefinitions, language }) => {\n              if (language.value !== currentLanguage().value) {\n                i18n.changeLanguage(language.value);\n              }\n              hotkeysManager.setHotkeys(hotkeyDefinitions);\n              hide();\n            },\n            onReset: () => hotkeysManager.restoreDefaultBindings(),\n            hotkeysModule: hotkeys,\n          },\n        }),\n    },\n  ];\n\n  if (appConfig.oidc) {\n    menuOptions.push({\n      title: t('Header:Logout'),\n      icon: 'power-off',\n      onClick: async () => {\n        navigate(`/logout?redirect_uri=${encodeURIComponent(window.location.href)}`);\n      },\n    });\n  }\n\n  return (\n    <Header\n      menuOptions={menuOptions}\n      isReturnEnabled={!!appConfig.showStudyList}\n      onClickReturnButton={onClickReturnButton}\n      WhiteLabeling={appConfig.whiteLabeling}\n    >\n      <ErrorBoundary context=\"Primary Toolbar\">\n        <div className=\"relative flex justify-center\">\n          <Toolbar servicesManager={servicesManager} />\n        </div>\n      </ErrorBoundary>\n    </Header>\n  );\n}\n\nexport default ViewerHeader;\n","import React, { useEffect, useState } from 'react';\nimport { SidePanel } from '@ohif/ui';\nimport { PanelService, ServicesManager } from '@ohif/core';\n\nexport type SidePanelWithServicesProps = {\n  servicesManager: ServicesManager;\n  side: 'left' | 'right';\n  className: string;\n  activeTabIndex: number;\n  tabs: any;\n  expandedWidth?: number;\n};\n\nconst SidePanelWithServices = ({\n  servicesManager,\n  side,\n  className,\n  activeTabIndex: activeTabIndexProp,\n  tabs,\n  expandedWidth,\n}: SidePanelWithServicesProps) => {\n  const panelService: PanelService = servicesManager?.services?.panelService;\n\n  // Tracks whether this SidePanel has been opened at least once since this SidePanel was inserted into the DOM.\n  // Thus going to the Study List page and back to the viewer resets this flag for a SidePanel.\n  const [hasBeenOpened, setHasBeenOpened] = useState(false);\n  const [activeTabIndex, setActiveTabIndex] = useState(activeTabIndexProp);\n\n  useEffect(() => {\n    if (panelService) {\n      const activatePanelSubscription = panelService.subscribe(\n        panelService.EVENTS.ACTIVATE_PANEL,\n        (activatePanelEvent: Types.ActivatePanelEvent) => {\n          if (!hasBeenOpened || activatePanelEvent.forceActive) {\n            const tabIndex = tabs.findIndex(tab => tab.id === activatePanelEvent.panelId);\n            if (tabIndex !== -1) {\n              setActiveTabIndex(tabIndex);\n            }\n          }\n        }\n      );\n\n      return () => {\n        activatePanelSubscription.unsubscribe();\n      };\n    }\n  }, [tabs, hasBeenOpened, panelService]);\n\n  return (\n    <SidePanel\n      side={side}\n      className={className}\n      activeTabIndex={activeTabIndex}\n      tabs={tabs}\n      onOpen={() => {\n        setHasBeenOpened(true);\n      }}\n      expandedWidth={expandedWidth}\n    ></SidePanel>\n  );\n};\n\nexport default SidePanelWithServices;\n","import React, { useEffect, useState } from 'react';\nimport PropTypes from 'prop-types';\n\nimport { SidePanel, ErrorBoundary, LoadingIndicatorProgress } from '@ohif/ui';\nimport { ServicesManager, HangingProtocolService, CommandsManager } from '@ohif/core';\nimport { useAppConfig } from '@state';\nimport ViewerHeader from './ViewerHeader';\nimport SidePanelWithServices from '../Components/SidePanelWithServices';\n\nfunction ViewerLayout({\n  // From Extension Module Params\n  extensionManager,\n  servicesManager,\n  hotkeysManager,\n  commandsManager,\n  // From Modes\n  viewports,\n  ViewportGridComp,\n  leftPanels = [],\n  rightPanels = [],\n  leftPanelDefaultClosed = false,\n  rightPanelDefaultClosed = false,\n}): React.FunctionComponent {\n  const [appConfig] = useAppConfig();\n\n  const { hangingProtocolService } = servicesManager.services;\n  const [showLoadingIndicator, setShowLoadingIndicator] = useState(appConfig.showLoadingIndicator);\n\n  /**\n   * Set body classes (tailwindcss) that don't allow vertical\n   * or horizontal overflow (no scrolling). Also guarantee window\n   * is sized to our viewport.\n   */\n  useEffect(() => {\n    document.body.classList.add('bg-black');\n    document.body.classList.add('overflow-hidden');\n    return () => {\n      document.body.classList.remove('bg-black');\n      document.body.classList.remove('overflow-hidden');\n    };\n  }, []);\n\n  const getComponent = id => {\n    const entry = extensionManager.getModuleEntry(id);\n\n    if (!entry) {\n      throw new Error(\n        `${id} is not valid for an extension module. Please verify your configuration or ensure that the extension is properly registered. It's also possible that your mode is utilizing a module from an extension that hasn't been included in its dependencies (add the extension to the \"extensionDependencies\" array in your mode's index.js file)`\n      );\n    }\n\n    let content;\n    if (entry && entry.component) {\n      content = entry.component;\n    } else {\n      throw new Error(\n        `No component found from extension ${id}. Check the reference string to the extension in your Mode configuration`\n      );\n    }\n\n    return { entry, content };\n  };\n\n  const getPanelData = id => {\n    const { content, entry } = getComponent(id);\n\n    return {\n      id: entry.id,\n      iconName: entry.iconName,\n      iconLabel: entry.iconLabel,\n      label: entry.label,\n      name: entry.name,\n      content,\n    };\n  };\n\n  useEffect(() => {\n    const { unsubscribe } = hangingProtocolService.subscribe(\n      HangingProtocolService.EVENTS.PROTOCOL_CHANGED,\n\n      // Todo: right now to set the loading indicator to false, we need to wait for the\n      // hangingProtocolService to finish applying the viewport matching to each viewport,\n      // however, this might not be the only approach to set the loading indicator to false. we need to explore this further.\n      () => {\n        setShowLoadingIndicator(false);\n      }\n    );\n\n    return () => {\n      unsubscribe();\n    };\n  }, [hangingProtocolService]);\n\n  const getViewportComponentData = viewportComponent => {\n    const { entry } = getComponent(viewportComponent.namespace);\n\n    return {\n      component: entry.component,\n      displaySetsToDisplay: viewportComponent.displaySetsToDisplay,\n    };\n  };\n\n  const leftPanelComponents = leftPanels.map(getPanelData);\n  const rightPanelComponents = rightPanels.map(getPanelData);\n  const viewportComponents = viewports.map(getViewportComponentData);\n\n  return (\n    <div>\n      <ViewerHeader\n        hotkeysManager={hotkeysManager}\n        extensionManager={extensionManager}\n        servicesManager={servicesManager}\n      />\n      <div\n        className=\"relative flex w-full flex-row flex-nowrap items-stretch overflow-hidden bg-black\"\n        style={{ height: 'calc(100vh - 52px' }}\n      >\n        <React.Fragment>\n          {showLoadingIndicator && <LoadingIndicatorProgress className=\"h-full w-full bg-black\" />}\n          {/* LEFT SIDEPANELS */}\n          {leftPanelComponents.length ? (\n            <ErrorBoundary context=\"Left Panel\">\n              <SidePanelWithServices\n                side=\"left\"\n                activeTabIndex={leftPanelDefaultClosed ? null : 0}\n                tabs={leftPanelComponents}\n                servicesManager={servicesManager}\n              />\n            </ErrorBoundary>\n          ) : null}\n          {/* TOOLBAR + GRID */}\n          <div className=\"flex h-full flex-1 flex-col\">\n            <div className=\"relative flex h-full flex-1 items-center justify-center overflow-hidden bg-black\">\n              <ErrorBoundary context=\"Grid\">\n                <ViewportGridComp\n                  servicesManager={servicesManager}\n                  viewportComponents={viewportComponents}\n                  commandsManager={commandsManager}\n                />\n              </ErrorBoundary>\n            </div>\n          </div>\n          {rightPanelComponents.length ? (\n            <ErrorBoundary context=\"Right Panel\">\n              <SidePanelWithServices\n                side=\"right\"\n                activeTabIndex={rightPanelDefaultClosed ? null : 0}\n                tabs={rightPanelComponents}\n                servicesManager={servicesManager}\n              />\n            </ErrorBoundary>\n          ) : null}\n        </React.Fragment>\n      </div>\n    </div>\n  );\n}\n\nViewerLayout.propTypes = {\n  // From extension module params\n  extensionManager: PropTypes.shape({\n    getModuleEntry: PropTypes.func.isRequired,\n  }).isRequired,\n  commandsManager: PropTypes.instanceOf(CommandsManager),\n  servicesManager: PropTypes.instanceOf(ServicesManager),\n  // From modes\n  leftPanels: PropTypes.array,\n  rightPanels: PropTypes.array,\n  leftPanelDefaultClosed: PropTypes.bool.isRequired,\n  rightPanelDefaultClosed: PropTypes.bool.isRequired,\n  /** Responsible for rendering our grid of viewports; provided by consuming application */\n  children: PropTypes.oneOfType([PropTypes.node, PropTypes.func]).isRequired,\n  viewports: PropTypes.array,\n};\n\nexport default ViewerLayout;\n","import React, { useState, useEffect, useRef } from 'react';\nimport PropTypes from 'prop-types';\nimport { StudyBrowser, useImageViewer, useViewportGrid } from '@ohif/ui';\nimport { utils } from '@ohif/core';\nimport { useNavigate } from 'react-router-dom';\n\nconst { sortStudyInstances, formatDate } = utils;\n\n/**\n *\n * @param {*} param0\n */\nfunction PanelStudyBrowser({\n  servicesManager,\n  getImageSrc,\n  getStudiesForPatientByMRN,\n  requestDisplaySetCreationForStudy,\n  dataSource,\n}) {\n  const { hangingProtocolService, displaySetService, uiNotificationService } =\n    servicesManager.services;\n  const navigate = useNavigate();\n\n  // Normally you nest the components so the tree isn't so deep, and the data\n  // doesn't have to have such an intense shape. This works well enough for now.\n  // Tabs --> Studies --> DisplaySets --> Thumbnails\n  const { StudyInstanceUIDs } = useImageViewer();\n  const [{ activeViewportId, viewports }, viewportGridService] = useViewportGrid();\n  const [activeTabName, setActiveTabName] = useState('primary');\n  const [expandedStudyInstanceUIDs, setExpandedStudyInstanceUIDs] = useState([\n    ...StudyInstanceUIDs,\n  ]);\n  const [studyDisplayList, setStudyDisplayList] = useState([]);\n  const [displaySets, setDisplaySets] = useState([]);\n  const [thumbnailImageSrcMap, setThumbnailImageSrcMap] = useState({});\n\n  const onDoubleClickThumbnailHandler = displaySetInstanceUID => {\n    let updatedViewports = [];\n    const viewportId = activeViewportId;\n    try {\n      updatedViewports = hangingProtocolService.getViewportsRequireUpdate(\n        viewportId,\n        displaySetInstanceUID\n      );\n    } catch (error) {\n      console.warn(error);\n      uiNotificationService.show({\n        title: 'Thumbnail Double Click',\n        message: 'The selected display sets could not be added to the viewport.',\n        type: 'info',\n        duration: 3000,\n      });\n    }\n\n    viewportGridService.setDisplaySetsForViewports(updatedViewports);\n  };\n\n  // ~~ studyDisplayList\n  useEffect(() => {\n    // Fetch all studies for the patient in each primary study\n    async function fetchStudiesForPatient(StudyInstanceUID) {\n      // current study qido\n      const qidoForStudyUID = await dataSource.query.studies.search({\n        studyInstanceUid: StudyInstanceUID,\n      });\n\n      if (!qidoForStudyUID?.length) {\n        navigate('/notfoundstudy', '_self');\n        throw new Error('Invalid study URL');\n      }\n\n      let qidoStudiesForPatient = qidoForStudyUID;\n\n      // try to fetch the prior studies based on the patientID if the\n      // server can respond.\n      try {\n        qidoStudiesForPatient = await getStudiesForPatientByMRN(qidoForStudyUID);\n      } catch (error) {\n        console.warn(error);\n      }\n\n      const mappedStudies = _mapDataSourceStudies(qidoStudiesForPatient);\n      const actuallyMappedStudies = mappedStudies.map(qidoStudy => {\n        return {\n          studyInstanceUid: qidoStudy.StudyInstanceUID,\n          date: formatDate(qidoStudy.StudyDate),\n          description: qidoStudy.StudyDescription,\n          modalities: qidoStudy.ModalitiesInStudy,\n          numInstances: qidoStudy.NumInstances,\n        };\n      });\n\n      setStudyDisplayList(prevArray => {\n        const ret = [...prevArray];\n        for (const study of actuallyMappedStudies) {\n          if (!prevArray.find(it => it.studyInstanceUid === study.studyInstanceUid)) {\n            ret.push(study);\n          }\n        }\n        return ret;\n      });\n    }\n\n    StudyInstanceUIDs.forEach(sid => fetchStudiesForPatient(sid));\n  }, [StudyInstanceUIDs, dataSource, getStudiesForPatientByMRN, navigate]);\n\n  // // ~~ Initial Thumbnails\n  useEffect(() => {\n    const currentDisplaySets = displaySetService.activeDisplaySets;\n    currentDisplaySets.forEach(async dSet => {\n      const newImageSrcEntry = {};\n      const displaySet = displaySetService.getDisplaySetByUID(dSet.displaySetInstanceUID);\n      const imageIds = dataSource.getImageIdsForDisplaySet(displaySet);\n      const imageId = imageIds[Math.floor(imageIds.length / 2)];\n\n      // TODO: Is it okay that imageIds are not returned here for SR displaySets?\n      if (!imageId || displaySet?.unsupported) {\n        return;\n      }\n      // When the image arrives, render it and store the result in the thumbnailImgSrcMap\n      newImageSrcEntry[dSet.displaySetInstanceUID] = await getImageSrc(imageId);\n\n      setThumbnailImageSrcMap(prevState => {\n        return { ...prevState, ...newImageSrcEntry };\n      });\n    });\n  }, [StudyInstanceUIDs, dataSource, displaySetService, getImageSrc]);\n\n  // ~~ displaySets\n  useEffect(() => {\n    // TODO: Are we sure `activeDisplaySets` will always be accurate?\n    const currentDisplaySets = displaySetService.activeDisplaySets;\n    const mappedDisplaySets = _mapDisplaySets(currentDisplaySets, thumbnailImageSrcMap);\n    sortStudyInstances(mappedDisplaySets);\n\n    setDisplaySets(mappedDisplaySets);\n  }, [StudyInstanceUIDs, thumbnailImageSrcMap, displaySetService]);\n\n  // ~~ subscriptions --> displaySets\n  useEffect(() => {\n    // DISPLAY_SETS_ADDED returns an array of DisplaySets that were added\n    const SubscriptionDisplaySetsAdded = displaySetService.subscribe(\n      displaySetService.EVENTS.DISPLAY_SETS_ADDED,\n      data => {\n        const { displaySetsAdded, options } = data;\n        displaySetsAdded.forEach(async dSet => {\n          const newImageSrcEntry = {};\n          const displaySet = displaySetService.getDisplaySetByUID(dSet.displaySetInstanceUID);\n          if (displaySet?.unsupported) {\n            return;\n          }\n\n          const imageIds = dataSource.getImageIdsForDisplaySet(displaySet);\n          const imageId = imageIds[Math.floor(imageIds.length / 2)];\n\n          // TODO: Is it okay that imageIds are not returned here for SR displaysets?\n          if (!imageId) {\n            return;\n          }\n          // When the image arrives, render it and store the result in the thumbnailImgSrcMap\n          newImageSrcEntry[dSet.displaySetInstanceUID] = await getImageSrc(\n            imageId,\n            dSet.initialViewport\n          );\n\n          setThumbnailImageSrcMap(prevState => {\n            return { ...prevState, ...newImageSrcEntry };\n          });\n        });\n      }\n    );\n\n    return () => {\n      SubscriptionDisplaySetsAdded.unsubscribe();\n    };\n  }, [getImageSrc, dataSource, displaySetService]);\n\n  useEffect(() => {\n    // TODO: Will this always hold _all_ the displaySets we care about?\n    // DISPLAY_SETS_CHANGED returns `DisplaySerService.activeDisplaySets`\n    const SubscriptionDisplaySetsChanged = displaySetService.subscribe(\n      displaySetService.EVENTS.DISPLAY_SETS_CHANGED,\n      changedDisplaySets => {\n        const mappedDisplaySets = _mapDisplaySets(changedDisplaySets, thumbnailImageSrcMap);\n        setDisplaySets(mappedDisplaySets);\n      }\n    );\n\n    const SubscriptionDisplaySetMetaDataInvalidated = displaySetService.subscribe(\n      displaySetService.EVENTS.DISPLAY_SET_SERIES_METADATA_INVALIDATED,\n      () => {\n        const mappedDisplaySets = _mapDisplaySets(\n          displaySetService.getActiveDisplaySets(),\n          thumbnailImageSrcMap\n        );\n\n        setDisplaySets(mappedDisplaySets);\n      }\n    );\n\n    return () => {\n      SubscriptionDisplaySetsChanged.unsubscribe();\n      SubscriptionDisplaySetMetaDataInvalidated.unsubscribe();\n    };\n  }, [StudyInstanceUIDs, thumbnailImageSrcMap, displaySetService]);\n\n  const tabs = _createStudyBrowserTabs(StudyInstanceUIDs, studyDisplayList, displaySets);\n\n  // TODO: Should not fire this on \"close\"\n  function _handleStudyClick(StudyInstanceUID) {\n    const shouldCollapseStudy = expandedStudyInstanceUIDs.includes(StudyInstanceUID);\n    const updatedExpandedStudyInstanceUIDs = shouldCollapseStudy\n      ? // eslint-disable-next-line prettier/prettier\n        [...expandedStudyInstanceUIDs.filter(stdyUid => stdyUid !== StudyInstanceUID)]\n      : [...expandedStudyInstanceUIDs, StudyInstanceUID];\n\n    setExpandedStudyInstanceUIDs(updatedExpandedStudyInstanceUIDs);\n\n    if (!shouldCollapseStudy) {\n      const madeInClient = true;\n      requestDisplaySetCreationForStudy(displaySetService, StudyInstanceUID, madeInClient);\n    }\n  }\n\n  const activeDisplaySetInstanceUIDs = viewports.get(activeViewportId)?.displaySetInstanceUIDs;\n\n  return (\n    <StudyBrowser\n      tabs={tabs}\n      servicesManager={servicesManager}\n      activeTabName={activeTabName}\n      onDoubleClickThumbnail={onDoubleClickThumbnailHandler}\n      activeDisplaySetInstanceUIDs={activeDisplaySetInstanceUIDs}\n      expandedStudyInstanceUIDs={expandedStudyInstanceUIDs}\n      onClickStudy={_handleStudyClick}\n      onClickTab={clickedTabName => {\n        setActiveTabName(clickedTabName);\n      }}\n    />\n  );\n}\n\nPanelStudyBrowser.propTypes = {\n  servicesManager: PropTypes.object.isRequired,\n  dataSource: PropTypes.shape({\n    getImageIdsForDisplaySet: PropTypes.func.isRequired,\n  }).isRequired,\n  getImageSrc: PropTypes.func.isRequired,\n  getStudiesForPatientByMRN: PropTypes.func.isRequired,\n  requestDisplaySetCreationForStudy: PropTypes.func.isRequired,\n};\n\nexport default PanelStudyBrowser;\n\n/**\n * Maps from the DataSource's format to a naturalized object\n *\n * @param {*} studies\n */\nfunction _mapDataSourceStudies(studies) {\n  return studies.map(study => {\n    // TODO: Why does the data source return in this format?\n    return {\n      AccessionNumber: study.accession,\n      StudyDate: study.date,\n      StudyDescription: study.description,\n      NumInstances: study.instances,\n      ModalitiesInStudy: study.modalities,\n      PatientID: study.mrn,\n      PatientName: study.patientName,\n      StudyInstanceUID: study.studyInstanceUid,\n      StudyTime: study.time,\n    };\n  });\n}\n\nfunction _mapDisplaySets(displaySets, thumbnailImageSrcMap) {\n  const thumbnailDisplaySets = [];\n  const thumbnailNoImageDisplaySets = [];\n\n  displaySets\n    .filter(ds => !ds.excludeFromThumbnailBrowser)\n    .forEach(ds => {\n      const imageSrc = thumbnailImageSrcMap[ds.displaySetInstanceUID];\n      const componentType = _getComponentType(ds);\n\n      const array =\n        componentType === 'thumbnail' ? thumbnailDisplaySets : thumbnailNoImageDisplaySets;\n\n      array.push({\n        displaySetInstanceUID: ds.displaySetInstanceUID,\n        description: ds.SeriesDescription || '',\n        seriesNumber: ds.SeriesNumber,\n        modality: ds.Modality,\n        seriesDate: ds.SeriesDate,\n        seriesTime: ds.SeriesTime,\n        numInstances: ds.numImageFrames,\n        countIcon: ds.countIcon,\n        StudyInstanceUID: ds.StudyInstanceUID,\n        messages: ds.messages,\n        componentType,\n        imageSrc,\n        dragData: {\n          type: 'displayset',\n          displaySetInstanceUID: ds.displaySetInstanceUID,\n          // .. Any other data to pass\n        },\n        isHydratedForDerivedDisplaySet: ds.isHydrated,\n      });\n    });\n\n  return [...thumbnailDisplaySets, ...thumbnailNoImageDisplaySets];\n}\n\nconst thumbnailNoImageModalities = ['SR', 'SEG', 'SM', 'RTSTRUCT', 'RTPLAN', 'RTDOSE'];\n\nfunction _getComponentType(ds) {\n  if (thumbnailNoImageModalities.includes(ds.Modality) || ds?.unsupported) {\n    // TODO probably others.\n    return 'thumbnailNoImage';\n  }\n\n  return 'thumbnail';\n}\n\n/**\n *\n * @param {string[]} primaryStudyInstanceUIDs\n * @param {object[]} studyDisplayList\n * @param {string} studyDisplayList.studyInstanceUid\n * @param {string} studyDisplayList.date\n * @param {string} studyDisplayList.description\n * @param {string} studyDisplayList.modalities\n * @param {number} studyDisplayList.numInstances\n * @param {object[]} displaySets\n * @returns tabs - The prop object expected by the StudyBrowser component\n */\nfunction _createStudyBrowserTabs(primaryStudyInstanceUIDs, studyDisplayList, displaySets) {\n  const primaryStudies = [];\n  const recentStudies = [];\n  const allStudies = [];\n\n  studyDisplayList.forEach(study => {\n    const displaySetsForStudy = displaySets.filter(\n      ds => ds.StudyInstanceUID === study.studyInstanceUid\n    );\n    const tabStudy = Object.assign({}, study, {\n      displaySets: displaySetsForStudy,\n    });\n\n    if (primaryStudyInstanceUIDs.includes(study.studyInstanceUid)) {\n      primaryStudies.push(tabStudy);\n    } else {\n      // TODO: Filter allStudies to dates within one year of current date\n      recentStudies.push(tabStudy);\n      allStudies.push(tabStudy);\n    }\n  });\n\n  const tabs = [\n    {\n      name: 'primary',\n      label: 'Primary',\n      studies: primaryStudies,\n    },\n    {\n      name: 'recent',\n      label: 'Recent',\n      studies: recentStudies,\n    },\n    {\n      name: 'all',\n      label: 'All',\n      studies: allStudies,\n    },\n  ];\n\n  return tabs;\n}\n","/**\n * @param {*} cornerstone\n * @param {*} imageId\n */\nfunction getImageSrcFromImageId(cornerstone, imageId) {\n  return new Promise((resolve, reject) => {\n    const canvas = document.createElement('canvas');\n    cornerstone.utilities\n      .loadImageToCanvas({ canvas, imageId })\n      .then(imageId => {\n        resolve(canvas.toDataURL());\n      })\n      .catch(reject);\n  });\n}\nexport default getImageSrcFromImageId;\n","async function getStudiesForPatientByMRN(dataSource, qidoForStudyUID) {\n  if (qidoForStudyUID && qidoForStudyUID.length && qidoForStudyUID[0].mrn) {\n    return dataSource.query.studies.search({\n      patientId: qidoForStudyUID[0].mrn,\n    });\n  }\n  console.log('No mrn found for', qidoForStudyUID);\n  return qidoForStudyUID;\n}\n\nexport default getStudiesForPatientByMRN;\n","function requestDisplaySetCreationForStudy(\n  dataSource,\n  displaySetService,\n  StudyInstanceUID,\n  madeInClient\n) {\n  // TODO: is this already short-circuited by the map of Retrieve promises?\n  if (\n    displaySetService.activeDisplaySets.some(\n      displaySet => displaySet.StudyInstanceUID === StudyInstanceUID\n    )\n  ) {\n    return;\n  }\n\n  dataSource.retrieve.series.metadata({ StudyInstanceUID, madeInClient });\n}\n\nexport default requestDisplaySetCreationForStudy;\n","import React, { useCallback } from 'react';\nimport PropTypes from 'prop-types';\n//\nimport PanelStudyBrowser from './PanelStudyBrowser';\nimport getImageSrcFromImageId from './getImageSrcFromImageId';\nimport getStudiesForPatientByMRN from './getStudiesForPatientByMRN';\nimport requestDisplaySetCreationForStudy from './requestDisplaySetCreationForStudy';\n\n/**\n * Wraps the PanelStudyBrowser and provides features afforded by managers/services\n *\n * @param {object} params\n * @param {object} commandsManager\n * @param {object} extensionManager\n */\nfunction WrappedPanelStudyBrowser({ commandsManager, extensionManager, servicesManager }) {\n  // TODO: This should be made available a different way; route should have\n  // already determined our datasource\n  const dataSource = extensionManager.getDataSources()[0];\n  const _getStudiesForPatientByMRN = getStudiesForPatientByMRN.bind(null, dataSource);\n  const _getImageSrcFromImageId = useCallback(\n    _createGetImageSrcFromImageIdFn(extensionManager),\n    []\n  );\n  const _requestDisplaySetCreationForStudy = requestDisplaySetCreationForStudy.bind(\n    null,\n    dataSource\n  );\n\n  return (\n    <PanelStudyBrowser\n      servicesManager={servicesManager}\n      dataSource={dataSource}\n      getImageSrc={_getImageSrcFromImageId}\n      getStudiesForPatientByMRN={_getStudiesForPatientByMRN}\n      requestDisplaySetCreationForStudy={_requestDisplaySetCreationForStudy}\n    />\n  );\n}\n\n/**\n * Grabs cornerstone library reference using a dependent command from\n * the @ohif/extension-cornerstone extension. Then creates a helper function\n * that can take an imageId and return an image src.\n *\n * @param {func} getCommand - CommandManager's getCommand method\n * @returns {func} getImageSrcFromImageId - A utility function powered by\n * cornerstone\n */\nfunction _createGetImageSrcFromImageIdFn(extensionManager) {\n  const utilities = extensionManager.getModuleEntry(\n    '@ohif/extension-cornerstone.utilityModule.common'\n  );\n\n  try {\n    const { cornerstone } = utilities.exports.getCornerstoneLibraries();\n    return getImageSrcFromImageId.bind(null, cornerstone);\n  } catch (ex) {\n    throw new Error('Required command not found');\n  }\n}\n\nWrappedPanelStudyBrowser.propTypes = {\n  commandsManager: PropTypes.object.isRequired,\n  extensionManager: PropTypes.object.isRequired,\n  servicesManager: PropTypes.object.isRequired,\n};\n\nexport default WrappedPanelStudyBrowser;\n","import React from 'react';\nimport PropTypes from 'prop-types';\nimport { useTranslation } from 'react-i18next';\n\nimport { LegacyButton, LegacyButtonGroup } from '@ohif/ui';\n\nfunction ActionButtons({ onExportClick, onCreateReportClick }) {\n  const { t } = useTranslation('MeasurementTable');\n\n  return (\n    <React.Fragment>\n      <LegacyButtonGroup\n        color=\"black\"\n        size=\"inherit\"\n      >\n        {/* TODO Revisit design of LegacyButtonGroup later - for now use LegacyButton for its children.*/}\n        <LegacyButton\n          className=\"px-2 py-2 text-base\"\n          onClick={onExportClick}\n        >\n          {t('Export CSV')}\n        </LegacyButton>\n        <LegacyButton\n          className=\"px-2 py-2 text-base\"\n          onClick={onCreateReportClick}\n        >\n          {t('Create Report')}\n        </LegacyButton>\n      </LegacyButtonGroup>\n    </React.Fragment>\n  );\n}\n\nActionButtons.propTypes = {\n  onExportClick: PropTypes.func,\n  onCreateReportClick: PropTypes.func,\n};\n\nActionButtons.defaultProps = {\n  onExportClick: () => alert('Export'),\n  onCreateReportClick: () => alert('Create Report'),\n};\n\nexport default ActionButtons;\n","import React from 'react';\n\nimport { ButtonEnums, Dialog, Input, Select } from '@ohif/ui';\n\nexport const CREATE_REPORT_DIALOG_RESPONSE = {\n  CANCEL: 0,\n  CREATE_REPORT: 1,\n};\n\nexport default function CreateReportDialogPrompt(uiDialogService, { extensionManager }) {\n  return new Promise(function (resolve, reject) {\n    let dialogId = undefined;\n\n    const _handleClose = () => {\n      // Dismiss dialog\n      uiDialogService.dismiss({ id: dialogId });\n      // Notify of cancel action\n      resolve({\n        action: CREATE_REPORT_DIALOG_RESPONSE.CANCEL,\n        value: undefined,\n        dataSourceName: undefined,\n      });\n    };\n\n    /**\n     *\n     * @param {string} param0.action - value of action performed\n     * @param {string} param0.value - value from input field\n     */\n    const _handleFormSubmit = ({ action, value }) => {\n      uiDialogService.dismiss({ id: dialogId });\n      switch (action.id) {\n        case 'save':\n          resolve({\n            action: CREATE_REPORT_DIALOG_RESPONSE.CREATE_REPORT,\n            value: value.label,\n            dataSourceName: value.dataSourceName,\n          });\n          break;\n        case 'cancel':\n          resolve({\n            action: CREATE_REPORT_DIALOG_RESPONSE.CANCEL,\n            value: undefined,\n            dataSourceName: undefined,\n          });\n          break;\n      }\n    };\n\n    const dataSourcesOpts = Object.keys(extensionManager.dataSourceMap)\n      .filter(ds => {\n        const configuration = extensionManager.dataSourceDefs[ds]?.configuration;\n        const supportsStow = configuration?.supportsStow ?? configuration?.wadoRoot;\n        return supportsStow;\n      })\n      .map(ds => {\n        return {\n          value: ds,\n          label: ds,\n          placeHolder: ds,\n        };\n      });\n\n    dialogId = uiDialogService.create({\n      centralize: true,\n      isDraggable: false,\n      content: Dialog,\n      useLastPosition: false,\n      showOverlay: true,\n      contentProps: {\n        title: 'Create Report',\n        value: {\n          label: '',\n          dataSourceName: extensionManager.activeDataSource,\n        },\n        noCloseButton: true,\n        onClose: _handleClose,\n        actions: [\n          { id: 'cancel', text: 'Cancel', type: ButtonEnums.type.secondary },\n          { id: 'save', text: 'Save', type: ButtonEnums.type.primary },\n        ],\n        // TODO: Should be on button press...\n        onSubmit: _handleFormSubmit,\n        body: ({ value, setValue }) => {\n          const onChangeHandler = event => {\n            event.persist();\n            setValue(value => ({ ...value, label: event.target.value }));\n          };\n          const onKeyPressHandler = event => {\n            if (event.key === 'Enter') {\n              uiDialogService.dismiss({ id: dialogId });\n              resolve({\n                action: CREATE_REPORT_DIALOG_RESPONSE.CREATE_REPORT,\n                value: value.label,\n              });\n            }\n          };\n          return (\n            <>\n              {dataSourcesOpts.length > 1 && window.config?.allowMultiSelectExport && (\n                <div>\n                  <label className=\"text-[14px] leading-[1.2] text-white\">Data Source</label>\n                  <Select\n                    closeMenuOnSelect={true}\n                    className=\"border-primary-main  mt-2 bg-black\"\n                    options={dataSourcesOpts}\n                    placeholder={\n                      dataSourcesOpts.find(option => option.value === value.dataSourceName)\n                        .placeHolder\n                    }\n                    value={value.dataSourceName}\n                    onChange={evt => {\n                      setValue(v => ({ ...v, dataSourceName: evt.value }));\n                    }}\n                    isClearable={false}\n                  />\n                </div>\n              )}\n              <div className=\"mt-3\">\n                <Input\n                  autoFocus\n                  label=\"Enter the report name\"\n                  labelClassName=\"text-white text-[14px] leading-[1.2]\"\n                  className=\"border-primary-main bg-black\"\n                  type=\"text\"\n                  value={value.label}\n                  onChange={onChangeHandler}\n                  onKeyPress={onKeyPressHandler}\n                  required\n                />\n              </div>\n            </>\n          );\n        },\n      },\n    });\n  });\n}\n","import React from 'react';\nimport { DicomMetadataStore } from '@ohif/core';\n\n/**\n *\n * @param {*} servicesManager\n */\nasync function createReportAsync({ servicesManager, getReport, reportType = 'measurement' }) {\n  const { displaySetService, uiNotificationService, uiDialogService } = servicesManager.services;\n  const loadingDialogId = uiDialogService.create({\n    showOverlay: true,\n    isDraggable: false,\n    centralize: true,\n    content: Loading,\n  });\n\n  try {\n    const naturalizedReport = await getReport();\n\n    // The \"Mode\" route listens for DicomMetadataStore changes\n    // When a new instance is added, it listens and\n    // automatically calls makeDisplaySets\n    DicomMetadataStore.addInstances([naturalizedReport], true);\n\n    const displaySet = displaySetService.getMostRecentDisplaySet();\n\n    const displaySetInstanceUID = displaySet.displaySetInstanceUID;\n\n    uiNotificationService.show({\n      title: 'Create Report',\n      message: `${reportType} saved successfully`,\n      type: 'success',\n    });\n\n    return [displaySetInstanceUID];\n  } catch (error) {\n    uiNotificationService.show({\n      title: 'Create Report',\n      message: error.message || `Failed to store ${reportType}`,\n      type: 'error',\n    });\n  } finally {\n    uiDialogService.dismiss({ id: loadingDialogId });\n  }\n}\n\nfunction Loading() {\n  return <div className=\"text-primary-active\">Loading...</div>;\n}\n\nexport default createReportAsync;\n","const MIN_SR_SERIES_NUMBER = 4700;\n\nexport default function getNextSRSeriesNumber(displaySetService) {\n  const activeDisplaySets = displaySetService.getActiveDisplaySets();\n  const srDisplaySets = activeDisplaySets.filter(ds => ds.Modality === 'SR');\n  const srSeriesNumbers = srDisplaySets.map(ds => ds.SeriesNumber);\n  const maxSeriesNumber = Math.max(...srSeriesNumbers, MIN_SR_SERIES_NUMBER);\n\n  return maxSeriesNumber + 1;\n}\n","import { DisplaySetService, Types } from '@ohif/core';\n\nimport getNextSRSeriesNumber from './getNextSRSeriesNumber';\n\n/**\n * Find an SR having the same series description.\n * This is used by the store service in order to store DICOM SR's having the\n * same Series Description into a single series under consecutive instance numbers\n * That way, they are all organized as a set and could have tools to view\n * \"prior\" SR instances.\n *\n * @param SeriesDescription - is the description to look for\n * @param displaySetService - the display sets to search for DICOM SR in\n * @returns SeriesMetadata from a DICOM SR having the same series description\n */\nexport default function findSRWithSameSeriesDescription(\n  SeriesDescription: string,\n  displaySetService: DisplaySetService\n): Types.SeriesMetadata {\n  const activeDisplaySets = displaySetService.getActiveDisplaySets();\n  const srDisplaySets = activeDisplaySets.filter(ds => ds.Modality === 'SR');\n  const sameSeries = srDisplaySets.find(ds => ds.SeriesDescription === SeriesDescription);\n  if (sameSeries) {\n    console.log('Storing to same series', sameSeries);\n    const { instance } = sameSeries;\n    const { SeriesInstanceUID, SeriesDescription, SeriesDate, SeriesTime, SeriesNumber, Modality } =\n      instance;\n    return {\n      SeriesInstanceUID,\n      SeriesDescription,\n      SeriesDate,\n      SeriesTime,\n      SeriesNumber,\n      Modality,\n      InstanceNumber: sameSeries.instances.length + 1,\n    };\n  }\n\n  const SeriesNumber = getNextSRSeriesNumber(displaySetService);\n  return { SeriesDescription, SeriesNumber };\n}\n","import React, { useEffect, useState } from 'react';\nimport PropTypes from 'prop-types';\nimport { useTranslation } from 'react-i18next';\nimport { utils, ServicesManager } from '@ohif/core';\nimport { MeasurementTable, Dialog, Input, useViewportGrid, ButtonEnums } from '@ohif/ui';\nimport ActionButtons from './ActionButtons';\nimport debounce from 'lodash.debounce';\n\nimport createReportDialogPrompt, {\n  CREATE_REPORT_DIALOG_RESPONSE,\n} from './createReportDialogPrompt';\nimport createReportAsync from '../Actions/createReportAsync';\nimport findSRWithSameSeriesDescription from '../utils/findSRWithSameSeriesDescription';\n\nconst { downloadCSVReport } = utils;\n\nexport default function PanelMeasurementTable({\n  servicesManager,\n  commandsManager,\n  extensionManager,\n}): React.FunctionComponent {\n  const { t } = useTranslation('MeasurementTable');\n\n  const [viewportGrid, viewportGridService] = useViewportGrid();\n  const { activeViewportId, viewports } = viewportGrid;\n  const { measurementService, uiDialogService, uiNotificationService, displaySetService } = (\n    servicesManager as ServicesManager\n  ).services;\n  const [displayMeasurements, setDisplayMeasurements] = useState([]);\n\n  useEffect(() => {\n    const debouncedSetDisplayMeasurements = debounce(setDisplayMeasurements, 100);\n    // ~~ Initial\n    setDisplayMeasurements(_getMappedMeasurements(measurementService));\n\n    // ~~ Subscription\n    const added = measurementService.EVENTS.MEASUREMENT_ADDED;\n    const addedRaw = measurementService.EVENTS.RAW_MEASUREMENT_ADDED;\n    const updated = measurementService.EVENTS.MEASUREMENT_UPDATED;\n    const removed = measurementService.EVENTS.MEASUREMENT_REMOVED;\n    const cleared = measurementService.EVENTS.MEASUREMENTS_CLEARED;\n    const subscriptions = [];\n\n    [added, addedRaw, updated, removed, cleared].forEach(evt => {\n      subscriptions.push(\n        measurementService.subscribe(evt, () => {\n          debouncedSetDisplayMeasurements(_getMappedMeasurements(measurementService));\n        }).unsubscribe\n      );\n    });\n\n    return () => {\n      subscriptions.forEach(unsub => {\n        unsub();\n      });\n      debouncedSetDisplayMeasurements.cancel();\n    };\n  }, []);\n\n  async function exportReport() {\n    const measurements = measurementService.getMeasurements();\n\n    downloadCSVReport(measurements, measurementService);\n  }\n\n  async function clearMeasurements() {\n    measurementService.clearMeasurements();\n  }\n\n  async function createReport(): Promise<any> {\n    // filter measurements that are added to the active study\n    const activeViewport = viewports.get(activeViewportId);\n    const measurements = measurementService.getMeasurements();\n    const displaySet = displaySetService.getDisplaySetByUID(\n      activeViewport.displaySetInstanceUIDs[0]\n    );\n    const trackedMeasurements = measurements.filter(\n      m => displaySet.StudyInstanceUID === m.referenceStudyUID\n    );\n\n    if (trackedMeasurements.length <= 0) {\n      uiNotificationService.show({\n        title: 'No Measurements',\n        message: 'No Measurements are added to the current Study.',\n        type: 'info',\n        duration: 3000,\n      });\n      return;\n    }\n\n    const promptResult = await createReportDialogPrompt(uiDialogService, {\n      extensionManager,\n    });\n\n    if (promptResult.action === CREATE_REPORT_DIALOG_RESPONSE.CREATE_REPORT) {\n      const dataSources = extensionManager.getDataSources(promptResult.dataSourceName);\n      const dataSource = dataSources[0];\n\n      const SeriesDescription =\n        // isUndefinedOrEmpty\n        promptResult.value === undefined || promptResult.value === ''\n          ? 'Research Derived Series' // default\n          : promptResult.value; // provided value\n\n      // Reuse an existing series having the same series description to avoid\n      // creating too many series instances.\n      const options = findSRWithSameSeriesDescription(SeriesDescription, displaySetService);\n\n      const getReport = async () => {\n        return commandsManager.runCommand(\n          'storeMeasurements',\n          {\n            measurementData: trackedMeasurements,\n            dataSource,\n            additionalFindingTypes: ['ArrowAnnotate'],\n            options,\n          },\n          'CORNERSTONE_STRUCTURED_REPORT'\n        );\n      };\n\n      return createReportAsync({ servicesManager, getReport });\n    }\n  }\n\n  const jumpToImage = ({ uid, isActive }) => {\n    measurementService.jumpToMeasurement(viewportGrid.activeViewportId, uid);\n\n    onMeasurementItemClickHandler({ uid, isActive });\n  };\n\n  const onMeasurementItemEditHandler = ({ uid, isActive }) => {\n    const measurement = measurementService.getMeasurement(uid);\n    //Todo: why we are jumping to image?\n    // jumpToImage({ id, isActive });\n\n    const onSubmitHandler = ({ action, value }) => {\n      switch (action.id) {\n        case 'save': {\n          measurementService.update(\n            uid,\n            {\n              ...measurement,\n              ...value,\n            },\n            true\n          );\n        }\n      }\n      uiDialogService.dismiss({ id: 'enter-annotation' });\n    };\n\n    uiDialogService.create({\n      id: 'enter-annotation',\n      centralize: true,\n      isDraggable: false,\n      showOverlay: true,\n      content: Dialog,\n      contentProps: {\n        title: 'Annotation',\n        noCloseButton: true,\n        value: { label: measurement.label || '' },\n        body: ({ value, setValue }) => {\n          const onChangeHandler = event => {\n            event.persist();\n            setValue(value => ({ ...value, label: event.target.value }));\n          };\n\n          const onKeyPressHandler = event => {\n            if (event.key === 'Enter') {\n              onSubmitHandler({ value, action: { id: 'save' } });\n            }\n          };\n          return (\n            <Input\n              label=\"Enter your annotation\"\n              labelClassName=\"text-white text-[14px] leading-[1.2]\"\n              autoFocus\n              id=\"annotation\"\n              className=\"border-primary-main bg-black\"\n              type=\"text\"\n              value={value.label}\n              onChange={onChangeHandler}\n              onKeyPress={onKeyPressHandler}\n            />\n          );\n        },\n        actions: [\n          { id: 'cancel', text: 'Cancel', type: ButtonEnums.type.secondary },\n          { id: 'save', text: 'Save', type: ButtonEnums.type.primary },\n        ],\n        onSubmit: onSubmitHandler,\n      },\n    });\n  };\n\n  const onMeasurementItemClickHandler = ({ uid, isActive }) => {\n    if (!isActive) {\n      const measurements = [...displayMeasurements];\n      const measurement = measurements.find(m => m.uid === uid);\n\n      measurements.forEach(m => (m.isActive = m.uid !== uid ? false : true));\n      measurement.isActive = true;\n      setDisplayMeasurements(measurements);\n    }\n  };\n\n  return (\n    <>\n      <div\n        className=\"ohif-scrollbar overflow-y-auto overflow-x-hidden\"\n        data-cy={'measurements-panel'}\n      >\n        <MeasurementTable\n          title={t(\"Measurements\")}\n          servicesManager={servicesManager}\n          data={displayMeasurements}\n          onClick={jumpToImage}\n          onEdit={onMeasurementItemEditHandler}\n        />\n      </div>\n      <div className=\"flex justify-center p-4\">\n        <ActionButtons\n          onExportClick={exportReport}\n          onClearMeasurementsClick={clearMeasurements}\n          onCreateReportClick={createReport}\n        />\n      </div>\n    </>\n  );\n}\n\nPanelMeasurementTable.propTypes = {\n  servicesManager: PropTypes.instanceOf(ServicesManager).isRequired,\n};\n\nfunction _getMappedMeasurements(measurementService) {\n  const measurements = measurementService.getMeasurements();\n\n  const mappedMeasurements = measurements.map((m, index) =>\n    _mapMeasurementToDisplay(m, index, measurementService.VALUE_TYPES)\n  );\n\n  return mappedMeasurements;\n}\n\n/**\n * Map the measurements to the display text.\n * Adds finding and site information to the displayText and/or label,\n * and provides as 'displayText' and 'label', while providing the original\n * values as baseDisplayText and baseLabel\n */\nfunction _mapMeasurementToDisplay(measurement, index, types) {\n  const {\n    displayText: baseDisplayText,\n    uid,\n    label: baseLabel,\n    type,\n    selected,\n    findingSites,\n    finding,\n  } = measurement;\n\n  const firstSite = findingSites?.[0];\n  const label = baseLabel || finding?.text || firstSite?.text || '(empty)';\n  let displayText = baseDisplayText || [];\n  if (findingSites) {\n    const siteText = [];\n    findingSites.forEach(site => {\n      if (site?.text !== label) {\n        siteText.push(site.text);\n      }\n    });\n    displayText = [...siteText, ...displayText];\n  }\n  if (finding && finding?.text !== label) {\n    displayText = [finding.text, ...displayText];\n  }\n\n  return {\n    uid,\n    label,\n    baseLabel,\n    measurementType: type,\n    displayText,\n    baseDisplayText,\n    isActive: selected,\n    finding,\n    findingSites,\n  };\n}\n","import React from 'react';\nimport { WrappedPanelStudyBrowser, PanelMeasurementTable } from './Panels';\nimport i18n from 'i18next';\n\n// TODO:\n// - No loading UI exists yet\n// - cancel promises when component is destroyed\n// - show errors in UI for thumbnails if promise fails\n\nfunction getPanelModule({ commandsManager, extensionManager, servicesManager }) {\n  const wrappedMeasurementPanel = () => {\n    return (\n      <PanelMeasurementTable\n        commandsManager={commandsManager}\n        servicesManager={servicesManager}\n        extensionManager={extensionManager}\n      />\n    );\n  };\n\n  return [\n    {\n      name: 'seriesList',\n      iconName: 'tab-studies',\n      iconLabel: 'Studies',\n      label: i18n.t('SidePanel:Studies'),\n      component: WrappedPanelStudyBrowser.bind(null, {\n        commandsManager,\n        extensionManager,\n        servicesManager,\n      }),\n    },\n    {\n      name: 'measure',\n      iconName: 'tab-linear',\n      iconLabel: 'Measure',\n      label: i18n.t('SidePanel:Measurements'),\n      secondaryLabel: i18n.t('SidePanel:Measurements'),\n      component: wrappedMeasurementPanel,\n    },\n  ];\n}\n\nexport default getPanelModule;\n","import packageJson from '../package.json';\n\nconst id = packageJson.name;\n\nexport { id };\n","import { vec3 } from 'gl-matrix';\nimport toNumber from '@ohif/core/src/utils/toNumber';\nimport { _getPerpendicularDistance } from '@ohif/core/src/utils/isDisplaySetReconstructable';\nimport calculateScanAxisNormal from '../calculateScanAxisNormal';\n\n/**\n * Checks if there is a position shift between consecutive frames\n * @param {*} previousPosition\n * @param {*} actualPosition\n * @param {*} scanAxisNormal\n * @param {*} averageSpacingBetweenFrames\n * @returns\n */\nfunction _checkSeriesPositionShift(\n  previousPosition,\n  actualPosition,\n  scanAxisNormal,\n  averageSpacingBetweenFrames\n) {\n  // predicted position should be the previous position added by the multiplication\n  // of the scanAxisNormal and the average spacing between frames\n  const predictedPosition = vec3.scaleAndAdd(\n    vec3.create(),\n    previousPosition,\n    scanAxisNormal,\n    averageSpacingBetweenFrames\n  );\n  return vec3.distance(actualPosition, predictedPosition) > averageSpacingBetweenFrames;\n}\n\n/**\n * Checks if a series has position shifts between consecutive frames\n * @param {*} instances\n * @returns\n */\nexport default function areAllImagePositionsEqual(instances: Array<any>): boolean {\n  if (!instances?.length) {\n    return false;\n  }\n  const firstImageOrientationPatient = toNumber(instances[0].ImageOrientationPatient);\n  if (!firstImageOrientationPatient) {\n    return false;\n  }\n  const scanAxisNormal = calculateScanAxisNormal(firstImageOrientationPatient);\n  const firstImagePositionPatient = toNumber(instances[0].ImagePositionPatient);\n  const lastIpp = toNumber(instances[instances.length - 1].ImagePositionPatient);\n\n  const averageSpacingBetweenFrames =\n    _getPerpendicularDistance(firstImagePositionPatient, lastIpp) / (instances.length - 1);\n\n  let previousImagePositionPatient = firstImagePositionPatient;\n  for (let i = 1; i < instances.length; i++) {\n    const instance = instances[i];\n    const imagePositionPatient = toNumber(instance.ImagePositionPatient);\n\n    if (\n      _checkSeriesPositionShift(\n        previousImagePositionPatient,\n        imagePositionPatient,\n        scanAxisNormal,\n        averageSpacingBetweenFrames\n      )\n    ) {\n      return false;\n    }\n    previousImagePositionPatient = imagePositionPatient;\n  }\n  return true;\n}\n","import { vec3 } from 'gl-matrix';\n\n/**\n * Calculates the scanAxisNormal based on a image orientation vector extract from a frame\n * @param {*} imageOrientation\n * @returns\n */\nexport default function calculateScanAxisNormal(imageOrientation) {\n  const rowCosineVec = vec3.fromValues(\n    imageOrientation[0],\n    imageOrientation[1],\n    imageOrientation[2]\n  );\n  const colCosineVec = vec3.fromValues(\n    imageOrientation[3],\n    imageOrientation[4],\n    imageOrientation[5]\n  );\n  return vec3.cross(vec3.create(), rowCosineVec, colCosineVec);\n}\n","import areAllImageDimensionsEqual from './areAllImageDimensionsEqual';\nimport areAllImageComponentsEqual from './areAllImageComponentsEqual';\nimport areAllImageOrientationsEqual from './areAllImageOrientationsEqual';\nimport areAllImagePositionsEqual from './areAllImagePositionsEqual';\nimport areAllImageSpacingEqual from './areAllImageSpacingEqual';\nimport { DisplaySetMessage, DisplaySetMessageList } from '@ohif/core';\n\n/**\n * Runs various checks in a single frame series\n * @param {*} instances\n * @param {*} warnings\n */\nexport default function checkSingleFrames(\n  instances: Array<any>,\n  messages: DisplaySetMessageList\n): void {\n  if (instances.length > 2) {\n    if (!areAllImageDimensionsEqual(instances)) {\n      messages.addMessage(DisplaySetMessage.CODES.INCONSISTENT_DIMENSIONS);\n    }\n\n    if (!areAllImageComponentsEqual(instances)) {\n      messages.addMessage(DisplaySetMessage.CODES.INCONSISTENT_COMPONENTS);\n    }\n\n    if (!areAllImageOrientationsEqual(instances)) {\n      messages.addMessage(DisplaySetMessage.CODES.INCONSISTENT_ORIENTATIONS);\n    }\n\n    if (!areAllImagePositionsEqual(instances)) {\n      messages.addMessage(DisplaySetMessage.CODES.INCONSISTENT_POSITION_INFORMATION);\n    }\n    areAllImageSpacingEqual(instances, messages);\n  }\n}\n","import toNumber from '@ohif/core/src/utils/toNumber';\n\n/**\n * Check if the frames in a series has different dimensions\n * @param {*} instances\n * @returns\n */\nexport default function areAllImageDimensionsEqual(instances: Array<any>): boolean {\n  if (!instances?.length) {\n    return false;\n  }\n  const firstImage = instances[0];\n  const firstImageRows = toNumber(firstImage.Rows);\n  const firstImageColumns = toNumber(firstImage.Columns);\n\n  for (let i = 1; i < instances.length; i++) {\n    const instance = instances[i];\n    const { Rows, Columns } = instance;\n\n    if (Rows !== firstImageRows || Columns !== firstImageColumns) {\n      return false;\n    }\n  }\n  return true;\n}\n","import toNumber from '@ohif/core/src/utils/toNumber';\n\n/**\n * Check if all voxels in series images has same number of components (samplesPerPixel)\n * @param {*} instances\n * @returns\n */\nexport default function areAllImageComponentsEqual(instances: Array<any>): boolean {\n  if (!instances?.length) {\n    return false;\n  }\n  const firstImage = instances[0];\n  const firstImageSamplesPerPixel = toNumber(firstImage.SamplesPerPixel);\n\n  for (let i = 1; i < instances.length; i++) {\n    const instance = instances[i];\n    const { SamplesPerPixel } = instance;\n\n    if (SamplesPerPixel !== firstImageSamplesPerPixel) {\n      return false;\n    }\n  }\n  return true;\n}\n","import toNumber from '@ohif/core/src/utils/toNumber';\nimport { _isSameOrientation } from '@ohif/core/src/utils/isDisplaySetReconstructable';\n\n/**\n * Check is the series has frames with different orientations\n * @param {*} instances\n * @returns\n */\nexport default function areAllImageOrientationsEqual(instances: Array<any>): boolean {\n  if (!instances?.length) {\n    return false;\n  }\n  const firstImage = instances[0];\n  const firstImageOrientationPatient = toNumber(firstImage.ImageOrientationPatient);\n\n  for (let i = 1; i < instances.length; i++) {\n    const instance = instances[i];\n    const imageOrientationPatient = toNumber(instance.ImageOrientationPatient);\n\n    if (!_isSameOrientation(imageOrientationPatient, firstImageOrientationPatient)) {\n      return false;\n    }\n  }\n  return true;\n}\n","import {\n  _getPerpendicularDistance,\n  _getSpacingIssue,\n  reconstructionIssues,\n} from '@ohif/core/src/utils/isDisplaySetReconstructable';\nimport { DisplaySetMessage } from '@ohif/core';\nimport toNumber from '@ohif/core/src/utils/toNumber';\nimport { DisplaySetMessageList } from '@ohif/core';\n\n/**\n * Checks if series has spacing issues\n * @param {*} instances\n * @param {*} warnings\n */\nexport default function areAllImageSpacingEqual(\n  instances: Array<any>,\n  messages: DisplaySetMessageList\n): void {\n  if (!instances?.length) {\n    return;\n  }\n  const firstImagePositionPatient = toNumber(instances[0].ImagePositionPatient);\n  if (!firstImagePositionPatient) {\n    return;\n  }\n  const lastIpp = toNumber(instances[instances.length - 1].ImagePositionPatient);\n\n  const averageSpacingBetweenFrames =\n    _getPerpendicularDistance(firstImagePositionPatient, lastIpp) / (instances.length - 1);\n\n  let previousImagePositionPatient = firstImagePositionPatient;\n\n  const issuesFound = [];\n  for (let i = 1; i < instances.length; i++) {\n    const instance = instances[i];\n    const imagePositionPatient = toNumber(instance.ImagePositionPatient);\n\n    const spacingBetweenFrames = _getPerpendicularDistance(\n      imagePositionPatient,\n      previousImagePositionPatient\n    );\n\n    const spacingIssue = _getSpacingIssue(spacingBetweenFrames, averageSpacingBetweenFrames);\n\n    if (spacingIssue) {\n      const issue = spacingIssue.issue;\n\n      // avoid multiple warning of the same thing\n      if (!issuesFound.includes(issue)) {\n        issuesFound.push(issue);\n        if (issue === reconstructionIssues.MISSING_FRAMES) {\n          messages.addMessage(DisplaySetMessage.CODES.MISSING_FRAMES);\n        } else if (issue === reconstructionIssues.IRREGULAR_SPACING) {\n          messages.addMessage(DisplaySetMessage.CODES.IRREGULAR_SPACING);\n        }\n      }\n      // we just want to find issues not how many\n      if (issuesFound.length > 1) {\n        break;\n      }\n    }\n    previousImagePositionPatient = imagePositionPatient;\n  }\n}\n","import sortInstancesByPosition from '@ohif/core/src/utils/sortInstancesByPosition';\nimport { constructableModalities } from '@ohif/core/src/utils/isDisplaySetReconstructable';\nimport { DisplaySetMessage, DisplaySetMessageList } from '@ohif/core';\nimport checkMultiFrame from './utils/validations/checkMultiframe';\nimport checkSingleFrames from './utils/validations/checkSingleFrames';\n/**\n * Checks if a series is reconstructable to a 3D volume.\n *\n * @param {Object[]} instances An array of `OHIFInstanceMetadata` objects.\n */\nexport default function getDisplaySetMessages(\n  instances: Array<any>,\n  isReconstructable: boolean\n): DisplaySetMessageList {\n  const messages = new DisplaySetMessageList();\n  if (!instances.length) {\n    messages.addMessage(DisplaySetMessage.CODES.NO_VALID_INSTANCES);\n    return;\n  }\n\n  const firstInstance = instances[0];\n  const { Modality, ImageType, NumberOfFrames } = firstInstance;\n  // Due to current requirements, LOCALIZER series doesn't have any messages\n  if (ImageType?.includes('LOCALIZER')) {\n    return messages;\n  }\n\n  if (!constructableModalities.includes(Modality)) {\n    return messages;\n  }\n\n  const isMultiframe = NumberOfFrames > 1;\n  // Can't reconstruct if all instances don't have the ImagePositionPatient.\n  if (!isMultiframe && !instances.every(instance => instance.ImagePositionPatient)) {\n    messages.addMessage(DisplaySetMessage.CODES.NO_POSITION_INFORMATION);\n  }\n\n  const sortedInstances = sortInstancesByPosition(instances);\n\n  isMultiframe\n    ? checkMultiFrame(sortedInstances[0], messages)\n    : checkSingleFrames(sortedInstances, messages);\n\n  if (!isReconstructable) {\n    messages.addMessage(DisplaySetMessage.CODES.NOT_RECONSTRUCTABLE);\n  }\n  return messages;\n}\n","import {\n  hasPixelMeasurements,\n  hasOrientation,\n  hasPosition,\n} from '@ohif/core/src/utils/isDisplaySetReconstructable';\nimport { DisplaySetMessage, DisplaySetMessageList } from '@ohif/core';\n\n/**\n * Check various multi frame issues. It calls OHIF core functions\n * @param {*} multiFrameInstance\n * @param {*} warnings\n */\nexport default function checkMultiFrame(multiFrameInstance, messages: DisplaySetMessageList): void {\n  if (!hasPixelMeasurements(multiFrameInstance)) {\n    messages.addMessage(DisplaySetMessage.CODES.MULTIFRAME_NO_PIXEL_MEASUREMENTS);\n  }\n\n  if (!hasOrientation(multiFrameInstance)) {\n    messages.addMessage(DisplaySetMessage.CODES.MULTIFRAME_NO_ORIENTATION);\n  }\n\n  if (!hasPosition(multiFrameInstance)) {\n    messages.addMessage(DisplaySetMessage.CODES.MULTIFRAME_NO_POSITION_INFORMATION);\n  }\n}\n","import ImageSet from '@ohif/core/src/classes/ImageSet';\nimport { DisplaySetMessage, DisplaySetMessageList } from '@ohif/core';\n/**\n * Default handler for a instance list with an unsupported sopClassUID\n */\nexport default function getDisplaySetsFromUnsupportedSeries(instances) {\n  const imageSet = new ImageSet(instances);\n  const messages = new DisplaySetMessageList();\n  messages.addMessage(DisplaySetMessage.CODES.UNSUPPORTED_DISPLAYSET);\n  const instance = instances[0];\n\n  imageSet.setAttributes({\n    displaySetInstanceUID: imageSet.uid, // create a local alias for the imageSet UID\n    SeriesDate: instance.SeriesDate,\n    SeriesTime: instance.SeriesTime,\n    SeriesInstanceUID: instance.SeriesInstanceUID,\n    StudyInstanceUID: instance.StudyInstanceUID,\n    SeriesNumber: instance.SeriesNumber || 0,\n    FrameRate: instance.FrameTime,\n    SOPClassUID: instance.SOPClassUID,\n    SeriesDescription: instance.SeriesDescription || '',\n    Modality: instance.Modality,\n    numImageFrames: instances.length,\n    unsupported: true,\n    SOPClassHandlerId: 'unsupported',\n    isReconstructable: false,\n    messages,\n  });\n  return [imageSet];\n}\n","import { isImage } from '@ohif/core/src/utils/isImage';\nimport sopClassDictionary from '@ohif/core/src/utils/sopClassDictionary';\nimport ImageSet from '@ohif/core/src/classes/ImageSet';\nimport isDisplaySetReconstructable from '@ohif/core/src/utils/isDisplaySetReconstructable';\nimport { id } from './id';\nimport getDisplaySetMessages from './getDisplaySetMessages';\nimport getDisplaySetsFromUnsupportedSeries from './getDisplaySetsFromUnsupportedSeries';\n\nconst sopClassHandlerName = 'stack';\n\nconst isMultiFrame = instance => {\n  return instance.NumberOfFrames > 1;\n};\n\nconst makeDisplaySet = instances => {\n  const instance = instances[0];\n  const imageSet = new ImageSet(instances);\n\n  const { value: isReconstructable, averageSpacingBetweenFrames } =\n    isDisplaySetReconstructable(instances);\n  // set appropriate attributes to image set...\n  const messages = getDisplaySetMessages(instances, isReconstructable);\n\n  imageSet.setAttributes({\n    displaySetInstanceUID: imageSet.uid, // create a local alias for the imageSet UID\n    SeriesDate: instance.SeriesDate,\n    SeriesTime: instance.SeriesTime,\n    SeriesInstanceUID: instance.SeriesInstanceUID,\n    StudyInstanceUID: instance.StudyInstanceUID,\n    SeriesNumber: instance.SeriesNumber || 0,\n    FrameRate: instance.FrameTime,\n    SOPClassUID: instance.SOPClassUID,\n    SeriesDescription: instance.SeriesDescription || '',\n    Modality: instance.Modality,\n    isMultiFrame: isMultiFrame(instance),\n    countIcon: isReconstructable ? 'icon-mpr' : undefined,\n    numImageFrames: instances.length,\n    SOPClassHandlerId: `${id}.sopClassHandlerModule.${sopClassHandlerName}`,\n    isReconstructable,\n    messages,\n    averageSpacingBetweenFrames: averageSpacingBetweenFrames || null,\n  });\n\n  // Sort the images in this series if needed\n  const shallSort = true; //!OHIF.utils.ObjectPath.get(Meteor, 'settings.public.ui.sortSeriesByIncomingOrder');\n  if (shallSort) {\n    imageSet.sortBy((a, b) => {\n      // Sort by InstanceNumber (0020,0013)\n      return (parseInt(a.InstanceNumber) || 0) - (parseInt(b.InstanceNumber) || 0);\n    });\n  }\n\n  // Include the first image instance number (after sorted)\n  /*imageSet.setAttribute(\n    'instanceNumber',\n    imageSet.getImage(0).InstanceNumber\n  );*/\n\n  /*const isReconstructable = isDisplaySetReconstructable(series, instances);\n\n  imageSet.isReconstructable = isReconstructable.value;\n\n  if (isReconstructable.missingFrames) {\n    // TODO -> This is currently unused, but may be used for reconstructing\n    // Volumes with gaps later on.\n    imageSet.missingFrames = isReconstructable.missingFrames;\n  }*/\n\n  return imageSet;\n};\n\nconst isSingleImageModality = modality => {\n  return modality === 'CR' || modality === 'MG' || modality === 'DX';\n};\n\nfunction getSopClassUids(instances) {\n  const uniqueSopClassUidsInSeries = new Set();\n  instances.forEach(instance => {\n    uniqueSopClassUidsInSeries.add(instance.SOPClassUID);\n  });\n  const sopClassUids = Array.from(uniqueSopClassUidsInSeries);\n\n  return sopClassUids;\n}\n\n/**\n * Basic SOPClassHandler:\n * - For all Image types that are stackable, create\n *   a displaySet with a stack of images\n *\n * @param {Array} sopClassHandlerModules List of SOP Class Modules\n * @param {SeriesMetadata} series The series metadata object from which the display sets will be created\n * @returns {Array} The list of display sets created for the given series object\n */\nfunction getDisplaySetsFromSeries(instances) {\n  // If the series has no instances, stop here\n  if (!instances || !instances.length) {\n    throw new Error('No instances were provided');\n  }\n\n  const displaySets = [];\n  const sopClassUids = getSopClassUids(instances);\n\n  // Search through the instances (InstanceMetadata object) of this series\n  // Split Multi-frame instances and Single-image modalities\n  // into their own specific display sets. Place the rest of each\n  // series into another display set.\n  const stackableInstances = [];\n  instances.forEach(instance => {\n    // All imaging modalities must have a valid value for sopClassUid (x00080016) or rows (x00280010)\n    if (!isImage(instance.SOPClassUID) && !instance.Rows) {\n      return;\n    }\n\n    let displaySet;\n\n    if (isMultiFrame(instance)) {\n      displaySet = makeDisplaySet([instance]);\n\n      displaySet.setAttributes({\n        sopClassUids,\n        isClip: true,\n        numImageFrames: instance.NumberOfFrames,\n        instanceNumber: instance.InstanceNumber,\n        acquisitionDatetime: instance.AcquisitionDateTime,\n      });\n      displaySets.push(displaySet);\n    } else if (isSingleImageModality(instance.Modality)) {\n      displaySet = makeDisplaySet([instance]);\n      displaySet.setAttributes({\n        sopClassUids,\n        instanceNumber: instance.InstanceNumber,\n        acquisitionDatetime: instance.AcquisitionDateTime,\n      });\n      displaySets.push(displaySet);\n    } else {\n      stackableInstances.push(instance);\n    }\n  });\n\n  if (stackableInstances.length) {\n    const displaySet = makeDisplaySet(stackableInstances);\n    displaySet.setAttribute('studyInstanceUid', instances[0].StudyInstanceUID);\n    displaySet.setAttributes({\n      sopClassUids,\n    });\n    displaySets.push(displaySet);\n  }\n\n  return displaySets;\n}\n\nconst sopClassUids = [\n  sopClassDictionary.ComputedRadiographyImageStorage,\n  sopClassDictionary.DigitalXRayImageStorageForPresentation,\n  sopClassDictionary.DigitalXRayImageStorageForProcessing,\n  sopClassDictionary.DigitalMammographyXRayImageStorageForPresentation,\n  sopClassDictionary.DigitalMammographyXRayImageStorageForProcessing,\n  sopClassDictionary.DigitalIntraOralXRayImageStorageForPresentation,\n  sopClassDictionary.DigitalIntraOralXRayImageStorageForProcessing,\n  sopClassDictionary.CTImageStorage,\n  sopClassDictionary.EnhancedCTImageStorage,\n  sopClassDictionary.LegacyConvertedEnhancedCTImageStorage,\n  sopClassDictionary.UltrasoundMultiframeImageStorage,\n  sopClassDictionary.MRImageStorage,\n  sopClassDictionary.EnhancedMRImageStorage,\n  sopClassDictionary.EnhancedMRColorImageStorage,\n  sopClassDictionary.LegacyConvertedEnhancedMRImageStorage,\n  sopClassDictionary.UltrasoundImageStorage,\n  sopClassDictionary.UltrasoundImageStorageRET,\n  sopClassDictionary.SecondaryCaptureImageStorage,\n  sopClassDictionary.MultiframeSingleBitSecondaryCaptureImageStorage,\n  sopClassDictionary.MultiframeGrayscaleByteSecondaryCaptureImageStorage,\n  sopClassDictionary.MultiframeGrayscaleWordSecondaryCaptureImageStorage,\n  sopClassDictionary.MultiframeTrueColorSecondaryCaptureImageStorage,\n  sopClassDictionary.XRayAngiographicImageStorage,\n  sopClassDictionary.EnhancedXAImageStorage,\n  sopClassDictionary.XRayRadiofluoroscopicImageStorage,\n  sopClassDictionary.EnhancedXRFImageStorage,\n  sopClassDictionary.XRay3DAngiographicImageStorage,\n  sopClassDictionary.XRay3DCraniofacialImageStorage,\n  sopClassDictionary.BreastTomosynthesisImageStorage,\n  sopClassDictionary.BreastProjectionXRayImageStorageForPresentation,\n  sopClassDictionary.BreastProjectionXRayImageStorageForProcessing,\n  sopClassDictionary.IntravascularOpticalCoherenceTomographyImageStorageForPresentation,\n  sopClassDictionary.IntravascularOpticalCoherenceTomographyImageStorageForProcessing,\n  sopClassDictionary.NuclearMedicineImageStorage,\n  sopClassDictionary.VLEndoscopicImageStorage,\n  sopClassDictionary.VideoEndoscopicImageStorage,\n  sopClassDictionary.VLMicroscopicImageStorage,\n  sopClassDictionary.VideoMicroscopicImageStorage,\n  sopClassDictionary.VLSlideCoordinatesMicroscopicImageStorage,\n  sopClassDictionary.VLPhotographicImageStorage,\n  sopClassDictionary.VideoPhotographicImageStorage,\n  sopClassDictionary.OphthalmicPhotography8BitImageStorage,\n  sopClassDictionary.OphthalmicPhotography16BitImageStorage,\n  sopClassDictionary.OphthalmicTomographyImageStorage,\n  sopClassDictionary.VLWholeSlideMicroscopyImageStorage,\n  sopClassDictionary.PositronEmissionTomographyImageStorage,\n  sopClassDictionary.EnhancedPETImageStorage,\n  sopClassDictionary.LegacyConvertedEnhancedPETImageStorage,\n  sopClassDictionary.RTImageStorage,\n  sopClassDictionary.EnhancedUSVolumeStorage,\n];\n\nfunction getSopClassHandlerModule() {\n  return [\n    {\n      name: sopClassHandlerName,\n      sopClassUids,\n      getDisplaySetsFromSeries,\n    },\n    {\n      name: 'not-supported-display-sets-handler',\n      sopClassUids: [],\n      getDisplaySetsFromSeries: getDisplaySetsFromUnsupportedSeries,\n    },\n  ];\n}\n\nexport default getSopClassHandlerModule;\n","import React from 'react';\n\nexport default function ToolbarDivider() {\n  return <span className=\"border-common-dark mx-2 h-8 w-4 self-center border-l\" />;\n}\n","import React, { useEffect, useState, useCallback } from 'react';\nimport PropTypes from 'prop-types';\nimport { LayoutSelector as OHIFLayoutSelector, ToolbarButton } from '@ohif/ui';\nimport { ServicesManager } from '@ohif/core';\n\nfunction ToolbarLayoutSelectorWithServices({ servicesManager, ...props }) {\n  const { toolbarService } = servicesManager.services;\n\n  const onSelection = useCallback(\n    props => {\n      toolbarService.recordInteraction({\n        interactionType: 'action',\n        commands: [\n          {\n            commandName: 'setViewportGridLayout',\n            commandOptions: { ...props },\n            context: 'DEFAULT',\n          },\n        ],\n      });\n    },\n    [toolbarService]\n  );\n\n  return (\n    <LayoutSelector\n      {...props}\n      onSelection={onSelection}\n    />\n  );\n}\n\nfunction LayoutSelector({ rows, columns, className, onSelection, ...rest }) {\n  const [isOpen, setIsOpen] = useState(false);\n\n  const closeOnOutsideClick = () => {\n    if (isOpen) {\n      setIsOpen(false);\n    }\n  };\n\n  useEffect(() => {\n    window.addEventListener('click', closeOnOutsideClick);\n    return () => {\n      window.removeEventListener('click', closeOnOutsideClick);\n    };\n  }, [isOpen]);\n\n  const onInteractionHandler = () => setIsOpen(!isOpen);\n  const DropdownContent = isOpen ? OHIFLayoutSelector : null;\n\n  return (\n    <ToolbarButton\n      id=\"Layout\"\n      label=\"Grid Layout\"\n      icon=\"tool-layout\"\n      onInteraction={onInteractionHandler}\n      className={className}\n      rounded={rest.rounded}\n      dropdownContent={\n        DropdownContent !== null && (\n          <DropdownContent\n            rows={rows}\n            columns={columns}\n            onSelection={onSelection}\n          />\n        )\n      }\n      isActive={isOpen}\n      type=\"toggle\"\n    />\n  );\n}\n\nLayoutSelector.propTypes = {\n  rows: PropTypes.number,\n  columns: PropTypes.number,\n  onLayoutChange: PropTypes.func,\n  servicesManager: PropTypes.instanceOf(ServicesManager),\n};\n\nLayoutSelector.defaultProps = {\n  rows: 3,\n  columns: 3,\n  onLayoutChange: () => {},\n};\n\nexport default ToolbarLayoutSelectorWithServices;\n","import { SplitButton, Icon, ToolbarButton } from '@ohif/ui';\nimport React, { useEffect, useState } from 'react';\nimport PropTypes from 'prop-types';\nimport classNames from 'classnames';\n\nfunction ToolbarSplitButtonWithServices({\n  isRadio,\n  isAction,\n  groupId,\n  primary,\n  secondary,\n  items,\n  renderer,\n  onInteraction,\n  servicesManager,\n}) {\n  const { toolbarService } = servicesManager?.services;\n\n  const handleItemClick = (item, index) => {\n    const { id, type, commands } = item;\n    onInteraction({\n      groupId,\n      itemId: id,\n      interactionType: type,\n      commands,\n    });\n\n    setState(state => ({\n      ...state,\n      primary: !isAction && isRadio ? { ...item, index } : state.primary,\n      isExpanded: false,\n      items: getSplitButtonItems(items).filter(item =>\n        isRadio && !isAction ? item.index !== index : true\n      ),\n    }));\n  };\n\n  /* Bubbles up individual item clicks */\n  const getSplitButtonItems = items =>\n    items.map((item, index) => ({\n      ...item,\n      index,\n      onClick: () => handleItemClick(item, index),\n    }));\n\n  const [buttonsState, setButtonState] = useState({\n    primaryToolId: '',\n    toggles: {},\n    groups: {},\n  });\n\n  const [state, setState] = useState({\n    primary,\n    items: getSplitButtonItems(items).filter(item =>\n      isRadio && !isAction ? item.id !== primary.id : true\n    ),\n  });\n\n  const { primaryToolId, toggles } = buttonsState;\n\n  const isPrimaryToggle = state.primary.type === 'toggle';\n\n  const isPrimaryActive =\n    (state.primary.type === 'tool' && primaryToolId === state.primary.id) ||\n    (isPrimaryToggle && toggles[state.primary.id] === true);\n\n  const PrimaryButtonComponent =\n    toolbarService?.getButtonComponentForUIType(state.primary.uiType) ?? ToolbarButton;\n\n  useEffect(() => {\n    const { unsubscribe } = toolbarService.subscribe(\n      toolbarService.EVENTS.TOOL_BAR_STATE_MODIFIED,\n      state => {\n        setButtonState({ ...state });\n      }\n    );\n\n    return () => {\n      unsubscribe();\n    };\n  }, [toolbarService]);\n\n  const updatedItems = state.items.map(item => {\n    const isActive = item.type === 'tool' && primaryToolId === item.id;\n\n    // We could have added the\n    // item.type === 'toggle' && toggles[item.id] === true\n    // too but that makes the button active when the toggle is active under it\n    // which feels weird\n    return {\n      ...item,\n      isActive,\n    };\n  });\n\n  const DefaultListItemRenderer = ({ type, icon, label, t, id }) => {\n    const isActive = type === 'toggle' && toggles[id] === true;\n\n    return (\n      <div\n        className={classNames(\n          'hover:bg-primary-dark flex h-8 w-full flex-row items-center p-3',\n          'whitespace-pre text-base',\n          isActive && 'bg-primary-dark',\n          isActive\n            ? 'text-[#348CFD]'\n            : 'text-common-bright hover:bg-primary-dark hover:text-primary-light'\n        )}\n      >\n        {icon && (\n          <span className=\"mr-4\">\n            <Icon\n              name={icon}\n              className=\"h-5 w-5\"\n            />\n          </span>\n        )}\n        <span className=\"mr-5\">{t(label)}</span>\n      </div>\n    );\n  };\n\n  const listItemRenderer = renderer || DefaultListItemRenderer;\n\n  return (\n    <SplitButton\n      isRadio={isRadio}\n      isAction={isAction}\n      primary={state.primary}\n      secondary={secondary}\n      items={updatedItems}\n      groupId={groupId}\n      renderer={listItemRenderer}\n      isActive={isPrimaryActive || updatedItems.some(item => item.isActive)}\n      isToggle={isPrimaryToggle}\n      onInteraction={onInteraction}\n      Component={props => (\n        <PrimaryButtonComponent\n          {...props}\n          servicesManager={servicesManager}\n        />\n      )}\n    />\n  );\n}\n\nToolbarSplitButtonWithServices.propTypes = {\n  isRadio: PropTypes.bool,\n  isAction: PropTypes.bool,\n  groupId: PropTypes.string,\n  primary: PropTypes.shape({\n    id: PropTypes.string.isRequired,\n    type: PropTypes.oneOf(['tool', 'action', 'toggle']).isRequired,\n    uiType: PropTypes.string,\n  }),\n  secondary: PropTypes.shape({\n    id: PropTypes.string,\n    icon: PropTypes.string.isRequired,\n    label: PropTypes.string,\n    tooltip: PropTypes.string.isRequired,\n    isActive: PropTypes.bool,\n  }),\n  items: PropTypes.arrayOf(\n    PropTypes.shape({\n      id: PropTypes.string.isRequired,\n      type: PropTypes.oneOf(['tool', 'action', 'toggle']).isRequired,\n      icon: PropTypes.string,\n      label: PropTypes.string,\n      tooltip: PropTypes.string,\n    })\n  ),\n  renderer: PropTypes.func,\n  onInteraction: PropTypes.func.isRequired,\n  servicesManager: PropTypes.shape({\n    services: PropTypes.shape({\n      toolbarService: PropTypes.object,\n    }),\n  }),\n};\n\nToolbarSplitButtonWithServices.defaultProps = {\n  isRadio: false,\n  isAction: false,\n};\n\nexport default ToolbarSplitButtonWithServices;\n","import { ToolbarButton } from '@ohif/ui';\nimport React, { useEffect, useState } from 'react';\nimport PropTypes from 'prop-types';\n\nfunction ToolbarButtonWithServices({\n  id,\n  type,\n  commands,\n  onInteraction,\n  servicesManager,\n  ...props\n}) {\n  const { toolbarService } = servicesManager?.services || {};\n\n  const [buttonsState, setButtonState] = useState({\n    primaryToolId: '',\n    toggles: {},\n    groups: {},\n  });\n  const { primaryToolId } = buttonsState;\n\n  const isActive =\n    (type === 'tool' && id === primaryToolId) ||\n    (type === 'toggle' && buttonsState.toggles[id] === true);\n\n  useEffect(() => {\n    const { unsubscribe } = toolbarService.subscribe(\n      toolbarService.EVENTS.TOOL_BAR_STATE_MODIFIED,\n      state => {\n        setButtonState({ ...state });\n      }\n    );\n\n    return () => {\n      unsubscribe();\n    };\n  }, [toolbarService]);\n\n  return (\n    <ToolbarButton\n      commands={commands}\n      id={id}\n      type={type}\n      isActive={isActive}\n      onInteraction={onInteraction}\n      {...props}\n    />\n  );\n}\n\nToolbarButtonWithServices.propTypes = {\n  id: PropTypes.string.isRequired,\n  type: PropTypes.oneOf(['tool', 'action', 'toggle']).isRequired,\n  commands: PropTypes.arrayOf(\n    PropTypes.shape({\n      commandName: PropTypes.string.isRequired,\n      context: PropTypes.string,\n    })\n  ),\n  onInteraction: PropTypes.func.isRequired,\n  servicesManager: PropTypes.shape({\n    services: PropTypes.shape({\n      toolbarService: PropTypes.shape({\n        subscribe: PropTypes.func.isRequired,\n        state: PropTypes.shape({\n          primaryToolId: PropTypes.string,\n          toggles: PropTypes.objectOf(PropTypes.bool),\n          groups: PropTypes.objectOf(PropTypes.any),\n        }).isRequired,\n      }).isRequired,\n    }).isRequired,\n  }).isRequired,\n};\n\nexport default ToolbarButtonWithServices;\n","import { Types } from '@ohif/ui';\nimport { Menu, SelectorProps, MenuItem, ContextMenuProps } from './types';\n\ntype ContextMenuItem = Types.ContextMenuItem;\n\n/**\n * Finds menu by menu id\n *\n * @returns Menu having the menuId\n */\nexport function findMenuById(menus: Menu[], menuId?: string): Menu {\n  if (!menuId) {\n    return;\n  }\n\n  return menus.find(menu => menu.id === menuId);\n}\n\n/**\n * Default finding menu method.  This method will go through\n * the list of menus until it finds the first one which\n * has no selector, OR has the selector, when applied to the\n * check props, return true.\n * The selectorProps are a set of provided properties which can be\n * passed into the selector function to determine when to display a menu.\n * For example, a selector function of:\n * `({displayset}) => displaySet?.SeriesDescription?.indexOf?.('Left')!==-1\n * would match series descriptions containing 'Left'.\n *\n * @param {Object[]} menus List of menus\n * @param {*} subProps\n * @returns\n */\nexport function findMenuDefault(menus: Menu[], subProps: Record<string, unknown>): Menu {\n  if (!menus) {\n    return null;\n  }\n  return menus.find(menu => !menu.selector || menu.selector(subProps.selectorProps));\n}\n\n/**\n * Finds the menu to be used for different scenarios:\n * This will first look for a subMenu with the specified subMenuId\n * Next it will look for the first menu whose selector returns true.\n *\n * @param menus - List of menus\n * @param props - root props\n * @param menuIdFilter - menu id identifier (to be considered on selection)\n *      This is intended to support other types of filtering in the future.\n */\nexport function findMenu(menus: Menu[], props?: Types.IProps, menuIdFilter?: string) {\n  const { subMenu } = props;\n\n  function* findMenuIterator() {\n    yield findMenuById(menus, menuIdFilter || subMenu);\n    yield findMenuDefault(menus, props);\n  }\n\n  const findIt = findMenuIterator();\n\n  let current = findIt.next();\n  let menu = current.value;\n\n  while (!current.done) {\n    menu = current.value;\n\n    if (menu) {\n      findIt.return();\n    }\n    current = findIt.next();\n  }\n\n  console.log('Menu chosen', menu?.id || 'NONE');\n\n  return menu;\n}\n\n/**\n * Returns the menu from a list of possible menus, based on the actual state of component props and tool data nearby.\n * This uses the findMenu command above to first find the appropriate\n * menu, and then it chooses the actual contents of that menu.\n * A menu item can be optional by implementing the 'selector',\n * which will be called with the selectorProps, and if it does not return true,\n * then the item is excluded.\n *\n * Other menus can be delegated to by setting the delegating value to\n * a string id for another menu.  That menu's content will replace the\n * current menu item (only if the item would be included).\n *\n * This allows single id menus to be chosen by id, but have varying contents\n * based on the delegated menus.\n *\n * Finally, for each item, the adaptItem call is made.  This allows\n * items to modify themselves before being displayed, such as\n * incorporating additional information from translation sources.\n * See the `test-mode` examples for details.\n *\n * @param selectorProps\n * @param {*} event event that originates the context menu\n * @param {*} menus List of menus\n * @param {*} menuIdFilter\n * @returns\n */\nexport function getMenuItems(\n  selectorProps: SelectorProps,\n  event: Event,\n  menus: Menu[],\n  menuIdFilter?: string\n): MenuItem[] | void {\n  // Include both the check props and the ...check props as one is used\n  // by the child menu and the other used by the selector function\n  const subProps = { selectorProps, event };\n\n  const menu = findMenu(menus, subProps, menuIdFilter);\n\n  if (!menu) {\n    return undefined;\n  }\n\n  if (!menu.items) {\n    console.warn('Must define items in menu', menu);\n    return [];\n  }\n\n  let menuItems = [];\n  menu.items.forEach(item => {\n    const { delegating, selector, subMenu } = item;\n\n    if (!selector || selector(selectorProps)) {\n      if (delegating) {\n        menuItems = [...menuItems, ...getMenuItems(selectorProps, event, menus, subMenu)];\n      } else {\n        const toAdd = adaptItem(item, subProps);\n        menuItems.push(toAdd);\n      }\n    }\n  });\n\n  return menuItems;\n}\n\n/**\n * Returns item adapted to be consumed by ContextMenu component\n * and then goes through the item to add action behaviour for clicking the item,\n * making it compatible with the default ContextMenu display.\n *\n * @param {Object} item\n * @param {Object} subProps\n * @returns a MenuItem that is compatible with the base ContextMenu\n *    This requires having a label and set of actions to be called.\n */\nexport function adaptItem(item: MenuItem, subProps: ContextMenuProps): ContextMenuItem {\n  const newItem: ContextMenuItem = {\n    ...item,\n    value: subProps.selectorProps?.value,\n  };\n\n  if (item.actionType === 'ShowSubMenu' && !newItem.iconRight) {\n    newItem.iconRight = 'chevron-menu';\n  }\n  if (!item.action) {\n    newItem.action = (itemRef, componentProps) => {\n      const { event = {} } = componentProps;\n      const { detail = {} } = event;\n      newItem.element = detail.element;\n\n      componentProps.onClose();\n      const action = componentProps[`on${itemRef.actionType || 'Default'}`];\n      if (action) {\n        action.call(componentProps, newItem, itemRef, subProps);\n      } else {\n        console.warn('No action defined for', itemRef);\n      }\n    };\n  }\n\n  return newItem;\n}\n","import * as ContextMenuItemsBuilder from './ContextMenuItemsBuilder';\nimport ContextMenu from '../../../../platform/ui/src/components/ContextMenu/ContextMenu';\nimport { CommandsManager, ServicesManager, Types } from '@ohif/core';\nimport { annotation as CsAnnotation } from '@cornerstonejs/tools';\nimport { Menu, MenuItem, Point, ContextMenuProps } from './types';\n\n/**\n * The context menu controller is a helper class that knows how\n * to manage context menus based on the UI Customization Service.\n * There are a few parts to this:\n *    1. Basic controls to manage displaying and hiding context menus\n *    2. Menu selection services, which use the UI customization service\n *       to choose which menu to display\n *    3. Menu item adapter services to convert menu items into displayable and actionable items.\n *\n * The format for a menu is defined in the exported type MenuItem\n */\nexport default class ContextMenuController {\n  commandsManager: CommandsManager;\n  services: Types.Services;\n  menuItems: Menu[] | MenuItem[];\n\n  constructor(servicesManager: ServicesManager, commandsManager: CommandsManager) {\n    this.services = servicesManager.services as Obj;\n    this.commandsManager = commandsManager;\n  }\n\n  closeContextMenu() {\n    this.services.uiDialogService.dismiss({ id: 'context-menu' });\n  }\n\n  /**\n   * Figures out which context menu is appropriate to display and shows it.\n   *\n   * @param contextMenuProps - the context menu properties, see ./types.ts\n   * @param viewportElement - the DOM element this context menu is related to\n   * @param defaultPointsPosition - a default position to show the context menu\n   */\n  showContextMenu(\n    contextMenuProps: ContextMenuProps,\n    viewportElement,\n    defaultPointsPosition\n  ): void {\n    if (!this.services.uiDialogService) {\n      console.warn('Unable to show dialog; no UI Dialog Service available.');\n      return;\n    }\n\n    const { event, subMenu, menuId, menus, selectorProps } = contextMenuProps;\n\n    const annotationManager = CsAnnotation.state.getAnnotationManager();\n    const { locking } = CsAnnotation;\n    const targetAnnotationId = selectorProps?.nearbyToolData?.annotationUID as string;\n    const isLocked = locking.isAnnotationLocked(\n      annotationManager.getAnnotation(targetAnnotationId)\n    );\n\n    if (isLocked) {\n      console.warn('Annotation is locked.');\n      return;\n    }\n\n    console.log('Getting items from', menus);\n    const items = ContextMenuItemsBuilder.getMenuItems(\n      selectorProps || contextMenuProps,\n      event,\n      menus,\n      menuId\n    );\n\n    this.services.uiDialogService.dismiss({ id: 'context-menu' });\n    this.services.uiDialogService.create({\n      id: 'context-menu',\n      isDraggable: false,\n      preservePosition: false,\n      preventCutOf: true,\n      defaultPosition: ContextMenuController._getDefaultPosition(\n        defaultPointsPosition,\n        event?.detail,\n        viewportElement\n      ),\n      event,\n      content: ContextMenu,\n\n      // This naming is part of the uiDialogService convention\n      // Clicking outside simply closes the dialog box.\n      onClickOutside: () => this.services.uiDialogService.dismiss({ id: 'context-menu' }),\n\n      contentProps: {\n        items,\n        selectorProps,\n        menus,\n        event,\n        subMenu,\n        eventData: event?.detail,\n\n        onClose: () => {\n          this.services.uiDialogService.dismiss({ id: 'context-menu' });\n        },\n\n        /**\n         * Displays a sub-menu, removing this menu\n         * @param {*} item\n         * @param {*} itemRef\n         * @param {*} subProps\n         */\n        onShowSubMenu: (item, itemRef, subProps) => {\n          if (!itemRef.subMenu) {\n            console.warn('No submenu defined for', item, itemRef, subProps);\n            return;\n          }\n          this.showContextMenu(\n            {\n              ...contextMenuProps,\n              menuId: itemRef.subMenu,\n            },\n            viewportElement,\n            defaultPointsPosition\n          );\n        },\n\n        // Default is to run the specified commands.\n        onDefault: (item, itemRef, subProps) => {\n          this.commandsManager.run(item, {\n            ...selectorProps,\n            ...itemRef,\n            subProps,\n          });\n        },\n      },\n    });\n  }\n\n  static getDefaultPosition = (): Point => {\n    return {\n      x: 0,\n      y: 0,\n    };\n  };\n\n  static _getEventDefaultPosition = eventDetail => ({\n    x: eventDetail && eventDetail.currentPoints.client[0],\n    y: eventDetail && eventDetail.currentPoints.client[1],\n  });\n\n  static _getElementDefaultPosition = element => {\n    if (element) {\n      const boundingClientRect = element.getBoundingClientRect();\n      return {\n        x: boundingClientRect.x,\n        y: boundingClientRect.y,\n      };\n    }\n\n    return {\n      x: undefined,\n      y: undefined,\n    };\n  };\n\n  static _getCanvasPointsPosition = (points = [], element) => {\n    const viewerPos = ContextMenuController._getElementDefaultPosition(element);\n\n    for (let pointIndex = 0; pointIndex < points.length; pointIndex++) {\n      const point = {\n        x: points[pointIndex][0] || points[pointIndex]['x'],\n        y: points[pointIndex][1] || points[pointIndex]['y'],\n      };\n      if (\n        ContextMenuController._isValidPosition(point) &&\n        ContextMenuController._isValidPosition(viewerPos)\n      ) {\n        return {\n          x: point.x + viewerPos.x,\n          y: point.y + viewerPos.y,\n        };\n      }\n    }\n  };\n\n  static _isValidPosition = (source): boolean => {\n    return source && typeof source.x === 'number' && typeof source.y === 'number';\n  };\n\n  /**\n   * Returns the context menu default position. It look for the positions of: canvasPoints (got from selected), event that triggers it, current viewport element\n   */\n  static _getDefaultPosition = (canvasPoints, eventDetail, viewerElement) => {\n    function* getPositionIterator() {\n      yield ContextMenuController._getCanvasPointsPosition(canvasPoints, viewerElement);\n      yield ContextMenuController._getEventDefaultPosition(eventDetail);\n      yield ContextMenuController._getElementDefaultPosition(viewerElement);\n      yield ContextMenuController.getDefaultPosition();\n    }\n\n    const positionIterator = getPositionIterator();\n\n    let current = positionIterator.next();\n    let position = current.value;\n\n    while (!current.done) {\n      position = current.value;\n\n      if (ContextMenuController._isValidPosition(position)) {\n        positionIterator.return();\n      }\n      current = positionIterator.next();\n    }\n\n    return position;\n  };\n}\n","const defaultContextMenu = {\n  id: 'measurementsContextMenu',\n  customizationType: 'ohif.contextMenu',\n  menus: [\n    // Get the items from the UI Customization for the menu name (and have a custom name)\n    {\n      id: 'forExistingMeasurement',\n      selector: ({ nearbyToolData }) => !!nearbyToolData,\n      items: [\n        {\n          label: 'Delete measurement',\n          commands: [\n            {\n              commandName: 'deleteMeasurement',\n            },\n          ],\n        },\n        {\n          label: 'Add Label',\n          commands: [\n            {\n              commandName: 'setMeasurementLabel',\n            },\n          ],\n        },\n      ],\n    },\n  ],\n};\n\nexport default defaultContextMenu;\n","import React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { VariableSizeList as List } from 'react-window';\nimport classNames from 'classnames';\nimport debounce from 'lodash.debounce';\n\nconst lineHeightPx = 20;\nconst lineHeightClassName = `leading-[${lineHeightPx}px]`;\nconst rowVerticalPaddingPx = 10;\nconst rowBottomBorderPx = 1;\nconst rowVerticalPaddingStyle = { padding: `${rowVerticalPaddingPx}px 0` };\nconst rowStyle = {\n  borderBottomWidth: `${rowBottomBorderPx}px`,\n  ...rowVerticalPaddingStyle,\n};\n\nfunction ColumnHeaders({ tagRef, vrRef, keywordRef, valueRef }) {\n  return (\n    <div\n      className={classNames(\n        'bg-secondary-dark ohif-scrollbar flex w-full flex-row overflow-y-scroll'\n      )}\n      style={rowVerticalPaddingStyle}\n    >\n      <div className=\"w-4/24 px-3\">\n        <label\n          ref={tagRef}\n          className=\"flex flex-1 select-none flex-col pl-1 text-lg text-white\"\n        >\n          <span className=\"flex flex-row items-center focus:outline-none\">Tag</span>\n        </label>\n      </div>\n      <div className=\"w-2/24 px-3\">\n        <label\n          ref={vrRef}\n          className=\"flex flex-1 select-none flex-col pl-1 text-lg text-white\"\n        >\n          <span className=\"flex flex-row items-center focus:outline-none\">VR</span>\n        </label>\n      </div>\n      <div className=\"w-6/24 px-3\">\n        <label\n          ref={keywordRef}\n          className=\"flex flex-1 select-none flex-col pl-1 text-lg text-white\"\n        >\n          <span className=\"flex flex-row items-center focus:outline-none\">Keyword</span>\n        </label>\n      </div>\n      <div className=\"w-5/24 grow px-3\">\n        <label\n          ref={valueRef}\n          className=\"flex flex-1 select-none flex-col pl-1 text-lg text-white\"\n        >\n          <span className=\"flex flex-row items-center focus:outline-none\">Value</span>\n        </label>\n      </div>\n    </div>\n  );\n}\n\nfunction DicomTagTable({ rows }) {\n  const listRef = useRef();\n  const canvasRef = useRef();\n\n  const [tagHeaderElem, setTagHeaderElem] = useState(null);\n  const [vrHeaderElem, setVrHeaderElem] = useState(null);\n  const [keywordHeaderElem, setKeywordHeaderElem] = useState(null);\n  const [valueHeaderElem, setValueHeaderElem] = useState(null);\n\n  // Here the refs are inturn stored in state to trigger a render of the table.\n  // This virtualized table does NOT render until the header is rendered because the header column widths are used to determine the row heights in the table.\n  // Therefore whenever the refs change (in particular the first time the refs are set), we want to trigger a render of the table.\n  const tagRef = elem => {\n    if (elem) {\n      setTagHeaderElem(elem);\n    }\n  };\n  const vrRef = elem => {\n    if (elem) {\n      setVrHeaderElem(elem);\n    }\n  };\n  const keywordRef = elem => {\n    if (elem) {\n      setKeywordHeaderElem(elem);\n    }\n  };\n  const valueRef = elem => {\n    if (elem) {\n      setValueHeaderElem(elem);\n    }\n  };\n\n  /**\n   * When new rows are set, scroll to the top and reset the virtualization.\n   */\n  useEffect(() => {\n    if (!listRef?.current) {\n      return;\n    }\n\n    listRef.current.scrollTo(0);\n    listRef.current.resetAfterIndex(0);\n  }, [rows]);\n\n  /**\n   * When the browser window resizes, update the row virtualization (i.e. row heights)\n   */\n  useEffect(() => {\n    const debouncedResize = debounce(() => listRef.current.resetAfterIndex(0), 100);\n\n    window.addEventListener('resize', debouncedResize);\n\n    return () => {\n      debouncedResize.cancel();\n      window.removeEventListener('resize', debouncedResize);\n    };\n  }, []);\n\n  const Row = useCallback(\n    ({ index, style }) => {\n      const row = rows[index];\n\n      return (\n        <div\n          style={{ ...style, ...rowStyle }}\n          className={classNames(\n            'hover:bg-secondary-main border-secondary-light flex w-full flex-row items-center break-all bg-black text-base transition duration-300',\n            lineHeightClassName\n          )}\n          key={`DICOMTagRow-${index}`}\n        >\n          <div className=\"w-4/24 px-3\">{row[0]}</div>\n          <div className=\"w-2/24 px-3\">{row[1]}</div>\n          <div className=\"w-6/24 px-3\">{row[2]}</div>\n          <div className=\"w-5/24 grow px-3\">{row[3]}</div>\n        </div>\n      );\n    },\n    [rows]\n  );\n\n  /**\n   * Whenever any one of the column headers is set, then the header is rendered.\n   * Here we chose the tag header.\n   */\n  const isHeaderRendered = useCallback(() => tagHeaderElem !== null, [tagHeaderElem]);\n\n  /**\n   * Get the item/row size. We use the header column widths to calculate the various row heights.\n   * @param index the row index\n   * @returns the row height\n   */\n  const getItemSize = useCallback(\n    index => {\n      const headerWidths = [\n        tagHeaderElem.offsetWidth,\n        vrHeaderElem.offsetWidth,\n        keywordHeaderElem.offsetWidth,\n        valueHeaderElem.offsetWidth,\n      ];\n\n      const context = canvasRef.current.getContext('2d');\n      context.font = getComputedStyle(canvasRef.current).font;\n\n      return rows[index]\n        .map((colText, index) => {\n          const colOneLineWidth = context.measureText(colText).width;\n          const numLines = Math.ceil(colOneLineWidth / headerWidths[index]);\n          return numLines * lineHeightPx + 2 * rowVerticalPaddingPx + rowBottomBorderPx;\n        })\n        .reduce((maxHeight, colHeight) => Math.max(maxHeight, colHeight));\n    },\n    [rows, keywordHeaderElem, tagHeaderElem, valueHeaderElem, vrHeaderElem]\n  );\n\n  return (\n    <div>\n      <canvas\n        style={{ visibility: 'hidden', position: 'absolute' }}\n        className=\"text-base\"\n        ref={canvasRef}\n      />\n      <ColumnHeaders\n        tagRef={tagRef}\n        vrRef={vrRef}\n        keywordRef={keywordRef}\n        valueRef={valueRef}\n      />\n      <div\n        className=\"relative m-auto border-2 border-black bg-black\"\n        style={{ height: '32rem' }}\n      >\n        {isHeaderRendered() && (\n          <List\n            ref={listRef}\n            height={500}\n            itemCount={rows.length}\n            itemSize={getItemSize}\n            width={'100%'}\n            className=\"ohif-scrollbar\"\n          >\n            {Row}\n          </List>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport default DicomTagTable;\n","import dcmjs from 'dcmjs';\nimport moment from 'moment';\nimport React, { useState, useMemo, useEffect } from 'react';\nimport { classes } from '@ohif/core';\nimport { InputRange, Select, Typography, InputFilterText } from '@ohif/ui';\nimport debounce from 'lodash.debounce';\n\nimport DicomTagTable from './DicomTagTable';\nimport './DicomTagBrowser.css';\n\nconst { ImageSet } = classes;\nconst { DicomMetaDictionary } = dcmjs.data;\nconst { nameMap } = DicomMetaDictionary;\n\nconst DicomTagBrowser = ({ displaySets, displaySetInstanceUID }) => {\n  // The column indices that are to be excluded during a filter of the table.\n  // At present the column indices are:\n  // 0: DICOM tag\n  // 1: VR\n  // 2: Keyword\n  // 3: Value\n  const excludedColumnIndicesForFilter: Set<number> = new Set([1]);\n\n  const [selectedDisplaySetInstanceUID, setSelectedDisplaySetInstanceUID] =\n    useState(displaySetInstanceUID);\n  const [instanceNumber, setInstanceNumber] = useState(1);\n  const [filterValue, setFilterValue] = useState('');\n\n  const onSelectChange = value => {\n    setSelectedDisplaySetInstanceUID(value.value);\n    setInstanceNumber(1);\n  };\n\n  const activeDisplaySet = displaySets.find(\n    ds => ds.displaySetInstanceUID === selectedDisplaySetInstanceUID\n  );\n\n  const isImageStack = _isImageStack(activeDisplaySet);\n  const showInstanceList = isImageStack && activeDisplaySet.images.length > 1;\n\n  const displaySetList = useMemo(() => {\n    displaySets.sort((a, b) => a.SeriesNumber - b.SeriesNumber);\n    return displaySets.map(displaySet => {\n      const {\n        displaySetInstanceUID,\n        SeriesDate,\n        SeriesTime,\n        SeriesNumber,\n        SeriesDescription,\n        Modality,\n      } = displaySet;\n\n      /* Map to display representation */\n      const dateStr = `${SeriesDate}:${SeriesTime}`.split('.')[0];\n      const date = moment(dateStr, 'YYYYMMDD:HHmmss');\n      const displayDate = date.format('ddd, MMM Do YYYY');\n\n      return {\n        value: displaySetInstanceUID,\n        label: `${SeriesNumber} (${Modality}): ${SeriesDescription}`,\n        description: displayDate,\n      };\n    });\n  }, [displaySets]);\n\n  const rows = useMemo(() => {\n    let metadata;\n    if (isImageStack) {\n      metadata = activeDisplaySet.images[instanceNumber - 1];\n    } else {\n      metadata = activeDisplaySet.instance || activeDisplaySet;\n    }\n    const tags = getSortedTags(metadata);\n    return getFormattedRowsFromTags(tags, metadata);\n  }, [instanceNumber, selectedDisplaySetInstanceUID]);\n\n  const filteredRows = useMemo(() => {\n    if (!filterValue) {\n      return rows;\n    }\n\n    const filterValueLowerCase = filterValue.toLowerCase();\n    return rows.filter(row => {\n      return row.reduce((keepRow, col, colIndex) => {\n        if (keepRow) {\n          // We are already keeping the row, why do more work so return now.\n          return keepRow;\n        }\n\n        if (excludedColumnIndicesForFilter.has(colIndex)) {\n          return keepRow;\n        }\n\n        return keepRow || col.toLowerCase().includes(filterValueLowerCase);\n      }, false);\n    });\n  }, [rows, filterValue]);\n\n  const debouncedSetFilterValue = useMemo(() => {\n    return debounce(setFilterValue, 200);\n  }, []);\n\n  useEffect(() => {\n    return () => {\n      debouncedSetFilterValue?.cancel();\n    };\n  }, []);\n\n  return (\n    <div className=\"dicom-tag-browser-content\">\n      <div className=\"mb-6 flex flex-row items-center pl-1\">\n        <div className=\"flex w-1/2 flex-row items-center\">\n          <Typography\n            variant=\"subtitle\"\n            className=\"mr-4\"\n          >\n            Series\n          </Typography>\n          <div className=\"mr-8 grow\">\n            <Select\n              id=\"display-set-selector\"\n              isClearable={false}\n              onChange={onSelectChange}\n              options={displaySetList}\n              value={displaySetList.find(ds => ds.value === selectedDisplaySetInstanceUID)}\n              className=\"text-white\"\n            />\n          </div>\n        </div>\n        <div className=\"flex w-1/2 flex-row items-center\">\n          {showInstanceList && (\n            <Typography\n              variant=\"subtitle\"\n              className=\"mr-4\"\n            >\n              Instance Number\n            </Typography>\n          )}\n          {showInstanceList && (\n            <div className=\"grow\">\n              <InputRange\n                value={instanceNumber}\n                key={selectedDisplaySetInstanceUID}\n                onChange={value => {\n                  setInstanceNumber(parseInt(value));\n                }}\n                minValue={1}\n                maxValue={activeDisplaySet.images.length}\n                step={1}\n                inputClassName=\"w-full\"\n                labelPosition=\"left\"\n                trackColor={'#3a3f99'}\n              />\n            </div>\n          )}\n        </div>\n      </div>\n      <div className=\"h-1 w-full bg-black\"></div>\n      <div className=\"my-3 flex w-1/2 flex-row\">\n        <InputFilterText\n          className=\"mr-8 block w-full\"\n          placeholder=\"Search metadata...\"\n          onDebounceChange={setFilterValue}\n        ></InputFilterText>\n      </div>\n      <DicomTagTable rows={filteredRows} />\n    </div>\n  );\n};\n\nfunction getFormattedRowsFromTags(tags, metadata) {\n  const rows = [];\n\n  tags.forEach(tagInfo => {\n    if (tagInfo.vr === 'SQ') {\n      rows.push([`${tagInfo.tagIndent}${tagInfo.tag}`, tagInfo.vr, tagInfo.keyword, '']);\n\n      const { values } = tagInfo;\n\n      values.forEach((item, index) => {\n        const formatedRowsFromTags = getFormattedRowsFromTags(item, metadata);\n\n        rows.push([`${item[0].tagIndent}(FFFE,E000)`, '', `Item #${index}`, '']);\n\n        rows.push(...formatedRowsFromTags);\n      });\n    } else {\n      if (tagInfo.vr === 'xs') {\n        try {\n          const tag = dcmjs.data.Tag.fromPString(tagInfo.tag).toCleanString();\n          const originalTagInfo = metadata[tag];\n          tagInfo.vr = originalTagInfo.vr;\n        } catch (error) {\n          console.error(`Failed to parse value representation for tag '${tagInfo.keyword}'`);\n        }\n      }\n      rows.push([`${tagInfo.tagIndent}${tagInfo.tag}`, tagInfo.vr, tagInfo.keyword, tagInfo.value]);\n    }\n  });\n\n  return rows;\n}\n\nfunction getSortedTags(metadata) {\n  const tagList = getRows(metadata);\n\n  // Sort top level tags, sequence groups are sorted when created.\n  _sortTagList(tagList);\n\n  return tagList;\n}\n\nfunction getRows(metadata, depth = 0) {\n  // Tag, Type, Value, Keyword\n\n  const keywords = Object.keys(metadata);\n\n  let tagIndent = '';\n\n  for (let i = 0; i < depth; i++) {\n    tagIndent += '>';\n  }\n\n  if (depth > 0) {\n    tagIndent += ' '; // If indented, add a space after the indents.\n  }\n\n  const rows = [];\n  for (let i = 0; i < keywords.length; i++) {\n    let keyword = keywords[i];\n\n    if (keyword === '_vrMap') {\n      continue;\n    }\n\n    const tagInfo = nameMap[keyword];\n\n    let value = metadata[keyword];\n\n    if (tagInfo && tagInfo.vr === 'SQ') {\n      const sequenceAsArray = toArray(value);\n\n      // Push line defining the sequence\n\n      const sequence = {\n        tag: tagInfo.tag,\n        tagIndent,\n        vr: tagInfo.vr,\n        keyword,\n        values: [],\n      };\n\n      rows.push(sequence);\n\n      if (value === null) {\n        // Type 2 Sequence\n        continue;\n      }\n\n      sequenceAsArray.forEach(item => {\n        const sequenceRows = getRows(item, depth + 1);\n\n        if (sequenceRows.length) {\n          // Sort the sequence group.\n          _sortTagList(sequenceRows);\n          sequence.values.push(sequenceRows);\n        }\n      });\n\n      continue;\n    }\n\n    if (Array.isArray(value)) {\n      if (value.length > 0 && typeof value[0] != 'object') {\n        value = value.join('\\\\');\n      }\n    }\n\n    if (typeof value === 'number') {\n      value = value.toString();\n    }\n\n    if (typeof value !== 'string') {\n      if (value === null) {\n        value = ' ';\n      } else {\n        if (typeof value === 'object') {\n          if (value.InlineBinary) {\n            value = 'Inline Binary';\n          } else if (value.BulkDataURI) {\n            value = `Bulk Data URI`; //: ${value.BulkDataURI}`;\n          } else if (value.Alphabetic) {\n            value = value.Alphabetic;\n          } else {\n            console.warn(`Unrecognised Value: ${value} for ${keyword}:`);\n            console.warn(value);\n            value = ' ';\n          }\n        } else {\n          console.warn(`Unrecognised Value: ${value} for ${keyword}:`);\n          value = ' ';\n        }\n      }\n    }\n\n    // tag / vr/ keyword/ value\n\n    // Remove retired tags\n    keyword = keyword.replace('RETIRED_', '');\n    if (tagInfo) {\n      rows.push({\n        tag: tagInfo.tag,\n        tagIndent,\n        vr: tagInfo.vr,\n        keyword,\n        value,\n      });\n    } else {\n      // skip properties without hex tag numbers\n      const regex = /[0-9A-Fa-f]{6}/g;\n      if (keyword.match(regex)) {\n        const tag = `(${keyword.substring(0, 4)},${keyword.substring(4, 8)})`;\n        rows.push({\n          tag,\n          tagIndent,\n          vr: '',\n          keyword: 'Private Tag',\n          value,\n        });\n      }\n    }\n  }\n\n  return rows;\n}\n\nfunction _isImageStack(displaySet) {\n  return displaySet instanceof ImageSet;\n}\n\nfunction toArray(objectOrArray) {\n  return Array.isArray(objectOrArray) ? objectOrArray : [objectOrArray];\n}\n\nfunction _sortTagList(tagList) {\n  tagList.sort((a, b) => {\n    if (a.tag < b.tag) {\n      return -1;\n    }\n\n    return 1;\n  });\n}\n\nexport default DicomTagBrowser;\n","import { HangingProtocolService, StateSyncService, Types } from '@ohif/core';\n\nexport type ReturnType = {\n  hangingProtocolStageIndexMap: Record<string, Types.HangingProtocol.HPInfo>;\n  viewportGridStore: Record<string, unknown>;\n  displaySetSelectorMap: Record<string, string>;\n};\n\n/**\n * Calculates a set of state information for hanging protocols and viewport grid\n * which defines the currently applied hanging protocol state.\n * @param state is the viewport grid state\n * @param syncService is the state sync service to use for getting existing state\n * @returns Set of states that can be applied to the state sync to remember\n *   the current view state.\n */\nconst reuseCachedLayout = (\n  state,\n  hangingProtocolService: HangingProtocolService,\n  syncService: StateSyncService\n): ReturnType => {\n  const { activeViewportId } = state;\n  const { protocol } = hangingProtocolService.getActiveProtocol();\n  const hpInfo = hangingProtocolService.getState();\n  const { protocolId, stageIndex, activeStudyUID } = hpInfo;\n\n  const syncState = syncService.getState();\n  const viewportGridStore = { ...syncState.viewportGridStore };\n  const displaySetSelectorMap = { ...syncState.displaySetSelectorMap };\n\n  const stage = protocol.stages[stageIndex];\n  const storeId = `${activeStudyUID}:${protocolId}:${stageIndex}`;\n  const cacheId = `${activeStudyUID}:${protocolId}`;\n  const hangingProtocolStageIndexMap = {\n    ...syncState.hangingProtocolStageIndexMap,\n  };\n  const { rows, columns } = stage.viewportStructure.properties;\n  const custom =\n    stage.viewports.length !== state.viewports.size ||\n    state.layout.numRows !== rows ||\n    state.layout.numCols !== columns;\n\n  hangingProtocolStageIndexMap[cacheId] = hpInfo;\n\n  if (storeId && custom) {\n    viewportGridStore[storeId] = { ...state };\n  }\n\n  state.viewports.forEach((viewport, viewportId) => {\n    const { displaySetOptions, displaySetInstanceUIDs } = viewport;\n    if (!displaySetOptions) {\n      return;\n    }\n    for (let i = 0; i < displaySetOptions.length; i++) {\n      const displaySetUID = displaySetInstanceUIDs[i];\n      if (!displaySetUID) {\n        continue;\n      }\n      if (viewportId === activeViewportId && i === 0) {\n        displaySetSelectorMap[`${activeStudyUID}:activeDisplaySet:0`] = displaySetUID;\n      }\n      if (displaySetOptions[i]?.id) {\n        displaySetSelectorMap[\n          `${activeStudyUID}:${displaySetOptions[i].id}:${\n            displaySetOptions[i].matchedDisplaySetsIndex || 0\n          }`\n        ] = displaySetUID;\n      }\n    }\n  });\n\n  return {\n    hangingProtocolStageIndexMap,\n    viewportGridStore,\n    displaySetSelectorMap,\n  };\n};\n\nexport default reuseCachedLayout;\n","import { StateSyncService } from '@ohif/core';\n\n/**\n * This find or create viewport is paired with the reduce results from\n * below, and the action of this viewport is to look for previously filled\n * viewports, and to reuse by position id.  If there is no filled viewport,\n * then one can be re-used from the display set if it isn't going to be displayed.\n * @param hangingProtocolService - bound parameter supplied before using this\n * @param viewportsByPosition - bound parameter supplied before using this\n * @param position - the position in the grid to retrieve\n * @param positionId - the current position on screen to retrieve\n * @param options - the set of options used, so that subsequent calls can\n *                  store state that is reset by the setLayout.\n *                  This class uses the options to store the already viewed\n *                  display sets, filling it initially with the pre-existing viewports.\n */\nexport const findOrCreateViewport = (\n  hangingProtocolService,\n  viewportsByPosition,\n  position: number,\n  positionId: string,\n  options: Record<string, unknown>\n) => {\n  const byPositionViewport = viewportsByPosition?.[positionId];\n  if (byPositionViewport) {\n    return { ...byPositionViewport };\n  }\n  const { protocolId, stageIndex } = hangingProtocolService.getState();\n\n  // Setup the initial in display correctly for initial view/select\n  if (!options.inDisplay) {\n    options.inDisplay = [...viewportsByPosition.initialInDisplay];\n  }\n  // See if there is a default viewport for new views.\n  const missing = hangingProtocolService.getMissingViewport(protocolId, stageIndex, options);\n  if (missing) {\n    const displaySetInstanceUIDs = missing.displaySetsInfo.map(it => it.displaySetInstanceUID);\n    options.inDisplay.push(...displaySetInstanceUIDs);\n    return {\n      displaySetInstanceUIDs,\n      displaySetOptions: missing.displaySetsInfo.map(it => it.displaySetOptions),\n      viewportOptions: {\n        ...missing.viewportOptions,\n      },\n    };\n  }\n  return {};\n};\n\n/**\n * Records the information on what viewports are displayed in which position.\n * Also records what instances from the existing positions are going to be in\n * view initially.\n * @param state is the viewport grid state\n * @param syncService is the state sync service to use for getting existing state\n * @returns Set of states that can be applied to the state sync to remember\n *   the current view state.\n */\nconst findViewportsByPosition = (\n  state,\n  { numRows, numCols },\n  syncService: StateSyncService\n): Record<string, Record<string, unknown>> => {\n  const { viewports } = state;\n  const syncState = syncService.getState();\n  const viewportsByPosition = { ...syncState.viewportsByPosition };\n  const initialInDisplay = [];\n\n  viewports.forEach(viewport => {\n    if (viewport.positionId) {\n      const storedViewport = {\n        ...viewport,\n        viewportOptions: { ...viewport.viewportOptions },\n      };\n      viewportsByPosition[viewport.positionId] = storedViewport;\n    }\n  });\n\n  for (let row = 0; row < numRows; row++) {\n    for (let col = 0; col < numCols; col++) {\n      const positionId = `${col}-${row}`;\n      const viewport = viewportsByPosition[positionId];\n      if (viewport?.displaySetInstanceUIDs) {\n        initialInDisplay.push(...viewport.displaySetInstanceUIDs);\n      }\n    }\n  }\n\n  // Store the initially displayed elements\n  viewportsByPosition.initialInDisplay = initialInDisplay;\n\n  return { viewportsByPosition };\n};\n\nexport default findViewportsByPosition;\n","import { ServicesManager, utils, Types } from '@ohif/core';\n\nimport { ContextMenuController, defaultContextMenu } from './CustomizableContextMenu';\nimport DicomTagBrowser from './DicomTagBrowser/DicomTagBrowser';\nimport reuseCachedLayouts from './utils/reuseCachedLayouts';\nimport findViewportsByPosition, {\n  findOrCreateViewport as layoutFindOrCreate,\n} from './findViewportsByPosition';\n\nimport { ContextMenuProps } from './CustomizableContextMenu/types';\nimport { NavigateHistory } from './types/commandModuleTypes';\nimport { history } from '@ohif/app';\n\nconst { subscribeToNextViewportGridChange } = utils;\n\nexport type HangingProtocolParams = {\n  protocolId?: string;\n  stageIndex?: number;\n  activeStudyUID?: string;\n  stageId?: string;\n};\n\nexport type UpdateViewportDisplaySetParams = {\n  direction: number;\n  excludeNonImageModalities?: boolean;\n};\n\n/**\n * Determine if a command is a hanging protocol one.\n * For now, just use the two hanging protocol commands that are in this\n * commands module, but if others get added elsewhere this may need enhancing.\n */\nconst isHangingProtocolCommand = command =>\n  command &&\n  (command.commandName === 'setHangingProtocol' || command.commandName === 'toggleHangingProtocol');\n\nconst commandsModule = ({\n  servicesManager,\n  commandsManager,\n}: Types.Extensions.ExtensionParams): Types.Extensions.CommandsModule => {\n  const {\n    customizationService,\n    measurementService,\n    hangingProtocolService,\n    uiNotificationService,\n    viewportGridService,\n    displaySetService,\n    stateSyncService,\n    toolbarService,\n  } = (servicesManager as ServicesManager).services;\n\n  // Define a context menu controller for use with any context menus\n  const contextMenuController = new ContextMenuController(servicesManager, commandsManager);\n\n  const actions = {\n    /**\n     * Show the context menu.\n     * @param options.menuId defines the menu name to lookup, from customizationService\n     * @param options.defaultMenu contains the default menu set to use\n     * @param options.element is the element to show the menu within\n     * @param options.event is the event that caused the context menu\n     * @param options.selectorProps is the set of selection properties to use\n     */\n    showContextMenu: (options: ContextMenuProps) => {\n      const {\n        menuCustomizationId,\n        element,\n        event,\n        selectorProps,\n        defaultPointsPosition = [],\n      } = options;\n\n      const optionsToUse = { ...options };\n\n      if (menuCustomizationId) {\n        Object.assign(\n          optionsToUse,\n          customizationService.get(menuCustomizationId, defaultContextMenu)\n        );\n      }\n\n      // TODO - make the selectorProps richer by including the study metadata and display set.\n      const { protocol, stage } = hangingProtocolService.getActiveProtocol();\n      optionsToUse.selectorProps = {\n        event,\n        protocol,\n        stage,\n        ...selectorProps,\n      };\n\n      contextMenuController.showContextMenu(optionsToUse, element, defaultPointsPosition);\n    },\n\n    /** Close a context menu currently displayed */\n    closeContextMenu: () => {\n      contextMenuController.closeContextMenu();\n    },\n\n    displayNotification: ({ text, title, type }) => {\n      uiNotificationService.show({\n        title: title,\n        message: text,\n        type: type,\n      });\n    },\n    clearMeasurements: () => {\n      measurementService.clear();\n    },\n\n    /**\n     * Toggles off all tools which contain a commandName of setHangingProtocol\n     * or toggleHangingProtocol, and which match/don't match the protocol id/stage\n     */\n    toggleHpTools: () => {\n      const {\n        protocol,\n        stageIndex: toggleStageIndex,\n        stage,\n      } = hangingProtocolService.getActiveProtocol();\n      const enableListener = button => {\n        if (!button.id) {\n          return;\n        }\n        const { commands, items, primary } = button.props || button;\n        if (primary) {\n          enableListener(primary);\n        }\n        if (items) {\n          items.forEach(enableListener);\n        }\n        const hpCommand = commands?.find?.(isHangingProtocolCommand);\n        if (!hpCommand) {\n          return;\n        }\n        const { protocolId, stageIndex, stageId } = hpCommand.commandOptions;\n        const isActive =\n          (!protocolId || protocolId === protocol.id) &&\n          (stageIndex === undefined || stageIndex === toggleStageIndex) &&\n          (!stageId || stageId === stage.id);\n        toolbarService.setToggled(button.id, isActive);\n      };\n      Object.values(toolbarService.getButtons()).forEach(enableListener);\n    },\n\n    /**\n     *  Sets the specified protocol\n     *    1. Records any existing state using the viewport grid service\n     *    2. Finds the destination state - this can be one of:\n     *       a. The specified protocol stage\n     *       b. An alternate (toggled or restored) protocol stage\n     *       c. A restored custom layout\n     *    3. Finds the parameters for the specified state\n     *       a. Gets the displaySetSelectorMap\n     *       b. Gets the map by position\n     *       c. Gets any toggle mapping to map position to/from current view\n     *    4. If restore, then sets layout\n     *       a. Maps viewport position by currently displayed viewport map id\n     *       b. Uses toggle information to map display set id\n     *    5. Else applies the hanging protocol\n     *       a. HP Service is provided displaySetSelectorMap\n     *       b. HP Service will throw an exception if it isn't applicable\n     * @param options - contains information on the HP to apply\n     * @param options.activeStudyUID - the updated study to apply the HP to\n     * @param options.protocolId - the protocol ID to change to\n     * @param options.stageId - the stageId to apply\n     * @param options.stageIndex - the index of the stage to go to.\n     * @param options.reset - flag to indicate if the HP should be reset to its original and not restored to a previous state\n     */\n    setHangingProtocol: ({\n      activeStudyUID = '',\n      protocolId,\n      stageId,\n      stageIndex,\n      reset = false,\n    }: HangingProtocolParams): boolean => {\n      const primaryToolBeforeHPChange = toolbarService.getActivePrimaryTool();\n      try {\n        // Stores in the state the display set selector id to displaySetUID mapping\n        // Pass in viewportId for the active viewport.  This item will get set as\n        // the activeViewportId\n        const state = viewportGridService.getState();\n        const hpInfo = hangingProtocolService.getState();\n        const { protocol: oldProtocol } = hangingProtocolService.getActiveProtocol();\n        const stateSyncReduce = reuseCachedLayouts(state, hangingProtocolService, stateSyncService);\n        const { hangingProtocolStageIndexMap, viewportGridStore, displaySetSelectorMap } =\n          stateSyncReduce;\n\n        if (!protocolId) {\n          // Reuse the previous protocol id, and optionally stage\n          protocolId = hpInfo.protocolId;\n          if (stageId === undefined && stageIndex === undefined) {\n            stageIndex = hpInfo.stageIndex;\n          }\n        } else if (stageIndex === undefined && stageId === undefined) {\n          // Re-set the same stage as was previously used\n          const hangingId = `${activeStudyUID || hpInfo.activeStudyUID}:${protocolId}`;\n          stageIndex = hangingProtocolStageIndexMap[hangingId]?.stageIndex;\n        }\n\n        const useStageIdx =\n          stageIndex ??\n          hangingProtocolService.getStageIndex(protocolId, {\n            stageId,\n            stageIndex,\n          });\n\n        if (activeStudyUID) {\n          hangingProtocolService.setActiveStudyUID(activeStudyUID);\n        }\n\n        const storedHanging = `${hangingProtocolService.getState().activeStudyUID}:${protocolId}:${\n          useStageIdx || 0\n        }`;\n\n        const restoreProtocol = !reset && viewportGridStore[storedHanging];\n\n        if (\n          protocolId === hpInfo.protocolId &&\n          useStageIdx === hpInfo.stageIndex &&\n          !activeStudyUID\n        ) {\n          // Clear the HP setting to reset them\n          hangingProtocolService.setProtocol(protocolId, {\n            stageId,\n            stageIndex: useStageIdx,\n          });\n        } else {\n          hangingProtocolService.setProtocol(protocolId, {\n            displaySetSelectorMap,\n            stageId,\n            stageIndex: useStageIdx,\n            restoreProtocol,\n          });\n          if (restoreProtocol) {\n            viewportGridService.set(viewportGridStore[storedHanging]);\n          }\n        }\n        // Do this after successfully applying the update\n        // Note, don't store the active display set - it is only needed while\n        // changing display sets.  This causes jump to measurement to fail on\n        // multi-study display.\n        delete displaySetSelectorMap[\n          `${activeStudyUID || hpInfo.activeStudyUID}:activeDisplaySet:0`\n        ];\n        stateSyncService.store(stateSyncReduce);\n        // This is a default action applied\n        actions.toggleHpTools();\n\n        // try to use the same tool in the new hanging protocol stage\n        const primaryButton = toolbarService.getButton(primaryToolBeforeHPChange);\n        if (primaryButton) {\n          // is there any type of interaction on this button, if not it might be in the\n          // items. This is a bit of a hack, but it works for now.\n\n          let interactionType = primaryButton.props?.interactionType;\n\n          if (!interactionType && primaryButton.props?.items) {\n            const firstItem = primaryButton.props.items[0];\n            interactionType = firstItem.props?.interactionType || firstItem.props?.type;\n          }\n\n          if (interactionType) {\n            toolbarService.recordInteraction({\n              interactionType,\n              ...primaryButton.props,\n            });\n          }\n        }\n        return true;\n      } catch (e) {\n        console.error(e);\n        actions.toggleHpTools();\n        uiNotificationService.show({\n          title: 'Apply Hanging Protocol',\n          message: 'The hanging protocol could not be applied.',\n          type: 'error',\n          duration: 3000,\n        });\n        return false;\n      }\n    },\n\n    toggleHangingProtocol: ({ protocolId, stageIndex }: HangingProtocolParams): boolean => {\n      const {\n        protocol,\n        stageIndex: desiredStageIndex,\n        activeStudy,\n      } = hangingProtocolService.getActiveProtocol();\n      const { toggleHangingProtocol } = stateSyncService.getState();\n      const storedHanging = `${activeStudy.StudyInstanceUID}:${protocolId}:${stageIndex | 0}`;\n      if (\n        protocol.id === protocolId &&\n        (stageIndex === undefined || stageIndex === desiredStageIndex)\n      ) {\n        // Toggling off - restore to previous state\n        const previousState = toggleHangingProtocol[storedHanging] || {\n          protocolId: 'default',\n        };\n        return actions.setHangingProtocol(previousState);\n      } else {\n        stateSyncService.store({\n          toggleHangingProtocol: {\n            ...toggleHangingProtocol,\n            [storedHanging]: {\n              protocolId: protocol.id,\n              stageIndex: desiredStageIndex,\n            },\n          },\n        });\n        return actions.setHangingProtocol({\n          protocolId,\n          stageIndex,\n          reset: true,\n        });\n      }\n    },\n\n    deltaStage: ({ direction }) => {\n      const { protocolId, stageIndex: oldStageIndex } = hangingProtocolService.getState();\n      const { protocol } = hangingProtocolService.getActiveProtocol();\n      for (\n        let stageIndex = oldStageIndex + direction;\n        stageIndex >= 0 && stageIndex < protocol.stages.length;\n        stageIndex += direction\n      ) {\n        if (protocol.stages[stageIndex].status !== 'disabled') {\n          return actions.setHangingProtocol({\n            protocolId,\n            stageIndex,\n          });\n        }\n      }\n      uiNotificationService.show({\n        title: 'Change Stage',\n        message: 'The hanging protocol has no more applicable stages',\n        type: 'info',\n        duration: 3000,\n      });\n    },\n\n    /**\n     * Changes the viewport grid layout in terms of the MxN layout.\n     */\n    setViewportGridLayout: ({ numRows, numCols }) => {\n      const { protocol } = hangingProtocolService.getActiveProtocol();\n      const onLayoutChange = protocol.callbacks?.onLayoutChange;\n      if (commandsManager.run(onLayoutChange, { numRows, numCols }) === false) {\n        console.log('setViewportGridLayout running', onLayoutChange, numRows, numCols);\n        // Don't apply the layout if the run command returns false\n        return;\n      }\n\n      const completeLayout = () => {\n        const state = viewportGridService.getState();\n        const stateReduce = findViewportsByPosition(state, { numRows, numCols }, stateSyncService);\n        const findOrCreateViewport = layoutFindOrCreate.bind(\n          null,\n          hangingProtocolService,\n          stateReduce.viewportsByPosition\n        );\n\n        viewportGridService.setLayout({\n          numRows,\n          numCols,\n          findOrCreateViewport,\n        });\n        stateSyncService.store(stateReduce);\n      };\n      // Need to finish any work in the callback\n      window.setTimeout(completeLayout, 0);\n    },\n\n    toggleOneUp() {\n      const viewportGridState = viewportGridService.getState();\n      const { activeViewportId, viewports, layout } = viewportGridState;\n      const { displaySetInstanceUIDs, displaySetOptions, viewportOptions } =\n        viewports.get(activeViewportId);\n\n      if (layout.numCols === 1 && layout.numRows === 1) {\n        // The viewer is in one-up. Check if there is a state to restore/toggle back to.\n        const { toggleOneUpViewportGridStore } = stateSyncService.getState();\n\n        if (!toggleOneUpViewportGridStore.layout) {\n          return;\n        }\n        // There is a state to toggle back to. The viewport that was\n        // originally toggled to one up was the former active viewport.\n        const viewportIdToUpdate = toggleOneUpViewportGridStore.activeViewportId;\n\n        // We are restoring the previous layout but taking into the account that\n        // the current one up viewport might have a new displaySet dragged and dropped on it.\n        // updatedViewportsViaHP below contains the viewports applicable to the HP that existed\n        // prior to the toggle to one-up - including the updated viewports if a display\n        // set swap were to have occurred.\n        const updatedViewportsViaHP =\n          displaySetInstanceUIDs.length > 1\n            ? []\n            : displaySetInstanceUIDs\n                .map(displaySetInstanceUID =>\n                  hangingProtocolService.getViewportsRequireUpdate(\n                    viewportIdToUpdate,\n                    displaySetInstanceUID\n                  )\n                )\n                .flat();\n\n        // findOrCreateViewport returns either one of the updatedViewportsViaHP\n        // returned from the HP service OR if there is not one from the HP service then\n        // simply returns what was in the previous state for a given position in the layout.\n        const findOrCreateViewport = (position: number, positionId: string) => {\n          // Find the viewport for the given position prior to the toggle to one-up.\n          const preOneUpViewport = Array.from(toggleOneUpViewportGridStore.viewports.values()).find(\n            viewport => viewport.positionId === positionId\n          );\n\n          // Use the viewport id from before the toggle to one-up to find any updates to the viewport.\n          const viewport = updatedViewportsViaHP.find(\n            viewport => viewport.viewportId === preOneUpViewport.viewportId\n          );\n\n          return viewport\n            ? // Use the applicable viewport from the HP updated viewports\n              { viewportOptions, displaySetOptions, ...viewport }\n            : // Use the previous viewport for the given position\n              preOneUpViewport;\n        };\n\n        const layoutOptions = viewportGridService.getLayoutOptionsFromState(\n          toggleOneUpViewportGridStore\n        );\n\n        // Restore the previous layout including the active viewport.\n        viewportGridService.setLayout({\n          numRows: toggleOneUpViewportGridStore.layout.numRows,\n          numCols: toggleOneUpViewportGridStore.layout.numCols,\n          activeViewportId: viewportIdToUpdate,\n          layoutOptions,\n          findOrCreateViewport,\n        });\n      } else {\n        // We are not in one-up, so toggle to one up.\n\n        // Store the current viewport grid state so we can toggle it back later.\n        stateSyncService.store({\n          toggleOneUpViewportGridStore: viewportGridState,\n        });\n\n        // This findOrCreateViewport only return one viewport - the active\n        // one being toggled to one up.\n        const findOrCreateViewport = () => {\n          return {\n            displaySetInstanceUIDs,\n            displaySetOptions,\n            viewportOptions,\n          };\n        };\n\n        // Set the layout to be 1x1/one-up.\n        viewportGridService.setLayout({\n          numRows: 1,\n          numCols: 1,\n          findOrCreateViewport,\n        });\n\n        // Subscribe to ANY (i.e. manual and hanging protocol) layout changes so that\n        // any grid layout state to toggle to from one up is cleared. This is performed on\n        // a timeout to avoid clearing the state for the actual to one up change.\n        // Whenever the next layout change event is fired, the subscriptions are unsubscribed.\n        const clearToggleOneUpViewportGridStore = () => {\n          const toggleOneUpViewportGridStore = {};\n          stateSyncService.store({\n            toggleOneUpViewportGridStore,\n          });\n        };\n\n        subscribeToNextViewportGridChange(viewportGridService, clearToggleOneUpViewportGridStore);\n      }\n    },\n\n    /**\n     * Exposes the browser history navigation used by OHIF. This command can be used to either replace or\n     * push a new entry into the browser history. For example, the following will replace the current\n     * browser history entry with the specified relative URL which changes the study displayed to the\n     * study with study instance UID 1.2.3. Note that as a result of using `options.replace = true`, the\n     * page prior to invoking this command cannot be returned to via the browser back button.\n     *\n     * navigateHistory({\n     *   to: 'viewer?StudyInstanceUIDs=1.2.3',\n     *   options: { replace: true },\n     * });\n     *\n     * @param historyArgs - arguments for the history function;\n     *                      the `to` property is the URL;\n     *                      the `options.replace` is a boolean indicating if the current browser history entry\n     *                      should be replaced or a new entry pushed onto the history (stack); the default value\n     *                      for `replace` is false\n     */\n    navigateHistory(historyArgs: NavigateHistory) {\n      history.navigate(historyArgs.to, historyArgs.options);\n    },\n\n    openDICOMTagViewer() {\n      const { activeViewportId, viewports } = viewportGridService.getState();\n      const activeViewportSpecificData = viewports.get(activeViewportId);\n      const { displaySetInstanceUIDs } = activeViewportSpecificData;\n\n      const displaySets = displaySetService.activeDisplaySets;\n      const { UIModalService } = servicesManager.services;\n\n      const displaySetInstanceUID = displaySetInstanceUIDs[0];\n      UIModalService.show({\n        content: DicomTagBrowser,\n        contentProps: {\n          displaySets,\n          displaySetInstanceUID,\n          onClose: UIModalService.hide,\n        },\n        title: 'DICOM Tag Browser',\n      });\n    },\n\n    /**\n     * Toggle viewport overlay (the information panel shown on the four corners\n     * of the viewport)\n     * @see ViewportOverlay and CustomizableViewportOverlay components\n     */\n    toggleOverlays: () => {\n      const overlays = document.getElementsByClassName('viewport-overlay');\n      for (let i = 0; i < overlays.length; i++) {\n        overlays.item(i).classList.toggle('hidden');\n      }\n    },\n\n    scrollActiveThumbnailIntoView: () => {\n      const { activeViewportId, viewports } = viewportGridService.getState();\n\n      const activeViewport = viewports.get(activeViewportId);\n      const activeDisplaySetInstanceUID = activeViewport.displaySetInstanceUIDs[0];\n\n      const thumbnailList = document.querySelector('#ohif-thumbnail-list');\n\n      if (!thumbnailList) {\n        return;\n      }\n\n      const thumbnailListBounds = thumbnailList.getBoundingClientRect();\n\n      const thumbnail = document.querySelector(`#thumbnail-${activeDisplaySetInstanceUID}`);\n\n      if (!thumbnail) {\n        return;\n      }\n\n      const thumbnailBounds = thumbnail.getBoundingClientRect();\n\n      // This only handles a vertical thumbnail list.\n      if (\n        thumbnailBounds.top >= thumbnailListBounds.top &&\n        thumbnailBounds.top <= thumbnailListBounds.bottom\n      ) {\n        return;\n      }\n\n      thumbnail.scrollIntoView({ behavior: 'smooth' });\n    },\n\n    updateViewportDisplaySet: ({\n      direction,\n      excludeNonImageModalities,\n    }: UpdateViewportDisplaySetParams) => {\n      const nonImageModalities = ['SR', 'SEG', 'SM', 'RTSTRUCT', 'RTPLAN', 'RTDOSE'];\n\n      // Sort the display sets as per the hanging protocol service viewport/display set scoring system.\n      // The thumbnail list uses the same sorting.\n      const dsSortFn = hangingProtocolService.getDisplaySetSortFunction();\n      const currentDisplaySets = [...displaySetService.activeDisplaySets];\n\n      currentDisplaySets.sort(dsSortFn);\n\n      const { activeViewportId, viewports } = viewportGridService.getState();\n\n      const { displaySetInstanceUIDs } = viewports.get(activeViewportId);\n\n      const activeDisplaySetIndex = currentDisplaySets.findIndex(displaySet =>\n        displaySetInstanceUIDs.includes(displaySet.displaySetInstanceUID)\n      );\n\n      let displaySetIndexToShow: number;\n\n      for (\n        displaySetIndexToShow = activeDisplaySetIndex + direction;\n        displaySetIndexToShow > -1 && displaySetIndexToShow < currentDisplaySets.length;\n        displaySetIndexToShow += direction\n      ) {\n        if (\n          !excludeNonImageModalities ||\n          !nonImageModalities.includes(currentDisplaySets[displaySetIndexToShow].Modality)\n        ) {\n          break;\n        }\n      }\n\n      if (displaySetIndexToShow < 0 || displaySetIndexToShow >= currentDisplaySets.length) {\n        return;\n      }\n\n      const { displaySetInstanceUID } = currentDisplaySets[displaySetIndexToShow];\n\n      let updatedViewports = [];\n\n      try {\n        updatedViewports = hangingProtocolService.getViewportsRequireUpdate(\n          activeViewportId,\n          displaySetInstanceUID\n        );\n      } catch (error) {\n        console.warn(error);\n        uiNotificationService.show({\n          title: 'Navigate Viewport Display Set',\n          message:\n            'The requested display sets could not be added to the viewport due to a mismatch in the Hanging Protocol rules.',\n          type: 'info',\n          duration: 3000,\n        });\n      }\n\n      viewportGridService.setDisplaySetsForViewports(updatedViewports);\n\n      setTimeout(() => actions.scrollActiveThumbnailIntoView(), 0);\n    },\n  };\n\n  const definitions = {\n    showContextMenu: {\n      commandFn: actions.showContextMenu,\n    },\n    closeContextMenu: {\n      commandFn: actions.closeContextMenu,\n    },\n    clearMeasurements: {\n      commandFn: actions.clearMeasurements,\n      storeContexts: [],\n      options: {},\n    },\n    displayNotification: {\n      commandFn: actions.displayNotification,\n      storeContexts: [],\n      options: {},\n    },\n    setHangingProtocol: {\n      commandFn: actions.setHangingProtocol,\n      storeContexts: [],\n      options: {},\n    },\n    toggleHangingProtocol: {\n      commandFn: actions.toggleHangingProtocol,\n      storeContexts: [],\n      options: {},\n    },\n    navigateHistory: {\n      commandFn: actions.navigateHistory,\n      storeContexts: [],\n      options: {},\n    },\n    nextStage: {\n      commandFn: actions.deltaStage,\n      storeContexts: [],\n      options: { direction: 1 },\n    },\n    previousStage: {\n      commandFn: actions.deltaStage,\n      storeContexts: [],\n      options: { direction: -1 },\n    },\n    setViewportGridLayout: {\n      commandFn: actions.setViewportGridLayout,\n      storeContexts: [],\n      options: {},\n    },\n    toggleOneUp: {\n      commandFn: actions.toggleOneUp,\n      storeContexts: [],\n      options: {},\n    },\n    openDICOMTagViewer: {\n      commandFn: actions.openDICOMTagViewer,\n    },\n    updateViewportDisplaySet: {\n      commandFn: actions.updateViewportDisplaySet,\n      storeContexts: [],\n      options: {},\n    },\n  };\n\n  return {\n    actions,\n    definitions,\n    defaultContext: 'DEFAULT',\n  };\n};\n\nexport default commandsModule;\n","import { Types } from '@ohif/core';\n\n/**\n * This hanging protocol can be activated on the primary mode by directly\n * referencing it in a URL or by directly including it within a mode, e.g.:\n * `&hangingProtocolId=@ohif/mnGrid` added to the viewer URL\n * It is not included in the viewer mode by default.\n */\nconst hpMN: Types.HangingProtocol.Protocol = {\n  id: '@ohif/mnGrid',\n  description: 'Has various hanging protocol grid layouts',\n  name: '2x2',\n  protocolMatchingRules: [\n    {\n      id: 'OneOrMoreSeries',\n      weight: 25,\n      attribute: 'numberOfDisplaySetsWithImages',\n      constraint: {\n        greaterThan: 0,\n      },\n    },\n  ],\n  toolGroupIds: ['default'],\n  displaySetSelectors: {\n    defaultDisplaySetId: {\n      seriesMatchingRules: [\n        {\n          attribute: 'numImageFrames',\n          constraint: {\n            greaterThan: { value: 0 },\n          },\n          required: true,\n        },\n        // This display set will select the specified items by preference\n        // It has no affect if nothing is specified in the URL.\n        {\n          attribute: 'isDisplaySetFromUrl',\n          weight: 10,\n          constraint: {\n            equals: true,\n          },\n        },\n      ],\n    },\n  },\n  defaultViewport: {\n    viewportOptions: {\n      viewportType: 'stack',\n      toolGroupId: 'default',\n      allowUnmatchedView: true,\n    },\n    displaySets: [\n      {\n        id: 'defaultDisplaySetId',\n        matchedDisplaySetsIndex: -1,\n      },\n    ],\n  },\n  stages: [\n    {\n      id: '2x2',\n      stageActivation: {\n        enabled: {\n          minViewportsMatched: 4,\n        },\n      },\n      viewportStructure: {\n        layoutType: 'grid',\n        properties: {\n          rows: 2,\n          columns: 2,\n        },\n      },\n      viewports: [\n        {\n          viewportOptions: {\n            toolGroupId: 'default',\n            allowUnmatchedView: true,\n          },\n          displaySets: [\n            {\n              id: 'defaultDisplaySetId',\n            },\n          ],\n        },\n        {\n          viewportOptions: {\n            toolGroupId: 'default',\n            allowUnmatchedView: true,\n          },\n          displaySets: [\n            {\n              matchedDisplaySetsIndex: 1,\n              id: 'defaultDisplaySetId',\n            },\n          ],\n        },\n        {\n          viewportOptions: {\n            toolGroupId: 'default',\n            allowUnmatchedView: true,\n          },\n          displaySets: [\n            {\n              matchedDisplaySetsIndex: 2,\n              id: 'defaultDisplaySetId',\n            },\n          ],\n        },\n        {\n          viewportOptions: {\n            toolGroupId: 'default',\n            allowUnmatchedView: true,\n          },\n          displaySets: [\n            {\n              matchedDisplaySetsIndex: 3,\n              id: 'defaultDisplaySetId',\n            },\n          ],\n        },\n      ],\n    },\n\n    // 3x1 stage\n    {\n      id: '3x1',\n      // Obsolete settings:\n      requiredViewports: 1,\n      preferredViewports: 3,\n      // New equivalent:\n      stageActivation: {\n        enabled: {\n          minViewportsMatched: 3,\n        },\n      },\n      viewportStructure: {\n        layoutType: 'grid',\n        properties: {\n          rows: 1,\n          columns: 3,\n        },\n      },\n      viewports: [\n        {\n          viewportOptions: {\n            toolGroupId: 'default',\n            allowUnmatchedView: true,\n          },\n          displaySets: [\n            {\n              id: 'defaultDisplaySetId',\n            },\n          ],\n        },\n        {\n          viewportOptions: {\n            toolGroupId: 'default',\n            allowUnmatchedView: true,\n          },\n          displaySets: [\n            {\n              id: 'defaultDisplaySetId',\n              matchedDisplaySetsIndex: 1,\n            },\n          ],\n        },\n        {\n          viewportOptions: {\n            toolGroupId: 'default',\n            allowUnmatchedView: true,\n          },\n          displaySets: [\n            {\n              id: 'defaultDisplaySetId',\n              matchedDisplaySetsIndex: 2,\n            },\n          ],\n        },\n      ],\n    },\n\n    // A 2x1 stage\n    {\n      id: '2x1',\n      requiredViewports: 1,\n      preferredViewports: 2,\n      stageActivation: {\n        enabled: {\n          minViewportsMatched: 2,\n        },\n      },\n      viewportStructure: {\n        layoutType: 'grid',\n        properties: {\n          rows: 1,\n          columns: 2,\n        },\n      },\n      viewports: [\n        {\n          viewportOptions: {\n            toolGroupId: 'default',\n            allowUnmatchedView: true,\n          },\n          displaySets: [\n            {\n              id: 'defaultDisplaySetId',\n            },\n          ],\n        },\n        {\n          viewportOptions: {\n            toolGroupId: 'default',\n            allowUnmatchedView: true,\n          },\n          displaySets: [\n            {\n              matchedDisplaySetsIndex: 1,\n              id: 'defaultDisplaySetId',\n            },\n          ],\n        },\n      ],\n    },\n\n    // A 1x1 stage - should be automatically activated if there is only 1 viewable instance\n    {\n      id: '1x1',\n      requiredViewports: 1,\n      preferredViewports: 1,\n      stageActivation: {\n        enabled: {\n          minViewportsMatched: 1,\n        },\n      },\n      viewportStructure: {\n        layoutType: 'grid',\n        properties: {\n          rows: 1,\n          columns: 1,\n        },\n      },\n      viewports: [\n        {\n          viewportOptions: {\n            toolGroupId: 'default',\n            allowUnmatchedView: true,\n          },\n          displaySets: [\n            {\n              id: 'defaultDisplaySetId',\n            },\n          ],\n        },\n      ],\n    },\n  ],\n  numberOfPriorsReferenced: -1,\n};\n\nexport default hpMN;\n","import { Types } from '@ohif/core';\n\nconst defaultDisplaySetSelector = {\n  studyMatchingRules: [\n    {\n      // The priorInstance is a study counter that indicates what position this study is in\n      // and the value comes from the options parameter.\n      attribute: 'studyInstanceUIDsIndex',\n      from: 'options',\n      required: true,\n      constraint: {\n        equals: { value: 0 },\n      },\n    },\n  ],\n  seriesMatchingRules: [\n    {\n      attribute: 'numImageFrames',\n      constraint: {\n        greaterThan: { value: 0 },\n      },\n    },\n    // This display set will select the specified items by preference\n    // It has no affect if nothing is specified in the URL.\n    {\n      attribute: 'isDisplaySetFromUrl',\n      weight: 10,\n      constraint: {\n        equals: true,\n      },\n    },\n  ],\n};\n\nconst priorDisplaySetSelector = {\n  studyMatchingRules: [\n    {\n      // The priorInstance is a study counter that indicates what position this study is in\n      // and the value comes from the options parameter.\n      attribute: 'studyInstanceUIDsIndex',\n      from: 'options',\n      required: true,\n      constraint: {\n        equals: { value: 1 },\n      },\n    },\n  ],\n  seriesMatchingRules: [\n    {\n      attribute: 'numImageFrames',\n      constraint: {\n        greaterThan: { value: 0 },\n      },\n    },\n    // This display set will select the specified items by preference\n    // It has no affect if nothing is specified in the URL.\n    {\n      attribute: 'isDisplaySetFromUrl',\n      weight: 10,\n      constraint: {\n        equals: true,\n      },\n    },\n  ],\n};\n\nconst currentDisplaySet = {\n  id: 'defaultDisplaySetId',\n};\n\nconst priorDisplaySet = {\n  id: 'priorDisplaySetId',\n};\n\nconst currentViewport0 = {\n  viewportOptions: {\n    toolGroupId: 'default',\n    allowUnmatchedView: true,\n  },\n  displaySets: [currentDisplaySet],\n};\n\nconst currentViewport1 = {\n  ...currentViewport0,\n  displaySets: [\n    {\n      ...currentDisplaySet,\n      matchedDisplaySetsIndex: 1,\n    },\n  ],\n};\n\nconst priorViewport0 = {\n  ...currentViewport0,\n  displaySets: [priorDisplaySet],\n};\n\nconst priorViewport1 = {\n  ...priorViewport0,\n  displaySets: [\n    {\n      ...priorDisplaySet,\n      matchedDisplaySetsIndex: 1,\n    },\n  ],\n};\n\n/**\n * This hanging protocol can be activated on the primary mode by directly\n * referencing it in a URL or by directly including it within a mode, e.g.:\n * `&hangingProtocolId=@ohif/mnGrid` added to the viewer URL\n * It is not included in the viewer mode by default.\n */\nconst hpMNCompare: Types.HangingProtocol.Protocol = {\n  id: '@ohif/hpCompare',\n  description: 'Compare two studies in various layouts',\n  name: 'Compare Two Studies',\n  numberOfPriorsReferenced: 1,\n  protocolMatchingRules: [\n    {\n      id: 'Two Studies',\n      weight: 1000,\n      attribute: 'StudyInstanceUID',\n      // The 'from' attribute says where to get the 'attribute' value from.  In this case\n      // prior means the second study in the study list.\n      from: 'prior',\n      required: true,\n      constraint: {\n        notNull: true,\n      },\n    },\n  ],\n  toolGroupIds: ['default'],\n  displaySetSelectors: {\n    defaultDisplaySetId: defaultDisplaySetSelector,\n    priorDisplaySetId: priorDisplaySetSelector,\n  },\n  defaultViewport: {\n    viewportOptions: {\n      viewportType: 'stack',\n      toolGroupId: 'default',\n      allowUnmatchedView: true,\n    },\n    displaySets: [\n      {\n        id: 'defaultDisplaySetId',\n        matchedDisplaySetsIndex: -1,\n      },\n    ],\n  },\n  stages: [\n    {\n      name: '2x2',\n      stageActivation: {\n        enabled: {\n          minViewportsMatched: 4,\n        },\n      },\n      viewportStructure: {\n        layoutType: 'grid',\n        properties: {\n          rows: 2,\n          columns: 2,\n        },\n      },\n      viewports: [currentViewport0, priorViewport0, currentViewport1, priorViewport1],\n    },\n\n    {\n      name: '2x1',\n      stageActivation: {\n        enabled: {\n          minViewportsMatched: 2,\n        },\n      },\n      viewportStructure: {\n        layoutType: 'grid',\n        properties: {\n          rows: 1,\n          columns: 2,\n        },\n      },\n      viewports: [currentViewport0, priorViewport0],\n    },\n  ],\n};\n\nexport default hpMNCompare;\n","import hpMNGrid from './hpMNGrid';\nimport hpMNCompare from './hpCompare';\n\nconst defaultProtocol = {\n  id: 'default',\n  locked: true,\n  // Don't store this hanging protocol as it applies to the currently active\n  // display set by default\n  // cacheId: null,\n  name: 'Default',\n  createdDate: '2021-02-23T19:22:08.894Z',\n  modifiedDate: '2023-04-01',\n  availableTo: {},\n  editableBy: {},\n  protocolMatchingRules: [],\n  toolGroupIds: ['default'],\n  hpInitiationCriteria: { minSeriesLoaded: 1 },\n  // -1 would be used to indicate active only, whereas other values are\n  // the number of required priors referenced - so 0 means active with\n  // 0 or more priors.\n  numberOfPriorsReferenced: 0,\n  // Default viewport is used to define the viewport when\n  // additional viewports are added using the layout tool\n  defaultViewport: {\n    viewportOptions: {\n      viewportType: 'stack',\n      toolGroupId: 'default',\n      allowUnmatchedView: true,\n    },\n    displaySets: [\n      {\n        id: 'defaultDisplaySetId',\n        matchedDisplaySetsIndex: -1,\n      },\n    ],\n  },\n  displaySetSelectors: {\n    defaultDisplaySetId: {\n      // Matches displaysets, NOT series\n      seriesMatchingRules: [\n        // Try to match series with images by default, to prevent weird display\n        // on SEG/SR containing studies\n        {\n          attribute: 'numImageFrames',\n          constraint: {\n            greaterThan: { value: 0 },\n          },\n        },\n        // This display set will select the specified items by preference\n        // It has no affect if nothing is specified in the URL.\n        {\n          attribute: 'isDisplaySetFromUrl',\n          weight: 10,\n          constraint: {\n            equals: true,\n          },\n        },\n      ],\n      // Can be used to select matching studies\n      // studyMatchingRules: [],\n    },\n  },\n  stages: [\n    {\n      name: 'default',\n      viewportStructure: {\n        layoutType: 'grid',\n        properties: {\n          rows: 1,\n          columns: 1,\n        },\n      },\n      viewports: [\n        {\n          viewportOptions: {\n            viewportType: 'stack',\n            viewportId: 'default',\n            toolGroupId: 'default',\n            // This will specify the initial image options index if it matches in the URL\n            // and will otherwise not specify anything.\n            initialImageOptions: {\n              custom: 'sopInstanceLocation',\n            },\n            // Other options for initialImageOptions, which can be included in the default\n            // custom attribute, or can be provided directly.\n            //   index: 180,\n            //   preset: 'middle', // 'first', 'last', 'middle'\n            // },\n          },\n          displaySets: [\n            {\n              id: 'defaultDisplaySetId',\n            },\n          ],\n        },\n      ],\n      createdDate: '2021-02-23T18:32:42.850Z',\n    },\n  ],\n};\n\nfunction getHangingProtocolModule() {\n  return [\n    {\n      name: defaultProtocol.id,\n      protocol: defaultProtocol,\n    },\n    // Create a MxN hanging protocol available by default\n    {\n      name: hpMNGrid.id,\n      protocol: hpMNGrid,\n    },\n    // Create a MxN comparison hanging protocol available by default\n    {\n      name: hpMNCompare.id,\n      protocol: hpMNCompare,\n    },\n  ];\n}\n\nexport default getHangingProtocolModule;\n","import React from 'react';\nimport classnames from 'classnames';\nimport { useNavigate } from 'react-router-dom';\nimport { useAppConfig } from '@state';\n\nimport { Button, ButtonEnums } from '@ohif/ui';\n\nfunction DataSourceSelector() {\n  const [appConfig] = useAppConfig();\n  const navigate = useNavigate();\n\n  // This is frowned upon, but the raw config is needed here to provide\n  // the selector\n  const dsConfigs = appConfig.dataSources;\n\n  return (\n    <div style={{ width: '100%', height: '100%' }}>\n      <div className=\"flex h-screen w-screen items-center justify-center \">\n        <div className=\"bg-secondary-dark mx-auto space-y-2 rounded-lg py-8 px-8 drop-shadow-md\">\n          <img\n            className=\"mx-auto block h-14\"\n            src=\"./ohif-logo.svg\"\n            alt=\"OHIF\"\n          />\n          <div className=\"space-y-2 pt-4 text-center\">\n            {dsConfigs\n              .filter(it => it.sourceName !== 'dicomjson' && it.sourceName !== 'dicomlocal')\n              .map(ds => (\n                <div key={ds.sourceName}>\n                  <h1 className=\"text-white\">\n                    {ds.configuration?.friendlyName || ds.friendlyName}\n                  </h1>\n                  <Button\n                    type={ButtonEnums.type.primary}\n                    className={classnames('ml-2')}\n                    onClick={() => {\n                      navigate({\n                        pathname: '/',\n                        search: `datasources=${ds.sourceName}`,\n                      });\n                    }}\n                  >\n                    {ds.sourceName}\n                  </Button>\n                  <br />\n                </div>\n              ))}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default DataSourceSelector;\n","import classNames from 'classnames';\nimport React, { ReactElement, useEffect, useState } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { Button, Icon, InputFilterText, LoadingIndicatorProgress } from '@ohif/ui';\nimport { Types } from '@ohif/core';\n\ntype ItemListComponentProps = {\n  itemLabel: string;\n  itemList: Array<Types.BaseDataSourceConfigurationAPIItem>;\n  onItemClicked: (item: Types.BaseDataSourceConfigurationAPIItem) => void;\n};\n\nfunction ItemListComponent({\n  itemLabel,\n  itemList,\n  onItemClicked,\n}: ItemListComponentProps): ReactElement {\n  const { t } = useTranslation('DataSourceConfiguration');\n  const [filterValue, setFilterValue] = useState('');\n\n  useEffect(() => {\n    setFilterValue('');\n  }, [itemList]);\n\n  return (\n    <div className=\"flex min-h-[1px] grow flex-col gap-4\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"text-primary-light text-[20px]\">{t(`Select ${itemLabel}`)}</div>\n        <InputFilterText\n          className=\"max-w-[40%] grow\"\n          value={filterValue}\n          onDebounceChange={setFilterValue}\n          placeholder={t(`Search ${itemLabel} list`)}\n        ></InputFilterText>\n      </div>\n      <div className=\"relative flex min-h-[1px] grow flex-col bg-black text-[14px]\">\n        {itemList == null ? (\n          <LoadingIndicatorProgress className={'h-full w-full'} />\n        ) : itemList.length === 0 ? (\n          <div className=\"text-primary-light flex h-full flex-col items-center justify-center px-6 py-4\">\n            <Icon\n              name=\"magnifier\"\n              className=\"mb-4\"\n            />\n            <span>{t(`No ${itemLabel} available`)}</span>\n          </div>\n        ) : (\n          <>\n            <div className=\"bg-secondary-dark px-3 py-1.5 text-white\">{t(itemLabel)}</div>\n            <div className=\"ohif-scrollbar overflow-auto\">\n              {itemList\n                .filter(\n                  item =>\n                    !filterValue || item.name.toLowerCase().includes(filterValue.toLowerCase())\n                )\n                .map(item => {\n                  const border =\n                    'rounded border-transparent border-b-secondary-light border-[1px] hover:border-primary-light';\n                  return (\n                    <div\n                      className={classNames(\n                        'hover:text-primary-light hover:bg-primary-dark group mx-2 flex items-center justify-between px-6 py-2',\n                        border\n                      )}\n                      key={item.id}\n                    >\n                      <div>{item.name}</div>\n                      <Button\n                        onClick={() => onItemClicked(item)}\n                        className=\"invisible group-hover:visible\"\n                        endIcon={<Icon name=\"arrow-left\" />}\n                      >\n                        {t('Select')}\n                      </Button>\n                    </div>\n                  );\n                })}\n            </div>\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport default ItemListComponent;\n","import classNames from 'classnames';\nimport React, { ReactElement, useEffect, useState } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { Icon } from '@ohif/ui';\nimport { Types } from '@ohif/core';\nimport ItemListComponent from './ItemListComponent';\n\nconst NO_WRAP_ELLIPSIS_CLASS_NAMES = 'text-ellipsis whitespace-nowrap overflow-hidden';\n\ntype DataSourceConfigurationModalComponentProps = {\n  configurationAPI: Types.BaseDataSourceConfigurationAPI;\n  configuredItems: Array<Types.BaseDataSourceConfigurationAPIItem>;\n  onHide: () => void;\n};\n\nfunction DataSourceConfigurationModalComponent({\n  configurationAPI,\n  configuredItems,\n  onHide,\n}: DataSourceConfigurationModalComponentProps) {\n  const { t } = useTranslation('DataSourceConfiguration');\n\n  const [itemList, setItemList] = useState<Array<Types.BaseDataSourceConfigurationAPIItem>>();\n\n  const [selectedItems, setSelectedItems] = useState(configuredItems);\n\n  const [errorMessage, setErrorMessage] = useState<string>();\n\n  const [itemLabels] = useState(configurationAPI.getItemLabels());\n\n  // Determines whether to show the full/existing configuration for the data source.\n  // A full or complete configuration is one where the data source (path) has the\n  // maximum/required number of path items. Anything less is considered not complete and\n  // the configuration starts from scratch (i.e. as if no items are configured at all).\n  // TODO: consider configuration starting from a partial (i.e. non-empty) configuration\n  const [showFullConfig, setShowFullConfig] = useState(\n    itemLabels.length === configuredItems.length\n  );\n\n  /**\n   * The index of the selected item that is considered current and for which\n   * its sub-items should be displayed in the items list component. When the\n   * full/existing configuration for a data source is to be shown, the current\n   * selected item is the second to last in the `selectedItems` list.\n   */\n  const currentSelectedItemIndex = showFullConfig\n    ? selectedItems.length - 2\n    : selectedItems.length - 1;\n\n  useEffect(() => {\n    let shouldUpdate = true;\n\n    setErrorMessage(null);\n\n    // Clear out the former/old list while we fetch the next sub item list.\n    setItemList(null);\n\n    if (selectedItems.length === 0) {\n      configurationAPI\n        .initialize()\n        .then(items => {\n          if (shouldUpdate) {\n            setItemList(items);\n          }\n        })\n        .catch(error => setErrorMessage(error.message));\n    } else if (!showFullConfig && selectedItems.length === itemLabels.length) {\n      // The last item to configure the data source (path) has been selected.\n      configurationAPI.setCurrentItem(selectedItems[selectedItems.length - 1]);\n      // We can hide the modal dialog now.\n      onHide();\n    } else {\n      configurationAPI\n        .setCurrentItem(selectedItems[currentSelectedItemIndex])\n        .then(items => {\n          if (shouldUpdate) {\n            setItemList(items);\n          }\n        })\n        .catch(error => setErrorMessage(error.message));\n    }\n\n    return () => {\n      shouldUpdate = false;\n    };\n  }, [\n    selectedItems,\n    configurationAPI,\n    onHide,\n    itemLabels,\n    showFullConfig,\n    currentSelectedItemIndex,\n  ]);\n\n  const getSelectedItemCursorClasses = itemIndex =>\n    itemIndex !== itemLabels.length - 1 && itemIndex < selectedItems.length\n      ? 'cursor-pointer'\n      : 'cursor-auto';\n\n  const getSelectedItemBackgroundClasses = itemIndex =>\n    itemIndex < selectedItems.length\n      ? classNames(\n          'bg-black/[.4]',\n          itemIndex !== itemLabels.length - 1 ? 'hover:bg-transparent active:bg-secondary-dark' : ''\n        )\n      : 'bg-transparent';\n\n  const getSelectedItemBorderClasses = itemIndex =>\n    itemIndex === currentSelectedItemIndex + 1\n      ? classNames('border-2', 'border-solid', 'border-primary-light')\n      : itemIndex < selectedItems.length\n      ? 'border border-solid border-primary-active hover:border-primary-light active:border-white'\n      : 'border border-dashed border-secondary-light';\n\n  const getSelectedItemTextClasses = itemIndex =>\n    itemIndex <= selectedItems.length ? 'text-primary-light' : 'text-primary-active';\n\n  const getErrorComponent = (): ReactElement => {\n    return (\n      <div className=\"flex min-h-[1px] grow flex-col gap-4\">\n        <div className=\"text-primary-light text-[20px]\">\n          {t(`Error fetching ${itemLabels[selectedItems.length]} list`)}\n        </div>\n        <div className=\"grow bg-black p-4 text-[14px]\">{errorMessage}</div>\n      </div>\n    );\n  };\n\n  const getSelectedItemsComponent = (): ReactElement => {\n    return (\n      <div className=\"flex gap-4\">\n        {itemLabels.map((itemLabel, itemLabelIndex) => {\n          return (\n            <div\n              key={itemLabel}\n              className={classNames(\n                'flex min-w-[1px] shrink basis-[200px] flex-col gap-1 rounded-md p-3.5',\n                getSelectedItemCursorClasses(itemLabelIndex),\n                getSelectedItemBackgroundClasses(itemLabelIndex),\n                getSelectedItemBorderClasses(itemLabelIndex),\n                getSelectedItemTextClasses(itemLabelIndex)\n              )}\n              onClick={\n                (showFullConfig && itemLabelIndex < currentSelectedItemIndex) ||\n                itemLabelIndex <= currentSelectedItemIndex\n                  ? () => {\n                      setShowFullConfig(false);\n                      setSelectedItems(theList => theList.slice(0, itemLabelIndex));\n                    }\n                  : undefined\n              }\n            >\n              <div className=\"text- flex items-center gap-2\">\n                {itemLabelIndex < selectedItems.length ? (\n                  <Icon name=\"status-tracked\" />\n                ) : (\n                  <Icon name=\"status-untracked\" />\n                )}\n                <div className={classNames(NO_WRAP_ELLIPSIS_CLASS_NAMES)}>{t(itemLabel)}</div>\n              </div>\n              {itemLabelIndex < selectedItems.length ? (\n                <div className={classNames('text-[14px] text-white', NO_WRAP_ELLIPSIS_CLASS_NAMES)}>\n                  {selectedItems[itemLabelIndex].name}\n                </div>\n              ) : (\n                <br></br>\n              )}\n            </div>\n          );\n        })}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"flex h-[calc(100vh-300px)] select-none flex-col gap-4 pt-0.5\">\n      {getSelectedItemsComponent()}\n      <div className=\"h-0.5 w-full shrink-0 bg-black\"></div>\n      {errorMessage ? (\n        getErrorComponent()\n      ) : (\n        <ItemListComponent\n          itemLabel={itemLabels[currentSelectedItemIndex + 1]}\n          itemList={itemList}\n          onItemClicked={item => {\n            setShowFullConfig(false);\n            setSelectedItems(theList => [...theList.slice(0, currentSelectedItemIndex + 1), item]);\n          }}\n        ></ItemListComponent>\n      )}\n    </div>\n  );\n}\n\nexport default DataSourceConfigurationModalComponent;\n","import React, { ReactElement, useCallback, useEffect, useState } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { Icon, useModal } from '@ohif/ui';\nimport { ExtensionManager, ServicesManager, Types } from '@ohif/core';\nimport DataSourceConfigurationModalComponent from './DataSourceConfigurationModalComponent';\n\ntype DataSourceConfigurationComponentProps = {\n  servicesManager: ServicesManager;\n  extensionManager: ExtensionManager;\n};\n\nfunction DataSourceConfigurationComponent({\n  servicesManager,\n  extensionManager,\n}: DataSourceConfigurationComponentProps): ReactElement {\n  const { t } = useTranslation('DataSourceConfiguration');\n  const { show, hide } = useModal();\n\n  const { customizationService } = servicesManager.services;\n\n  const [configurationAPI, setConfigurationAPI] = useState<Types.BaseDataSourceConfigurationAPI>();\n\n  const [configuredItems, setConfiguredItems] =\n    useState<Array<Types.BaseDataSourceConfigurationAPIItem>>();\n\n  useEffect(() => {\n    let shouldUpdate = true;\n\n    const dataSourceChangedCallback = async () => {\n      const activeDataSourceDef = extensionManager.getActiveDataSourceDefinition();\n\n      if (!activeDataSourceDef.configuration.configurationAPI) {\n        return;\n      }\n\n      const { factory: configurationAPIFactory } =\n        customizationService.get(activeDataSourceDef.configuration.configurationAPI) ?? {};\n\n      if (!configurationAPIFactory) {\n        return;\n      }\n\n      const configAPI = configurationAPIFactory(activeDataSourceDef.sourceName);\n      setConfigurationAPI(configAPI);\n\n      // New configuration API means that the existing configured items must be cleared.\n      setConfiguredItems(null);\n\n      configAPI.getConfiguredItems().then(list => {\n        if (shouldUpdate) {\n          setConfiguredItems(list);\n        }\n      });\n    };\n\n    const sub = extensionManager.subscribe(\n      extensionManager.EVENTS.ACTIVE_DATA_SOURCE_CHANGED,\n      dataSourceChangedCallback\n    );\n\n    dataSourceChangedCallback();\n\n    return () => {\n      shouldUpdate = false;\n      sub.unsubscribe();\n    };\n  }, []);\n\n  const showConfigurationModal = useCallback(() => {\n    show({\n      content: DataSourceConfigurationModalComponent,\n      title: t('Configure Data Source'),\n      contentProps: {\n        configurationAPI,\n        configuredItems,\n        onHide: hide,\n      },\n    });\n  }, [configurationAPI, configuredItems]);\n\n  useEffect(() => {\n    if (!configurationAPI || !configuredItems) {\n      return;\n    }\n\n    if (configuredItems.length !== configurationAPI.getItemLabels().length) {\n      // Not the correct number of configured items, so show the modal to configure the data source.\n      showConfigurationModal();\n    }\n  }, [configurationAPI, configuredItems, showConfigurationModal]);\n\n  return configuredItems ? (\n    <div className=\"text-aqua-pale flex items-center overflow-hidden\">\n      <Icon\n        name=\"settings\"\n        className=\"mr-2.5 h-3.5 w-3.5 shrink-0 cursor-pointer\"\n        onClick={showConfigurationModal}\n      ></Icon>\n      {configuredItems.map((item, itemIndex) => {\n        return (\n          <div\n            key={itemIndex}\n            className=\"flex overflow-hidden\"\n          >\n            <div\n              key={itemIndex}\n              className=\"overflow-hidden text-ellipsis whitespace-nowrap\"\n            >\n              {item.name}\n            </div>\n            {itemIndex !== configuredItems.length - 1 && <div className=\"px-2.5\">|</div>}\n          </div>\n        );\n      })}\n    </div>\n  ) : (\n    <></>\n  );\n}\n\nexport default DataSourceConfigurationComponent;\n","import { ExtensionManager, Types } from '@ohif/core';\n\n/**\n * This file contains the implementations of BaseDataSourceConfigurationAPIItem\n * and BaseDataSourceConfigurationAPI for the Google cloud healthcare API. To\n * better understand this implementation and/or to implement custom implementations,\n * see the platform\\core\\src\\types\\DataSourceConfigurationAPI.ts and its JS doc\n * comments as a guide.\n */\n\n/**\n * The various Google Cloud Healthcare path item types.\n */\nenum ItemType {\n  projects = 0,\n  locations = 1,\n  datasets = 2,\n  dicomStores = 3,\n}\n\ninterface NamedItem {\n  name: string;\n}\ninterface Project extends NamedItem {\n  projectId: string;\n}\n\nconst initialUrl = 'https://cloudresourcemanager.googleapis.com/v1';\nconst baseHealthcareUrl = 'https://healthcare.googleapis.com/v1';\n\nclass GoogleCloudDataSourceConfigurationAPIItem\n  implements Types.BaseDataSourceConfigurationAPIItem\n{\n  id: string;\n  name: string;\n  url: string;\n  itemType: ItemType;\n}\n\nclass GoogleCloudDataSourceConfigurationAPI implements Types.BaseDataSourceConfigurationAPI {\n  private _extensionManager: ExtensionManager;\n  private _fetchOptions: { method: string; headers: unknown };\n  private _dataSourceName: string;\n\n  constructor(dataSourceName, servicesManager, extensionManager) {\n    this._dataSourceName = dataSourceName;\n    this._extensionManager = extensionManager;\n    const userAuthenticationService = servicesManager.services.userAuthenticationService;\n    this._fetchOptions = {\n      method: 'GET',\n      headers: userAuthenticationService.getAuthorizationHeader(),\n    };\n  }\n\n  getItemLabels = () => ['Project', 'Location', 'Data set', 'DICOM store'];\n\n  async initialize(): Promise<Types.BaseDataSourceConfigurationAPIItem[]> {\n    const url = `${initialUrl}/projects`;\n\n    const projects = (await GoogleCloudDataSourceConfigurationAPI._doFetch(\n      url,\n      ItemType.projects,\n      this._fetchOptions\n    )) as Array<Project>;\n\n    if (!projects?.length) {\n      return [];\n    }\n\n    const projectItems = projects.map(project => {\n      return {\n        id: project.projectId,\n        name: project.name,\n        itemType: ItemType.projects,\n        url: `${baseHealthcareUrl}/projects/${project.projectId}`,\n      };\n    });\n\n    return projectItems;\n  }\n\n  async setCurrentItem(\n    anItem: Types.BaseDataSourceConfigurationAPIItem\n  ): Promise<Types.BaseDataSourceConfigurationAPIItem[]> {\n    const googleCloudItem = anItem as GoogleCloudDataSourceConfigurationAPIItem;\n\n    if (googleCloudItem.itemType === ItemType.dicomStores) {\n      // Last configurable item, so update the data source configuration.\n      const url = `${googleCloudItem.url}/dicomWeb`;\n      const dataSourceDefCopy = JSON.parse(\n        JSON.stringify(this._extensionManager.getDataSourceDefinition(this._dataSourceName))\n      );\n      dataSourceDefCopy.configuration = {\n        ...dataSourceDefCopy.configuration,\n        wadoUriRoot: url,\n        qidoRoot: url,\n        wadoRoot: url,\n      };\n\n      this._extensionManager.updateDataSourceConfiguration(\n        dataSourceDefCopy.sourceName,\n        dataSourceDefCopy.configuration\n      );\n\n      return [];\n    }\n\n    const subItemType = googleCloudItem.itemType + 1;\n    const subItemField = `${ItemType[subItemType]}`;\n\n    const url = `${googleCloudItem.url}/${subItemField}`;\n\n    const fetchedSubItems = await GoogleCloudDataSourceConfigurationAPI._doFetch(\n      url,\n      subItemType,\n      this._fetchOptions\n    );\n\n    if (!fetchedSubItems?.length) {\n      return [];\n    }\n\n    const subItems = fetchedSubItems.map(subItem => {\n      const nameSplit = subItem.name.split('/');\n      return {\n        id: subItem.name,\n        name: nameSplit[nameSplit.length - 1],\n        itemType: subItemType,\n        url: `${baseHealthcareUrl}/${subItem.name}`,\n      };\n    });\n\n    return subItems;\n  }\n\n  async getConfiguredItems(): Promise<Array<GoogleCloudDataSourceConfigurationAPIItem>> {\n    const dataSourceDefinition = this._extensionManager.getDataSourceDefinition(\n      this._dataSourceName\n    );\n\n    const url = dataSourceDefinition.configuration.wadoUriRoot;\n    const projectsIndex = url.indexOf('projects');\n    // Split the configured URL into (essentially) pairs (i.e. item type followed by item)\n    // Explicitly: ['projects','aProject','locations','aLocation','datasets','aDataSet','dicomStores','aDicomStore']\n    // Note that a partial configuration will have a subset of the above.\n    const urlSplit = url.substring(projectsIndex).split('/');\n\n    const configuredItems = [];\n\n    for (\n      let itemType = 0;\n      // the number of configured items is either the max (4) or the number extracted from the url split\n      itemType < 4 && (itemType + 1) * 2 < urlSplit.length;\n      itemType += 1\n    ) {\n      if (itemType === ItemType.projects) {\n        const projectId = urlSplit[1];\n        const projectUrl = `${initialUrl}/projects/${projectId}`;\n        const data = await GoogleCloudDataSourceConfigurationAPI._doFetch(\n          projectUrl,\n          ItemType.projects,\n          this._fetchOptions\n        );\n        const project = data[0] as Project;\n        configuredItems.push({\n          id: project.projectId,\n          name: project.name,\n          itemType: itemType,\n          url: `${baseHealthcareUrl}/projects/${project.projectId}`,\n        });\n      } else {\n        const relativePath = urlSplit.slice(0, itemType * 2 + 2).join('/');\n        configuredItems.push({\n          id: relativePath,\n          name: urlSplit[itemType * 2 + 1],\n          itemType: itemType,\n          url: `${baseHealthcareUrl}/${relativePath}`,\n        });\n      }\n    }\n\n    return configuredItems;\n  }\n\n  /**\n   * Fetches an array of items the specified item type.\n   * @param urlStr the fetch url\n   * @param fetchItemType the type to fetch\n   * @param fetchOptions the header options for the fetch (e.g. authorization header)\n   * @param fetchSearchParams any search query params; currently only used for paging results\n   * @returns an array of items of the specified type\n   */\n  private static async _doFetch(\n    urlStr: string,\n    fetchItemType: ItemType,\n    fetchOptions = {},\n    fetchSearchParams: Record<string, string> = {}\n  ): Promise<Array<Project> | Array<NamedItem>> {\n    try {\n      const url = new URL(urlStr);\n      url.search = new URLSearchParams(fetchSearchParams).toString();\n\n      const response = await fetch(url, fetchOptions);\n      const data = await response.json();\n      if (response.status >= 200 && response.status < 300 && data != null) {\n        if (data.nextPageToken != null) {\n          fetchSearchParams.pageToken = data.nextPageToken;\n          const subPageData = await this._doFetch(\n            urlStr,\n            fetchItemType,\n            fetchOptions,\n            fetchSearchParams\n          );\n          data[ItemType[fetchItemType]] = data[ItemType[fetchItemType]].concat(subPageData);\n        }\n        if (data[ItemType[fetchItemType]]) {\n          return data[ItemType[fetchItemType]];\n        } else if (data.name) {\n          return [data];\n        } else {\n          return [];\n        }\n      } else {\n        const message =\n          data?.error?.message ||\n          `Error returned from Google Cloud Healthcare: ${response.status} - ${response.statusText}`;\n        throw new Error(message);\n      }\n    } catch (err) {\n      const message = err?.message || 'Error occurred during fetch request.';\n      throw new Error(message);\n    }\n  }\n}\n\nexport { GoogleCloudDataSourceConfigurationAPI };\n","import OHIF from '@ohif/core';\n\nimport { InstanceMetadata, PhilipsPETPrivateGroup } from '@cornerstonejs/calculate-suv/src/types';\n\nconst metadataProvider = OHIF.classes.MetadataProvider;\n\nexport default function getPTImageIdInstanceMetadata(imageId: string): InstanceMetadata {\n  const dicomMetaData = metadataProvider.get('instance', imageId);\n\n  if (!dicomMetaData) {\n    throw new Error('dicom metadata are required');\n  }\n\n  if (\n    dicomMetaData.SeriesDate === undefined ||\n    dicomMetaData.SeriesTime === undefined ||\n    dicomMetaData.CorrectedImage === undefined ||\n    dicomMetaData.Units === undefined ||\n    !dicomMetaData.RadiopharmaceuticalInformationSequence ||\n    dicomMetaData.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife === undefined ||\n    dicomMetaData.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose === undefined ||\n    dicomMetaData.DecayCorrection === undefined ||\n    dicomMetaData.AcquisitionDate === undefined ||\n    dicomMetaData.AcquisitionTime === undefined ||\n    (dicomMetaData.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime ===\n      undefined &&\n      dicomMetaData.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime ===\n        undefined)\n  ) {\n    throw new Error('required metadata are missing');\n  }\n\n  if (dicomMetaData.PatientWeight === undefined) {\n    console.warn('PatientWeight missing from PT instance metadata');\n  }\n\n  const instanceMetadata: InstanceMetadata = {\n    CorrectedImage: dicomMetaData.CorrectedImage,\n    Units: dicomMetaData.Units,\n    RadionuclideHalfLife:\n      dicomMetaData.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife,\n    RadionuclideTotalDose:\n      dicomMetaData.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose,\n    RadiopharmaceuticalStartDateTime:\n      dicomMetaData.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime,\n    RadiopharmaceuticalStartTime:\n      dicomMetaData.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime,\n    DecayCorrection: dicomMetaData.DecayCorrection,\n    PatientWeight: dicomMetaData.PatientWeight,\n    SeriesDate: dicomMetaData.SeriesDate,\n    SeriesTime: dicomMetaData.SeriesTime,\n    AcquisitionDate: dicomMetaData.AcquisitionDate,\n    AcquisitionTime: dicomMetaData.AcquisitionTime,\n  };\n\n  if (\n    dicomMetaData['70531000'] ||\n    dicomMetaData['70531000'] !== undefined ||\n    dicomMetaData['70531009'] ||\n    dicomMetaData['70531009'] !== undefined\n  ) {\n    const philipsPETPrivateGroup: PhilipsPETPrivateGroup = {\n      SUVScaleFactor: dicomMetaData['70531000'],\n      ActivityConcentrationScaleFactor: dicomMetaData['70531009'],\n    };\n    instanceMetadata.PhilipsPETPrivateGroup = philipsPETPrivateGroup;\n  }\n\n  if (dicomMetaData['0009100d'] && dicomMetaData['0009100d'] !== undefined) {\n    instanceMetadata.GEPrivatePostInjectionDateTime = dicomMetaData['0009100d'];\n  }\n\n  if (dicomMetaData.FrameReferenceTime && dicomMetaData.FrameReferenceTime !== undefined) {\n    instanceMetadata.FrameReferenceTime = dicomMetaData.FrameReferenceTime;\n  }\n\n  if (dicomMetaData.ActualFrameDuration && dicomMetaData.ActualFrameDuration !== undefined) {\n    instanceMetadata.ActualFrameDuration = dicomMetaData.ActualFrameDuration;\n  }\n\n  if (dicomMetaData.PatientSex && dicomMetaData.PatientSex !== undefined) {\n    instanceMetadata.PatientSex = dicomMetaData.PatientSex;\n  }\n\n  if (dicomMetaData.PatientSize && dicomMetaData.PatientSize !== undefined) {\n    instanceMetadata.PatientSize = dicomMetaData.PatientSize;\n  }\n\n  return instanceMetadata;\n}\n\nfunction convertInterfaceTimeToString(time): string {\n  const hours = `${time.hours || '00'}`.padStart(2, '0');\n  const minutes = `${time.minutes || '00'}`.padStart(2, '0');\n  const seconds = `${time.seconds || '00'}`.padStart(2, '0');\n\n  const fractionalSeconds = `${time.fractionalSeconds || '000000'}`.padEnd(6, '0');\n\n  const timeString = `${hours}${minutes}${seconds}.${fractionalSeconds}`;\n  return timeString;\n}\n\nfunction convertInterfaceDateToString(date): string {\n  const month = `${date.month}`.padStart(2, '0');\n  const day = `${date.day}`.padStart(2, '0');\n  const dateString = `${date.year}${month}${day}`;\n  return dateString;\n}\n\nexport { getPTImageIdInstanceMetadata };\n","import { DicomMetadataStore, classes } from '@ohif/core';\nimport { calculateSUVScalingFactors } from '@cornerstonejs/calculate-suv';\n\nimport getPTImageIdInstanceMetadata from './getPTImageIdInstanceMetadata';\n\nconst metadataProvider = classes.MetadataProvider;\n\n/**\n *\n * @param {Object} servicesManager\n * @param {Object} configuration\n */\nexport default function init({ servicesManager, configuration = {} }): void {\n  const { stateSyncService } = servicesManager.services;\n  // Add\n  DicomMetadataStore.subscribe(DicomMetadataStore.EVENTS.INSTANCES_ADDED, handlePETImageMetadata);\n\n  // If the metadata for PET has changed by the user (e.g. manually changing the PatientWeight)\n  // we need to recalculate the SUV Scaling Factors\n  DicomMetadataStore.subscribe(DicomMetadataStore.EVENTS.SERIES_UPDATED, handlePETImageMetadata);\n\n  // viewportGridStore is a sync state which stores the entire\n  // ViewportGridService getState, by the keys `<activeStudyUID>:<protocolId>:<stageIndex>`\n  // Used to recover manual changes to the layout of a stage.\n  stateSyncService.register('viewportGridStore', { clearOnModeExit: true });\n\n  // displaySetSelectorMap stores a map from\n  // `<activeStudyUID>:<displaySetSelectorId>:<matchOffset>` to\n  // a displaySetInstanceUID, used to display named display sets in\n  // specific spots within a hanging protocol and be able to remember what the\n  // user did with those named spots between stages and protocols.\n  stateSyncService.register('displaySetSelectorMap', { clearOnModeExit: true });\n\n  // Stores a map from `<activeStudyUID>:${protocolId}` to the getHPInfo results\n  // in order to recover the correct stage when returning to a Hanging Protocol.\n  stateSyncService.register('hangingProtocolStageIndexMap', {\n    clearOnModeExit: true,\n  });\n\n  // Stores a map from the to be applied hanging protocols `<activeStudyUID>:<protocolId>`\n  // to the previously applied hanging protolStageIndexMap key, in order to toggle\n  // off the applied protocol and remember the old state.\n  stateSyncService.register('toggleHangingProtocol', { clearOnModeExit: true });\n\n  // Stores the viewports by `rows-cols` position so that when the layout\n  // changes numRows and numCols, the viewports can be remembers and then replaced\n  // afterwards.\n  stateSyncService.register('viewportsByPosition', { clearOnModeExit: true });\n}\n\nconst handlePETImageMetadata = ({ SeriesInstanceUID, StudyInstanceUID }) => {\n  const { instances } = DicomMetadataStore.getSeries(StudyInstanceUID, SeriesInstanceUID);\n\n  if (!instances?.length) {\n    return;\n  }\n\n  const modality = instances[0].Modality;\n\n  if (!modality || modality !== 'PT') {\n    return;\n  }\n\n  const imageIds = instances.map(instance => instance.imageId);\n  const instanceMetadataArray = [];\n\n  // try except block to prevent errors when the metadata is not correct\n  try {\n    imageIds.forEach(imageId => {\n      const instanceMetadata = getPTImageIdInstanceMetadata(imageId);\n      if (instanceMetadata) {\n        instanceMetadataArray.push(instanceMetadata);\n      }\n    });\n\n    if (!instanceMetadataArray.length) {\n      return;\n    }\n\n    const suvScalingFactors = calculateSUVScalingFactors(instanceMetadataArray);\n    instanceMetadataArray.forEach((instanceMetadata, index) => {\n      metadataProvider.addCustomMetadata(\n        imageIds[index],\n        'scalingModule',\n        suvScalingFactors[index]\n      );\n    });\n  } catch (error) {\n    console.log(error);\n  }\n};\n","import { Types } from '@ohif/core';\n\nimport getDataSourcesModule from './getDataSourcesModule.js';\nimport getLayoutTemplateModule from './getLayoutTemplateModule.js';\nimport getPanelModule from './getPanelModule';\nimport getSopClassHandlerModule from './getSopClassHandlerModule.js';\nimport getToolbarModule from './getToolbarModule';\nimport getCommandsModule from './commandsModule';\nimport getHangingProtocolModule from './getHangingProtocolModule';\nimport getStudiesForPatientByMRN from './Panels/getStudiesForPatientByMRN';\nimport getCustomizationModule from './getCustomizationModule';\nimport { id } from './id.js';\nimport preRegistration from './init';\nimport { ContextMenuController, CustomizableContextMenuTypes } from './CustomizableContextMenu';\nimport * as dicomWebUtils from './DicomWebDataSource/utils';\nimport { createReportDialogPrompt } from './Panels';\nimport createReportAsync from './Actions/createReportAsync';\n\nconst defaultExtension: Types.Extensions.Extension = {\n  /**\n   * Only required property. Should be a unique value across all extensions.\n   */\n  id,\n  preRegistration,\n  getDataSourcesModule,\n  getLayoutTemplateModule,\n  getPanelModule,\n  getHangingProtocolModule,\n  getSopClassHandlerModule,\n  getToolbarModule,\n  getCommandsModule,\n  getUtilityModule({ servicesManager }) {\n    return [\n      {\n        name: 'common',\n        exports: {\n          getStudiesForPatientByMRN,\n        },\n      },\n    ];\n  },\n\n  getCustomizationModule,\n};\n\nexport default defaultExtension;\n\nexport {\n  ContextMenuController,\n  CustomizableContextMenuTypes,\n  getStudiesForPatientByMRN,\n  dicomWebUtils,\n  createReportDialogPrompt,\n  createReportAsync,\n};\n","import ViewerLayout from './ViewerLayout';\n/*\n- Define layout for the viewer in mode configuration.\n- Pass in the viewport types that can populate the viewer.\n- Init layout based on the displaySets and the objects.\n*/\n\nexport default function ({ servicesManager, extensionManager, commandsManager, hotkeysManager }) {\n  function ViewerLayoutWithServices(props) {\n    return ViewerLayout({\n      servicesManager,\n      extensionManager,\n      commandsManager,\n      hotkeysManager,\n      ...props,\n    });\n  }\n\n  return [\n    // Layout Template Definition\n    // TODO: this is weird naming\n    {\n      name: 'viewerLayout',\n      id: 'viewerLayout',\n      component: ViewerLayoutWithServices,\n    },\n  ];\n}\n","import ToolbarDivider from './Toolbar/ToolbarDivider';\nimport ToolbarLayoutSelectorWithServices from './Toolbar/ToolbarLayoutSelector';\nimport ToolbarSplitButtonWithServices from './Toolbar/ToolbarSplitButtonWithServices';\nimport ToolbarButtonWithServices from './Toolbar/ToolbarButtonWithServices';\n\nexport default function getToolbarModule({ commandsManager, servicesManager }) {\n  return [\n    {\n      name: 'ohif.divider',\n      defaultComponent: ToolbarDivider,\n      clickHandler: () => {},\n    },\n    {\n      name: 'ohif.action',\n      defaultComponent: ToolbarButtonWithServices,\n      clickHandler: () => {},\n    },\n    {\n      name: 'ohif.radioGroup',\n      defaultComponent: ToolbarButtonWithServices,\n      clickHandler: () => {},\n    },\n    {\n      name: 'ohif.splitButton',\n      defaultComponent: ToolbarSplitButtonWithServices,\n      clickHandler: () => {},\n    },\n    {\n      name: 'ohif.layoutSelector',\n      defaultComponent: ToolbarLayoutSelectorWithServices,\n      clickHandler: (evt, clickedBtn, btnSectionName) => {},\n    },\n    {\n      name: 'ohif.toggle',\n      defaultComponent: ToolbarButtonWithServices,\n      clickHandler: () => {},\n    },\n  ];\n}\n","import { CustomizationService } from '@ohif/core';\nimport React from 'react';\nimport DataSourceSelector from './Panels/DataSourceSelector';\nimport DataSourceConfigurationComponent from './Components/DataSourceConfigurationComponent';\nimport { GoogleCloudDataSourceConfigurationAPI } from './DataSourceConfigurationAPI/GoogleCloudDataSourceConfigurationAPI';\n\n/**\n *\n * Note: this is an example of how the customization module can be used\n * using the customization module. Below, we are adding a new custom route\n * to the application at the path /custom and rendering a custom component\n * Real world use cases of the having a custom route would be to add a\n * custom page for the user to view their profile, or to add a custom\n * page for login etc.\n */\nexport default function getCustomizationModule({ servicesManager, extensionManager }) {\n  return [\n    {\n      name: 'helloPage',\n      value: {\n        id: 'customRoutes',\n        routes: [\n          {\n            path: '/custom',\n            children: () => <h1 style={{ color: 'white' }}>Hello Custom Route</h1>,\n          },\n        ],\n      },\n    },\n\n    // Example customization to list a set of datasources\n    {\n      name: 'datasources',\n      value: {\n        id: 'customRoutes',\n        routes: [\n          {\n            path: '/datasources',\n            children: DataSourceSelector,\n          },\n        ],\n      },\n    },\n\n    {\n      name: 'default',\n      value: [\n        /**\n         * Customization Component Type definition for overlay items.\n         * Overlay items are texts (or other components) that will be displayed\n         * on a Viewport Overlay, which contains the information panels on the\n         * four corners of a viewport.\n         *\n         * @definition of a overlay item using this type\n         * The value to be displayed is defined by\n         *  - setting DICOM image instance's property to this field,\n         *  - or defining contentF()\n         *\n         * {\n         *   id: string - unique id for the overlay item\n         *   customizationType: string - indicates customization type definition to this\n         *   label: string - Label, to be displayed for the item\n         *   title: string - Tooltip, for the item\n         *   color: string - Color of the text\n         *   condition: ({ instance }) => boolean - decides whether to display the overlay item or not\n         *   attribute: string - property name of the DICOM image instance\n         *   contentF: ({ instance, formatters }) => string | component,\n         * }\n         *\n         * @example\n         *  {\n         *    id: 'PatientNameOverlay',\n         *    customizationType: 'ohif.overlayItem',\n         *    label: 'PN:',\n         *    title: 'Patient Name',\n         *    color: 'yellow',\n         *    condition: ({ instance }) => instance && instance.PatientName && instance.PatientName.Alphabetic,\n         *    attribute: 'PatientName',\n         *    contentF: ({ instance, formatters: { formatPN } }) => `${formatPN(instance.PatientName.Alphabetic)} ${(instance.PatientSex ? '(' + instance.PatientSex + ')' : '')}`,\n         *  },\n         *\n         * @see CustomizableViewportOverlay\n         */\n        {\n          id: 'ohif.overlayItem',\n          content: function (props) {\n            if (this.condition && !this.condition(props)) {\n              return null;\n            }\n\n            const { instance } = props;\n            const value =\n              instance && this.attribute\n                ? instance[this.attribute]\n                : this.contentF && typeof this.contentF === 'function'\n                ? this.contentF(props)\n                : null;\n            if (!value) {\n              return null;\n            }\n\n            return (\n              <span\n                className=\"overlay-item flex flex-row\"\n                style={{ color: this.color || undefined }}\n                title={this.title || ''}\n              >\n                {this.label && <span className=\"mr-1 shrink-0\">{this.label}</span>}\n                <span className=\"font-light\">{value}</span>\n              </span>\n            );\n          },\n        },\n\n        {\n          id: 'ohif.contextMenu',\n\n          /** Applies the customizationType to all the menu items.\n           * This function clones the object and child objects to prevent\n           * changes to the original customization object.\n           */\n          transform: function (customizationService: CustomizationService) {\n            // Don't modify the children, as those are copied by reference\n            const clonedObject = { ...this };\n            clonedObject.menus = this.menus.map(menu => ({ ...menu }));\n\n            for (const menu of clonedObject.menus) {\n              const { items: originalItems } = menu;\n              menu.items = [];\n              for (const item of originalItems) {\n                menu.items.push(customizationService.transform(item));\n              }\n            }\n            return clonedObject;\n          },\n        },\n\n        {\n          // the generic GUI component to configure a data source using an instance of a BaseDataSourceConfigurationAPI\n          id: 'ohif.dataSourceConfigurationComponent',\n          component: DataSourceConfigurationComponent.bind(null, {\n            servicesManager,\n            extensionManager,\n          }),\n        },\n\n        {\n          // The factory for creating an instance of a BaseDataSourceConfigurationAPI for Google Cloud Healthcare\n          id: 'ohif.dataSourceConfigurationAPI.google',\n          factory: (dataSourceName: string) =>\n            new GoogleCloudDataSourceConfigurationAPI(\n              dataSourceName,\n              servicesManager,\n              extensionManager\n            ),\n        },\n      ],\n    },\n  ];\n}\n"],"names":["getString","getName","getModalities","DICOMWeb","processResults","qidoStudies","length","studies","forEach","qidoStudy","push","studyInstanceUid","date","time","accession","mrn","patientName","utils","formatPN","instances","Number","description","modalities","async","search","dicomWebClient","seriesInstanceUid","queryParameters","searchForStudies","undefined","queryParams","mapParams","params","options","commaSeparatedFields","join","supportsWildcard","withWildcard","value","parameters","PatientName","patientId","AccessionNumber","accessionNumber","StudyDescription","studyDescription","ModalitiesInStudy","modalitiesInStudy","limit","offset","fuzzymatching","supportsFuzzyMatching","includefield","startDate","endDate","StudyDate","today","Date","DD","String","getDate","padStart","MM","getMonth","todayStr","getFullYear","oldDateStr","studyUids","Array","isArray","replace","StudyInstanceUID","final","Object","keys","key","getImageId","instance","frame","config","thumbnail","url","renderingAttr","uri","baseWadoRsUri","SeriesInstanceUID","SOPInstanceUID","wadoRoot","buildInstanceWadoRsUri","buildInstanceFrameWadoRsUri","getWADORSImageId","wadouri","paramString","wadoUriRoot","buildInstanceWadoUrl","imageId","RetrieveMetadataLoader","constructor","client","studyInstanceUID","filters","sortCriteria","sortFunction","this","execLoad","preLoadData","preLoad","loadData","load","posLoad","runLoaders","loaders","result","loader","next","done","Error","configLoad","RetrieveMetadataLoaderSync","getOptions","seriesInstanceUID","getLoaders","retrieveSeriesMetadata","bind","retrieveStudyMetadata","includeField","DeferredPromise","metadata","processFunction","internalPromise","thenFunction","rejectFunction","setMetadata","setProcessFunction","func","getPromise","start","then","reject","RetrieveMetadataLoaderAsync","getPreLoaders","preLoaders","searchForSeries","naturalizeDataset","dcmjs","DicomMetaDictionary","naturalized","map","sortStudySeries","seriesAsyncLoader","seriesInstanceUIDList","freeze","hasNext","shift","promise","makeSeriesAsyncLoader","seriesMetadata","promises","enableStudyLazyLoad","retrieveMetadataLoader","SeriesInstanceUIDs","Promise","resolve","uid","seriesSpecificFilters","assign","RetrieveMetadata","all","results","aggregatedResult","concat","moduleName","StudyMetaDataPromises","Map","dicomWebConfig","promiseId","name","has","get","retrieveMetadataFiltered","data","set","deleteStudyMetadataPromise","delete","StaticWadoClient","api","DICOMwebClient","qidoConfig","super","staticWado","searchResult","lowerParams","toLowerParams","filter","study","studyFilterKeys","filterItem","series","seriesFilterKeys","compareValues","desired","actual","find","item","actualItem","Alphabetic","indexOf","substring","compareDateRange","range","dash","end","sourceFilterMap","altKey","testValue","valueElem","vr","Value","entries","toLowerCase","studyinstanceuid","patientname","studydescription","studydate","modalitiesinstudy","accessionnumber","seriesinstanceuid","seriesnumber","modality","getDirectURL","singlepart","tag","defaultPath","defaultType","fetchPart","DirectRetrieveURL","InlineBinary","blob","b64toBlob","URL","createObjectURL","retrieveBulkData","mediaType","arr","Blob","type","console","warn","BulkDataURI","hasQuery","hasAccept","fixBulkDataURI","startsWith","origin","bulkDataURI","relativeResolution","DicomDict","denaturalizeDataset","ImplementationClassUID","ImplementationVersionName","EXPLICIT_VR_LITTLE_ENDIAN","metadataProvider","classes","MetadataProvider","createDicomWebApi","servicesManager","userAuthenticationService","customizationService","services","dicomWebConfigCopy","wadoConfig","qidoDicomWebClient","wadoDicomWebClient","getAuthrorizationHeader","generateWadoHeader","implementation","initialize","query","onConfiguration","JSON","parse","stringify","xhrRequestHeaders","authHeaders","getAuthorizationHeader","Authorization","Accept","generateAcceptHeader","acceptHeader","requestTransferSyntaxUID","omitQuotationForMultipartRequest","qidoRoot","headers","errorInterceptor","errorHandler","getHTTPErrorHandler","origParams","mappedParams","qidoSearch","qidoSeries","seriesNumber","seriesDate","formatDate","numSeriesInstances","processSeriesResults","seriesInStudy","call","retrieve","directURL","multipart","val","madeInClient","returnPromises","_retrieveSeriesMetadataAsync","_retrieveSeriesMetadataSync","store","dicom","dataset","request","dicomDict","ArrayBuffer","datasets","storeInstances","effectiveDicomDict","meta","FileMetaInformationVersion","_meta","MediaStorageSOPClassUID","SOPClassUID","MediaStorageSOPInstanceUID","TransferSyntaxUID","denaturalized","defaultDicomDict","dict","write","naturalizedInstancesMetadata","seriesSummaryMetadata","instancesPerSeries","SeriesDescription","SeriesNumber","SeriesTime","ProtocolName","Modality","getImageIdsForInstance","wadoUri","addImageIdToUIDs","values","DicomMetadataStore","addSeriesMetadata","addInstances","seriesPromises","addRetrieveBulkData","enabled","useOptions","mediaTypes","ret","arrayBuffer","byteLength","setSuccessFlag","getStudy","isLoaded","aSeries","seriesDeliveredPromises","naturalizedInstances","getImageIdsForDisplaySet","displaySet","images","imageIds","NumberOfFrames","getConfig","getStudyInstanceUIDs","StudyInstanceUIDs","paramsStudyInstanceUIDs","queryStudyInstanceUIDs","splitComma","getAll","supportsReject","xhr","XMLHttpRequest","open","log","onreadystatechange","readyState","status","responseText","send","IWebApiDataSource","create","OHIF","mappings","_store","urls","studyInstanceUIDMap","wrapSequences","obj","reduce","acc","endsWith","addAccessors","getMetaDataByURL","metaData","findStudies","aStudy","createDicomJSONApi","dicomJsonConfig","response","fetch","json","naturalizedDicom","param","mappedParam","NumInstances","Modalities","PatientID","StudyTime","customSort","seriesSummary","numberOfSeries","index","i","EVENTS","END_MODALITIES","SR","SEG","DOC","compareValue","v1","v2","def","seriesA","seriesB","instanceA","instanceB","modalityA","modalityB","isEndA","isEndB","createDicomLocalApi","dicomLocalConfig","numInstances","Set","add","firstInstance","from","SeriesDate","_broadcastEvent","SERIES_ADDED","isMultiframe","frameIndex","INSTANCES_ADDED","naturalizedReport","reportBlob","datasetToBlob","objectUrl","window","location","getInstance","StudyInstanceUIDsAsArray","isStudyInCache","sort","SQL_STATEMENT_API","createDatabricksPixelsDicom","dcmConfig","dicomConfig","databricksClient","warehouseId","info","token","serverHostname","httpPath","pixelsTable","connectOptions","axios","baseURL","defaults","common","split","body","post","data_array","qidoStudiesSearch","qidoSeriesSearch","sopInstanceUID","path","qidoSeriesMetadataSearch","qidoSeriesMetadata","currentSerie","serie","StudyInstanceUid","SeriesInstanceUid","InstanceNumber","numImageFrames","replaceAll","processSeriesMetadataResults","relative_path","seriesDescription","seriesTime","sopClassUID","protocolName","createDicomWebProxyApi","dicomWebProxyConfig","dicomWebDelegate","servers","dicomWeb","configuration","args","studyInstanceUIDs","mergeMap","mergeKey","tagFunc","x","sourceName","RetrieveAETitle","updateSeriesMetadata","callForAllDataSourcesAsync","extensionManager","dataSourceNames","defaultDataSourceName","defs","dataSourceDefs","defaultDataSourceDef","unshift","sourceNames","dataSourceDef","includes","dataSource","getDataSources","apply","mergedData","allSettled","uniqBy","flat","callForAllDataSources","callForDefaultDataSource","callByRetrieveAETitle","getSeries","createMergeDataSourceApi","mergeConfig","seriesMerge","createDataSource","Toolbar","toolbarService","viewportGrid","viewportGridService","useViewportGrid","toolbarButtons","setToolbarButtons","useState","useEffect","updateToolbar","toolGroupId","getActiveViewportOptionByKey","getButtonSection","unsubscribe","subscribe","TOOL_BAR_MODIFIED","onInteraction","useCallback","recordInteraction","React","toolDef","id","Component","componentProps","className","classnames","_extends","availableLanguages","defaultLanguage","currentLanguage","i18n","hotkeysManager","appConfig","useAppConfig","navigate","useNavigate","useLocation","t","useTranslation","show","hide","useModal","hotkeyDefinitions","hotkeyDefaults","menuOptions","title","icon","onClick","content","AboutModal","contentProps","versionNumber","process","commitHash","UserPreferences","getValidHotkeyDefinitions","onCancel","hotkeys","stopRecord","unpause","onSubmit","language","changeLanguage","setHotkeys","onReset","restoreDefaultBindings","hotkeysModule","oidc","encodeURIComponent","href","Header","isReturnEnabled","showStudyList","onClickReturnButton","pathname","dataSourceIdx","configUrl","URLSearchParams","dataSourceName","existingDataSource","searchQuery","append","decodeURIComponent","toString","WhiteLabeling","whiteLabeling","ErrorBoundary","context","SidePanelWithServices","side","activeTabIndex","activeTabIndexProp","tabs","expandedWidth","panelService","hasBeenOpened","setHasBeenOpened","setActiveTabIndex","activatePanelSubscription","ACTIVATE_PANEL","activatePanelEvent","forceActive","tabIndex","findIndex","tab","panelId","SidePanel","onOpen","ViewerLayout","commandsManager","viewports","ViewportGridComp","leftPanels","rightPanels","leftPanelDefaultClosed","rightPanelDefaultClosed","hangingProtocolService","showLoadingIndicator","setShowLoadingIndicator","document","classList","remove","getComponent","entry","getModuleEntry","component","getPanelData","iconName","iconLabel","label","HangingProtocolService","PROTOCOL_CHANGED","leftPanelComponents","rightPanelComponents","viewportComponents","viewportComponent","namespace","displaySetsToDisplay","ViewerHeader","style","height","LoadingIndicatorProgress","propTypes","PropTypes","isRequired","CommandsManager","ServicesManager","children","sortStudyInstances","PanelStudyBrowser","getImageSrc","getStudiesForPatientByMRN","requestDisplaySetCreationForStudy","displaySetService","uiNotificationService","useImageViewer","activeViewportId","activeTabName","setActiveTabName","expandedStudyInstanceUIDs","setExpandedStudyInstanceUIDs","studyDisplayList","setStudyDisplayList","displaySets","setDisplaySets","thumbnailImageSrcMap","setThumbnailImageSrcMap","sid","qidoForStudyUID","qidoStudiesForPatient","error","actuallyMappedStudies","prevArray","it","fetchStudiesForPatient","activeDisplaySets","newImageSrcEntry","getDisplaySetByUID","dSet","displaySetInstanceUID","Math","floor","unsupported","prevState","mappedDisplaySets","_mapDisplaySets","SubscriptionDisplaySetsAdded","DISPLAY_SETS_ADDED","displaySetsAdded","initialViewport","SubscriptionDisplaySetsChanged","DISPLAY_SETS_CHANGED","changedDisplaySets","SubscriptionDisplaySetMetaDataInvalidated","DISPLAY_SET_SERIES_METADATA_INVALIDATED","getActiveDisplaySets","primaryStudyInstanceUIDs","primaryStudies","recentStudies","allStudies","displaySetsForStudy","ds","tabStudy","_createStudyBrowserTabs","activeDisplaySetInstanceUIDs","displaySetInstanceUIDs","StudyBrowser","onDoubleClickThumbnail","updatedViewports","viewportId","getViewportsRequireUpdate","message","duration","setDisplaySetsForViewports","onClickStudy","shouldCollapseStudy","updatedExpandedStudyInstanceUIDs","stdyUid","onClickTab","clickedTabName","thumbnailDisplaySets","thumbnailNoImageDisplaySets","excludeFromThumbnailBrowser","imageSrc","componentType","thumbnailNoImageModalities","_getComponentType","countIcon","messages","dragData","isHydratedForDerivedDisplaySet","isHydrated","cornerstone","canvas","createElement","utilities","loadImageToCanvas","toDataURL","catch","some","WrappedPanelStudyBrowser","_getStudiesForPatientByMRN","_getImageSrcFromImageId","exports","getCornerstoneLibraries","getImageSrcFromImageId","ex","_createGetImageSrcFromImageIdFn","_requestDisplaySetCreationForStudy","ActionButtons","onExportClick","onCreateReportClick","LegacyButtonGroup","color","size","LegacyButton","defaultProps","alert","CREATE_REPORT_DIALOG_RESPONSE","CANCEL","CREATE_REPORT","CreateReportDialogPrompt","uiDialogService","dialogId","dataSourcesOpts","dataSourceMap","supportsStow","placeHolder","centralize","isDraggable","Dialog","useLastPosition","showOverlay","activeDataSource","noCloseButton","onClose","_handleClose","dismiss","action","actions","text","ButtonEnums","secondary","primary","_handleFormSubmit","setValue","allowMultiSelectExport","Select","closeMenuOnSelect","placeholder","option","onChange","evt","v","isClearable","Input","autoFocus","labelClassName","event","persist","target","onKeyPress","required","Loading","getReport","reportType","loadingDialogId","getMostRecentDisplaySet","MIN_SR_SERIES_NUMBER","findSRWithSameSeriesDescription","sameSeries","srSeriesNumbers","max","getNextSRSeriesNumber","downloadCSVReport","PanelMeasurementTable","measurementService","displayMeasurements","setDisplayMeasurements","debouncedSetDisplayMeasurements","debounce","_getMappedMeasurements","added","MEASUREMENT_ADDED","addedRaw","RAW_MEASUREMENT_ADDED","updated","MEASUREMENT_UPDATED","removed","MEASUREMENT_REMOVED","cleared","MEASUREMENTS_CLEARED","subscriptions","unsub","cancel","onMeasurementItemClickHandler","isActive","measurements","measurement","m","MeasurementTable","jumpToImage","jumpToMeasurement","onEdit","onMeasurementItemEditHandler","getMeasurement","onSubmitHandler","update","getMeasurements","onClearMeasurementsClick","clearMeasurements","activeViewport","trackedMeasurements","referenceStudyUID","promptResult","createReportDialogPrompt","createReportAsync","runCommand","measurementData","additionalFindingTypes","types","displayText","baseDisplayText","baseLabel","selected","findingSites","finding","firstSite","siteText","site","measurementType","_mapMeasurementToDisplay","VALUE_TYPES","secondaryLabel","wrappedMeasurementPanel","packageJson","_checkSeriesPositionShift","previousPosition","actualPosition","scanAxisNormal","averageSpacingBetweenFrames","predictedPosition","vec3","areAllImagePositionsEqual","firstImageOrientationPatient","toNumber","ImageOrientationPatient","imageOrientation","rowCosineVec","colCosineVec","calculateScanAxisNormal","firstImagePositionPatient","ImagePositionPatient","lastIpp","_getPerpendicularDistance","previousImagePositionPatient","imagePositionPatient","checkSingleFrames","firstImage","firstImageRows","Rows","firstImageColumns","Columns","areAllImageDimensionsEqual","addMessage","DisplaySetMessage","CODES","INCONSISTENT_DIMENSIONS","firstImageSamplesPerPixel","SamplesPerPixel","areAllImageComponentsEqual","INCONSISTENT_COMPONENTS","imageOrientationPatient","_isSameOrientation","areAllImageOrientationsEqual","INCONSISTENT_ORIENTATIONS","INCONSISTENT_POSITION_INFORMATION","issuesFound","spacingBetweenFrames","spacingIssue","_getSpacingIssue","issue","reconstructionIssues","MISSING_FRAMES","IRREGULAR_SPACING","areAllImageSpacingEqual","getDisplaySetMessages","isReconstructable","DisplaySetMessageList","NO_VALID_INSTANCES","ImageType","constructableModalities","every","NO_POSITION_INFORMATION","sortedInstances","sortInstancesByPosition","multiFrameInstance","hasPixelMeasurements","MULTIFRAME_NO_PIXEL_MEASUREMENTS","hasOrientation","MULTIFRAME_NO_ORIENTATION","hasPosition","MULTIFRAME_NO_POSITION_INFORMATION","checkMultiFrame","NOT_RECONSTRUCTABLE","getDisplaySetsFromUnsupportedSeries","imageSet","ImageSet","UNSUPPORTED_DISPLAYSET","setAttributes","FrameRate","FrameTime","SOPClassHandlerId","sopClassHandlerName","isMultiFrame","makeDisplaySet","isDisplaySetReconstructable","sortBy","a","b","parseInt","isSingleImageModality","getDisplaySetsFromSeries","sopClassUids","uniqueSopClassUidsInSeries","getSopClassUids","stackableInstances","isImage","isClip","instanceNumber","acquisitionDatetime","AcquisitionDateTime","setAttribute","sopClassDictionary","ComputedRadiographyImageStorage","DigitalXRayImageStorageForPresentation","DigitalXRayImageStorageForProcessing","DigitalMammographyXRayImageStorageForPresentation","DigitalMammographyXRayImageStorageForProcessing","DigitalIntraOralXRayImageStorageForPresentation","DigitalIntraOralXRayImageStorageForProcessing","CTImageStorage","EnhancedCTImageStorage","LegacyConvertedEnhancedCTImageStorage","UltrasoundMultiframeImageStorage","MRImageStorage","EnhancedMRImageStorage","EnhancedMRColorImageStorage","LegacyConvertedEnhancedMRImageStorage","UltrasoundImageStorage","UltrasoundImageStorageRET","SecondaryCaptureImageStorage","MultiframeSingleBitSecondaryCaptureImageStorage","MultiframeGrayscaleByteSecondaryCaptureImageStorage","MultiframeGrayscaleWordSecondaryCaptureImageStorage","MultiframeTrueColorSecondaryCaptureImageStorage","XRayAngiographicImageStorage","EnhancedXAImageStorage","XRayRadiofluoroscopicImageStorage","EnhancedXRFImageStorage","XRay3DAngiographicImageStorage","XRay3DCraniofacialImageStorage","BreastTomosynthesisImageStorage","BreastProjectionXRayImageStorageForPresentation","BreastProjectionXRayImageStorageForProcessing","IntravascularOpticalCoherenceTomographyImageStorageForPresentation","IntravascularOpticalCoherenceTomographyImageStorageForProcessing","NuclearMedicineImageStorage","VLEndoscopicImageStorage","VideoEndoscopicImageStorage","VLMicroscopicImageStorage","VideoMicroscopicImageStorage","VLSlideCoordinatesMicroscopicImageStorage","VLPhotographicImageStorage","VideoPhotographicImageStorage","OphthalmicPhotography8BitImageStorage","OphthalmicPhotography16BitImageStorage","OphthalmicTomographyImageStorage","VLWholeSlideMicroscopyImageStorage","PositronEmissionTomographyImageStorage","EnhancedPETImageStorage","LegacyConvertedEnhancedPETImageStorage","RTImageStorage","EnhancedUSVolumeStorage","ToolbarDivider","LayoutSelector","rows","columns","onSelection","rest","isOpen","setIsOpen","closeOnOutsideClick","addEventListener","removeEventListener","DropdownContent","OHIFLayoutSelector","ToolbarButton","onInteractionHandler","rounded","dropdownContent","onLayoutChange","props","interactionType","commands","commandName","commandOptions","ToolbarSplitButtonWithServices","isRadio","isAction","groupId","items","renderer","handleItemClick","itemId","setState","state","isExpanded","getSplitButtonItems","buttonsState","setButtonState","primaryToolId","toggles","groups","isPrimaryToggle","isPrimaryActive","PrimaryButtonComponent","getButtonComponentForUIType","uiType","TOOL_BAR_STATE_MODIFIED","updatedItems","listItemRenderer","DefaultListItemRenderer","classNames","Icon","SplitButton","isToggle","tooltip","ToolbarButtonWithServices","getMenuItems","selectorProps","menus","menuIdFilter","subProps","menu","subMenu","findIt","menuId","findMenuById","selector","findMenuDefault","findMenuIterator","current","return","findMenu","menuItems","delegating","toAdd","newItem","actionType","iconRight","itemRef","detail","element","adaptItem","ContextMenuController","closeContextMenu","showContextMenu","contextMenuProps","viewportElement","defaultPointsPosition","annotationManager","CsAnnotation","locking","targetAnnotationId","nearbyToolData","annotationUID","isAnnotationLocked","getAnnotation","ContextMenuItemsBuilder","preservePosition","preventCutOf","defaultPosition","_getDefaultPosition","ContextMenu","onClickOutside","eventData","onShowSubMenu","onDefault","run","_ContextMenuController","getDefaultPosition","y","_getEventDefaultPosition","eventDetail","currentPoints","_getElementDefaultPosition","boundingClientRect","getBoundingClientRect","_getCanvasPointsPosition","points","viewerPos","pointIndex","point","_isValidPosition","source","canvasPoints","viewerElement","positionIterator","getPositionIterator","position","customizationType","rowVerticalPaddingStyle","padding","rowStyle","borderBottomWidth","ColumnHeaders","tagRef","vrRef","keywordRef","valueRef","ref","listRef","useRef","canvasRef","tagHeaderElem","setTagHeaderElem","vrHeaderElem","setVrHeaderElem","keywordHeaderElem","setKeywordHeaderElem","valueHeaderElem","setValueHeaderElem","scrollTo","resetAfterIndex","debouncedResize","Row","row","isHeaderRendered","getItemSize","headerWidths","offsetWidth","getContext","font","getComputedStyle","colText","colOneLineWidth","measureText","width","ceil","maxHeight","colHeight","visibility","elem","List","itemCount","itemSize","nameMap","getFormattedRowsFromTags","tags","tagInfo","tagIndent","keyword","formatedRowsFromTags","Tag","fromPString","toCleanString","originalTagInfo","getRows","depth","keywords","sequenceAsArray","objectOrArray","sequence","sequenceRows","_sortTagList","regex","match","tagList","DicomTagBrowser","excludedColumnIndicesForFilter","selectedDisplaySetInstanceUID","setSelectedDisplaySetInstanceUID","setInstanceNumber","filterValue","setFilterValue","activeDisplaySet","isImageStack","showInstanceList","displaySetList","useMemo","dateStr","moment","format","getSortedTags","filteredRows","filterValueLowerCase","keepRow","col","colIndex","debouncedSetFilterValue","Typography","variant","InputRange","minValue","maxValue","step","inputClassName","labelPosition","trackColor","InputFilterText","onDebounceChange","DicomTagTable","reuseCachedLayout","syncService","protocol","getActiveProtocol","hpInfo","getState","protocolId","stageIndex","activeStudyUID","syncState","viewportGridStore","displaySetSelectorMap","stage","stages","storeId","cacheId","hangingProtocolStageIndexMap","viewportStructure","properties","custom","layout","numRows","numCols","viewport","displaySetOptions","displaySetUID","matchedDisplaySetsIndex","findOrCreateViewport","viewportsByPosition","positionId","byPositionViewport","inDisplay","initialInDisplay","missing","getMissingViewport","displaySetsInfo","viewportOptions","findViewportsByPosition","storedViewport","subscribeToNextViewportGridChange","isHangingProtocolCommand","command","commandsModule","stateSyncService","contextMenuController","menuCustomizationId","optionsToUse","defaultContextMenu","displayNotification","clear","toggleHpTools","toggleStageIndex","enableListener","button","hpCommand","stageId","setToggled","getButtons","setHangingProtocol","reset","primaryToolBeforeHPChange","getActivePrimaryTool","oldProtocol","stateSyncReduce","reuseCachedLayouts","hangingId","useStageIdx","getStageIndex","setActiveStudyUID","storedHanging","restoreProtocol","setProtocol","primaryButton","getButton","firstItem","e","toggleHangingProtocol","desiredStageIndex","activeStudy","previousState","deltaStage","direction","oldStageIndex","setViewportGridLayout","callbacks","setTimeout","completeLayout","stateReduce","layoutFindOrCreate","setLayout","toggleOneUp","viewportGridState","toggleOneUpViewportGridStore","viewportIdToUpdate","updatedViewportsViaHP","preOneUpViewport","layoutOptions","getLayoutOptionsFromState","clearToggleOneUpViewportGridStore","navigateHistory","historyArgs","history","to","openDICOMTagViewer","activeViewportSpecificData","UIModalService","toggleOverlays","overlays","getElementsByClassName","toggle","scrollActiveThumbnailIntoView","activeDisplaySetInstanceUID","thumbnailList","querySelector","thumbnailListBounds","thumbnailBounds","top","bottom","scrollIntoView","behavior","updateViewportDisplaySet","excludeNonImageModalities","nonImageModalities","dsSortFn","getDisplaySetSortFunction","currentDisplaySets","displaySetIndexToShow","definitions","commandFn","storeContexts","nextStage","previousStage","defaultContext","protocolMatchingRules","weight","attribute","constraint","greaterThan","toolGroupIds","displaySetSelectors","defaultDisplaySetId","seriesMatchingRules","equals","defaultViewport","viewportType","allowUnmatchedView","stageActivation","minViewportsMatched","layoutType","requiredViewports","preferredViewports","numberOfPriorsReferenced","currentDisplaySet","priorDisplaySet","currentViewport0","currentViewport1","priorViewport0","notNull","studyMatchingRules","priorDisplaySetId","defaultProtocol","locked","createdDate","modifiedDate","availableTo","editableBy","hpInitiationCriteria","minSeriesLoaded","initialImageOptions","hpMNGrid","hpMNCompare","dsConfigs","dataSources","src","alt","friendlyName","Button","itemLabel","itemList","onItemClicked","endIcon","NO_WRAP_ELLIPSIS_CLASS_NAMES","configurationAPI","configuredItems","onHide","setItemList","selectedItems","setSelectedItems","errorMessage","setErrorMessage","itemLabels","getItemLabels","showFullConfig","setShowFullConfig","currentSelectedItemIndex","shouldUpdate","setCurrentItem","getSelectedItemBackgroundClasses","itemIndex","getSelectedItemBorderClasses","getSelectedItemTextClasses","itemLabelIndex","theList","slice","ItemListComponent","setConfigurationAPI","setConfiguredItems","dataSourceChangedCallback","activeDataSourceDef","getActiveDataSourceDefinition","factory","configurationAPIFactory","configAPI","getConfiguredItems","list","sub","ACTIVE_DATA_SOURCE_CHANGED","showConfigurationModal","DataSourceConfigurationModalComponent","ItemType","initialUrl","baseHealthcareUrl","GoogleCloudDataSourceConfigurationAPI","_extensionManager","_fetchOptions","_dataSourceName","method","projects","_doFetch","project","projectId","itemType","anItem","googleCloudItem","dicomStores","dataSourceDefCopy","getDataSourceDefinition","updateDataSourceConfiguration","subItemType","subItemField","fetchedSubItems","subItem","nameSplit","projectsIndex","urlSplit","projectUrl","relativePath","urlStr","fetchItemType","fetchOptions","fetchSearchParams","nextPageToken","pageToken","subPageData","statusText","err","handlePETImageMetadata","instanceMetadataArray","instanceMetadata","dicomMetaData","CorrectedImage","Units","RadiopharmaceuticalInformationSequence","RadionuclideHalfLife","RadionuclideTotalDose","DecayCorrection","AcquisitionDate","AcquisitionTime","RadiopharmaceuticalStartDateTime","RadiopharmaceuticalStartTime","PatientWeight","philipsPETPrivateGroup","SUVScaleFactor","ActivityConcentrationScaleFactor","PhilipsPETPrivateGroup","GEPrivatePostInjectionDateTime","FrameReferenceTime","ActualFrameDuration","PatientSex","PatientSize","getPTImageIdInstanceMetadata","suvScalingFactors","calculateSUVScalingFactors","addCustomMetadata","preRegistration","SERIES_UPDATED","register","clearOnModeExit","getDataSourcesModule","getLayoutTemplateModule","getPanelModule","getHangingProtocolModule","getSopClassHandlerModule","getToolbarModule","defaultComponent","clickHandler","ToolbarLayoutSelectorWithServices","clickedBtn","btnSectionName","getCommandsModule","getUtilityModule","getCustomizationModule","routes","DataSourceSelector","condition","contentF","transform","clonedObject","originalItems","DataSourceConfigurationComponent"],"sourceRoot":""}