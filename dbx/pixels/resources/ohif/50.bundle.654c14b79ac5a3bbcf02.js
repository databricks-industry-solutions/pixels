"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[50,481],{71093:(e,t,n)=>{n.r(t),n.d(t,{default:()=>Q});const a=JSON.parse('{"UU":"@ohif/extension-cornerstone-dicom-seg"}').UU,o=`${a}.sopClassHandlerModule.dicom-seg`;var r=n(41766),i=n(14283),s=n(50719),l=n(20767),c=n(83342),d=n(31426);const g=["1.2.840.10008.5.1.4.1.1.66.4"];let m={};function S(e,t,n){const a=e[0],{StudyInstanceUID:r,SeriesInstanceUID:S,SOPInstanceUID:u,SeriesDescription:p,SeriesNumber:v,SeriesDate:h,SOPClassUID:E,wadoRoot:I,wadoUri:y,wadoUriRoot:T}=a,R={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:i.utils.guid(),SeriesDescription:p,SeriesNumber:v,SeriesDate:h,SOPInstanceUID:u,SeriesInstanceUID:S,StudyInstanceUID:r,SOPClassHandlerId:o,SOPClassUID:E,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:g,instance:a,instances:[a],wadoRoot:I,wadoUriRoot:T,wadoUri:y,isOverlayDisplaySet:!0},C=a.ReferencedSeriesSequence;if(!C)return void console.error("ReferencedSeriesSequence is missing for the SEG");const b=C[0]||C;return R.referencedImages=a.ReferencedSeriesSequence.ReferencedInstanceSequence,R.referencedSeriesInstanceUID=b.SeriesInstanceUID,R.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(R.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const a=n[0];R.referencedDisplaySetInstanceUID=a.displaySetInstanceUID,R.referencedVolumeURI=a.displaySetInstanceUID;const o=`cornerstoneStreamingImageVolume:${R.referencedVolumeURI}`;return R.referencedVolumeId=o,a},R.load=async({headers:e})=>await function(e,t,n,a){const{SOPInstanceUID:o}=e,{segmentationService:r}=t.services;if((e.loading||e.isLoaded)&&m[o]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,r))return m[o];return e.loading=!0,m[o]=new Promise((async(o,i)=>{e.segments&&0!==Object.keys(e.segments).length||await async function({extensionManager:e,servicesManager:t,segDisplaySet:n,headers:a}){const o=e.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{segmentationService:r,uiNotificationService:i}=t.services,{dicomLoaderService:g}=o.exports,m=await g.findDicomDataPromise(n,null,a),S=s.cache.getVolume(n.referencedVolumeId);if(!S)throw new Error("Referenced Volume is missing for the SEG, and stack viewport SEG is not supported yet");const{imageIds:u}=S,p=.001,v=!0;s.eventTarget.addEventListener(c.fX.Events.SEGMENTATION_LOAD_PROGRESS,(e=>{const{percentComplete:t}=e.detail;r._broadcastEvent(r.EVENTS.SEGMENT_LOADING_COMPLETE,{percentComplete:t})}));const h=await c.ql.Cornerstone3D.Segmentation.generateToolState(u,m,s.metaData,{skipOverlapping:v,tolerance:p,eventTarget:s.eventTarget,triggerEvent:s.triggerEvent});let E=!0;h.segMetadata.data.forEach(((e,t)=>{var n;t>0&&(e.rgba=e.RecommendedDisplayCIELabValue,e.rgba?e.rgba=(n=e.rgba,d.Ay.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)))):(E=!1,e.rgba=l.CONSTANTS.COLOR_LUT[t%l.CONSTANTS.COLOR_LUT.length]))})),h.overlappingSegments&&i.show({title:"Overlapping Segments",message:"Unsupported overlapping segments detected, segmentation rendering results may be incorrect.",type:"warning"});E||i.show({title:"DICOM SEG import",message:"RecommendedDisplayCIELabValue not found for one or more segments. The default color was used instead.",type:"warning",duration:5e3});Object.assign(n,h)}({extensionManager:n,servicesManager:t,segDisplaySet:e,headers:a});const g=!0;r.createSegmentationForSEGDisplaySet(e,null,g).then((()=>{e.loading=!1,o()})).catch((t=>{e.loading=!1,i(t)}))})),m[o]}(R,t,n,e),[R]}const u=function({servicesManager:e,extensionManager:t}){return[{name:"dicom-seg",sopClassUids:g,getDisplaySetsFromSeries:n=>S(n,e,t)}]},p={id:"@ohif/seg",name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const v=function(){return[{name:p.id,protocol:p}]};var h=n(15575),E=n(98335),I=n(11374),y=n.n(I),T=n(21683);const R=function(e,t,n){const a="enter-segment-label",o=({action:t,value:o})=>{switch(t.id){case"save":n(o.label,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:a})};e&&e.create({id:a,centralize:!0,isDraggable:!1,showOverlay:!0,content:T.lG,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:a}),actions:[{id:"cancel",text:"Cancel",type:T.Ny.NW.secondary},{id:"save",text:"Confirm",type:T.Ny.NW.primary}],onSubmit:o,body:({value:e,setValue:t})=>r.createElement(T.pd,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"border-primary-main bg-black",type:"text",value:e.label,onChange:e=>{e.persist(),t((t=>({...t,label:e.target.value})))},onKeyPress:t=>{"Enter"===t.key&&o({value:e,action:{id:"save"}})}})}})};var C=n(13726);const b=function(e,t,n){const a="pick-color",o=({action:t,value:o})=>{switch(t.id){case"save":n(o.rgbaColor,t.id);break;case"cancel":n("",t.id)}e.dismiss({id:a})};e&&e.create({id:a,centralize:!0,isDraggable:!1,showOverlay:!0,content:T.lG,contentProps:{title:"Segment Color",value:{rgbaColor:t},noCloseButton:!0,onClose:()=>e.dismiss({id:a}),actions:[{id:"cancel",text:"Cancel",type:"primary"},{id:"save",text:"Save",type:"secondary"}],onSubmit:o,body:({value:e,setValue:t})=>r.createElement(C.xk,{color:e.rgbaColor,onChange:e=>{t({rgbaColor:e.rgb})},presetColors:[],width:300})}})};var w=n(80619);function f({servicesManager:e,commandsManager:t,extensionManager:n,configuration:a}){const{segmentationService:o,viewportGridService:i,uiDialogService:s}=e.services,{t:l}=(0,w.Bd)("PanelSegmentation"),[c,d]=(0,r.useState)(null),[g,m]=(0,r.useState)(o.getConfiguration()),[S,u]=(0,r.useState)((()=>o.getSegmentations()));(0,r.useEffect)((()=>{const e=o.EVENTS.SEGMENTATION_ADDED,t=o.EVENTS.SEGMENTATION_UPDATED,n=o.EVENTS.SEGMENTATION_REMOVED,a=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=o.subscribe(e,(()=>{const e=o.getSegmentations();u(e),m(o.getConfiguration())}));a.push(t)})),()=>{a.forEach((e=>{e()}))}}),[]);const p=e=>o.getToolGroupIdsWithSegmentation(e),v=(0,r.useCallback)(((e,t,n)=>{o.setConfiguration({segmentationId:e,[t]:n})}),[o]);return r.createElement(r.Fragment,null,r.createElement("div",{className:"ohif-scrollbar flex min-h-0 flex-auto select-none flex-col justify-between overflow-auto"},r.createElement(T.QQ,{title:l("Segmentations"),segmentations:S,disableEditing:a.disableEditing,activeSegmentationId:c||"",onSegmentationAdd:async()=>{t.runCommand("createEmptySegmentationForViewport")},onSegmentationClick:e=>{o.setActiveSegmentationForToolGroup(e)},onSegmentationDelete:e=>{o.remove(e)},onSegmentationDownload:e=>{t.runCommand("downloadSegmentation",{segmentationId:e})},onSegmentationDownloadRTSS:e=>{t.runCommand("downloadRTSS",{segmentationId:e})},storeSegmentation:async a=>{const r=n.getActiveDataSource(),s=await(0,E.createReportAsync)({servicesManager:e,getReport:()=>t.runCommand("storeSegmentation",{segmentationId:a,dataSource:r[0]}),reportType:"Segmentation"});s&&(o.remove(a),i.setDisplaySetsForViewport({viewportId:i.getActiveViewportId(),displaySetInstanceUIDs:s}))},onSegmentationEdit:e=>{const t=o.getSegmentation(e),{label:n}=t;R(s,n,((t,n)=>{""!==t&&o.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{o.setActiveSegment(e,t);p(e).forEach((n=>{o.setActiveSegmentationForToolGroup(e,n),o.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{const n=o.getSegmentation(e).segments[t],{label:a}=n;R(s,a,((n,a)=>{""!==n&&o.setSegmentLabel(e,t,n)}))},onSegmentAdd:e=>{o.addSegment(e)},onSegmentColorClick:(e,t)=>{const n=o.getSegmentation(e).segments[t],{color:a,opacity:r}=n,i={r:a[0],g:a[1],b:a[2],a:r/255};b(s,i,((n,a)=>{"cancel"!==a&&o.setSegmentRGBAColor(e,t,[n.r,n.g,n.b,255*n.a])}))},onSegmentDelete:(e,t)=>{o.removeSegment(e,t)},onToggleSegmentVisibility:(e,t)=>{const n=!o.getSegmentation(e).segments[t].isVisible;p(e).forEach((a=>{o.setSegmentVisibility(e,t,n,a)}))},onToggleSegmentLock:(e,t)=>{o.toggleSegmentLocked(e,t)},onToggleSegmentationVisibility:e=>{o.toggleSegmentationVisibility(e)},showDeleteSegment:!0,segmentationConfig:{initialConfig:g},setRenderOutline:e=>v(c,"renderOutline",e),setOutlineOpacityActive:e=>v(c,"outlineOpacity",e),setRenderFill:e=>v(c,"renderFill",e),setRenderInactiveSegmentations:e=>v(c,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>v(c,"outlineWidthActive",e),setFillAlpha:e=>v(c,"fillAlpha",e),setFillAlphaInactive:e=>v(c,"fillAlphaInactive",e)})))}f.propTypes={commandsManager:y().shape({runCommand:y().func.isRequired}),servicesManager:y().shape({services:y().shape({segmentationService:y().shape({getSegmentation:y().func.isRequired,getSegmentations:y().func.isRequired,toggleSegmentationVisibility:y().func.isRequired,subscribe:y().func.isRequired,EVENTS:y().object.isRequired}).isRequired}).isRequired}).isRequired};const{segmentation:D}=l.utilities,O={CIRCULAR_BRUSH:"CircularBrush",SPHERE_BRUSH:"SphereBrush",CIRCULAR_ERASER:"CircularEraser",SPHERE_ERASER:"SphereEraser",CIRCLE_SHAPE:"CircleScissor",RECTANGLE_SHAPE:"RectangleScissor",SPHERE_SHAPE:"SphereScissor",THRESHOLD_CIRCULAR_BRUSH:"ThresholdCircularBrush",THRESHOLD_SPHERE_BRUSH:"ThresholdSphereBrush"},U={SET_TOOL_CONFIG:"SET_TOOL_CONFIG",SET_ACTIVE_TOOL:"SET_ACTIVE_TOOL"},A={Brush:{brushSize:15,mode:"CircularBrush"},Eraser:{brushSize:15,mode:"CircularEraser"},Shapes:{brushSize:15,mode:"CircleScissor"},ThresholdBrush:{brushSize:15,thresholdRange:null},activeTool:null};function M(e,t){switch(t.type){case U.SET_TOOL_CONFIG:const{tool:n,config:a}=t.payload;return{...e,[n]:{...e[n],...a}};case U.SET_ACTIVE_TOOL:return{...e,activeTool:t.payload};default:return e}}function _(e){let t=[];switch(e){case"Brush":t=["CircularBrush","SphereBrush"];break;case"Eraser":t=["CircularEraser","SphereEraser"];break;case"ThresholdBrush":t=["ThresholdCircularBrush","ThresholdSphereBrush"]}return t}const L=function({servicesManager:e,extensionManager:t}){const{toolbarService:n,segmentationService:a,toolGroupService:o}=e.services,[i]=(0,T.ih)(),{viewports:s,activeViewportId:l}=i,[c,d]=(0,r.useState)(!1),[g,m]=(0,r.useReducer)(M,A),S=(0,r.useCallback)((()=>{if(!s?.size||void 0===l)return;const e=s.get(l);e&&m({type:U.SET_ACTIVE_TOOL,payload:o.getActiveToolForViewport(e.viewportId)})}),[l,s,o,m]),u=(0,r.useCallback)((e=>{!function(e){if(null===g.ThresholdBrush.thresholdRange){const t=o.getToolGroupIds()[0],n=o.getToolGroup(t).getToolConfiguration(e),a=n?.strategySpecificConfiguration?.THRESHOLD?.threshold;m({type:U.SET_TOOL_CONFIG,payload:{tool:"ThresholdBrush",config:{thresholdRange:a}}})}}(e),n.recordInteraction({interactionType:"tool",commands:[{commandName:"setToolActive",commandOptions:{toolName:e}}]}),m({type:U.SET_ACTIVE_TOOL,payload:e})}),[n,m]);(0,r.useEffect)((()=>{const e=[a.EVENTS.SEGMENTATION_ADDED,a.EVENTS.SEGMENTATION_UPDATED,a.EVENTS.SEGMENTATION_REMOVED],t=[];return e.forEach((e=>{const{unsubscribe:n}=a.subscribe(e,(()=>{const e=a.getSegmentations(),t=e?.find((e=>e.isActive));d(t?.segmentCount>0)}));t.push(n)})),S(),()=>{t.forEach((e=>e()))}}),[l,s,a,S]),(0,r.useEffect)((()=>{const{unsubscribe:e}=n.subscribe(n.EVENTS.TOOL_BAR_STATE_MODIFIED,(()=>{S()}));return()=>{e()}}),[n,S]),(0,r.useEffect)((()=>{Object.values(O).includes(g.activeTool)&&(c||u("WindowLevel"))}),[c,g.activeTool,u]);const p=(0,r.useCallback)(((e,t)=>{o.getToolGroupIds()?.forEach((n=>{D.setBrushSizeForToolGroup(n,t,e)}))}),[o]),v=(0,r.useCallback)(((e,t)=>{const n=Number(e);_(t).forEach((e=>{p(e,n)})),m({type:U.SET_TOOL_CONFIG,payload:{tool:t,config:{brushSize:n}}})}),[o,m]),h=(0,r.useCallback)((e=>{if(e[0]===g.ThresholdBrush.thresholdRange?.[0]&&e[1]===g.ThresholdBrush.thresholdRange?.[1])return;_("ThresholdBrush").forEach((t=>{o.getToolGroupIds()?.forEach((n=>{o.getToolGroup(n).setToolConfiguration(t,{strategySpecificConfiguration:{THRESHOLD:{threshold:e}}})}))})),m({type:U.SET_TOOL_CONFIG,payload:{tool:"ThresholdBrush",config:{thresholdRange:e}}})}),[o,m,g.ThresholdBrush.thresholdRange]);return r.createElement(T.om,{title:"Segmentation Tools",items:[{name:"Brush",icon:"icon-tool-brush",disabled:!c,active:g.activeTool===O.CIRCULAR_BRUSH||g.activeTool===O.SPHERE_BRUSH,onClick:()=>u(O.CIRCULAR_BRUSH),options:[{name:"Radius (mm)",id:"brush-radius",type:"range",min:.5,max:99.5,value:g.Brush.brushSize,step:.5,onChange:e=>v(e,"Brush")},{name:"Mode",type:"radio",id:"brush-mode",value:g.Brush.mode,values:[{value:O.CIRCULAR_BRUSH,label:"Circle"},{value:O.SPHERE_BRUSH,label:"Sphere"}],onChange:e=>u(e)}]},{name:"Eraser",icon:"icon-tool-eraser",disabled:!c,active:g.activeTool===O.CIRCULAR_ERASER||g.activeTool===O.SPHERE_ERASER,onClick:()=>u(O.CIRCULAR_ERASER),options:[{name:"Radius (mm)",type:"range",id:"eraser-radius",min:.5,max:99.5,value:g.Eraser.brushSize,step:.5,onChange:e=>v(e,"Eraser")},{name:"Mode",type:"radio",id:"eraser-mode",value:g.Eraser.mode,values:[{value:O.CIRCULAR_ERASER,label:"Circle"},{value:O.SPHERE_ERASER,label:"Sphere"}],onChange:e=>u(e)}]},{name:"Shapes",icon:"icon-tool-shape",disabled:!c,active:g.activeTool===O.CIRCLE_SHAPE||g.activeTool===O.RECTANGLE_SHAPE||g.activeTool===O.SPHERE_SHAPE,onClick:()=>u(O.CIRCLE_SHAPE),options:[{name:"Mode",type:"radio",value:g.Shapes.mode,id:"shape-mode",values:[{value:O.CIRCLE_SHAPE,label:"Circle"},{value:O.RECTANGLE_SHAPE,label:"Rectangle"},{value:O.SPHERE_SHAPE,label:"Sphere"}],onChange:e=>u(e)}]},{name:"Threshold Tool",icon:"icon-tool-threshold",disabled:!c,active:g.activeTool===O.THRESHOLD_CIRCULAR_BRUSH||g.activeTool===O.THRESHOLD_SPHERE_BRUSH,onClick:()=>u(O.THRESHOLD_CIRCULAR_BRUSH),options:[{name:"Radius (mm)",id:"threshold-radius",type:"range",min:.5,max:99.5,value:g.ThresholdBrush.brushSize,step:.5,onChange:e=>v(e,"ThresholdBrush")},{name:"Mode",type:"radio",id:"threshold-mode",value:g.activeTool,values:[{value:O.THRESHOLD_CIRCULAR_BRUSH,label:"Circle"},{value:O.THRESHOLD_SPHERE_BRUSH,label:"Sphere"}],onChange:e=>u(e)},{type:"custom",id:"segmentation-threshold-range",children:()=>r.createElement("div",null,r.createElement("div",{className:"bg-secondary-light h-[1px]"}),r.createElement("div",{className:"mt-1 text-[13px] text-white"},"Threshold"),r.createElement(T.Z5,{values:g.ThresholdBrush.thresholdRange,onChange:h,minValue:-1e3,maxValue:1e3,step:1,showLabel:!0,allowNumberEdit:!0,showAdjustmentArrows:!1}))}]}]})},V=({commandsManager:e,servicesManager:t,extensionManager:n,configuration:a})=>{const{customizationService:o}=t.services;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:a=>{const[i]=(0,h.r)(),s=o.get("segmentation.disableEditing");return r.createElement(f,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a,disableEditing:i.disableEditing||s?.value}})}},{name:"panelSegmentationWithTools",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:a=>{const[o]=(0,h.r)();return r.createElement(r.Fragment,null,r.createElement(L,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a}}),r.createElement(f,{commandsManager:e,servicesManager:t,extensionManager:n,configuration:{...a}}))}}]};var N=n(52754),G=n(45128),H=n(94448);async function F({viewportId:e,loadFn:t,servicesManager:n,referencedDisplaySetInstanceUID:a}){const{cornerstoneViewportService:o,segmentationService:r,viewportGridService:i}=n.services,l=B({viewportId:e,viewportGridService:i}),c=l.viewportOptions.viewportId,d=P({servicesManager:n,viewportId:e,referencedDisplaySetInstanceUID:a=a||l?.displaySetInstanceUIDs[0]}),g=async()=>{const e=await t();r.hydrateSegmentation(e)},m=Array.from(s.cache._volumeCache.keys()).some((e=>e.includes(a)));return d.forEach((async e=>{e.viewportOptions={...e.viewportOptions,viewportType:"volume",needsRerendering:!0};const t=e.viewportId,n=o.getCornerstoneViewport(t),r=n.getCamera();if(m&&t===c)return void await g();const i=async e=>{const n=e.detail.volumeActors?.find((e=>e.uid.includes(a))),l=o.getCornerstoneViewport(t);l.setCamera(r),l.element.removeEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,i),n&&t===c&&await g()};n.element.addEventListener(s.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,i)})),i.setDisplaySetsForViewports(d),!0}const B=({viewportId:e,viewportGridService:t})=>{const{viewports:n,activeViewportId:a}=t.getState(),o=e||a;return n.get(o)};function P({viewportId:e,servicesManager:t,referencedDisplaySetInstanceUID:n}){const{hangingProtocolService:a,displaySetService:o,segmentationService:r,viewportGridService:i}=t.services,{viewports:s}=i.getState(),l=B({viewportId:e,viewportGridService:i}).viewportOptions.viewportId,c=s.get(l).displaySetInstanceUIDs,d=n||c[0],g=o.getDisplaySetByUID(d).instances[0].FrameOfReferenceUID,m=a.getViewportsRequireUpdate(l,d);return s.forEach(((e,t)=>{if(l===t||m.find((e=>e.viewportId===t)))return;r.shouldRenderSegmentation(e.displaySetInstanceUIDs,g)&&m.push({viewportId:t,displaySetInstanceUIDs:e.displaySetInstanceUIDs,viewportOptions:{viewportType:"volume",needsRerendering:!0}})})),m}const{datasetToBlob:x}=d.Ay.data,{Cornerstone3D:{Segmentation:{generateLabelMaps2DFrom3D:k,generateSegmentation:q}}}=c.ql,{Cornerstone3D:{RTSS:{generateRTSSFromSegmentations:z}}}=c.f_,{downloadDICOMData:j}=c._$,W=({servicesManager:e,extensionManager:t})=>{const{uiNotificationService:n,segmentationService:a,uiDialogService:o,displaySetService:r,viewportGridService:c}=e.services,g={getUpdatedViewportsForSegmentation:P,createEmptySegmentationForViewport:async({viewportId:t})=>{const o=B({viewportId:t,viewportGridService:c}),i=o.displaySetInstanceUIDs[0];r.getDisplaySetByUID(i).isReconstructable?F({viewportId:t,servicesManager:e,loadFn:async()=>{const e=a.getSegmentations(),t=await a.createSegmentationForDisplaySet(i,{label:`Segmentation ${e.length+1}`}),n=o.viewportOptions.toolGroupId;return await a.addSegmentationRepresentationToToolGroup(n,t),a.addSegment(t,{toolGroupId:n,segmentIndex:1,properties:{label:"Segment 1"}}),t}}):n.show({title:"Segmentation",message:"Segmentation is not supported for non-reconstructible displaysets yet",type:"error"})},loadSegmentationsForViewport:async({segmentations:t,viewportId:n})=>{F({viewportId:n,servicesManager:e,loadFn:async()=>{const e=B({viewportId:n,viewportGridService:c}),o=e.displaySetInstanceUIDs[0],r=t[0],i=r.id,s=r.label,l=r.segments;if(delete r.segments,await a.createSegmentationForDisplaySet(o,{segmentationId:i,label:s}),r.scalarData){a.getLabelmapVolume(i).scalarData.set(r.scalarData)}a.addOrUpdateSegmentation(r);const d=e.viewportOptions.toolGroupId;return await a.addSegmentationRepresentationToToolGroup(d,i),l.forEach((e=>{null!==e&&a.addSegment(i,{segmentIndex:e.segmentIndex,toolGroupId:d,properties:{color:e.color,label:e.label,opacity:e.opacity,isLocked:e.isLocked,visibility:e.isVisible,active:r.activeSegmentIndex===e.segmentIndex}})})),r.centroidsIJK&&a.setCentroids(r.id,r.centroidsIJK),i}})},loadSegmentationDisplaySetsForViewport:async({viewportId:t,displaySets:n})=>{const o=n[0];F({viewportId:t,servicesManager:e,referencedDisplaySetInstanceUID:o.referencedDisplaySetInstanceUID,loadFn:async()=>{const e=o,t="SEG"===e.Modality?"createSegmentationForSEGDisplaySet":"createSegmentationForRTDisplaySet",n=a[t].bind(a);return await n(e,null,!1)}})},generateSegmentation:({segmentationId:e,options:t={}})=>{const n=l.segmentation.state.getSegmentation(e),{referencedVolumeId:o}=n.representationData.LABELMAP,r=s.cache.getVolume(e),i=s.cache.getVolume(o).getCornerstoneImages(),c=k(r);c.metadata=[];const g=a.getSegmentation(e);c.segmentsOnLabelmap.forEach((e=>{const t=g?.segments[e],{label:n,color:a}=t,o=d.Ay.data.Colors.rgb2DICOMLAB(a.slice(0,3).map((e=>e/255))).map((e=>Math.round(e))),r={SegmentNumber:e.toString(),SegmentLabel:n,SegmentAlgorithmType:"MANUAL",SegmentAlgorithmName:"OHIF Brush",RecommendedDisplayCIELabValue:o,SegmentedPropertyCategoryCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"},SegmentedPropertyTypeCodeSequence:{CodeValue:"T-D0050",CodingSchemeDesignator:"SRT",CodeMeaning:"Tissue"}};c.metadata[e]=r}));return q(i,c,s.metaData,t)},downloadSegmentation:({segmentationId:e})=>{const t=a.getSegmentation(e),n=g.generateSegmentation({segmentationId:e});j(n.dataset,`${t.label}`)},storeSegmentation:async({segmentationId:e,dataSource:n})=>{const r=await(0,E.createReportDialogPrompt)(o,{extensionManager:t});if(1!==r.action&&r.value)return;const s=a.getSegmentation(e);if(!s)throw new Error("No segmentation found");const{label:l}=s,c=r.value||l||"Research Derived Series",d=g.generateSegmentation({segmentationId:e,options:{SeriesDescription:c}});if(!d||!d.dataset)throw new Error("Error during segmentation generation");const{dataset:m}=d;return await n.store.dicom(m),m.wadoRoot=n.getConfig().wadoRoot,i.DicomMetadataStore.addInstances([m],!0),m},downloadRTSS:({segmentationId:e})=>{const t=a.getSegmentation(e),n={vtkImageMarchingSquares:N.Ay,vtkDataArray:G.Ay,vtkImageData:H.Ay},o=z(t,i.classes.MetadataProvider,i.DicomMetadataStore,s.cache,l.Enums,n);try{const e=x(o),t=URL.createObjectURL(e);window.location.assign(t)}catch(e){console.warn(e)}}},m={getUpdatedViewportsForSegmentation:{commandFn:g.getUpdatedViewportsForSegmentation},loadSegmentationDisplaySetsForViewport:{commandFn:g.loadSegmentationDisplaySetsForViewport},loadSegmentationsForViewport:{commandFn:g.loadSegmentationsForViewport},createEmptySegmentationForViewport:{commandFn:g.createEmptySegmentationForViewport},generateSegmentation:{commandFn:g.generateSegmentation},downloadSegmentation:{commandFn:g.downloadSegmentation},storeSegmentation:{commandFn:g.storeSegmentation},downloadRTSS:{commandFn:g.downloadRTSS}};return{actions:g,definitions:m}};function $(){return $=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},$.apply(this,arguments)}const J=r.lazy((()=>n.e(295).then(n.bind(n,58295)))),K=e=>r.createElement(r.Suspense,{fallback:r.createElement("div",null,"Loading...")},r.createElement(J,e)),Q={id:a,preRegistration:function({configuration:e={}}){(0,l.addTool)(l.BrushTool)},getPanelModule:V,getCommandsModule:W,getViewportModule:({servicesManager:e,extensionManager:t})=>[{name:"dicom-seg",component:n=>r.createElement(K,$({servicesManager:e,extensionManager:t,commandsManager},n))}],getSopClassHandlerModule:u,getHangingProtocolModule:v}}}]);
//# sourceMappingURL=50.bundle.654c14b79ac5a3bbcf02.js.map