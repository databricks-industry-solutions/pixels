<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICOMweb Gateway Metrics</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --primary: #38bdf8;
            --secondary: #818cf8;
            --accent: #f472b6;
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --success: #4ade80;
            --warning: #facc15;
            --error: #fb7185;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 2.25rem;
            margin: 0 0 1.5rem 0;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ── Status bar ────────────────────────────────────────── */

        .status-bar {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 0.85rem;
            margin-bottom: 1.5rem;
            color: var(--text-dim);
            flex-wrap: wrap;
            justify-content: center;
        }

        .status-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-dim);
            box-shadow: none;
        }

        .dot.live {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.4); opacity: 0.5; }
        }

        /* ── KPI tiles ─────────────────────────────────────────── */

        .kpi-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 1.5rem;
        }

        .kpi {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            text-align: center;
            transition: border-color 0.2s;
        }

        .kpi:hover { border-color: rgba(255, 255, 255, 0.2); }

        .kpi-label {
            display: block;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-dim);
            margin-bottom: 0.35rem;
        }

        .kpi-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            color: var(--text);
            transition: color 0.3s;
        }

        /* ── Chart grid ────────────────────────────────────────── */

        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            width: 100%;
            max-width: 1200px;
        }

        .chart-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.25rem 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s, border-color 0.2s;
        }

        .chart-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .chart-card h2 {
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            margin: 0 0 0.75rem 0;
            color: var(--text-dim);
        }

        .chart-wrap {
            position: relative;
            height: 200px;
        }

        footer {
            margin-top: 2rem;
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        @media (max-width: 900px) {
            .kpi-row { grid-template-columns: repeat(2, 1fr); }
            .chart-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 500px) {
            .kpi-row { grid-template-columns: repeat(2, 1fr); }
            body { padding: 1rem; }
        }
    </style>
</head>

<body>

    <h1>DICOMweb Gateway Dashboard</h1>

    <div class="status-bar">
        <div class="status-group">
            <div class="dot" id="status-dot"></div>
            <span id="status-text">Connecting&hellip;</span>
        </div>
        <span id="timestamp">&mdash;</span>
    </div>

    <div class="kpi-row">
        <div class="kpi">
            <span class="kpi-label">Requests / tick</span>
            <span class="kpi-value" id="kpi-req">&mdash;</span>
        </div>
        <div class="kpi">
            <span class="kpi-label">Errors / tick</span>
            <span class="kpi-value" id="kpi-err">&mdash;</span>
        </div>
        <div class="kpi">
            <span class="kpi-label">Avg Latency</span>
            <span class="kpi-value" id="kpi-lat">&mdash;</span>
        </div>
        <div class="kpi">
            <span class="kpi-label">Error Rate</span>
            <span class="kpi-value" id="kpi-erate">&mdash;</span>
        </div>
    </div>

    <div class="chart-grid">
        <div class="chart-card">
            <h2>Request Throughput</h2>
            <div class="chart-wrap"><canvas id="chart-throughput"></canvas></div>
        </div>
        <div class="chart-card">
            <h2>Latency (ms)</h2>
            <div class="chart-wrap"><canvas id="chart-latency"></canvas></div>
        </div>
    </div>

    <footer>
        DICOMweb Gateway Monitoring &bull; Live via WebSocket &bull; Data from Lakebase
    </footer>

    <script>
        /* ── Configuration ──────────────────────────────────────── */

        var REST_ENDPOINT = '/api/metrics';
        var MAX_POINTS = 60;

        /* ── WebSocket state ────────────────────────────────────── */

        var ws = null;
        var reconnectTimer = null;
        var reconnectDelay = 1000;
        var MAX_RECONNECT_DELAY = 30000;
        var restFallback = null;

        /* ── Time-series buffers ───────────────────────────────── */

        var labels = [];
        var gwBuf = { req: [], err: [], lat: [] };

        function pushBuf(arr, val) {
            arr.push(val);
            if (arr.length > MAX_POINTS) arr.shift();
        }

        /* ── DOM helpers ────────────────────────────────────────── */

        function setKpi(id, text, level) {
            var el = document.getElementById(id);
            if (!el) return;
            el.innerText = text;
            var palette = { good: '#4ade80', warn: '#facc15', bad: '#fb7185' };
            el.style.color = palette[level] || '#f8fafc';
        }

        function setStatus(state) {
            var dot = document.getElementById('status-dot');
            var txt = document.getElementById('status-text');
            if (state === 'connected') {
                dot.className = 'dot live';
                txt.innerText = 'Connected (live)';
            } else {
                dot.className = 'dot';
                txt.innerText = 'Reconnecting\u2026';
            }
        }

        /* ── Chart.js setup ─────────────────────────────────────── */

        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.06)';
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.font.size = 11;

        function makeOpts(yOverride) {
            var base = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { boxWidth: 10, padding: 10, usePointStyle: true }
                    },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: { maxTicksLimit: 6, maxRotation: 0 }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    }
                },
                elements: {
                    point: { radius: 0, hoverRadius: 3 },
                    line: { tension: 0.35, borderWidth: 1.5 }
                }
            };
            if (yOverride) Object.assign(base.scales.y, yOverride);
            return base;
        }

        function ds(label, data, hex, extra) {
            var r = parseInt(hex.slice(1, 3), 16);
            var g = parseInt(hex.slice(3, 5), 16);
            var b = parseInt(hex.slice(5, 7), 16);
            var out = {
                label: label,
                data: data,
                borderColor: hex,
                backgroundColor: 'rgba(' + r + ',' + g + ',' + b + ',0.06)',
                fill: true
            };
            if (extra) Object.assign(out, extra);
            return out;
        }

        var chartThroughput = new Chart(document.getElementById('chart-throughput'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    ds('Requests', gwBuf.req, '#38bdf8'),
                    ds('Errors', gwBuf.err, '#fb7185', { fill: false, borderDash: [4, 2] })
                ]
            },
            options: makeOpts()
        });

        var chartLatency = new Chart(document.getElementById('chart-latency'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    ds('Avg Latency', gwBuf.lat, '#818cf8')
                ]
            },
            options: makeOpts({ ticks: { callback: function (v) { return v + ' ms'; } } })
        });

        var allCharts = [chartThroughput, chartLatency];

        /* ── Dashboard update (shared by WS and REST) ───────────── */

        function updateDashboard(data) {
            var gRows = data.gateway || [];

            /* ── Timestamp label ─────────────────────────────────── */
            var now = new Date().toLocaleTimeString([], {
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            labels.push(now);
            if (labels.length > MAX_POINTS) labels.shift();

            /* ── Gateway data ────────────────────────────────────── */
            var gLatest = gRows.length ? gRows[0] : null;
            var reqCount = 0, errCount = 0, avgLat = 0;

            if (gLatest) {
                var gm = gLatest.metrics;
                reqCount = gm.request_count || 0;
                errCount = gm.error_count || 0;
                avgLat = Math.round((gm.avg_latency_s || 0) * 1000);

                if (gLatest.recorded_at) {
                    document.getElementById('timestamp').innerText =
                        new Date(gLatest.recorded_at).toLocaleTimeString();
                }
            }

            pushBuf(gwBuf.req, reqCount);
            pushBuf(gwBuf.err, errCount);
            pushBuf(gwBuf.lat, avgLat);

            /* ── KPI tiles ───────────────────────────────────────── */
            setKpi('kpi-req', reqCount, reqCount > 0 ? 'good' : null);
            setKpi('kpi-err', errCount,
                errCount === 0 ? 'good' : errCount < 5 ? 'warn' : 'bad');
            setKpi('kpi-lat', avgLat + ' ms',
                avgLat < 100 ? 'good' : avgLat < 500 ? 'warn' : 'bad');

            var errRate = reqCount > 0
                ? ((errCount / reqCount) * 100).toFixed(1) + '%'
                : '0%';
            var errRatePct = reqCount > 0 ? (errCount / reqCount) * 100 : 0;
            setKpi('kpi-erate', errRate,
                errRatePct < 1 ? 'good' : errRatePct < 5 ? 'warn' : 'bad');

            /* ── Sync charts ─────────────────────────────────────── */
            allCharts.forEach(function (ch) { ch.update('none'); });
            setStatus('connected');
        }

        /* ── REST fallback ──────────────────────────────────────── */

        function fetchRest() {
            fetch(REST_ENDPOINT, { credentials: 'include' })
                .then(function (res) { return res.json(); })
                .then(updateDashboard)
                .catch(function () { setStatus('disconnected'); });
        }

        /* ── WebSocket with auto-reconnect ──────────────────────── */

        function connectWebSocket() {
            var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(proto + '//' + location.host + '/ws/metrics');

            ws.onopen = function () {
                reconnectDelay = 1000;
                if (restFallback) { clearInterval(restFallback); restFallback = null; }
                setStatus('connected');
            };

            ws.onmessage = function (event) {
                updateDashboard(JSON.parse(event.data));
            };

            ws.onclose = function () {
                setStatus('disconnected');
                scheduleReconnect();
            };

            ws.onerror = function () { ws.close(); };
        }

        function scheduleReconnect() {
            if (reconnectTimer) return;
            if (!restFallback) {
                restFallback = setInterval(fetchRest, 3000);
            }
            reconnectTimer = setTimeout(function () {
                reconnectTimer = null;
                connectWebSocket();
            }, reconnectDelay);
            reconnectDelay = Math.min(reconnectDelay * 2, MAX_RECONNECT_DELAY);
        }

        connectWebSocket();
    </script>

</body>

</html>
