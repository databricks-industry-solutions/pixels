<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WADO-RS vs WADO-URI Performance Benchmark</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface2: #242834;
            --border: #2e3345;
            --text: #e4e7ef;
            --text-muted: #8b92a8;
            --accent: #6c5ce7;
            --accent-glow: rgba(108, 92, 231, 0.25);
            --green: #00b894;
            --red: #e17055;
            --yellow: #fdcb6e;
            --blue: #74b9ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-muted);
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card h2 .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .dot-green {
            background: var(--green);
        }

        .dot-blue {
            background: var(--blue);
        }

        .dot-yellow {
            background: var(--yellow);
        }

        /* Config form */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .form-group label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group input,
        .form-group select {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.65rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-sm {
            padding: 0.4rem 1rem;
            font-size: 0.8rem;
            background: var(--surface2);
            border: 1px solid var(--border);
        }

        .btn-sm:hover {
            background: var(--border);
        }

        /* Progress */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--surface2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #6c5ce7, #a29bfe);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        #status-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            min-height: 1.2em;
        }

        /* Results table */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        thead th {
            text-align: left;
            padding: 0.6rem 0.75rem;
            border-bottom: 2px solid var(--border);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tbody td {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:hover {
            background: var(--surface2);
        }

        .val-good {
            color: var(--green);
            font-weight: 600;
        }

        .val-bad {
            color: var(--red);
            font-weight: 600;
        }

        .val-neutral {
            color: var(--text);
        }

        .winner-badge {
            display: inline-block;
            background: rgba(0, 184, 148, 0.15);
            color: var(--green);
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        /* Metric cards */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .metric-card {
            background: var(--surface2);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .metric-card .label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-card .value {
            font-size: 1.4rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }

        .metric-card .detail {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Log */
        #log {
            background: var(--surface2);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            color: var(--text-muted);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .log-entry {
            padding: 1px 0;
        }

        .log-time {
            color: var(--accent);
        }

        .log-ok {
            color: var(--green);
        }

        .log-err {
            color: var(--red);
        }

        .log-warn {
            color: var(--yellow);
        }

        .hidden {
            display: none;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .discovery-item {
            padding: 0.75rem 1rem;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .discovery-item:hover {
            border-color: var(--accent);
            background: rgba(108, 92, 231, 0.1);
        }

        .discovery-item .main {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .discovery-item .sub {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .discovery-item .tag {
            font-size: 0.7rem;
            background: var(--border);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <h1>‚ö° WADO-RS vs WADO-URI Benchmark</h1>
    <p class="subtitle">Measure time-to-first-frame, complete load time, and transfer sizes for DICOMweb retrieval
        protocols</p>

    <!-- ‚îÄ‚îÄ Configuration ‚îÄ‚îÄ -->
    <div class="card">
        <h2><span class="dot dot-blue"></span> Configuration</h2>
        <div class="form-grid">
            <div class="form-group full-width">
                <label>DICOMweb Base URL</label>
                <input type="text" id="baseUrl" placeholder="e.g. https://your-app.databricks.app/api/dicomweb" />
            </div>
            <div class="form-group">
                <label>Iterations</label>
                <input type="number" id="iterations" value="3" min="1" max="20" />
            </div>
            <div class="form-group">
                <label>Concurrent Users</label>
                <input type="number" id="concurrency" value="1" min="1" max="10" />
            </div>
            <div class="form-group" style="display:none">
                <label>Total Frames (auto-detected)</label>
                <input type="number" id="totalFrames" value="1" min="1" readonly />
            </div>

            <div class="form-group full-width" id="selection-summary"
                style="padding: 1rem; background: var(--surface2); border-radius: 8px; border: 1px dashed var(--border); display:none;">
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">SELECTED TARGET</div>
                <div id="target-display" style="font-family: monospace; font-size: 0.85rem;"></div>
                <div id="frame-display" style="font-size: 0.8rem; color: var(--accent); margin-top: 0.25rem;"></div>
            </div>

            <div class="form-group full-width hidden">
                <input type="text" id="studyUid" />
                <input type="text" id="seriesUid" />
                <input type="text" id="instanceUid" />
            </div>
        </div>
        <div style="margin-top:1rem; display:flex; gap:0.75rem; align-items:center;">
            <button class="btn btn-sm" id="btnBrowse" onclick="toggleDiscovery()">üìÇ Browse Catalog</button>
            <button class="btn" id="btnRun" onclick="runBenchmark()" disabled>‚ñ∂ Run Benchmark</button>
            <span id="status-text">Select an instance to start</span>
        </div>
        <div class="progress-bar">
            <div class="fill" id="progressFill"></div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Discovery Browser ‚îÄ‚îÄ -->
    <div class="card hidden" id="discoveryCard">
        <div class="section-header">
            <h2><span class="dot dot-blue"></span> Discover Test Instance</h2>
            <button class="btn btn-sm" onclick="toggleDiscovery()">‚úï Close</button>
        </div>
        <div id="discovery-path"
            style="margin: 1rem 0; font-size: 0.8rem; color: var(--text-muted); display: flex; gap: 0.5rem; align-items: center;">
            <span style="cursor:pointer; color:var(--accent)" onclick="loadStudies()">Studies</span>
            <span class="path-sep hidden">/</span>
            <span id="path-study" class="hidden" style="cursor:pointer; color:var(--accent)"></span>
            <span class="path-sep hidden">/</span>
            <span id="path-series" class="hidden"></span>
        </div>
        <div id="discovery-list"
            style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 400px; overflow-y: auto; padding-right: 0.5rem;">
            <!-- Fetched items go here -->
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Results ‚îÄ‚îÄ -->
    <div class="card hidden" id="resultsCard">
        <div class="section-header">
            <h2><span class="dot dot-green"></span> Results</h2>
            <button class="btn btn-sm" onclick="exportResults()">üìã Copy JSON</button>
        </div>

        <!-- Summary metrics -->
        <div class="metric-grid" id="summaryMetrics"></div>

        <!-- Comparison table -->
        <div style="margin-top:1.5rem; overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>WADO-RS (frames)</th>
                        <th>WADO-URI (instance ‚Üí frame)</th>
                        <th>Diff</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>

        <!-- Scalability projection -->
        <div class="scalability-note" id="scalabilityNote"></div>
    </div>

    <!-- ‚îÄ‚îÄ Per-iteration detail ‚îÄ‚îÄ -->
    <div class="card hidden" id="detailCard">
        <h2><span class="dot dot-yellow"></span> Per-Iteration Detail</h2>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Protocol</th>
                        <th>TTFF (ms)</th>
                        <th>Total (ms)</th>
                        <th>Size (KB)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="detailBody"></tbody>
            </table>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Log ‚îÄ‚îÄ -->
    <div class="card">
        <h2><span class="dot dot-yellow"></span> Log</h2>
        <div id="log"></div>
    </div>

    <script>
        // ‚îÄ‚îÄ Globals ‚îÄ‚îÄ
        let allResults = [];
        let detectedFrames = 1;

        function log(msg, cls = '') {
            const el = document.getElementById('log');
            const t = new Date().toLocaleTimeString();
            el.innerHTML += `<div class="log-entry"><span class="log-time">[${t}]</span> <span class="${cls}">${msg}</span></div>`;
            el.scrollTop = el.scrollHeight;
        }

        function setStatus(msg) { document.getElementById('status-text').textContent = msg; }
        function setProgress(pct) { document.getElementById('progressFill').style.width = pct + '%'; }

        function getBaseUrl() {
            let url = document.getElementById('baseUrl').value.trim();
            if (!url) {
                // Auto-detect from current page
                url = window.location.origin + '/api/dicomweb';
                document.getElementById('baseUrl').value = url;
            }
            return url.replace(/\/$/, '');
        }

        // ‚îÄ‚îÄ Discovery Browser Logic ‚îÄ‚îÄ
        function toggleDiscovery() {
            const card = document.getElementById('discoveryCard');
            card.classList.toggle('hidden');
            if (!card.classList.contains('hidden')) {
                loadStudies();
            }
        }

        async function loadStudies() {
            const base = getBaseUrl();
            const list = document.getElementById('discovery-list');
            list.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-muted)">Loading studies...</div>';

            // Reset path
            document.querySelectorAll('.path-sep, #path-study, #path-series').forEach(el => el.classList.add('hidden'));

            try {
                const resp = await fetch(`${base}/studies?limit=15`, { credentials: 'include' });
                const studies = await resp.json();
                list.innerHTML = '';

                if (!studies.length) {
                    list.innerHTML = '<div style="padding:2rem; text-align:center">No studies found in catalog.</div>';
                    return;
                }

                studies.forEach(s => {
                    const uid = s['0020000D']?.Value?.[0];
                    const desc = s['00081030']?.Value?.[0] || 'No Description';
                    const date = s['00080020']?.Value?.[0] || '';
                    const modality = s['00080060']?.Value?.[0] || '??';

                    const item = document.createElement('div');
                    item.className = 'discovery-item';
                    item.onclick = () => loadSeries(uid, desc);
                    item.innerHTML = `
                        <div>
                            <div class="main">${desc}</div>
                            <div class="sub">${uid.slice(-16)}...</div>
                        </div>
                        <div style="display:flex; gap:0.5rem; align-items:center">
                            <span class="tag">${date}</span>
                            <span class="tag" style="color:var(--accent)">${modality}</span>
                            <span>‚Üí</span>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (e) {
                list.innerHTML = `<div style="padding:2rem; color:var(--red)">Error: ${e.message}</div>`;
            }
        }

        async function loadSeries(studyUid, studyDesc) {
            const base = getBaseUrl();
            const list = document.getElementById('discovery-list');
            list.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-muted)">Loading series...</div>';

            // Update path
            document.getElementById('path-study').innerText = studyDesc.slice(0, 20) + (studyDesc.length > 20 ? '...' : '');
            document.getElementById('path-study').onclick = () => loadStudies();
            document.querySelectorAll('.path-sep:nth-of-type(1), #path-study').forEach(el => el.classList.remove('hidden'));
            document.querySelectorAll('.path-sep:nth-of-type(2), #path-series').forEach(el => el.classList.add('hidden'));

            try {
                const resp = await fetch(`${base}/studies/${studyUid}/series`, { credentials: 'include' });
                const series = await resp.json();
                list.innerHTML = '';

                series.forEach(s => {
                    const uid = s['0020000E']?.Value?.[0];
                    const desc = s['0008103e']?.Value?.[0] || 'No Description';
                    const modality = s['00080060']?.Value?.[0] || '??';
                    const instances = s['00201209']?.Value?.[0] || '?';

                    const item = document.createElement('div');
                    item.className = 'discovery-item';
                    item.onclick = () => loadInstances(studyUid, uid, desc);
                    item.innerHTML = `
                        <div>
                            <div class="main">${desc}</div>
                            <div class="sub">${uid.slice(-16)}...</div>
                        </div>
                        <div style="display:flex; gap:0.5rem; align-items:center">
                            <span class="tag">${modality}</span>
                            <span class="tag">${instances} items</span>
                            <span>‚Üí</span>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (e) {
                list.innerHTML = `<div style="padding:2rem; color:var(--red)">Error: ${e.message}</div>`;
            }
        }

        async function loadInstances(studyUid, seriesUid, seriesDesc) {
            const base = getBaseUrl();
            const list = document.getElementById('discovery-list');
            list.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-muted)">Loading instances...</div>';

            // Update path
            document.getElementById('path-series').innerText = seriesDesc.slice(0, 20) + (seriesDesc.length > 20 ? '...' : '');
            document.querySelectorAll('.path-sep, #path-series').forEach(el => el.classList.remove('hidden'));

            try {
                const resp = await fetch(`${base}/studies/${studyUid}/series/${seriesUid}/instances`, { credentials: 'include' });
                const instances = await resp.json();
                list.innerHTML = '';

                instances.forEach(ins => {
                    const uid = ins['00080018']?.Value?.[0];
                    const frames = ins['00280008']?.Value?.[0] || '1';
                    const rows = ins['00280010']?.Value?.[0] || '?';
                    const cols = ins['00280011']?.Value?.[0] || '?';

                    const item = document.createElement('div');
                    item.className = 'discovery-item';
                    item.onclick = () => selectInstance(studyUid, seriesUid, uid, frames);
                    item.innerHTML = `
                        <div>
                            <div class="main">Instance ${uid.slice(-8)}</div>
                            <div class="sub">${uid.slice(-24)}</div>
                        </div>
                        <div style="display:flex; gap:0.5rem; align-items:center">
                            <span class="tag">${rows}x${cols}</span>
                            <span class="tag" style="color:var(--accent)">${frames} frames</span>
                            <span style="color:var(--green); font-weight:bold">SELECT</span>
                        </div>
                    `;
                    list.appendChild(item);
                });
            } catch (e) {
                list.innerHTML = `<div style="padding:2rem; color:var(--red)">Error: ${e.message}</div>`;
            }
        }

        function selectInstance(study, series, instance, frames) {
            document.getElementById('studyUid').value = study;
            document.getElementById('seriesUid').value = series;
            document.getElementById('instanceUid').value = instance;
            document.getElementById('totalFrames').value = frames;

            // Show summary
            document.getElementById('target-display').innerText = `Instance: ...${instance.slice(-12)}`;
            document.getElementById('frame-display').innerText = `Detected ${frames} frames`;
            document.getElementById('selection-summary').style.display = 'block';

            document.getElementById('btnRun').disabled = false;
            document.getElementById('discoveryCard').classList.add('hidden');
            setStatus('Instance selected. Ready to run.');
            log(`Target selected: ${instance}`, 'log-ok');

            // Reset results
            document.getElementById('resultsCard').classList.add('hidden');
            document.getElementById('detailCard').classList.add('hidden');
        }

        // ‚îÄ‚îÄ Benchmark WADO-RS (one request per frame, matching OHIF behavior) ‚îÄ‚îÄ
        async function benchWadoRS(base, study, series, instance, numFrames) {
            const t0 = performance.now();
            let ttff = null; // time until first frame fully received
            let totalBytes = 0;

            for (let f = 1; f <= numFrames; f++) {
                const url = `${base}/studies/${study}/series/${series}/instances/${instance}/frames/${f}`;
                const resp = await fetch(url, { credentials: 'include' });
                if (!resp.ok) throw new Error(`WADO-RS frame ${f}: ${resp.status}`);

                const reader = resp.body.getReader();
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    totalBytes += value.byteLength;
                }

                // TTFF = when the first frame response is fully received
                if (f === 1) {
                    ttff = performance.now() - t0;
                }
            }

            const totalTime = performance.now() - t0;
            return { ttff: ttff || totalTime, totalTime, totalBytes, protocol: 'WADO-RS', numFrames };
        }

        // ‚îÄ‚îÄ Benchmark WADO-URI ‚îÄ‚îÄ
        // WADO-URI for frame retrieval: the viewer must either:
        //   A) Download the entire instance first, then extract frames client-side
        //   B) Use frameNumber param if the server supports it (ours does)
        // For "time to first frame" in WADO-URI mode, we measure the full instance download
        // because the viewer cannot display anything until the full file arrives.
        async function benchWadoURI(base, study, series, instance, numFrames) {
            // In a real WADO-URI viewer (like OHIF in wadouri mode), the entire DICOM file
            // is downloaded first, then frames are extracted client-side from the ArrayBuffer.
            // The "time to first frame" = time to download the entire file.
            // const framesList = frames.split(',').map(f => f.trim()); // No longer needed

            // If server supports frameNumber param, test that path too
            // But the key metric is: time until the viewer can display Frame 1
            // In wadouri mode, that's when the entire file download completes.

            // Step 1: Download full instance (this is what OHIF does in wadouri mode)
            const instanceUrl = `${base}/wado?requestType=WADO&studyUID=${study}&seriesUID=${series}&objectUID=${instance}&contentType=application/dicom`;
            const t0 = performance.now();
            let totalBytes = 0;
            let ttff = null;

            const resp = await fetch(instanceUrl, { credentials: 'include' });
            if (!resp.ok) throw new Error(`WADO-URI ${resp.status}`);

            const reader = resp.body.getReader();
            let firstChunk = true;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                totalBytes += value.byteLength;
                if (firstChunk) {
                    // Note: this is TTFB, not TTFF. In wadouri mode, the first frame
                    // can only be rendered after the ENTIRE file is downloaded and parsed.
                    firstChunk = false;
                }
            }

            // In WADO-URI mode, time-to-first-frame = total download time
            // because the viewer needs the entire file to parse and render any frame
            const totalTime = performance.now() - t0;
            ttff = totalTime; // This is the critical difference vs WADO-RS

            return { ttff, totalTime, totalBytes, protocol: 'WADO-URI', numFrames: 'all (file)' };
        }

        // ‚îÄ‚îÄ Main benchmark runner ‚îÄ‚îÄ
        async function runBenchmark() {
            const base = getBaseUrl();
            const study = document.getElementById('studyUid').value.trim();
            const series = document.getElementById('seriesUid').value.trim();
            const instance = document.getElementById('instanceUid').value.trim();
            const iterations = parseInt(document.getElementById('iterations').value) || 3;
            const concurrency = parseInt(document.getElementById('concurrency').value) || 1;

            if (!study || !series || !instance) {
                log('Missing UIDs ‚Äî run Discovery first', 'log-err');
                setStatus('Error: missing UIDs');
                return;
            }

            const btn = document.getElementById('btnRun');
            btn.disabled = true;
            allResults = [];
            document.getElementById('detailBody').innerHTML = '';
            setProgress(0);

            log(`\n‚îÅ‚îÅ‚îÅ Target: ${instance.slice(-12)} ‚îÅ‚îÅ‚îÅ`);
            setStatus('Detecting frame count...');

            let numFrames = 1;
            try {
                const metaResp = await fetch(`${base}/studies/${study}/series/${series}/metadata`, { credentials: 'include' });
                if (!metaResp.ok) throw new Error(`Metadata fetch failed: ${metaResp.status}`);
                const metaList = await metaResp.json();
                const instMeta = metaList.find(m => m['00080018']?.Value?.[0] === instance);
                if (instMeta) {
                    numFrames = parseInt(instMeta['00280008']?.Value?.[0] || '1');
                }
                log(`Detected ${numFrames} frames for target instance`, 'log-ok');
            } catch (e) {
                log(`Auto-detection failed: ${e.message}. Defaulting to 1.`, 'log-warn');
                numFrames = 1;
            }
            document.getElementById('totalFrames').value = numFrames;

            const totalTests = iterations * concurrency * 2;
            let completed = 0;

            log(`Starting benchmark: ${iterations} iterations x ${concurrency} users`);

            const rsResults = [];
            const uriResults = [];

            const runSet = async (protocol) => {
                const tasks = [];
                for (let c = 0; c < concurrency; c++) {
                    tasks.push((async (userId) => {
                        for (let i = 0; i < iterations; i++) {
                            setStatus(`User ${userId + 1} | Iteration ${i + 1} ‚Äî ${protocol}...`);
                            try {
                                const result = (protocol === 'WADO-RS')
                                    ? await benchWadoRS(base, study, series, instance, numFrames)
                                    : await benchWadoURI(base, study, series, instance, numFrames);

                                if (protocol === 'WADO-RS') rsResults.push(result);
                                else uriResults.push(result);

                                addDetailRow(`${userId + 1}.${i + 1}`, result);
                                log(`${protocol} U${userId + 1}#${i + 1}: TTFF=${result.ttff.toFixed(1)}ms, Total=${result.totalTime.toFixed(1)}ms`, 'log-ok');
                            } catch (e) {
                                log(`${protocol} ERR U${userId + 1}#${i + 1}: ${e.message}`, 'log-err');
                            }
                            completed++;
                            setProgress((completed / totalTests) * 100);
                        }
                    })(c));
                }
                await Promise.all(tasks);
            };

            const startTime = performance.now();
            await runSet('WADO-RS');
            const rsEndTime = performance.now();

            await new Promise(r => setTimeout(r, 500)); // Cool down

            const uriStartTime = performance.now();
            await runSet('WADO-URI');
            const uriEndTime = performance.now();

            // Compute summary with throughput
            const rsWallTime = (rsEndTime - startTime) / 1000;
            const uriWallTime = (uriEndTime - uriStartTime) / 1000;
            const rsTotalRequests = rsResults.reduce((a, b) => a + b.numFrames, 0);
            const uriTotalRequests = uriResults.length; // 1 file per iteration

            allResults = {
                rs: rsResults,
                uri: uriResults,
                config: { study, series, instance, numFrames, iterations, concurrency },
                throughput: {
                    rsRps: rsTotalRequests / rsWallTime,
                    uriRps: (uriResults.length * numFrames) / uriWallTime // Normalized to frames for comparison
                }
            };

            showResults(rsResults, uriResults, allResults.throughput);
            setStatus('Benchmark complete');
            setProgress(100);
            btn.disabled = false;
            log('‚îÅ‚îÅ‚îÅ Benchmark complete ‚îÅ‚îÅ‚îÅ\n', 'log-ok');
        }

        function median(arr) {
            if (!arr.length) return NaN;
            const s = [...arr].sort((a, b) => a - b);
            const mid = Math.floor(s.length / 2);
            return s.length % 2 ? s[mid] : (s[mid - 1] + s[mid]) / 2;
        }

        function showResults(rsArr, uriArr, throughput) {
            if (!rsArr.length || !uriArr.length) return;

            document.getElementById('resultsCard').classList.remove('hidden');
            document.getElementById('detailCard').classList.remove('hidden');

            const rsTtff = rsArr.map(r => r.ttff);
            const rsTotal = rsArr.map(r => r.totalTime);
            const rsBytes = rsArr.map(r => r.totalBytes);

            const uriTtff = uriArr.map(r => r.ttff);
            const uriTotal = uriArr.map(r => r.totalTime);
            const uriBytes = uriArr.map(r => r.totalBytes);

            const metrics = [
                {
                    label: 'TTFF (median)',
                    rs: median(rsTtff), uri: median(uriTtff), unit: 'ms', lower: true
                },
                {
                    label: 'TTFF (min)',
                    rs: Math.min(...rsTtff), uri: Math.min(...uriTtff), unit: 'ms', lower: true
                },
                {
                    label: 'Total Time (median)',
                    rs: median(rsTotal), uri: median(uriTotal), unit: 'ms', lower: true
                },
                {
                    label: 'Total Time (min)',
                    rs: Math.min(...rsTotal), uri: Math.min(...uriTotal), unit: 'ms', lower: true
                },
                {
                    label: 'Throughput',
                    rs: throughput.rsRps, uri: throughput.uriRps, unit: 'fps', lower: false
                }
            ];

            // Summary metric cards
            const summaryEl = document.getElementById('summaryMetrics');
            const ttffRs = median(rsTtff);
            const ttffUri = median(uriTtff);
            const ttffWinner = ttffRs < ttffUri ? 'WADO-RS' : 'WADO-URI';
            const ttffSpeedup = ttffRs < ttffUri ? (ttffUri / ttffRs).toFixed(1) : (ttffRs / ttffUri).toFixed(1);

            const rpsRs = throughput.rsRps;
            const rpsUri = throughput.uriRps;
            const rpsWinner = rpsRs > rpsUri ? 'WADO-RS' : 'WADO-URI';

            summaryEl.innerHTML = `
    <div class="metric-card">
      <div class="label">TTFF Winner</div>
      <div class="value" style="color:var(--green)">${ttffWinner}</div>
      <div class="detail">${ttffSpeedup}√ó faster response</div>
    </div>
    <div class="metric-card">
      <div class="label">Throughput Winner</div>
      <div class="value" style="color:var(--accent)">${rpsWinner}</div>
      <div class="detail">Comparing frames per second</div>
    </div>
    <div class="metric-card">
      <div class="label">WADO-RS RPS</div>
      <div class="value">${rpsRs.toFixed(1)}<span style="font-size:0.8rem;color:var(--text-muted)">fps</span></div>
      <div class="detail">Individual frame requests</div>
    </div>
    <div class="metric-card">
      <div class="label">WADO-URI RPS</div>
      <div class="value">${rpsUri.toFixed(1)}<span style="font-size:0.8rem;color:var(--text-muted)">fps</span></div>
      <div class="detail">Normalized full-file x frames</div>
    </div>
  `;

            // Comparison table
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            for (const m of metrics) {
                const rsVal = m.divisor ? m.rs / m.divisor : m.rs;
                const uriVal = m.divisor ? m.uri / m.divisor : m.uri;
                const diff = uriVal - rsVal;
                const rsWins = m.lower ? rsVal < uriVal : rsVal > uriVal;
                const uriWins = !rsWins;

                tbody.innerHTML += `<tr>
      <td>${m.label}</td>
      <td class="${rsWins ? 'val-good' : 'val-neutral'}">${rsVal.toFixed(1)} ${m.unit}${rsWins ? '<span class="winner-badge">WINNER</span>' : ''}</td>
      <td class="${uriWins ? 'val-good' : 'val-neutral'}">${uriVal.toFixed(1)} ${m.unit}${uriWins ? '<span class="winner-badge">WINNER</span>' : ''}</td>
      <td>${diff > 0 ? '+' : ''}${diff.toFixed(1)} ${m.unit}</td>
    </tr>`;
            }

            // Scalability note
            const note = document.getElementById('scalabilityNote');
            const rsPerSec = 1000 / totalRs;
            const uriPerSec = 1000 / totalUri;
            note.innerHTML = `
    <strong>üìä Scalability Projection (100 concurrent users)</strong><br/>
    <strong>WADO-RS:</strong> Each frame request transfers ~${(avgBytesRs / 1024).toFixed(0)} KB.
    At ${rsPerSec.toFixed(1)} req/s throughput, the server must handle ~${(100 * rsPerSec).toFixed(0)} frame-req/s
    and ~${(100 * avgBytesRs / 1024 / 1024).toFixed(1)} MB/s bandwidth.<br/>
    <strong>WADO-URI:</strong> Each instance download transfers ~${(avgBytesUri / 1024).toFixed(0)} KB.
    At ${uriPerSec.toFixed(1)} req/s throughput, the server must handle ~${(100 * uriPerSec).toFixed(0)} inst-req/s
    and ~${(100 * avgBytesUri / 1024 / 1024).toFixed(1)} MB/s bandwidth.<br/><br/>
    <strong>Key insight:</strong> WADO-RS sends only the requested frames (${(avgBytesRs / 1024).toFixed(0)} KB/req),
    while WADO-URI sends the entire DICOM file (${(avgBytesUri / 1024).toFixed(0)} KB/req).
    ${bandwidthSaved > 0
                    ? `At 100 users, WADO-RS saves ~${(100 * (avgBytesUri - avgBytesRs) / 1024 / 1024).toFixed(1)} MB/s bandwidth.`
                    : `Transfer sizes are comparable for single-frame files.`}
    For multi-frame files, WADO-RS is critical for memory ‚Äî the server and client only handle one frame at a time instead of the entire file.
  `;
        }

        function addDetailRow(iter, result, error) {
            const tbody = document.getElementById('detailBody');
            const status = error ? `<span class="val-bad">‚ùå ${error}</span>` : '<span class="val-good">‚úÖ OK</span>';
            tbody.innerHTML += `<tr>
    <td>${iter}</td>
    <td>${result.protocol}</td>
    <td>${isNaN(result.ttff) ? '‚Äî' : result.ttff.toFixed(1)}</td>
    <td>${isNaN(result.totalTime) ? '‚Äî' : result.totalTime.toFixed(1)}</td>
    <td>${(result.totalBytes / 1024).toFixed(1)}</td>
    <td>${status}</td>
  </tr>`;
        }

        function exportResults() {
            const json = JSON.stringify(allResults, null, 2);
            navigator.clipboard.writeText(json).then(() => {
                log('Results copied to clipboard', 'log-ok');
            });
        }

        // Auto-fill base URL on load
        window.addEventListener('load', () => {
            if (!document.getElementById('baseUrl').value) {
                document.getElementById('baseUrl').value = window.location.origin + '/api/dicomweb';
            }
        });
    </script>
</body>

</html>